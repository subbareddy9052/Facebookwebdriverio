"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _requestPromise = _interopRequireDefault(require("request-promise"));

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("./logger"));

var _lodash = _interopRequireDefault(require("lodash"));

const hubUri = config => {
  const protocol = config.hubProtocol || 'http';
  return `${protocol}://${config.hubHost}:${config.hubPort}`;
};

async function registerNode(configFile, addr, port) {
  let data;

  try {
    data = await _appiumSupport.fs.readFile(configFile, 'utf-8');
  } catch (err) {
    _logger.default.error(`Unable to load node configuration file to register with grid: ${err.message}`);

    return;
  }

  if (!data) {
    _logger.default.error('No data found in the node configuration file to send to the grid');

    return;
  }

  postRequest(data, addr, port);
}

async function registerToGrid(options_post, jsonObject) {
  try {
    let response = await (0, _requestPromise.default)(options_post);

    if (response === undefined || response.statusCode !== 200) {
      throw new Error('Request failed');
    }

    let logMessage = `Appium successfully registered with the grid on ${hubUri(jsonObject.configuration)}`;

    _logger.default.debug(logMessage);
  } catch (err) {
    _logger.default.error(`Request to register with grid was unsuccessful: ${err.message}`);
  }
}

function postRequest(data, addr, port) {
  let jsonObject;

  try {
    jsonObject = JSON.parse(data);
  } catch (err) {
    _logger.default.errorAndThrow(`Syntax error in node configuration file: ${err.message}`);
  }

  if (!_lodash.default.has(jsonObject, 'configuration')) {
    let configuration = {};

    for (const property in jsonObject) {
      if (_lodash.default.has(jsonObject, property) && property !== 'capabilities') {
        configuration[property] = jsonObject[property];
        delete jsonObject[property];
      }
    }

    jsonObject.configuration = configuration;
  }

  if (!jsonObject.configuration.url || !jsonObject.configuration.host || !jsonObject.configuration.port) {
    jsonObject.configuration.url = `http://${addr}:${port}/wd/hub`;
    jsonObject.configuration.host = addr;
    jsonObject.configuration.port = port;
  }

  if (!jsonObject.configuration.id) {
    jsonObject.configuration.id = `http://${jsonObject.configuration.host}:${jsonObject.configuration.port}`;
  }

  data = JSON.stringify(jsonObject);
  let post_headers = {
    'Content-Type': 'application/json',
    'Content-Length': data.length
  };
  let post_options = {
    url: `${hubUri(jsonObject.configuration)}/grid/register`,
    method: 'POST',
    body: data,
    headers: post_headers,
    resolveWithFullResponse: true
  };

  if (jsonObject.configuration.register !== true) {
    _logger.default.debug(`No registration sent (${jsonObject.configuration.register} = false)`);

    return;
  }

  let registerCycleTime = jsonObject.configuration.registerCycle;

  if (registerCycleTime !== null && registerCycleTime > 0) {
    let first = true;

    _logger.default.debug(`Starting auto register thread for grid. Will try to register every ${registerCycleTime} ms.`);

    setInterval(async function registerRetry() {
      if (first !== true) {
        let isRegistered = await isAlreadyRegistered(jsonObject);

        if (isRegistered !== null && isRegistered !== true) {
          await registerToGrid(post_options, jsonObject);
        }
      } else {
        first = false;
        await registerToGrid(post_options, jsonObject);
      }
    }, registerCycleTime);
  }
}

async function isAlreadyRegistered(jsonObject) {
  let id = jsonObject.configuration.id;

  try {
    let response = await (0, _requestPromise.default)({
      uri: `${hubUri(jsonObject.configuration)}/grid/api/proxy?id=${id}`,
      method: 'GET',
      timeout: 10000,
      resolveWithFullResponse: true
    });

    if (response === undefined || response.statusCode !== 200) {
      throw new Error(`Request failed`);
    }

    let responseData = JSON.parse(response.body);

    if (responseData.success !== true) {
      _logger.default.debug(`Grid registration error: ${responseData.msg}`);
    }

    return responseData.success;
  } catch (err) {
    _logger.default.debug(`Hub down or not responding: ${err.message}`);
  }
}

var _default = registerNode;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9ncmlkLXJlZ2lzdGVyLmpzIl0sIm5hbWVzIjpbImh1YlVyaSIsImNvbmZpZyIsInByb3RvY29sIiwiaHViUHJvdG9jb2wiLCJodWJIb3N0IiwiaHViUG9ydCIsInJlZ2lzdGVyTm9kZSIsImNvbmZpZ0ZpbGUiLCJhZGRyIiwicG9ydCIsImRhdGEiLCJmcyIsInJlYWRGaWxlIiwiZXJyIiwibG9nZ2VyIiwiZXJyb3IiLCJtZXNzYWdlIiwicG9zdFJlcXVlc3QiLCJyZWdpc3RlclRvR3JpZCIsIm9wdGlvbnNfcG9zdCIsImpzb25PYmplY3QiLCJyZXNwb25zZSIsInVuZGVmaW5lZCIsInN0YXR1c0NvZGUiLCJFcnJvciIsImxvZ01lc3NhZ2UiLCJjb25maWd1cmF0aW9uIiwiZGVidWciLCJKU09OIiwicGFyc2UiLCJlcnJvckFuZFRocm93IiwiXyIsImhhcyIsInByb3BlcnR5IiwidXJsIiwiaG9zdCIsImlkIiwic3RyaW5naWZ5IiwicG9zdF9oZWFkZXJzIiwibGVuZ3RoIiwicG9zdF9vcHRpb25zIiwibWV0aG9kIiwiYm9keSIsImhlYWRlcnMiLCJyZXNvbHZlV2l0aEZ1bGxSZXNwb25zZSIsInJlZ2lzdGVyIiwicmVnaXN0ZXJDeWNsZVRpbWUiLCJyZWdpc3RlckN5Y2xlIiwiZmlyc3QiLCJzZXRJbnRlcnZhbCIsInJlZ2lzdGVyUmV0cnkiLCJpc1JlZ2lzdGVyZWQiLCJpc0FscmVhZHlSZWdpc3RlcmVkIiwidXJpIiwidGltZW91dCIsInJlc3BvbnNlRGF0YSIsInN1Y2Nlc3MiLCJtc2ciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsTUFBTSxHQUFJQyxNQUFELElBQVk7QUFDekIsUUFBTUMsUUFBUSxHQUFHRCxNQUFNLENBQUNFLFdBQVAsSUFBc0IsTUFBdkM7QUFDQSxTQUFRLEdBQUVELFFBQVMsTUFBS0QsTUFBTSxDQUFDRyxPQUFRLElBQUdILE1BQU0sQ0FBQ0ksT0FBUSxFQUF6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T0FBcEI7QUFDRCxHQWhCRCxDQWdCRSxPQUFPM0MsR0FBUCxFQUFZO0FBQ1pDLG9CQUFPYSxLQUFQLENBQWMsK0JBQThCZCxHQUFHLENBQUNHLE9BQVEsRUFBeEQ7QUFDRDtBQUNGOztlQUdjVixZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHJlcXVlc3QgZnJvbSAncmVxdWVzdC1wcm9taXNlJztcbmltcG9ydCB7IGZzIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuXG5cbmNvbnN0IGh1YlVyaSA9IChjb25maWcpID0+IHtcbiAgY29uc3QgcHJvdG9jb2wgPSBjb25maWcuaHViUHJvdG9jb2wgfHwgJ2h0dHAnO1xuICByZXR1cm4gYCR7cHJvdG9jb2x9Oi8vJHtjb25maWcuaHViSG9zdH06JHtjb25maWcuaHViUG9ydH1gO1xufTtcblxuYXN5bmMgZnVuY3Rpb24gcmVnaXN0ZXJOb2RlIChjb25maWdGaWxlLCBhZGRyLCBwb3J0KSB7XG4gIGxldCBkYXRhO1xuICB0cnkge1xuICAgIGRhdGEgPSBhd2FpdCBmcy5yZWFkRmlsZShjb25maWdGaWxlLCAndXRmLTgnKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nZ2VyLmVycm9yKGBVbmFibGUgdG8gbG9hZCBub2RlIGNvbmZpZ3VyYXRpb24gZmlsZSB0byByZWdpc3RlciB3aXRoIGdyaWQ6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgLy8gQ2hlY2sgcHJlc2VuY2Ugb2YgZGF0YSBiZWZvcmUgcG9zdGluZyAgaXQgdG8gdGhlIHNlbGVuaXVtIGdyaWRcbiAgaWYgKCFkYXRhKSB7XG4gICAgbG9nZ2VyLmVycm9yKCdObyBkYXRhIGZvdW5kIGluIHRoZSBub2RlIGNvbmZpZ3VyYXRpb24gZmlsZSB0byBzZW5kIHRvIHRoZSBncmlkJyk7XG4gICAgcmV0dXJuO1xuICB9XG4gIHBvc3RSZXF1ZXN0KGRhdGEsIGFkZHIsIHBvcnQpO1xufVxuXG5hc3luYyBmdW5jdGlvbiByZWdpc3RlclRvR3JpZCAob3B0aW9uc19wb3N0LCBqc29uT2JqZWN0KSB7XG4gIHRyeSB7XG4gICAgbGV0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChvcHRpb25zX3Bvc3QpO1xuICAgIGlmIChyZXNwb25zZSA9PT0gdW5kZWZpbmVkIHx8IHJlc3BvbnNlLnN0YXR1c0NvZGUgIT09IDIwMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdSZXF1ZXN0IGZhaWxlZCcpO1xuICAgIH1cbiAgICBsZXQgbG9nTWVzc2FnZSA9IGBBcHBpdW0gc3VjY2Vzc2Z1bGx5IHJlZ2lzdGVyZWQgd2l0aCB0aGUgZ3JpZCBvbiAke2h1YlVyaShqc29uT2JqZWN0LmNvbmZpZ3VyYXRpb24pfWA7XG4gICAgbG9nZ2VyLmRlYnVnKGxvZ01lc3NhZ2UpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2dnZXIuZXJyb3IoYFJlcXVlc3QgdG8gcmVnaXN0ZXIgd2l0aCBncmlkIHdhcyB1bnN1Y2Nlc3NmdWw6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gcG9zdFJlcXVlc3QgKGRhdGEsIGFkZHIsIHBvcnQpIHtcbiAgLy8gcGFyc2UganNvbiB0byBnZXQgaHViIGhvc3QgYW5kIHBvcnRcbiAgbGV0IGpzb25PYmplY3Q7XG4gIHRyeSB7XG4gICAganNvbk9iamVjdCA9IEpTT04ucGFyc2UoZGF0YSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZ2dlci5lcnJvckFuZFRocm93KGBTeW50YXggZXJyb3IgaW4gbm9kZSBjb25maWd1cmF0aW9uIGZpbGU6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gIH1cblxuICAvLyBNb3ZlIFNlbGVuaXVtIDMgY29uZmlndXJhdGlvbiBwcm9wZXJ0aWVzIHRvIGNvbmZpZ3VyYXRpb24gb2JqZWN0XG4gIGlmICghXy5oYXMoanNvbk9iamVjdCwgJ2NvbmZpZ3VyYXRpb24nKSkge1xuICAgIGxldCBjb25maWd1cmF0aW9uID0ge307XG4gICAgZm9yIChjb25zdCBwcm9wZXJ0eSBpbiBqc29uT2JqZWN0KSB7XG4gICAgICBpZiAoXy5oYXMoanNvbk9iamVjdCwgcHJvcGVydHkpICYmIHByb3BlcnR5ICE9PSAnY2FwYWJpbGl0aWVzJykge1xuICAgICAgICBjb25maWd1cmF0aW9uW3Byb3BlcnR5XSA9IGpzb25PYmplY3RbcHJvcGVydHldO1xuICAgICAgICBkZWxldGUganNvbk9iamVjdFtwcm9wZXJ0eV07XG4gICAgICB9XG4gICAgfVxuICAgIGpzb25PYmplY3QuY29uZmlndXJhdGlvbiA9IGNvbmZpZ3VyYXRpb247XG4gIH1cblxuICAvLyBpZiB0aGUgbm9kZSBjb25maWcgZG9lcyBub3QgaGF2ZSB0aGUgYXBwaXVtL3dlYmRyaXZlciB1cmwsIGhvc3QsIGFuZCBwb3J0LFxuICAvLyBhdXRvbWF0aWNhbGx5IGFkZCBpdCBiYXNlZCBvbiBob3cgYXBwaXVtIHdhcyBpbml0aWFsaXplZFxuICAvLyBvdGhlcndpc2UsIHdlIHdpbGwgdGFrZSB3aGF0ZXZlciB0aGUgdXNlciBzZXR1cFxuICAvLyBiZWNhdXNlIHdlIHdpbGwgYWx3YXlzIHNldCBsb2NhbGhvc3QvMTI3LjAuMC4xLiB0aGlzIHdvbid0IHdvcmsgaWYgeW91clxuICAvLyBub2RlIGFuZCBncmlkIGFyZW4ndCBpbiB0aGUgc2FtZSBwbGFjZVxuICBpZiAoIWpzb25PYmplY3QuY29uZmlndXJhdGlvbi51cmwgfHwgIWpzb25PYmplY3QuY29uZmlndXJhdGlvbi5ob3N0IHx8ICFqc29uT2JqZWN0LmNvbmZpZ3VyYXRpb24ucG9ydCkge1xuICAgIGpzb25PYmplY3QuY29uZmlndXJhdGlvbi51cmwgPSBgaHR0cDovLyR7YWRkcn06JHtwb3J0fS93ZC9odWJgO1xuICAgIGpzb25PYmplY3QuY29uZmlndXJhdGlvbi5ob3N0ID0gYWRkcjtcbiAgICBqc29uT2JqZWN0LmNvbmZpZ3VyYXRpb24ucG9ydCA9IHBvcnQ7XG4gIH1cbiAgLy8gaWYgdGhlIG5vZGUgY29uZmlnIGRvZXMgbm90IGhhdmUgaWQgYXV0b21hdGljYWxseSBhZGQgaXRcbiAgaWYgKCFqc29uT2JqZWN0LmNvbmZpZ3VyYXRpb24uaWQpIHtcbiAgICBqc29uT2JqZWN0LmNvbmZpZ3VyYXRpb24uaWQgPSBgaHR0cDovLyR7anNvbk9iamVjdC5jb25maWd1cmF0aW9uLmhvc3R9OiR7anNvbk9iamVjdC5jb25maWd1cmF0aW9uLnBvcnR9YDtcbiAgfVxuXG4gIC8vIHJlLXNlcmlhbGl6ZSB0aGUgY29uZmlndXJhdGlvbiB3aXRoIHRoZSBhdXRvIHBvcHVsYXRlZCBkYXRhXG4gIGRhdGEgPSBKU09OLnN0cmluZ2lmeShqc29uT2JqZWN0KTtcblxuICAvLyBwcmVwYXJlIHRoZSBoZWFkZXJcbiAgbGV0IHBvc3RfaGVhZGVycyA9IHtcbiAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICdDb250ZW50LUxlbmd0aCc6IGRhdGEubGVuZ3RoXG4gIH07XG4gIC8vIHRoZSBwb3N0IG9wdGlvbnNcbiAgbGV0IHBvc3Rfb3B0aW9ucyA9IHtcbiAgICB1cmw6IGAke2h1YlVyaShqc29uT2JqZWN0LmNvbmZpZ3VyYXRpb24pfS9ncmlkL3JlZ2lzdGVyYCxcbiAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICBib2R5OiBkYXRhLFxuICAgIGhlYWRlcnM6IHBvc3RfaGVhZGVycyxcbiAgICByZXNvbHZlV2l0aEZ1bGxSZXNwb25zZTogdHJ1ZSAvLyByZXR1cm4gdGhlIGZ1bGwgcmVzcG9uc2UsIG5vdCBqdXN0IHRoZSBib2R5XG4gIH07XG5cbiAgaWYgKGpzb25PYmplY3QuY29uZmlndXJhdGlvbi5yZWdpc3RlciAhPT0gdHJ1ZSkge1xuICAgIGxvZ2dlci5kZWJ1ZyhgTm8gcmVnaXN0cmF0aW9uIHNlbnQgKCR7anNvbk9iamVjdC5jb25maWd1cmF0aW9uLnJlZ2lzdGVyfSA9IGZhbHNlKWApO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGxldCByZWdpc3RlckN5Y2xlVGltZSA9IGpzb25PYmplY3QuY29uZmlndXJhdGlvbi5yZWdpc3RlckN5Y2xlO1xuICBpZiAocmVnaXN0ZXJDeWNsZVRpbWUgIT09IG51bGwgJiYgcmVnaXN0ZXJDeWNsZVRpbWUgPiAwKSB7XG4gICAgLy8gaW5pdGlhdGUgYSBuZXcgVGhyZWFkXG4gICAgbGV0IGZpcnN0ID0gdHJ1ZTtcbiAgICBsb2dnZXIuZGVidWcoYFN0YXJ0aW5nIGF1dG8gcmVnaXN0ZXIgdGhyZWFkIGZvciBncmlkLiBXaWxsIHRyeSB0byByZWdpc3RlciBldmVyeSAke3JlZ2lzdGVyQ3ljbGVUaW1lfSBtcy5gKTtcbiAgICBzZXRJbnRlcnZhbChhc3luYyBmdW5jdGlvbiByZWdpc3RlclJldHJ5ICgpIHtcbiAgICAgIGlmIChmaXJzdCAhPT0gdHJ1ZSkge1xuICAgICAgICBsZXQgaXNSZWdpc3RlcmVkID0gYXdhaXQgaXNBbHJlYWR5UmVnaXN0ZXJlZChqc29uT2JqZWN0KTtcbiAgICAgICAgaWYgKGlzUmVnaXN0ZXJlZCAhPT0gbnVsbCAmJiBpc1JlZ2lzdGVyZWQgIT09IHRydWUpIHtcbiAgICAgICAgICAvLyBtYWtlIHRoZSBodHRwIFBPU1QgdG8gdGhlIGdyaWQgZm9yIHJlZ2lzdHJhdGlvblxuICAgICAgICAgIGF3YWl0IHJlZ2lzdGVyVG9HcmlkKHBvc3Rfb3B0aW9ucywganNvbk9iamVjdCk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGZpcnN0ID0gZmFsc2U7XG4gICAgICAgIGF3YWl0IHJlZ2lzdGVyVG9HcmlkKHBvc3Rfb3B0aW9ucywganNvbk9iamVjdCk7XG4gICAgICB9XG4gICAgfSwgcmVnaXN0ZXJDeWNsZVRpbWUpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGlzQWxyZWFkeVJlZ2lzdGVyZWQgKGpzb25PYmplY3QpIHtcbiAgLy9jaGVjayBpZiBub2RlIGlzIGFscmVhZHkgcmVnaXN0ZXJlZFxuICBsZXQgaWQgPSBqc29uT2JqZWN0LmNvbmZpZ3VyYXRpb24uaWQ7XG4gIHRyeSB7XG4gICAgbGV0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdCh7XG4gICAgICB1cmk6IGAke2h1YlVyaShqc29uT2JqZWN0LmNvbmZpZ3VyYXRpb24pfS9ncmlkL2FwaS9wcm94eT9pZD0ke2lkfWAsXG4gICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgdGltZW91dDogMTAwMDAsXG4gICAgICByZXNvbHZlV2l0aEZ1bGxSZXNwb25zZTogdHJ1ZSAvLyByZXR1cm4gdGhlIGZ1bGwgcmVzcG9uc2UsIG5vdCBqdXN0IHRoZSBib2R5XG4gICAgfSk7XG4gICAgaWYgKHJlc3BvbnNlID09PSB1bmRlZmluZWQgfHwgcmVzcG9uc2Uuc3RhdHVzQ29kZSAhPT0gMjAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFJlcXVlc3QgZmFpbGVkYCk7XG4gICAgfVxuICAgIGxldCByZXNwb25zZURhdGEgPSBKU09OLnBhcnNlKHJlc3BvbnNlLmJvZHkpO1xuICAgIGlmIChyZXNwb25zZURhdGEuc3VjY2VzcyAhPT0gdHJ1ZSkge1xuICAgICAgLy8gaWYgcmVnaXN0ZXIgZmFpbCwgcHJpbnQgdGhlIGRlYnVnIG1zZ1xuICAgICAgbG9nZ2VyLmRlYnVnKGBHcmlkIHJlZ2lzdHJhdGlvbiBlcnJvcjogJHtyZXNwb25zZURhdGEubXNnfWApO1xuICAgIH1cbiAgICByZXR1cm4gcmVzcG9uc2VEYXRhLnN1Y2Nlc3M7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZ2dlci5kZWJ1ZyhgSHViIGRvd24gb3Igbm90IHJlc3BvbmRpbmc6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gIH1cbn1cblxuXG5leHBvcnQgZGVmYXVsdCByZWdpc3Rlck5vZGU7XG4iXSwiZmlsZSI6ImxpYi9ncmlkLXJlZ2lzdGVyLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
