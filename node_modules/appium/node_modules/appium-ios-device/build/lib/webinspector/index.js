"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.WEB_INSPECTOR_SERVICE_NAME = exports.WebInspectorService = void 0;

require("source-map-support/register");

var _webinspectorDecoder = _interopRequireDefault(require("./transformer/webinspector-decoder"));

var _webinspectorEncoder = _interopRequireDefault(require("./transformer/webinspector-encoder"));

var _plistServiceDecoder = _interopRequireDefault(require("../plist-service/transformer/plist-service-decoder"));

var _plistServiceEncoder = _interopRequireDefault(require("../plist-service/transformer/plist-service-encoder"));

var _lengthBasedSplitter = _interopRequireDefault(require("../util/transformer/length-based-splitter"));

var _streamLogger = _interopRequireDefault(require("../util/transformer/stream-logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _constants = require("../constants");

var _logger = _interopRequireDefault(require("../logger"));

var _baseService = require("../base-service");

const WEB_INSPECTOR_SERVICE_NAME = 'com.apple.webinspector';
exports.WEB_INSPECTOR_SERVICE_NAME = WEB_INSPECTOR_SERVICE_NAME;
const MAX_FRAME_SIZE = 20 * _constants.MB;
const PARTIAL_MESSAGE_SUPPORT_DEPRECATION_VERSION = 11;

class WebInspectorService extends _baseService.BaseServiceSocket {
  constructor(opts = {}) {
    const {
      majorOsVersion,
      isSimulator = false,
      socketChunkSize,
      verbose = false,
      verboseHexDump = false,
      socketClient
    } = opts;
    super(socketClient);

    if (_lodash.default.isFunction(socketClient.setMaxSendFragment) && !_lodash.default.isNil(socketChunkSize) && socketChunkSize > 0) {
      if (socketClient.setMaxSendFragment(socketChunkSize)) {
        _logger.default.debug(`Maximum TLS fragment size set to '${socketChunkSize}'`);
      } else {
        _logger.default.warn(`Unable to set TLS fragment size to '${socketChunkSize}'`);
      }
    }

    this._verbose = verbose;
    this._isSimulator = isSimulator;
    this._majorOsVersion = majorOsVersion;

    if (!isSimulator && majorOsVersion < PARTIAL_MESSAGE_SUPPORT_DEPRECATION_VERSION) {
      this._initializePartialMessageSupport(verboseHexDump);
    } else {
      this._initializeFullMessageSupport(verboseHexDump);
    }
  }

  _initializeFullMessageSupport(verbose) {
    this._decoder = new _plistServiceDecoder.default();

    this._socketClient.pipe(new _streamLogger.default(_streamLogger.default.RECEIVE, verbose)).pipe(this._splitter = new _lengthBasedSplitter.default({
      readableStream: this._socketClient,
      littleEndian: false,
      maxFrameLength: MAX_FRAME_SIZE,
      lengthFieldOffset: 0,
      lengthFieldLength: 4,
      lengthAdjustment: 4
    })).pipe(this._decoder);

    this._encoder = new _plistServiceEncoder.default();

    this._encoder.pipe(new _streamLogger.default(_streamLogger.default.SEND, verbose)).pipe(this._socketClient);
  }

  _initializePartialMessageSupport(verbose) {
    this._decoder = new _webinspectorDecoder.default(_constants.MB);

    this._socketClient.pipe(new _streamLogger.default(_streamLogger.default.RECEIVE, verbose)).pipe(this._splitter = new _lengthBasedSplitter.default({
      readableStream: this._socketClient,
      littleEndian: false,
      maxFrameLength: MAX_FRAME_SIZE,
      lengthFieldOffset: 0,
      lengthFieldLength: 4,
      lengthAdjustment: 4
    })).pipe(new _plistServiceDecoder.default()).pipe(this._decoder);

    this._encoder = new _webinspectorEncoder.default();

    this._encoder.pipe(new _plistServiceEncoder.default()).pipe(new _streamLogger.default(_streamLogger.default.SEND, verbose)).pipe(this._socketClient);
  }

  sendMessage(rpcObject) {
    if (_lodash.default.isNil(rpcObject)) {
      throw new Error('Cannot send a null object');
    }

    if (this._verbose) {
      _logger.default.debug('Sending message to Web Inspector:');

      _logger.default.debug(_appiumSupport.util.jsonStringify(rpcObject));
    }

    this._encoder.write(rpcObject);

    if (!this._isSimulator && this._majorOsVersion >= PARTIAL_MESSAGE_SUPPORT_DEPRECATION_VERSION) {
      this._encoder.write(' ');
    }
  }

  listenMessage(onData) {
    this._decoder.on('data', data => {
      if (this._verbose) {
        _logger.default.debug('Received message from Web Inspector:');

        _logger.default.debug(_appiumSupport.util.jsonStringify(data));
      }

      onData(data);
    });
  }

}

exports.WebInspectorService = WebInspectorService;
var _default = WebInspectorService;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZWJpbnNwZWN0b3IvaW5kZXguanMiXSwibmFtZXMiOlsiV0VCX0lOU1BFQ1RPUl9TRVJWSUNFX05BTUUiLCJNQVhfRlJBTUVfU0laRSIsIk1CIiwiUEFSVElBTF9NRVNTQUdFX1NVUFBPUlRfREVQUkVDQVRJT05fVkVSU0lPTiIsIldlYkluc3BlY3RvclNlcnZpY2UiLCJCYXNlU2VydmljZVNvY2tldCIsImNvbnN0cnVjdG9yIiwib3B0cyIsIm1ham9yT3NWZXJzaW9uIiwiaXNTaW11bGF0b3IiLCJzb2NrZXRDaHVua1NpemUiLCJ2ZXJib3NlIiwidmVyYm9zZUhleER1bXAiLCJzb2NrZXRDbGllbnQiLCJfIiwiaXNGdW5jdGlvbiIsInNldE1heFNlbmRGcmFnbWVudCIsImlzTmlsIiwibG9nIiwiZGVidWciLCJ3YXJuIiwiX3ZlcmJvc2UiLCJfaXNTaW11bGF0b3IiLCJfbWFqb3JPc1ZlcnNpb24iLCJfaW5pdGlhbGl6ZVBhcnRpYWxNZXNzYWdlU3VwcG9ydCIsIl9pbml0aWFsaXplRnVsbE1lc3NhZ2VTdXBwb3J0IiwiX2RlY29kZXIiLCJQbGlzdFNlcnZpY2VEZWNvZGVyIiwiX3NvY2tldENsaWVudCIsInBpcGUiLCJTdHJlYW1Mb2dnZXIiLCJSRUNFSVZFIiwiX3NwbGl0dGVyIiwiTGVuZ3RoQmFzZWRTcGxpdHRlciIsInJlYWRhYmxlU3RyZWFtIiwibGl0dGxlRW5kaWFuIiwibWF4RnJhbWVMZW5ndGgiLCJsZW5ndGhGaWVsZE9mZnNldCIsImxlbmd0aEZpZWxkTGVuZ3RoIiwibGVuZ3RoQWRqdXN0bWVudCIsIl9lbmNvZGVyIiwiUGxpc3RTZXJ2aWNlRW5jb2RlciIsIlNFTkQiLCJXZWJJbnNwZWN0b3JEZWNvZGVyIiwiV2ViSW5zcGVjdG9yRW5jb2RlciIsInNlbmRNZXNzYWdlIiwicnBjT2JqZWN0IiwiRXJyb3IiLCJ1dGlsIiwianNvblN0cmluZ2lmeSIsIndyaXRlIiwibGlzdGVuTWVzc2FnZSIsIm9uRGF0YSIsIm9uIiwiZGF0YSJd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LE1BQWpCLEVBQTBCQyxJQUFELElBQVU7QUFDakMsVUFBSSxLQUFLakMsUUFBVCxFQUFtQjtBQUNqQkgsd0JBQUlDLEtBQUosQ0FBVSxzQ0FBVjs7QUFDQUQsd0JBQUlDLEtBQUosQ0FBVTZCLG9CQUFLQyxhQUFMLENBQW1CSyxJQUFuQixDQUFWO0FBQ0Q7O0FBQ0RGLE1BQUFBLE1BQU0sQ0FBQ0UsSUFBRCxDQUFOO0FBQ0QsS0FORDtBQU9EOztBQTNJaUQ7OztlQStJckNsRCxtQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBXZWJJbnNwZWN0b3JEZWNvZGVyIGZyb20gJy4vdHJhbnNmb3JtZXIvd2ViaW5zcGVjdG9yLWRlY29kZXInO1xuaW1wb3J0IFdlYkluc3BlY3RvckVuY29kZXIgZnJvbSAnLi90cmFuc2Zvcm1lci93ZWJpbnNwZWN0b3ItZW5jb2Rlcic7XG5pbXBvcnQgUGxpc3RTZXJ2aWNlRGVjb2RlciBmcm9tICcuLi9wbGlzdC1zZXJ2aWNlL3RyYW5zZm9ybWVyL3BsaXN0LXNlcnZpY2UtZGVjb2Rlcic7XG5pbXBvcnQgUGxpc3RTZXJ2aWNlRW5jb2RlciBmcm9tICcuLi9wbGlzdC1zZXJ2aWNlL3RyYW5zZm9ybWVyL3BsaXN0LXNlcnZpY2UtZW5jb2Rlcic7XG5pbXBvcnQgTGVuZ3RoQmFzZWRTcGxpdHRlciBmcm9tICcuLi91dGlsL3RyYW5zZm9ybWVyL2xlbmd0aC1iYXNlZC1zcGxpdHRlcic7XG5pbXBvcnQgU3RyZWFtTG9nZ2VyIGZyb20gJy4uL3V0aWwvdHJhbnNmb3JtZXIvc3RyZWFtLWxvZ2dlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IE1CIH0gZnJvbSAnLi4vY29uc3RhbnRzJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IEJhc2VTZXJ2aWNlU29ja2V0IH0gZnJvbSAnLi4vYmFzZS1zZXJ2aWNlJztcblxuXG5jb25zdCBXRUJfSU5TUEVDVE9SX1NFUlZJQ0VfTkFNRSA9ICdjb20uYXBwbGUud2ViaW5zcGVjdG9yJztcbmNvbnN0IE1BWF9GUkFNRV9TSVpFID0gMjAgKiBNQjtcblxuY29uc3QgUEFSVElBTF9NRVNTQUdFX1NVUFBPUlRfREVQUkVDQVRJT05fVkVSU0lPTiA9IDExO1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFdlYkluc3BlY3RvclNlcnZpY2VPcHRpb25zXG4gKlxuICogQHByb3BlcnR5IHtudW1iZXJ9IG1ham9yT3NWZXJzaW9uIFRoZSBtYWpvciB2ZXJzaW9uIG9mIHRoZSBvcyB2ZXJzaW9uXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzU2ltdWxhdG9yIFdoZXRoZXIgdGhlIGRldmljZSBpcyBhIHNpbXVsYXRvclxuICogQHByb3BlcnR5IHs/bnVtYmVyfSBzb2NrZXRDaHVua1NpemUgU2l6ZSwgaW4gYnl0ZXMgb2YgdGhlIGNodW5rcyB0byBzZW5kIHRvXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWFsIGRldmljZSAob25seSBpT1MgMTErKS4gRGVmYXVsdHMgdG9cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDE2Mzg0IGJ5dGVzICh0aGUgVExTU29ja2V0IG1heCkuXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IHZlcmJvc2UgVHVybiBvbiBsb2dnaW5nIG9mIGVhY2ggbWVzc2FnZSBzZW50IG9yIHJlY2VpdmVkLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgIERlZmF1bHRzIHRvIGZhbHNlXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IHZlcmJvc2VIZXhEdW1wIFR1cm4gb24gbG9nZ2luZyBvZiBfYWxsXyBjb21tdW5pY2F0aW9uIGFzXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhleCBkdW1wLiBEZWZhdWx0cyB0byBmYWxzZVxuICogQHByb3BlcnR5IHsqfSBzb2NrZXRDbGllbnQgVGhlIHNvY2tldCBjbGllbnQgd2hlcmUgdGhlIGNvbW11bmljYXRpb24gd2lsbCBoYXBwZW5cbiAqL1xuXG5jbGFzcyBXZWJJbnNwZWN0b3JTZXJ2aWNlIGV4dGVuZHMgQmFzZVNlcnZpY2VTb2NrZXQge1xuICAvKipcbiAgICogVGhlIG1haW4gc2VydmljZSBmb3IgY29tbXVuaWNhdGlvbiB3aXRoIHRoZSB3ZWJpbnNwZWN0b3JkXG4gICAqXG4gICAqIEBwYXJhbSB7V2ViSW5zcGVjdG9yU2VydmljZU9wdGlvbnN9XG4gICAqL1xuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7XG4gICAgY29uc3Qge1xuICAgICAgbWFqb3JPc1ZlcnNpb24sXG4gICAgICBpc1NpbXVsYXRvciA9IGZhbHNlLFxuICAgICAgc29ja2V0Q2h1bmtTaXplLFxuICAgICAgdmVyYm9zZSA9IGZhbHNlLFxuICAgICAgdmVyYm9zZUhleER1bXAgPSBmYWxzZSxcbiAgICAgIHNvY2tldENsaWVudCxcbiAgICB9ID0gb3B0cztcblxuICAgIHN1cGVyKHNvY2tldENsaWVudCk7XG5cbiAgICAvLyBzZXQgdGhlIGxhcmdlc3QgZnJhZ21lbnQgc2l6ZSBmb3IgdGhlIHNvY2tldCwgaWYgdGhlIG9wdGlvbiBpcyB0aGVyZVxuICAgIGlmIChfLmlzRnVuY3Rpb24oc29ja2V0Q2xpZW50LnNldE1heFNlbmRGcmFnbWVudCkgJiYgIV8uaXNOaWwoc29ja2V0Q2h1bmtTaXplKSAmJiBzb2NrZXRDaHVua1NpemUgPiAwKSB7XG4gICAgICBpZiAoc29ja2V0Q2xpZW50LnNldE1heFNlbmRGcmFnbWVudChzb2NrZXRDaHVua1NpemUpKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgTWF4aW11bSBUTFMgZnJhZ21lbnQgc2l6ZSBzZXQgdG8gJyR7c29ja2V0Q2h1bmtTaXplfSdgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIGFueXRoaW5nIG92ZXIgdGhlIF9hY3R1YWxfIG1heGltdW0gd2lsbCBmYWlsLCBhbmQgdGhpbmdzIHdpbGwgcmVtYWluIHRoZSBzYW1lXG4gICAgICAgIGxvZy53YXJuKGBVbmFibGUgdG8gc2V0IFRMUyBmcmFnbWVudCBzaXplIHRvICcke3NvY2tldENodW5rU2l6ZX0nYCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy5fdmVyYm9zZSA9IHZlcmJvc2U7XG4gICAgdGhpcy5faXNTaW11bGF0b3IgPSBpc1NpbXVsYXRvcjtcbiAgICB0aGlzLl9tYWpvck9zVmVyc2lvbiA9IG1ham9yT3NWZXJzaW9uO1xuXG4gICAgaWYgKCFpc1NpbXVsYXRvciAmJiBtYWpvck9zVmVyc2lvbiA8IFBBUlRJQUxfTUVTU0FHRV9TVVBQT1JUX0RFUFJFQ0FUSU9OX1ZFUlNJT04pIHtcbiAgICAgIHRoaXMuX2luaXRpYWxpemVQYXJ0aWFsTWVzc2FnZVN1cHBvcnQodmVyYm9zZUhleER1bXApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9pbml0aWFsaXplRnVsbE1lc3NhZ2VTdXBwb3J0KHZlcmJvc2VIZXhEdW1wKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogSW50aWFsaXplcyB0aGUgZGF0YSBmbG93IGZvciBpT1MgMTErLlxuICAgKlxuICAgKiBAcGFyYW0ge2Jvb2xlYW59IHZlcmJvc2UgLSB3aGV0aGVyIHRvIHByaW50IG91dCB0aGUgaGV4IGR1bXAgZm9yIGNvbW11bmljYXRpb25cbiAgICovXG4gIF9pbml0aWFsaXplRnVsbE1lc3NhZ2VTdXBwb3J0ICh2ZXJib3NlKSB7XG4gICAgdGhpcy5fZGVjb2RlciA9IG5ldyBQbGlzdFNlcnZpY2VEZWNvZGVyKCk7XG4gICAgdGhpcy5fc29ja2V0Q2xpZW50XG4gICAgICAvLyBsb2cgZmlyc3QsIGluIGNhc2UgdGhlcmUgaXMgYSBwcm9ibGVtIGluIHByb2Nlc3NpbmdcbiAgICAgIC5waXBlKG5ldyBTdHJlYW1Mb2dnZXIoU3RyZWFtTG9nZ2VyLlJFQ0VJVkUsIHZlcmJvc2UpKVxuICAgICAgLnBpcGUodGhpcy5fc3BsaXR0ZXIgPSBuZXcgTGVuZ3RoQmFzZWRTcGxpdHRlcih7XG4gICAgICAgIHJlYWRhYmxlU3RyZWFtOiB0aGlzLl9zb2NrZXRDbGllbnQsXG4gICAgICAgIGxpdHRsZUVuZGlhbjogZmFsc2UsXG4gICAgICAgIG1heEZyYW1lTGVuZ3RoOiBNQVhfRlJBTUVfU0laRSxcbiAgICAgICAgbGVuZ3RoRmllbGRPZmZzZXQ6IDAsXG4gICAgICAgIGxlbmd0aEZpZWxkTGVuZ3RoOiA0LFxuICAgICAgICBsZW5ndGhBZGp1c3RtZW50OiA0LFxuICAgICAgfSkpXG4gICAgICAucGlwZSh0aGlzLl9kZWNvZGVyKTtcblxuICAgIHRoaXMuX2VuY29kZXIgPSBuZXcgUGxpc3RTZXJ2aWNlRW5jb2RlcigpO1xuICAgIHRoaXMuX2VuY29kZXJcbiAgICAgIC5waXBlKG5ldyBTdHJlYW1Mb2dnZXIoU3RyZWFtTG9nZ2VyLlNFTkQsIHZlcmJvc2UpKVxuICAgICAgLnBpcGUodGhpcy5fc29ja2V0Q2xpZW50KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbnRpYWxpemVzIHRoZSBkYXRhIGZsb3cgZm9yIGlPUyA8IDExLCB3aGVyZSBkYXRhIGlzIHNlcGFyYXRlZCBpbnRvIHBhcnRpYWxcbiAgICogbWVzc2FnZXMgYmVmb3JlIHNlbmRpbmcuXG4gICAqXG4gICAqIEBwYXJhbSB7Ym9vbGVhbn0gdmVyYm9zZSAtIHdoZXRoZXIgdG8gcHJpbnQgb3V0IHRoZSBoZXggZHVtcCBmb3IgY29tbXVuaWNhdGlvblxuICAgKi9cbiAgX2luaXRpYWxpemVQYXJ0aWFsTWVzc2FnZVN1cHBvcnQgKHZlcmJvc2UpIHtcbiAgICAvLyAxTUIgYXMgYnVmZmVyIGZvciBidWxkaW5nIHdlYmluc3BlY3RvciBmdWxsIG1lc3NhZ2VzLiBXZSBjYW4gaW5jcmVhc2UgdGhlIHZhbHVlIGlmIG1vcmUgYnVmZmVyIGlzIG5lZWRlZFxuICAgIHRoaXMuX2RlY29kZXIgPSBuZXcgV2ViSW5zcGVjdG9yRGVjb2RlcihNQik7XG4gICAgdGhpcy5fc29ja2V0Q2xpZW50XG4gICAgICAvLyBsb2cgZmlyc3QsIGluIGNhc2UgdGhlcmUgaXMgYSBwcm9ibGVtIGluIHByb2Nlc3NpbmdcbiAgICAgIC5waXBlKG5ldyBTdHJlYW1Mb2dnZXIoU3RyZWFtTG9nZ2VyLlJFQ0VJVkUsIHZlcmJvc2UpKVxuICAgICAgLnBpcGUodGhpcy5fc3BsaXR0ZXIgPSBuZXcgTGVuZ3RoQmFzZWRTcGxpdHRlcih7XG4gICAgICAgIHJlYWRhYmxlU3RyZWFtOiB0aGlzLl9zb2NrZXRDbGllbnQsXG4gICAgICAgIGxpdHRsZUVuZGlhbjogZmFsc2UsXG4gICAgICAgIG1heEZyYW1lTGVuZ3RoOiBNQVhfRlJBTUVfU0laRSxcbiAgICAgICAgbGVuZ3RoRmllbGRPZmZzZXQ6IDAsXG4gICAgICAgIGxlbmd0aEZpZWxkTGVuZ3RoOiA0LFxuICAgICAgICBsZW5ndGhBZGp1c3RtZW50OiA0LFxuICAgICAgfSkpXG4gICAgICAucGlwZShuZXcgUGxpc3RTZXJ2aWNlRGVjb2RlcigpKVxuICAgICAgLnBpcGUodGhpcy5fZGVjb2Rlcik7XG5cbiAgICB0aGlzLl9lbmNvZGVyID0gbmV3IFdlYkluc3BlY3RvckVuY29kZXIoKTtcbiAgICB0aGlzLl9lbmNvZGVyXG4gICAgICAucGlwZShuZXcgUGxpc3RTZXJ2aWNlRW5jb2RlcigpKVxuICAgICAgLnBpcGUobmV3IFN0cmVhbUxvZ2dlcihTdHJlYW1Mb2dnZXIuU0VORCwgdmVyYm9zZSkpXG4gICAgICAucGlwZSh0aGlzLl9zb2NrZXRDbGllbnQpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNlbmRzIGFuIG9iamVjdCB0byB0aGUgd2ViaW5zcGVjdG9yZCBzb2NrZXRcbiAgICogQHBhcmFtIHtPYmplY3R9IHJwY09iamVjdCBUaGUgb2JqZWN0IHRoYXQgd2lsbCBiZSBzZW50XG4gICAqIEB0aHJvd3MgV2lsbCB0aHJvdyBhbiBlcnJvciB3aGVuIHRoZSBvYmplY3QgaXMgbnVsbCBvciB1bmRlZmluZWRcbiAgICovXG4gIHNlbmRNZXNzYWdlIChycGNPYmplY3QpIHtcbiAgICBpZiAoXy5pc05pbChycGNPYmplY3QpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBzZW5kIGEgbnVsbCBvYmplY3QnKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5fdmVyYm9zZSkge1xuICAgICAgbG9nLmRlYnVnKCdTZW5kaW5nIG1lc3NhZ2UgdG8gV2ViIEluc3BlY3RvcjonKTtcbiAgICAgIGxvZy5kZWJ1Zyh1dGlsLmpzb25TdHJpbmdpZnkocnBjT2JqZWN0KSk7XG4gICAgfVxuXG4gICAgdGhpcy5fZW5jb2Rlci53cml0ZShycGNPYmplY3QpO1xuXG4gICAgLy8gd3JpdGUgYW4gZW1wdHkgbWVzc2FnZSwgd2hpY2ggb24gcmVhbCBkZXZpY2VzIGVuc3VyZXMgdGhlIGFjdHVhbCBtZXNzYWdlXG4gICAgLy8gZ2V0cyBzZW50IHRvIHRoZSBkZXZpY2UuIHdpdGhvdXQgdGhpcyBpdCB3aWxsIHBlcmlvZGljYWxseSBoYW5nIHdpdGhcbiAgICAvLyBub3RoaW5nIHNlbnRcbiAgICAvLyBob3dldmVyLCB0aGlzIGNhdXNlcyB3ZWJpbnNwZWN0b3JkIHRvIGNyYXNoIG9uIGRldmljZXMgcnVubmluZyBpT1MgMTBcbiAgICBpZiAoIXRoaXMuX2lzU2ltdWxhdG9yICYmIHRoaXMuX21ham9yT3NWZXJzaW9uID49IFBBUlRJQUxfTUVTU0FHRV9TVVBQT1JUX0RFUFJFQ0FUSU9OX1ZFUlNJT04pIHtcbiAgICAgIHRoaXMuX2VuY29kZXIud3JpdGUoJyAnKTtcbiAgICB9XG4gIH1cblxuICAvKiogVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHdoaWNoIHdpbGwgYmUgY2FsbGVkIGR1cmluZyBtZXNzYWdlIGxpc3RlbmluZ1xuICAgKiBAbmFtZSBNZXNzYWdlQ2FsbGJhY2tcbiAgICogQGZ1bmN0aW9uXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIHJwYyBvYmplY3QgdGhhdCBpcyBzZW50IGZyb20gdGhlIHdlYmluc3BlY3RvcmRcbiAgKi9cblxuICAvKipcbiAgICogTGlzdGVuIHRvIG1lc3NhZ2VzIGNvbWluZyBmcm9tIHdlYmluc3BlY3RvcmRcbiAgICogQHBhcmFtIHtNZXNzYWdlQ2FsbGJhY2t9IGNhbGxiYWNrXG4gICAqL1xuICBsaXN0ZW5NZXNzYWdlIChvbkRhdGEpIHtcbiAgICB0aGlzLl9kZWNvZGVyLm9uKCdkYXRhJywgKGRhdGEpID0+IHtcbiAgICAgIGlmICh0aGlzLl92ZXJib3NlKSB7XG4gICAgICAgIGxvZy5kZWJ1ZygnUmVjZWl2ZWQgbWVzc2FnZSBmcm9tIFdlYiBJbnNwZWN0b3I6Jyk7XG4gICAgICAgIGxvZy5kZWJ1Zyh1dGlsLmpzb25TdHJpbmdpZnkoZGF0YSkpO1xuICAgICAgfVxuICAgICAgb25EYXRhKGRhdGEpO1xuICAgIH0pO1xuICB9XG59XG5cbmV4cG9ydCB7IFdlYkluc3BlY3RvclNlcnZpY2UsIFdFQl9JTlNQRUNUT1JfU0VSVklDRV9OQU1FIH07XG5leHBvcnQgZGVmYXVsdCBXZWJJbnNwZWN0b3JTZXJ2aWNlO1xuIl0sImZpbGUiOiJsaWIvd2ViaW5zcGVjdG9yL2luZGV4LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
