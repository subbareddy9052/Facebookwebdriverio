"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.configureApp = configureApp;
exports.isPackageOrBundle = isPackageOrBundle;
exports.getCoordDefault = getCoordDefault;
exports.getSwipeTouchDuration = getSwipeTouchDuration;
exports.duplicateKeys = duplicateKeys;
exports.parseCapsArray = parseCapsArray;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _url = _interopRequireDefault(require("url"));

var _logger = _interopRequireDefault(require("./logger"));

var _fs2 = _interopRequireDefault(require("fs"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _appiumSupport = require("appium-support");

var _request = _interopRequireDefault(require("request"));

var _requestPromise = _interopRequireDefault(require("request-promise"));

var _lruCache = _interopRequireDefault(require("lru-cache"));

var _asyncLock = _interopRequireDefault(require("async-lock"));

var _sanitizeFilename = _interopRequireDefault(require("sanitize-filename"));

const ZIP_EXTS = ['.zip', '.ipa'];
const ZIP_MIME_TYPES = ['application/zip', 'application/x-zip-compressed', 'multipart/x-zip'];
const CACHED_APPS_MAX_AGE = 1000 * 60 * 60 * 24;
const APPLICATIONS_CACHE = new _lruCache.default({
  maxAge: CACHED_APPS_MAX_AGE,
  updateAgeOnGet: true,
  dispose: async (app, {
    fullPath
  }) => {
    if (!(await _appiumSupport.fs.exists(fullPath))) {
      return;
    }

    _logger.default.info(`The application '${app}' cached at '${fullPath}' has expired`);

    await _appiumSupport.fs.rimraf(fullPath);
  },
  noDisposeOnSet: true
});
const APPLICATIONS_CACHE_GUARD = new _asyncLock.default();
const SANITIZE_REPLACEMENT = '-';
const DEFAULT_BASENAME = 'appium-app';
process.on('exit', () => {
  if (!APPLICATIONS_CACHE.length) {
    return;
  }

  const appPaths = APPLICATIONS_CACHE.values().map(({
    fullPath
  }) => fullPath);

  _logger.default.debug(`Performing cleanup of ${appPaths.length} cached ` + `${_appiumSupport.util.pluralize('application', appPaths.length)}`);

  for (const appPath of appPaths) {
    try {
      _appiumSupport.fs.rimrafSync(appPath);
    } catch (e) {
      _logger.default.warn(e.message);
    }
  }
});

async function retrieveHeaders(link) {
  try {
    const response = await (0, _requestPromise.default)({
      url: link,
      method: 'HEAD',
      resolveWithFullResponse: true,
      timeout: 5000
    });
    return response.headers;
  } catch (e) {
    _logger.default.debug(`Cannot send HEAD request to '${link}'. Original error: ${e.message}`);
  }

  return {};
}

function getCachedApplicationPath(link, currentModified) {
  if (!APPLICATIONS_CACHE.has(link) || !currentModified) {
    return null;
  }

  const {
    lastModified,
    fullPath
  } = APPLICATIONS_CACHE.get(link);

  if (lastModified && currentModified.getTime() <= lastModified.getTime()) {
    return fullPath;
  }

  _logger.default.debug(`'Last-Modified' timestamp of '${link}' has been updated. ` + `A fresh copy of the application is going to be downloaded.`);

  return null;
}

function verifyAppExtension(app, supportedAppExtensions) {
  if (supportedAppExtensions.includes(_path.default.extname(app))) {
    return app;
  }

  throw new Error(`New app path '${app}' did not have extension(s) '${supportedAppExtensions}'`);
}

async function configureApp(app, supportedAppExtensions) {
  if (!_lodash.default.isString(app)) {
    return;
  }

  if (!_lodash.default.isArray(supportedAppExtensions)) {
    supportedAppExtensions = [supportedAppExtensions];
  }

  let newApp = app;
  let shouldUnzipApp = false;
  let archiveHash = null;
  let currentModified = null;

  const {
    protocol,
    pathname
  } = _url.default.parse(newApp);

  const isUrl = ['http:', 'https:'].includes(protocol);
  return await APPLICATIONS_CACHE_GUARD.acquire(app, async () => {
    if (isUrl) {
      _logger.default.info(`Using downloadable app '${newApp}'`);

      const headers = await retrieveHeaders(newApp);

      if (headers['last-modified']) {
        _logger.default.debug(`App Last-Modified: ${headers['last-modified']}`);

        currentModified = new Date(headers['last-modified']);
      }

      const cachedPath = getCachedApplicationPath(app, currentModified);

      if (cachedPath) {
        if (await _appiumSupport.fs.exists(cachedPath)) {
          _logger.default.info(`Reusing previously downloaded application at '${cachedPath}'`);

          return verifyAppExtension(cachedPath, supportedAppExtensions);
        }

        _logger.default.info(`The application at '${cachedPath}' does not exist anymore. Deleting it from the cache`);

        APPLICATIONS_CACHE.del(app);
      }

      let fileName = null;
      const basename = (0, _sanitizeFilename.default)(_path.default.basename(decodeURIComponent(pathname)), {
        replacement: SANITIZE_REPLACEMENT
      });

      const extname = _path.default.extname(basename);

      if (ZIP_EXTS.includes(extname)) {
        fileName = basename;
        shouldUnzipApp = true;
      }

      if (headers['content-type']) {
        _logger.default.debug(`Content-Type: ${headers['content-type']}`);

        if (ZIP_MIME_TYPES.some(mimeType => new RegExp(`\\b${_lodash.default.escapeRegExp(mimeType)}\\b`).test(headers['content-type']))) {
          if (!fileName) {
            fileName = `${DEFAULT_BASENAME}.zip`;
          }

          shouldUnzipApp = true;
        }
      }

      if (headers['content-disposition'] && /^attachment/i.test(headers['content-disposition'])) {
        _logger.default.debug(`Content-Disposition: ${headers['content-disposition']}`);

        const match = /filename="([^"]+)/i.exec(headers['content-disposition']);

        if (match) {
          fileName = (0, _sanitizeFilename.default)(match[1], {
            replacement: SANITIZE_REPLACEMENT
          });
          shouldUnzipApp = shouldUnzipApp || ZIP_EXTS.includes(_path.default.extname(fileName));
        }
      }

      if (!fileName) {
        const resultingName = basename ? basename.substring(0, basename.length - extname.length) : DEFAULT_BASENAME;
        let resultingExt = extname;

        if (!supportedAppExtensions.includes(resultingExt)) {
          _logger.default.info(`The current file extension '${resultingExt}' is not supported. ` + `Defaulting to '${_lodash.default.first(supportedAppExtensions)}'`);

          resultingExt = _lodash.default.first(supportedAppExtensions);
        }

        fileName = `${resultingName}${resultingExt}`;
      }

      const targetPath = await _appiumSupport.tempDir.path({
        prefix: fileName,
        suffix: ''
      });
      newApp = await downloadApp(newApp, targetPath);
    } else if (await _appiumSupport.fs.exists(newApp)) {
      _logger.default.info(`Using local app '${newApp}'`);

      shouldUnzipApp = ZIP_EXTS.includes(_path.default.extname(newApp));
    } else {
      let errorMessage = `The application at '${newApp}' does not exist or is not accessible`;

      if (_lodash.default.isString(protocol) && protocol.length > 2) {
        errorMessage = `The protocol '${protocol}' used in '${newApp}' is not supported. ` + `Only http: and https: protocols are supported`;
      }

      throw new Error(errorMessage);
    }

    if (shouldUnzipApp) {
      const archivePath = newApp;
      archiveHash = await _appiumSupport.fs.hash(archivePath);

      if (APPLICATIONS_CACHE.has(app) && archiveHash === APPLICATIONS_CACHE.get(app).hash) {
        const {
          fullPath
        } = APPLICATIONS_CACHE.get(app);

        if (await _appiumSupport.fs.exists(fullPath)) {
          if (archivePath !== app) {
            await _appiumSupport.fs.rimraf(archivePath);
          }

          _logger.default.info(`Will reuse previously cached application at '${fullPath}'`);

          return verifyAppExtension(fullPath, supportedAppExtensions);
        }

        _logger.default.info(`The application at '${fullPath}' does not exist anymore. Deleting it from the cache`);

        APPLICATIONS_CACHE.del(app);
      }

      const tmpRoot = await _appiumSupport.tempDir.openDir();

      try {
        newApp = await unzipApp(archivePath, tmpRoot, supportedAppExtensions);
      } finally {
        if (newApp !== archivePath && archivePath !== app) {
          await _appiumSupport.fs.rimraf(archivePath);
        }
      }

      _logger.default.info(`Unzipped local app to '${newApp}'`);
    } else if (!_path.default.isAbsolute(newApp)) {
      newApp = _path.default.resolve(process.cwd(), newApp);

      _logger.default.warn(`The current application path '${app}' is not absolute ` + `and has been rewritten to '${newApp}'. Consider using absolute paths rather than relative`);

      app = newApp;
    }

    verifyAppExtension(newApp, supportedAppExtensions);

    if (app !== newApp && (archiveHash || currentModified)) {
      if (APPLICATIONS_CACHE.has(app)) {
        const {
          fullPath
        } = APPLICATIONS_CACHE.get(app);

        if (fullPath !== newApp && (await _appiumSupport.fs.exists(fullPath))) {
          await _appiumSupport.fs.rimraf(fullPath);
        }
      }

      APPLICATIONS_CACHE.set(app, {
        hash: archiveHash,
        lastModified: currentModified,
        fullPath: newApp
      });
    }

    return newApp;
  });
}

async function downloadApp(app, targetPath) {
  const {
    href
  } = _url.default.parse(app);

  const timer = new _appiumSupport.timing.Timer().start();

  try {
    await new _bluebird.default((resolve, reject) => {
      (0, _request.default)(href).on('error', reject).on('response', res => {
        if (res.statusCode >= 400) {
          return reject(new Error(`${res.statusCode} - ${res.statusMessage}`));
        }
      }).pipe(_fs2.default.createWriteStream(targetPath)).on('close', resolve);
    });
  } catch (err) {
    throw new Error(`Problem downloading app from url ${href}: ${err.message}`);
  }

  const secondsElapsed = timer.getDuration().asSeconds;
  const {
    size
  } = await _appiumSupport.fs.stat(targetPath);

  _logger.default.debug(`'${href}' (${_appiumSupport.util.toReadableSizeString(size)}) ` + `has been downloaded to '${targetPath}' in ${secondsElapsed.toFixed(3)}s`);

  if (secondsElapsed >= 2) {
    const bytesPerSec = Math.floor(size / secondsElapsed);

    _logger.default.debug(`Approximate download speed: ${_appiumSupport.util.toReadableSizeString(bytesPerSec)}/s`);
  }

  return targetPath;
}

async function unzipApp(zipPath, dstRoot, supportedAppExtensions) {
  await _appiumSupport.zip.assertValidZip(zipPath);

  if (!_lodash.default.isArray(supportedAppExtensions)) {
    supportedAppExtensions = [supportedAppExtensions];
  }

  const tmpRoot = await _appiumSupport.tempDir.openDir();

  try {
    _logger.default.debug(`Unzipping '${zipPath}'`);

    await _appiumSupport.zip.extractAllTo(zipPath, tmpRoot);
    const allExtractedItems = [];
    await _appiumSupport.fs.walkDir(tmpRoot, true, itemPath => void allExtractedItems.push(itemPath));

    _logger.default.debug(`Extracted ${allExtractedItems.length} item(s) from '${zipPath}'`);

    const isSupportedAppItem = relativePath => supportedAppExtensions.includes(_path.default.extname(relativePath)) || _lodash.default.some(supportedAppExtensions, x => relativePath.includes(`${x}${_path.default.sep}`));

    const itemsToKeep = allExtractedItems.map(itemPath => _path.default.relative(tmpRoot, itemPath)).filter(relativePath => isSupportedAppItem(relativePath)).map(relativePath => _path.default.resolve(tmpRoot, relativePath));

    const itemsToRemove = _lodash.default.difference(allExtractedItems, itemsToKeep).filter(itemToRemovePath => !_lodash.default.some(itemsToKeep, itemToKeepPath => itemToKeepPath.startsWith(itemToRemovePath)));

    await _bluebird.default.all(itemsToRemove, async itemPath => {
      if (await _appiumSupport.fs.exists(itemPath)) {
        await _appiumSupport.fs.rimraf(itemPath);
      }
    });
    let allBundleItems = [];
    await _appiumSupport.fs.walkDir(tmpRoot, true, itemPath => void allBundleItems.push(itemPath));
    allBundleItems = allBundleItems.map(itemPath => _path.default.relative(tmpRoot, itemPath)).filter(relativePath => isSupportedAppItem(relativePath)).sort((a, b) => a.split(_path.default.sep).length - b.split(_path.default.sep).length);

    if (_lodash.default.isEmpty(allBundleItems)) {
      throw new Error(`App zip unzipped OK, but we could not find ${supportedAppExtensions} bundle(s) ` + `in it. Make sure your archive contains ${supportedAppExtensions} package(s) ` + `and nothing else`);
    }

    const matchedBundle = _lodash.default.first(allBundleItems);

    _logger.default.debug(`Matched ${allBundleItems.length} item(s) in the extracted archive. ` + `Assuming '${matchedBundle}' is the correct bundle`);

    await _appiumSupport.fs.mv(_path.default.resolve(tmpRoot, matchedBundle), _path.default.resolve(dstRoot, matchedBundle), {
      mkdirp: true
    });
    return _path.default.resolve(dstRoot, matchedBundle);
  } finally {
    await _appiumSupport.fs.rimraf(tmpRoot);
  }
}

function isPackageOrBundle(app) {
  return /^([a-zA-Z0-9\-_]+\.[a-zA-Z0-9\-_]+)+$/.test(app);
}

function getCoordDefault(val) {
  return _appiumSupport.util.hasValue(val) ? val : 0.5;
}

function getSwipeTouchDuration(waitGesture) {
  let duration = 0.8;

  if (typeof waitGesture.options.ms !== 'undefined' && waitGesture.options.ms) {
    duration = waitGesture.options.ms / 1000;

    if (duration === 0) {
      duration = 0.1;
    }
  }

  return duration;
}

function duplicateKeys(input, firstKey, secondKey) {
  if (_lodash.default.isArray(input)) {
    return input.map(item => duplicateKeys(item, firstKey, secondKey));
  }

  if (_lodash.default.isPlainObject(input)) {
    const resultObj = {};

    for (let [key, value] of _lodash.default.toPairs(input)) {
      const recursivelyCalledValue = duplicateKeys(value, firstKey, secondKey);

      if (key === firstKey) {
        resultObj[secondKey] = recursivelyCalledValue;
      } else if (key === secondKey) {
        resultObj[firstKey] = recursivelyCalledValue;
      }

      resultObj[key] = recursivelyCalledValue;
    }

    return resultObj;
  }

  return input;
}

function parseCapsArray(cap) {
  if (_lodash.default.isArray(cap)) {
    return cap;
  }

  let parsedCaps;

  try {
    parsedCaps = JSON.parse(cap);

    if (_lodash.default.isArray(parsedCaps)) {
      return parsedCaps;
    }
  } catch (ign) {
    _logger.default.warn(`Failed to parse capability as JSON array`);
  }

  if (_lodash.default.isString(cap)) {
    return [cap];
  }

  throw new Error(`must provide a string or JSON Array; received ${cap}`);
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2hlbHBlcnMuanMiXSwibmFtZXMiOlsiWklQX0VYVFMiLCJaSVBfTUlNRV9UWVBFUyIsIkNBQ0hFRF9BUFBTX01BWF9BR0UiLCJBUFBMSUNBVElPTlNfQ0FDSEUiLCJMUlUiLCJtYXhBZ2UiLCJ1cGRhdGVBZ2VPbkdldCIsImRpc3Bvc2UiLCJhcHAiLCJmdWxsUGF0aCIsImZzIiwiZXhpc3RzIiwibG9nZ2VyIiwiaW5mbyIsInJpbXJhZiIsIm5vRGlzcG9zZU9uU2V0IiwiQVBQTElDQVRJT05TX0NBQ0hFX0dVQVJEIiwiQXN5bmNMb2NrIiwiU0FOSVRJWkVfUkVQTEFDRU1FTlQiLCJERUZBVUxUX0JBU0VOQU1FIiwicHJvY2VzcyIsIm9uIiwibGVuZ3RoIiwiYXBwUGF0aHMiLCJ2YWx1ZXMiLCJtYXAiLCJkZWJ1ZyIsInV0aWwiLCJwbHVyYWxpemUiLCJhcHBQYXRoIiwicmltcmFmU3luYyIsImUiLCJ3YXJuIiwibWVzc2FnZSIsInJldHJpZXZlSGVhZGVycyIsImxpbmsiLCJyZXNwb25zZSIsInVybCIsIm1ldGhvZCIsInJlc29sdmVXaXRoRnVsbFJlc3BvbnNlIiwidGltZW91dCIsImhlYWRlcnMiLCJnZXRDYWNoZWRBcHBsaWNhdGlvblBhdGgiLCJjdXJyZW50TW9kaWZpZWQiLCJoYXMiLCJsYXN0TW9kaWZpZWQiLCJnZXQiLCJnZXRUaW1lIiwidmVyaWZ5QXBwRXh0ZW5zaW9uIiwic3VwcG9ydGVkQXBwRXh0ZW5zaW9ucyIsImluY2x1ZGVzIiwicGF0aCIsImV4dG5hbWUiLCJFcnJvciIsImNvbmZpZ3VyZUFwcCIsIl8iLCJpc1N0cmluZyIsImlzQXJyYXkiLCJuZXdBcHAiLCJzaG91bGRVbnppcEFwcCIsImFyY2hpdmVIYXNoIiwicHJvdG9jb2wiLCJwYXRobmFtZSIsInBhcnNlIiwiaXNVcmwiLCJhY3F1aXJlIiwiRGF0ZSIsImNhY2hlZFBhdGgiLCJkZWwiLCJmaWxlTmFtZSIsImJhc2VuYW1lIiwiZGVjb2RlVVJJQ29tcG9uZW50IiwicmVwbGFjZW1lbnQiLCJzb21lIiwibWltZVR5cGUiLCJSZWdFeHAiLCJlc2NhcGVSZWdFeHAiLCJ0ZXN0IiwibWF0Y2giLCJleGVjIiwicmVzdWx0aW5nTmFtZSIsInN1YnN0cmluZyIsInJlc3VsdGluZ0V4dCIsImZpcnN0IiwidGFyZ2V0UGF0aCIsInRlbXBEaXIiLCJwcmVmaXgiLCJzdWZmaXgiLCJkb3dubG9hZEFwcCIsImVycm9yTWVzc2FnZSIsImFyY2hpdmVQYXRoIiwiaGFzaCIsInRtcFJvb3QiLCJvcGVuRGlyIiwidW56aXBBcHAiLCJpc0Fic29sdXRlIiwicmVzb2x2ZSIsImN3ZCIsInNldCIsImhyZWYiLCJ0aW1lciIsInRpbWluZyIsIlRpbWVyIiwic3RhcnQiLCJCIiwicmVqZWN0IiwicmVzIiwic3RhdHVzQ29kZSIsInN0YXR1c01lc3NhZ2UiLCJwaXBlIiwiX2ZzIiwiY3JlYXRlV3JpdGVTdHJlYW0iLCJlcnIiLCJzZWNvbmRzRWxhcHNlZCIsImdldER1cmF0aW9uIiwiYXNTZWNvbmRzIiwic2l6ZSIsInN0YXQiLCJ0b1JlYWRhYmxlU2l6ZVN0cmluZyIsInRvRml4ZWQiLCJieXRlc1BlclNlYyIsIk1hdGgiLCJmbG9vciIsInppcFBhdGgiLCJkc3RSb290IiwiemlwIiwiYXNzZXJ0VmFsaWRaaXAiLCJleHRyYWN0QWxsVG8iLCJhbGxFeHRyYWN0ZWRJdGVtcyIsIndhbGtEaXIiLCJpdGVtUGF0aCIsInB1c2giLCJpc1N1cHBvcnRlZEFwcEl0ZW0iLCJyZWxhdGl2ZVBhdGgiLCJ4Iiwic2VwIiwiaXRlbXNUb0tlZXAiLCJyZWxhdGl2ZSIsImZpbHRlciIsIml0ZW1zVG9SZW1vdmUiLCJkaWZmZXJlbmNlIiwiaXRlbVRvUmVtb3ZlUGF0aCIsIml0ZW1Ub0tlZXBQYXRoIiwic3RhcnRzV2l0aCIsImFsbCIsImFsbEJ1bmRsZUl0ZW1zIiwic29ydCIsImEiLCJiIiwic3BsaXQiLCJpc0VtcHR5IiwibWF0Y2hlZEJ1bmRsZSIsIm12IiwibWtkaXJwIiwiaXNQYWNrYWdlT3JCdW5kbGUiLCJnZXRDb29yZERlZmF1bHQiLCJ2YWwiLCJoYXNWYWx1ZSIsImdldFN3aXBlVG91Y2hEdXJhdGlvbiIsIndhaXRHZXN0dXJlIiwiZHVyYXRpb24iLCJvcHRpb25zIiwibXMiLCJkdXBsaWNhdGVLZXlzIiwiaW5wdXQiLCJmaXJzdEtleSIsInNlY29uZEtleSIsIml0ZW0iLCJpc1BsYWluT2JqZWN0IiwicmVzdWx0T2JqIiwia2V5IiwidmFsdWUiLCJ0b1BhaXJzIiwicmVjdXJzaXZlbHlDYWxsZWRWYWx1ZSIsInBhcnNlQ2Fwc0FycmF5IiwiY2FwIiwicGFyc2VkQ2FwcyIsIkpTT04iLCJpZ24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSxRQUFRLEdBQUcsQ0FBQyxNQUFELEVBQVMsTUFBVCxDQUFqQjtBQUNBLE1BQU1DLGNBQWMsR0FBRyxDQUNyQixpQkFEcUIsRUFFckIsOEJBRnFCLEVBR3JCLGlCQUhxQixDQUF2QjtBQUtBLE1BQU1DLG1CQUFtQixHQUFHLE9BQU8sRUFBUCxHQUFZLEVBQVosR0FBaUIsRUFBN0M7QUFDQSxNQUFNQyxrQkFBa0IsR0FBRyxJQUFJQyxpQkFBSixDQUFRO0FBQ2pDQyxFQUFBQSxNQUFNLEVBQUVILG1CQUR5QjtBQUVqQ0ksRUFBQUEsY0FBYyxFQUFFLElBRmlCO0FBR2pDQyxFQUFBQSxPQUFPLEVBQUUsT0FBT0MsR0FBUCxFQUFZO0FBQUNDLElBQUFBO0FBQUQsR0FBWixLQUEyQjtBQUNsQyxRQUFJLEVBQUMsTUFBTUMsa0JBQUdDLE1BQUgsQ0FBVUYsUUFBVixDQUFQLENBQUosRUFBZ0M7QUFDOUI7QUFDRDs7QUFFREcsb0JBQU9DLElBQVAsQ0FBYSxvQkFBbUJMLEdBQUksZ0JBQWVDLFFBQVMsZUFBNUQ7O0FBQ0EsVUFBTUMsa0JBQUdJLE1BQUgsQ0FBVUwsUUFBVixDQUFOO0FBQ0QsR0FWZ0M7QUFXakNNLEVBQUFBLGNBQWMsRUFBRTtBQVhpQixDQUFSLENBQTNCO0FBYUEsTUFBTUMsd0JBQXdCLEdBQUcsSUFBSUMsa0JBQUosRUFBakM7QUFDQSxNQUFNQyxvQkFBb0IsR0FBRyxHQUE3QjtBQUNBLE1BQU1DLGdCQUFnQixHQUFHLFlBQXpCO0FBRUFDLE9BQU8sQ0FBQ0MsRUFBUixDQUFXLE1BQVgsRUFBbUIsTUFBTTtBQUN2QixNQUFJLENBQUNsQixrQkFBa0IsQ0FBQ21CLE1BQXhCLEVBQWdDO0FBQzlCO0FBQ0Q7O0FBRUQsUUFBTUMsUUFBUSxHQUFHcEIsa0JBQWtCLENBQUNxQixNQUFuQixHQUNkQyxHQURjLENBQ1YsQ0FBQztBQUFDaEIsSUFBQUE7QUFBRCxHQUFELEtBQWdCQSxRQUROLENBQWpCOztBQUVBRyxrQkFBT2MsS0FBUCxDQUFjLHlCQUF3QkgsUUFBUSxDQUFDRCxNQUFPLFVBQXpDLEdBQ1YsR0FBRUssb0JBQUtDLFNBQUwsQ0FBZSxhQUFmLEVBQThCTCxRQUFRLENBQUNELE1BQXZDLENBQStDLEVBRHBEOztBQUVBLE9BQUssTUFBTU8sT0FBWCxJQUFzQk4sUUFBdEIsRUFBZ0M7QUFDOUIsUUFBSTtBQUVGYix3QkFBR29CLFVBQUgsQ0FBY0QsT0FBZDtBQUNELEtBSEQsQ0FHRSxPQUFPRSxDQUFQLEVBQVU7QUFDVm5CLHNCQUFPb0IsSUFBUCxDQUFZRCxDQUFDLENBQUNFLE9BQWQ7QUFDRDtBQUNGO0FBQ0YsQ0FqQkQ7O0FBb0JBLGVBQWVDLGVBQWYsQ0FBZ0NDLElBQWhDLEVBQXNDO0FBQ3BDLE1BQUk7QUFDRixVQUFNQyxRQUFRLEdBQUcsTUFBTSw2QkFBYTtBQUNsQ0MsTUFBQUEsR0FBRyxFQUFFRixJQUQ2QjtBQUVsQ0csTUFBQUEsTUFBTSxFQUFFLE1BRjBCO0FBR2xDQyxNQUFBQSx1QkFBdUIsRUFBRSxJQUhTO0FBSWxDQyxNQUFBQSxPQUFPLEVBQUU7QUFKeUIsS0FBYixDQUF2QjtBQU1BLFdBQU9KLFFBQVEsQ0FBQ0ssT0FBaEI7QUFDRCxHQVJELENBUUUsT0FBT1YsQ0FBUCxFQUFVO0FBQ1ZuQixvQkFBT2MsS0FBUCxDQUFjLGdDQUErQlMsSUFBSyxzQkFBcUJKLENBQUMsQ0FBQ0UsT0FBUSxFQUFqRjtBQUNEOztBQUNELFNBQU8sRUFBUDtBQUNEOztBQUVELFNBQVNTLHdCQUFULENBQW1DUCxJQUFuQyxFQUF5Q1EsZUFBekMsRUFBMEQ7QUFDeEQsTUFBSSxDQUFDeEMsa0JBQWtCLENBQUN5QyxHQUFuQixDQUF1QlQsSUFBdkIsQ0FBRCxJQUFpQyxDQUFDUSxlQUF0QyxFQUF1RDtBQUNyRCxXQUFPLElBQVA7QUFDRDs7QUFFRCxRQUFNO0FBQUNFLElBQUFBLFlBQUQ7QUFBZXBDLElBQUFBO0FBQWYsTUFBMkJOLGtCQUFrQixDQUFDMkMsR0FBbkIsQ0FBdUJYLElBQXZCLENBQWpDOztBQUNBLE1BQUlVLFlBQVksSUFBSUYsZUFBZSxDQUFDSSxPQUFoQixNQUE2QkYsWUFBWSxDQUFDRSxPQUFiLEVBQWpELEVBQXlFO0FBQ3ZFLFdBQU90QyxRQUFQO0FBQ0Q7O0FBQ0RHLGtCQUFPYyxLQUFQLENBQWMsaUNBQWdDUyxJQUFLLHNCQUF0QyxHQUNWLDREQURIOztBQUVBLFNBQU8sSUFBUDtBQUNEOztBQUVELFNBQVNhLGtCQUFULENBQTZCeEMsR0FBN0IsRUFBa0N5QyxzQkFBbEMsRUFBMEQ7QUFDeEQsTUFBSUEsc0JBQXNCLENBQUNDLFFBQXZCLENBQWdDQyxjQUFLQyxPQUFMLENBQWE1QyxHQUFiLENBQWhDLENBQUosRUFBd0Q7QUFDdEQsV0FBT0EsR0FBUDtBQUNEOztBQUNELFFBQU0sSUFBSTZDLEtBQUosQ0FBVyxpQkFBZ0I3QyxHQUFJLGdDQUErQnlDLHNCQUF1QixHQUFyRixDQUFOO0FBQ0Q7O0FBRUQsZUFBZUssWUFBZixDQUE2QjlDLEdBQTdCLEVBQWtDeUMsc0JBQWxDLEVBQTBEO0FBQ3hELE1BQUksQ0FBQ00sZ0JBQUVDLFFBQUYsQ0FBV2hELEdBQVgsQ0FBTCxFQUFzQjtBQUVwQjtBQUNEOztBQUNELE1BQUksQ0FBQytDLGdCQUFFRSxPQUFGLENBQVVSLHNCQUFWLENBQUwsRUFBd0M7QUFDdENBLElBQUFBLHNCQUFzQixHQUFHLENBQUNBLHNCQUFELENBQXpCO0FBQ0Q7O0FBRUQsTUFBSVMsTUFBTSxHQUFHbEQsR0FBYjtBQUNBLE1BQUltRCxjQUFjLEdBQUcsS0FBckI7QUFDQSxNQUFJQyxXQUFXLEdBQUcsSUFBbEI7QUFDQSxNQUFJakIsZUFBZSxHQUFHLElBQXRCOztBQUNBLFFBQU07QUFBQ2tCLElBQUFBLFFBQUQ7QUFBV0MsSUFBQUE7QUFBWCxNQUF1QnpCLGFBQUkwQixLQUFKLENBQVVMLE1BQVYsQ0FBN0I7O0FBQ0EsUUFBTU0sS0FBSyxHQUFHLENBQUMsT0FBRCxFQUFVLFFBQVYsRUFBb0JkLFFBQXBCLENBQTZCVyxRQUE3QixDQUFkO0FBRUEsU0FBTyxNQUFNN0Msd0JBQXdCLENBQUNpRCxPQUF6QixDQUFpQ3pELEdBQWpDLEVBQXNDLFlBQVk7QUFDN0QsUUFBSXdELEtBQUosRUFBVztBQUVUcEQsc0JBQU9DLElBQVAsQ0FBYSwyQkFBMEI2QyxNQUFPLEdBQTlDOztBQUNBLFlBQU1qQixPQUFPLEdBQUcsTUFBTVAsZUFBZSxDQUFDd0IsTUFBRCxDQUFyQzs7QUFDQSxVQUFJakIsT0FBTyxDQUFDLGVBQUQsQ0FBWCxFQUE4QjtBQUM1QjdCLHdCQUFPYyxLQUFQLENBQWMsc0JBQXFCZSxPQUFPLENBQUMsZUFBRCxDQUFrQixFQUE1RDs7QUFDQUUsUUFBQUEsZUFBZSxHQUFHLElBQUl1QixJQUFKLENBQVN6QixPQUFPLENBQUMsZUFBRCxDQUFoQixDQUFsQjtBQUNEOztBQUNELFlBQU0wQixVQUFVLEdBQUd6Qix3QkFBd0IsQ0FBQ2xDLEdBQUQsRUFBTW1DLGVBQU4sQ0FBM0M7O0FBQ0EsVUFBSXdCLFVBQUosRUFBZ0I7QUFDZCxZQUFJLE1BQU16RCxrQkFBR0MsTUFBSCxDQUFVd0QsVUFBVixDQUFWLEVBQWlDO0FBQy9CdkQsMEJBQU9DLElBQVAsQ0FBYSxpREFBZ0RzRCxVQUFXLEdBQXhFOztBQUNBLGlCQUFPbkIsa0JBQWtCLENBQUNtQixVQUFELEVBQWFsQixzQkFBYixDQUF6QjtBQUNEOztBQUNEckMsd0JBQU9DLElBQVAsQ0FBYSx1QkFBc0JzRCxVQUFXLHNEQUE5Qzs7QUFDQWhFLFFBQUFBLGtCQUFrQixDQUFDaUUsR0FBbkIsQ0FBdUI1RCxHQUF2QjtBQUNEOztBQUVELFVBQUk2RCxRQUFRLEdBQUcsSUFBZjtBQUNBLFlBQU1DLFFBQVEsR0FBRywrQkFBU25CLGNBQUttQixRQUFMLENBQWNDLGtCQUFrQixDQUFDVCxRQUFELENBQWhDLENBQVQsRUFBc0Q7QUFDckVVLFFBQUFBLFdBQVcsRUFBRXREO0FBRHdELE9BQXRELENBQWpCOztBQUdBLFlBQU1rQyxPQUFPLEdBQUdELGNBQUtDLE9BQUwsQ0FBYWtCLFFBQWIsQ0FBaEI7O0FBR0EsVUFBSXRFLFFBQVEsQ0FBQ2tELFFBQVQsQ0FBa0JFLE9BQWxCLENBQUosRUFBZ0M7QUFDOUJpQixRQUFBQSxRQUFRLEdBQUdDLFFBQVg7QUFDQVgsUUFBQUEsY0FBYyxHQUFHLElBQWpCO0FBQ0Q7O0FBQ0QsVUFBSWxCLE9BQU8sQ0FBQyxjQUFELENBQVgsRUFBNkI7QUFDM0I3Qix3QkFBT2MsS0FBUCxDQUFjLGlCQUFnQmUsT0FBTyxDQUFDLGNBQUQsQ0FBaUIsRUFBdEQ7O0FBRUEsWUFBSXhDLGNBQWMsQ0FBQ3dFLElBQWYsQ0FBb0JDLFFBQVEsSUFBSSxJQUFJQyxNQUFKLENBQVksTUFBS3BCLGdCQUFFcUIsWUFBRixDQUFlRixRQUFmLENBQXlCLEtBQTFDLEVBQWdERyxJQUFoRCxDQUFxRHBDLE9BQU8sQ0FBQyxjQUFELENBQTVELENBQWhDLENBQUosRUFBb0g7QUFDbEgsY0FBSSxDQUFDNEIsUUFBTCxFQUFlO0FBQ2JBLFlBQUFBLFFBQVEsR0FBSSxHQUFFbEQsZ0JBQWlCLE1BQS9CO0FBQ0Q7O0FBQ0R3QyxVQUFBQSxjQUFjLEdBQUcsSUFBakI7QUFDRDtBQUNGOztBQUNELFVBQUlsQixPQUFPLENBQUMscUJBQUQsQ0FBUCxJQUFrQyxlQUFlb0MsSUFBZixDQUFvQnBDLE9BQU8sQ0FBQyxxQkFBRCxDQUEzQixDQUF0QyxFQUEyRjtBQUN6RjdCLHdCQUFPYyxLQUFQLENBQWMsd0JBQXVCZSxPQUFPLENBQUMscUJBQUQsQ0FBd0IsRUFBcEU7O0FBQ0EsY0FBTXFDLEtBQUssR0FBRyxxQkFBcUJDLElBQXJCLENBQTBCdEMsT0FBTyxDQUFDLHFCQUFELENBQWpDLENBQWQ7O0FBQ0EsWUFBSXFDLEtBQUosRUFBVztBQUNUVCxVQUFBQSxRQUFRLEdBQUcsK0JBQVNTLEtBQUssQ0FBQyxDQUFELENBQWQsRUFBbUI7QUFDNUJOLFlBQUFBLFdBQVcsRUFBRXREO0FBRGUsV0FBbkIsQ0FBWDtBQUdBeUMsVUFBQUEsY0FBYyxHQUFHQSxjQUFjLElBQUkzRCxRQUFRLENBQUNrRCxRQUFULENBQWtCQyxjQUFLQyxPQUFMLENBQWFpQixRQUFiLENBQWxCLENBQW5DO0FBQ0Q7QUFDRjs7QUFDRCxVQUFJLENBQUNBLFFBQUwsRUFBZTtBQUViLGNBQU1XLGFBQWEsR0FBR1YsUUFBUSxHQUMxQkEsUUFBUSxDQUFDVyxTQUFULENBQW1CLENBQW5CLEVBQXNCWCxRQUFRLENBQUNoRCxNQUFULEdBQWtCOEIsT0FBTyxDQUFDOUIsTUFBaEQsQ0FEMEIsR0FFMUJILGdCQUZKO0FBR0EsWUFBSStELFlBQVksR0FBRzlCLE9BQW5COztBQUNBLFlBQUksQ0FBQ0gsc0JBQXNCLENBQUNDLFFBQXZCLENBQWdDZ0MsWUFBaEMsQ0FBTCxFQUFvRDtBQUNsRHRFLDBCQUFPQyxJQUFQLENBQWEsK0JBQThCcUUsWUFBYSxzQkFBNUMsR0FDVCxrQkFBaUIzQixnQkFBRTRCLEtBQUYsQ0FBUWxDLHNCQUFSLENBQWdDLEdBRHBEOztBQUVBaUMsVUFBQUEsWUFBWSxHQUFHM0IsZ0JBQUU0QixLQUFGLENBQVFsQyxzQkFBUixDQUFmO0FBQ0Q7O0FBQ0RvQixRQUFBQSxRQUFRLEdBQUksR0FBRVcsYUFBYyxHQUFFRSxZQUFhLEVBQTNDO0FBQ0Q7O0FBQ0QsWUFBTUUsVUFBVSxHQUFHLE1BQU1DLHVCQUFRbEMsSUFBUixDQUFhO0FBQ3BDbUMsUUFBQUEsTUFBTSxFQUFFakIsUUFENEI7QUFFcENrQixRQUFBQSxNQUFNLEVBQUU7QUFGNEIsT0FBYixDQUF6QjtBQUlBN0IsTUFBQUEsTUFBTSxHQUFHLE1BQU04QixXQUFXLENBQUM5QixNQUFELEVBQVMwQixVQUFULENBQTFCO0FBQ0QsS0FuRUQsTUFtRU8sSUFBSSxNQUFNMUUsa0JBQUdDLE1BQUgsQ0FBVStDLE1BQVYsQ0FBVixFQUE2QjtBQUVsQzlDLHNCQUFPQyxJQUFQLENBQWEsb0JBQW1CNkMsTUFBTyxHQUF2Qzs7QUFDQUMsTUFBQUEsY0FBYyxHQUFHM0QsUUFBUSxDQUFDa0QsUUFBVCxDQUFrQkMsY0FBS0MsT0FBTCxDQUFhTSxNQUFiLENBQWxCLENBQWpCO0FBQ0QsS0FKTSxNQUlBO0FBQ0wsVUFBSStCLFlBQVksR0FBSSx1QkFBc0IvQixNQUFPLHVDQUFqRDs7QUFFQSxVQUFJSCxnQkFBRUMsUUFBRixDQUFXSyxRQUFYLEtBQXdCQSxRQUFRLENBQUN2QyxNQUFULEdBQWtCLENBQTlDLEVBQWlEO0FBQy9DbUUsUUFBQUEsWUFBWSxHQUFJLGlCQUFnQjVCLFFBQVMsY0FBYUgsTUFBTyxzQkFBOUMsR0FDWiwrQ0FESDtBQUVEOztBQUNELFlBQU0sSUFBSUwsS0FBSixDQUFVb0MsWUFBVixDQUFOO0FBQ0Q7O0FBRUQsUUFBSTlCLGNBQUosRUFBb0I7QUFDbEIsWUFBTStCLFdBQVcsR0FBR2hDLE1BQXBCO0FBQ0FFLE1BQUFBLFdBQVcsR0FBRyxNQUFNbEQsa0JBQUdpRixJQUFILENBQVFELFdBQVIsQ0FBcEI7O0FBQ0EsVUFBSXZGLGtCQUFrQixDQUFDeUMsR0FBbkIsQ0FBdUJwQyxHQUF2QixLQUErQm9ELFdBQVcsS0FBS3pELGtCQUFrQixDQUFDMkMsR0FBbkIsQ0FBdUJ0QyxHQUF2QixFQUE0Qm1GLElBQS9FLEVBQXFGO0FBQ25GLGNBQU07QUFBQ2xGLFVBQUFBO0FBQUQsWUFBYU4sa0JBQWtCLENBQUMyQyxHQUFuQixDQUF1QnRDLEdBQXZCLENBQW5COztBQUNBLFlBQUksTUFBTUUsa0JBQUdDLE1BQUgsQ0FBVUYsUUFBVixDQUFWLEVBQStCO0FBQzdCLGNBQUlpRixXQUFXLEtBQUtsRixHQUFwQixFQUF5QjtBQUN2QixrQkFBTUUsa0JBQUdJLE1BQUgsQ0FBVTRFLFdBQVYsQ0FBTjtBQUNEOztBQUNEOUUsMEJBQU9DLElBQVAsQ0FBYSxnREFBK0NKLFFBQVMsR0FBckU7O0FBQ0EsaUJBQU91QyxrQkFBa0IsQ0FBQ3ZDLFFBQUQsRUFBV3dDLHNCQUFYLENBQXpCO0FBQ0Q7O0FBQ0RyQyx3QkFBT0MsSUFBUCxDQUFhLHVCQUFzQkosUUFBUyxzREFBNUM7O0FBQ0FOLFFBQUFBLGtCQUFrQixDQUFDaUUsR0FBbkIsQ0FBdUI1RCxHQUF2QjtBQUNEOztBQUNELFlBQU1vRixPQUFPLEdBQUcsTUFBTVAsdUJBQVFRLE9BQVIsRUFBdEI7O0FBQ0EsVUFBSTtBQUNGbkMsUUFBQUEsTUFBTSxHQUFHLE1BQU1vQyxRQUFRLENBQUNKLFdBQUQsRUFBY0UsT0FBZCxFQUF1QjNDLHNCQUF2QixDQUF2QjtBQUNELE9BRkQsU0FFVTtBQUNSLFlBQUlTLE1BQU0sS0FBS2dDLFdBQVgsSUFBMEJBLFdBQVcsS0FBS2xGLEdBQTlDLEVBQW1EO0FBQ2pELGdCQUFNRSxrQkFBR0ksTUFBSCxDQUFVNEUsV0FBVixDQUFOO0FBQ0Q7QUFDRjs7QUFDRDlFLHNCQUFPQyxJQUFQLENBQWEsMEJBQXlCNkMsTUFBTyxHQUE3QztBQUNELEtBeEJELE1Bd0JPLElBQUksQ0FBQ1AsY0FBSzRDLFVBQUwsQ0FBZ0JyQyxNQUFoQixDQUFMLEVBQThCO0FBQ25DQSxNQUFBQSxNQUFNLEdBQUdQLGNBQUs2QyxPQUFMLENBQWE1RSxPQUFPLENBQUM2RSxHQUFSLEVBQWIsRUFBNEJ2QyxNQUE1QixDQUFUOztBQUNBOUMsc0JBQU9vQixJQUFQLENBQWEsaUNBQWdDeEIsR0FBSSxvQkFBckMsR0FDVCw4QkFBNkJrRCxNQUFPLHVEQUR2Qzs7QUFFQWxELE1BQUFBLEdBQUcsR0FBR2tELE1BQU47QUFDRDs7QUFFRFYsSUFBQUEsa0JBQWtCLENBQUNVLE1BQUQsRUFBU1Qsc0JBQVQsQ0FBbEI7O0FBRUEsUUFBSXpDLEdBQUcsS0FBS2tELE1BQVIsS0FBbUJFLFdBQVcsSUFBSWpCLGVBQWxDLENBQUosRUFBd0Q7QUFDdEQsVUFBSXhDLGtCQUFrQixDQUFDeUMsR0FBbkIsQ0FBdUJwQyxHQUF2QixDQUFKLEVBQWlDO0FBQy9CLGNBQU07QUFBQ0MsVUFBQUE7QUFBRCxZQUFhTixrQkFBa0IsQ0FBQzJDLEdBQW5CLENBQXVCdEMsR0FBdkIsQ0FBbkI7O0FBRUEsWUFBSUMsUUFBUSxLQUFLaUQsTUFBYixLQUF1QixNQUFNaEQsa0JBQUdDLE1BQUgsQ0FBVUYsUUFBVixDQUE3QixDQUFKLEVBQXNEO0FBQ3BELGdCQUFNQyxrQkFBR0ksTUFBSCxDQUFVTCxRQUFWLENBQU47QUFDRDtBQUNGOztBQUNETixNQUFBQSxrQkFBa0IsQ0FBQytGLEdBQW5CLENBQXVCMUYsR0FBdkIsRUFBNEI7QUFDMUJtRixRQUFBQSxJQUFJLEVBQUUvQixXQURvQjtBQUUxQmYsUUFBQUEsWUFBWSxFQUFFRixlQUZZO0FBRzFCbEMsUUFBQUEsUUFBUSxFQUFFaUQ7QUFIZ0IsT0FBNUI7QUFLRDs7QUFDRCxXQUFPQSxNQUFQO0FBQ0QsR0FsSVksQ0FBYjtBQW1JRDs7QUFFRCxlQUFlOEIsV0FBZixDQUE0QmhGLEdBQTVCLEVBQWlDNEUsVUFBakMsRUFBNkM7QUFDM0MsUUFBTTtBQUFDZSxJQUFBQTtBQUFELE1BQVM5RCxhQUFJMEIsS0FBSixDQUFVdkQsR0FBVixDQUFmOztBQUNBLFFBQU00RixLQUFLLEdBQUcsSUFBSUMsc0JBQU9DLEtBQVgsR0FBbUJDLEtBQW5CLEVBQWQ7O0FBQ0EsTUFBSTtBQUVGLFVBQU0sSUFBSUMsaUJBQUosQ0FBTSxDQUFDUixPQUFELEVBQVVTLE1BQVYsS0FBcUI7QUFDL0IsNEJBQVFOLElBQVIsRUFDRzlFLEVBREgsQ0FDTSxPQUROLEVBQ2VvRixNQURmLEVBRUdwRixFQUZILENBRU0sVUFGTixFQUVtQnFGLEdBQUQsSUFBUztBQUV2QixZQUFJQSxHQUFHLENBQUNDLFVBQUosSUFBa0IsR0FBdEIsRUFBMkI7QUFDekIsaUJBQU9GLE1BQU0sQ0FBQyxJQUFJcEQsS0FBSixDQUFXLEdBQUVxRCxHQUFHLENBQUNDLFVBQVcsTUFBS0QsR0FBRyxDQUFDRSxhQUFjLEVBQW5ELENBQUQsQ0FBYjtBQUNEO0FBQ0YsT0FQSCxFQVFHQyxJQVJILENBUVFDLGFBQUlDLGlCQUFKLENBQXNCM0IsVUFBdEIsQ0FSUixFQVNHL0QsRUFUSCxDQVNNLE9BVE4sRUFTZTJFLE9BVGY7QUFVRCxLQVhLLENBQU47QUFZRCxHQWRELENBY0UsT0FBT2dCLEdBQVAsRUFBWTtBQUNaLFVBQU0sSUFBSTNELEtBQUosQ0FBVyxvQ0FBbUM4QyxJQUFLLEtBQUlhLEdBQUcsQ0FBQy9FLE9BQVEsRUFBbkUsQ0FBTjtBQUNEOztBQUNELFFBQU1nRixjQUFjLEdBQUdiLEtBQUssQ0FBQ2MsV0FBTixHQUFvQkMsU0FBM0M7QUFDQSxRQUFNO0FBQUNDLElBQUFBO0FBQUQsTUFBUyxNQUFNMUcsa0JBQUcyRyxJQUFILENBQVFqQyxVQUFSLENBQXJCOztBQUNBeEUsa0JBQU9jLEtBQVAsQ0FBYyxJQUFHeUUsSUFBSyxNQUFLeEUsb0JBQUsyRixvQkFBTCxDQUEwQkYsSUFBMUIsQ0FBZ0MsSUFBOUMsR0FDViwyQkFBMEJoQyxVQUFXLFFBQU82QixjQUFjLENBQUNNLE9BQWYsQ0FBdUIsQ0FBdkIsQ0FBMEIsR0FEekU7O0FBRUEsTUFBSU4sY0FBYyxJQUFJLENBQXRCLEVBQXlCO0FBQ3ZCLFVBQU1PLFdBQVcsR0FBR0MsSUFBSSxDQUFDQyxLQUFMLENBQVdOLElBQUksR0FBR0gsY0FBbEIsQ0FBcEI7O0FBQ0FyRyxvQkFBT2MsS0FBUCxDQUFjLCtCQUE4QkMsb0JBQUsyRixvQkFBTCxDQUEwQkUsV0FBMUIsQ0FBdUMsSUFBbkY7QUFDRDs7QUFDRCxTQUFPcEMsVUFBUDtBQUNEOztBQUVELGVBQWVVLFFBQWYsQ0FBeUI2QixPQUF6QixFQUFrQ0MsT0FBbEMsRUFBMkMzRSxzQkFBM0MsRUFBbUU7QUFDakUsUUFBTTRFLG1CQUFJQyxjQUFKLENBQW1CSCxPQUFuQixDQUFOOztBQUVBLE1BQUksQ0FBQ3BFLGdCQUFFRSxPQUFGLENBQVVSLHNCQUFWLENBQUwsRUFBd0M7QUFDdENBLElBQUFBLHNCQUFzQixHQUFHLENBQUNBLHNCQUFELENBQXpCO0FBQ0Q7O0FBRUQsUUFBTTJDLE9BQU8sR0FBRyxNQUFNUCx1QkFBUVEsT0FBUixFQUF0Qjs7QUFDQSxNQUFJO0FBQ0ZqRixvQkFBT2MsS0FBUCxDQUFjLGNBQWFpRyxPQUFRLEdBQW5DOztBQUNBLFVBQU1FLG1CQUFJRSxZQUFKLENBQWlCSixPQUFqQixFQUEwQi9CLE9BQTFCLENBQU47QUFDQSxVQUFNb0MsaUJBQWlCLEdBQUcsRUFBMUI7QUFDQSxVQUFNdEgsa0JBQUd1SCxPQUFILENBQVdyQyxPQUFYLEVBQW9CLElBQXBCLEVBQTJCc0MsUUFBRCxJQUFjLEtBQUtGLGlCQUFpQixDQUFDRyxJQUFsQixDQUF1QkQsUUFBdkIsQ0FBN0MsQ0FBTjs7QUFDQXRILG9CQUFPYyxLQUFQLENBQWMsYUFBWXNHLGlCQUFpQixDQUFDMUcsTUFBTyxrQkFBaUJxRyxPQUFRLEdBQTVFOztBQUNBLFVBQU1TLGtCQUFrQixHQUFJQyxZQUFELElBQWtCcEYsc0JBQXNCLENBQUNDLFFBQXZCLENBQWdDQyxjQUFLQyxPQUFMLENBQWFpRixZQUFiLENBQWhDLEtBQ3hDOUUsZ0JBQUVrQixJQUFGLENBQU94QixzQkFBUCxFQUFnQ3FGLENBQUQsSUFBT0QsWUFBWSxDQUFDbkYsUUFBYixDQUF1QixHQUFFb0YsQ0FBRSxHQUFFbkYsY0FBS29GLEdBQUksRUFBdEMsQ0FBdEMsQ0FETDs7QUFFQSxVQUFNQyxXQUFXLEdBQUdSLGlCQUFpQixDQUNsQ3ZHLEdBRGlCLENBQ1p5RyxRQUFELElBQWMvRSxjQUFLc0YsUUFBTCxDQUFjN0MsT0FBZCxFQUF1QnNDLFFBQXZCLENBREQsRUFFakJRLE1BRmlCLENBRVRMLFlBQUQsSUFBa0JELGtCQUFrQixDQUFDQyxZQUFELENBRjFCLEVBR2pCNUcsR0FIaUIsQ0FHWjRHLFlBQUQsSUFBa0JsRixjQUFLNkMsT0FBTCxDQUFhSixPQUFiLEVBQXNCeUMsWUFBdEIsQ0FITCxDQUFwQjs7QUFJQSxVQUFNTSxhQUFhLEdBQUdwRixnQkFBRXFGLFVBQUYsQ0FBYVosaUJBQWIsRUFBZ0NRLFdBQWhDLEVBRW5CRSxNQUZtQixDQUVYRyxnQkFBRCxJQUFzQixDQUFDdEYsZ0JBQUVrQixJQUFGLENBQU8rRCxXQUFQLEVBQXFCTSxjQUFELElBQW9CQSxjQUFjLENBQUNDLFVBQWYsQ0FBMEJGLGdCQUExQixDQUF4QyxDQUZYLENBQXRCOztBQUdBLFVBQU1yQyxrQkFBRXdDLEdBQUYsQ0FBTUwsYUFBTixFQUFxQixNQUFPVCxRQUFQLElBQW9CO0FBQzdDLFVBQUksTUFBTXhILGtCQUFHQyxNQUFILENBQVV1SCxRQUFWLENBQVYsRUFBK0I7QUFDN0IsY0FBTXhILGtCQUFHSSxNQUFILENBQVVvSCxRQUFWLENBQU47QUFDRDtBQUNGLEtBSkssQ0FBTjtBQUtBLFFBQUllLGNBQWMsR0FBRyxFQUFyQjtBQUNBLFVBQU12SSxrQkFBR3VILE9BQUgsQ0FBV3JDLE9BQVgsRUFBb0IsSUFBcEIsRUFBMkJzQyxRQUFELElBQWMsS0FBS2UsY0FBYyxDQUFDZCxJQUFmLENBQW9CRCxRQUFwQixDQUE3QyxDQUFOO0FBQ0FlLElBQUFBLGNBQWMsR0FBR0EsY0FBYyxDQUM1QnhILEdBRGMsQ0FDVHlHLFFBQUQsSUFBYy9FLGNBQUtzRixRQUFMLENBQWM3QyxPQUFkLEVBQXVCc0MsUUFBdkIsQ0FESixFQUVkUSxNQUZjLENBRU5MLFlBQUQsSUFBa0JELGtCQUFrQixDQUFDQyxZQUFELENBRjdCLEVBSWRhLElBSmMsQ0FJVCxDQUFDQyxDQUFELEVBQUlDLENBQUosS0FBVUQsQ0FBQyxDQUFDRSxLQUFGLENBQVFsRyxjQUFLb0YsR0FBYixFQUFrQmpILE1BQWxCLEdBQTJCOEgsQ0FBQyxDQUFDQyxLQUFGLENBQVFsRyxjQUFLb0YsR0FBYixFQUFrQmpILE1BSjlDLENBQWpCOztBQUtBLFFBQUlpQyxnQkFBRStGLE9BQUYsQ0FBVUwsY0FBVixDQUFKLEVBQStCO0FBQzdCLFlBQU0sSUFBSTVGLEtBQUosQ0FBVyw4Q0FBNkNKLHNCQUF1QixhQUFyRSxHQUNiLDBDQUF5Q0Esc0JBQXVCLGNBRG5ELEdBRWIsa0JBRkcsQ0FBTjtBQUdEOztBQUNELFVBQU1zRyxhQUFhLEdBQUdoRyxnQkFBRTRCLEtBQUYsQ0FBUThELGNBQVIsQ0FBdEI7O0FBQ0FySSxvQkFBT2MsS0FBUCxDQUFjLFdBQVV1SCxjQUFjLENBQUMzSCxNQUFPLHFDQUFqQyxHQUNWLGFBQVlpSSxhQUFjLHlCQUQ3Qjs7QUFFQSxVQUFNN0ksa0JBQUc4SSxFQUFILENBQU1yRyxjQUFLNkMsT0FBTCxDQUFhSixPQUFiLEVBQXNCMkQsYUFBdEIsQ0FBTixFQUE0Q3BHLGNBQUs2QyxPQUFMLENBQWE0QixPQUFiLEVBQXNCMkIsYUFBdEIsQ0FBNUMsRUFBa0Y7QUFDdEZFLE1BQUFBLE1BQU0sRUFBRTtBQUQ4RSxLQUFsRixDQUFOO0FBR0EsV0FBT3RHLGNBQUs2QyxPQUFMLENBQWE0QixPQUFiLEVBQXNCMkIsYUFBdEIsQ0FBUDtBQUNELEdBdkNELFNBdUNVO0FBQ1IsVUFBTTdJLGtCQUFHSSxNQUFILENBQVU4RSxPQUFWLENBQU47QUFDRDtBQUNGOztBQUVELFNBQVM4RCxpQkFBVCxDQUE0QmxKLEdBQTVCLEVBQWlDO0FBQy9CLFNBQVEsdUNBQUQsQ0FBMENxRSxJQUExQyxDQUErQ3JFLEdBQS9DLENBQVA7QUFDRDs7QUFFRCxTQUFTbUosZUFBVCxDQUEwQkMsR0FBMUIsRUFBK0I7QUFJN0IsU0FBT2pJLG9CQUFLa0ksUUFBTCxDQUFjRCxHQUFkLElBQXFCQSxHQUFyQixHQUEyQixHQUFsQztBQUNEOztBQUVELFNBQVNFLHFCQUFULENBQWdDQyxXQUFoQyxFQUE2QztBQUczQyxNQUFJQyxRQUFRLEdBQUcsR0FBZjs7QUFDQSxNQUFJLE9BQU9ELFdBQVcsQ0FBQ0UsT0FBWixDQUFvQkMsRUFBM0IsS0FBa0MsV0FBbEMsSUFBaURILFdBQVcsQ0FBQ0UsT0FBWixDQUFvQkMsRUFBekUsRUFBNkU7QUFDM0VGLElBQUFBLFFBQVEsR0FBR0QsV0FBVyxDQUFDRSxPQUFaLENBQW9CQyxFQUFwQixHQUF5QixJQUFwQzs7QUFDQSxRQUFJRixRQUFRLEtBQUssQ0FBakIsRUFBb0I7QUFHbEJBLE1BQUFBLFFBQVEsR0FBRyxHQUFYO0FBQ0Q7QUFDRjs7QUFDRCxTQUFPQSxRQUFQO0FBQ0Q7O0FBWUQsU0FBU0csYUFBVCxDQUF3QkMsS0FBeEIsRUFBK0JDLFFBQS9CLEVBQXlDQyxTQUF6QyxFQUFvRDtBQUVsRCxNQUFJL0csZ0JBQUVFLE9BQUYsQ0FBVTJHLEtBQVYsQ0FBSixFQUFzQjtBQUNwQixXQUFPQSxLQUFLLENBQUMzSSxHQUFOLENBQVc4SSxJQUFELElBQVVKLGFBQWEsQ0FBQ0ksSUFBRCxFQUFPRixRQUFQLEVBQWlCQyxTQUFqQixDQUFqQyxDQUFQO0FBQ0Q7O0FBR0QsTUFBSS9HLGdCQUFFaUgsYUFBRixDQUFnQkosS0FBaEIsQ0FBSixFQUE0QjtBQUMxQixVQUFNSyxTQUFTLEdBQUcsRUFBbEI7O0FBQ0EsU0FBSyxJQUFJLENBQUNDLEdBQUQsRUFBTUMsS0FBTixDQUFULElBQXlCcEgsZ0JBQUVxSCxPQUFGLENBQVVSLEtBQVYsQ0FBekIsRUFBMkM7QUFDekMsWUFBTVMsc0JBQXNCLEdBQUdWLGFBQWEsQ0FBQ1EsS0FBRCxFQUFRTixRQUFSLEVBQWtCQyxTQUFsQixDQUE1Qzs7QUFDQSxVQUFJSSxHQUFHLEtBQUtMLFFBQVosRUFBc0I7QUFDcEJJLFFBQUFBLFNBQVMsQ0FBQ0gsU0FBRCxDQUFULEdBQXVCTyxzQkFBdkI7QUFDRCxPQUZELE1BRU8sSUFBSUgsR0FBRyxLQUFLSixTQUFaLEVBQXVCO0FBQzVCRyxRQUFBQSxTQUFTLENBQUNKLFFBQUQsQ0FBVCxHQUFzQlEsc0JBQXRCO0FBQ0Q7O0FBQ0RKLE1BQUFBLFNBQVMsQ0FBQ0MsR0FBRCxDQUFULEdBQWlCRyxzQkFBakI7QUFDRDs7QUFDRCxXQUFPSixTQUFQO0FBQ0Q7O0FBR0QsU0FBT0wsS0FBUDtBQUNEOztBQVFELFNBQVNVLGNBQVQsQ0FBeUJDLEdBQXpCLEVBQThCO0FBQzVCLE1BQUl4SCxnQkFBRUUsT0FBRixDQUFVc0gsR0FBVixDQUFKLEVBQW9CO0FBQ2xCLFdBQU9BLEdBQVA7QUFDRDs7QUFFRCxNQUFJQyxVQUFKOztBQUNBLE1BQUk7QUFDRkEsSUFBQUEsVUFBVSxHQUFHQyxJQUFJLENBQUNsSCxLQUFMLENBQVdnSCxHQUFYLENBQWI7O0FBQ0EsUUFBSXhILGdCQUFFRSxPQUFGLENBQVV1SCxVQUFWLENBQUosRUFBMkI7QUFDekIsYUFBT0EsVUFBUDtBQUNEO0FBQ0YsR0FMRCxDQUtFLE9BQU9FLEdBQVAsRUFBWTtBQUNadEssb0JBQU9vQixJQUFQLENBQWEsMENBQWI7QUFDRDs7QUFDRCxNQUFJdUIsZ0JBQUVDLFFBQUYsQ0FBV3VILEdBQVgsQ0FBSixFQUFxQjtBQUNuQixXQUFPLENBQUNBLEdBQUQsQ0FBUDtBQUNEOztBQUNELFFBQU0sSUFBSTFILEtBQUosQ0FBVyxpREFBZ0QwSCxHQUFJLEVBQS9ELENBQU47QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB1cmwgZnJvbSAndXJsJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IF9mcyBmcm9tICdmcyc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyB0ZW1wRGlyLCBmcywgdXRpbCwgemlwLCB0aW1pbmcgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgcmVxdWVzdCBmcm9tICdyZXF1ZXN0JztcbmltcG9ydCBhc3luY1JlcXVlc3QgZnJvbSAncmVxdWVzdC1wcm9taXNlJztcbmltcG9ydCBMUlUgZnJvbSAnbHJ1LWNhY2hlJztcbmltcG9ydCBBc3luY0xvY2sgZnJvbSAnYXN5bmMtbG9jayc7XG5pbXBvcnQgc2FuaXRpemUgZnJvbSAnc2FuaXRpemUtZmlsZW5hbWUnO1xuXG5cbmNvbnN0IFpJUF9FWFRTID0gWycuemlwJywgJy5pcGEnXTtcbmNvbnN0IFpJUF9NSU1FX1RZUEVTID0gW1xuICAnYXBwbGljYXRpb24vemlwJyxcbiAgJ2FwcGxpY2F0aW9uL3gtemlwLWNvbXByZXNzZWQnLFxuICAnbXVsdGlwYXJ0L3gtemlwJyxcbl07XG5jb25zdCBDQUNIRURfQVBQU19NQVhfQUdFID0gMTAwMCAqIDYwICogNjAgKiAyNDsgLy8gbXNcbmNvbnN0IEFQUExJQ0FUSU9OU19DQUNIRSA9IG5ldyBMUlUoe1xuICBtYXhBZ2U6IENBQ0hFRF9BUFBTX01BWF9BR0UsIC8vIGV4cGlyZSBhZnRlciAyNCBob3Vyc1xuICB1cGRhdGVBZ2VPbkdldDogdHJ1ZSxcbiAgZGlzcG9zZTogYXN5bmMgKGFwcCwge2Z1bGxQYXRofSkgPT4ge1xuICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKGZ1bGxQYXRoKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxvZ2dlci5pbmZvKGBUaGUgYXBwbGljYXRpb24gJyR7YXBwfScgY2FjaGVkIGF0ICcke2Z1bGxQYXRofScgaGFzIGV4cGlyZWRgKTtcbiAgICBhd2FpdCBmcy5yaW1yYWYoZnVsbFBhdGgpO1xuICB9LFxuICBub0Rpc3Bvc2VPblNldDogdHJ1ZSxcbn0pO1xuY29uc3QgQVBQTElDQVRJT05TX0NBQ0hFX0dVQVJEID0gbmV3IEFzeW5jTG9jaygpO1xuY29uc3QgU0FOSVRJWkVfUkVQTEFDRU1FTlQgPSAnLSc7XG5jb25zdCBERUZBVUxUX0JBU0VOQU1FID0gJ2FwcGl1bS1hcHAnO1xuXG5wcm9jZXNzLm9uKCdleGl0JywgKCkgPT4ge1xuICBpZiAoIUFQUExJQ0FUSU9OU19DQUNIRS5sZW5ndGgpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCBhcHBQYXRocyA9IEFQUExJQ0FUSU9OU19DQUNIRS52YWx1ZXMoKVxuICAgIC5tYXAoKHtmdWxsUGF0aH0pID0+IGZ1bGxQYXRoKTtcbiAgbG9nZ2VyLmRlYnVnKGBQZXJmb3JtaW5nIGNsZWFudXAgb2YgJHthcHBQYXRocy5sZW5ndGh9IGNhY2hlZCBgICtcbiAgICBgJHt1dGlsLnBsdXJhbGl6ZSgnYXBwbGljYXRpb24nLCBhcHBQYXRocy5sZW5ndGgpfWApO1xuICBmb3IgKGNvbnN0IGFwcFBhdGggb2YgYXBwUGF0aHMpIHtcbiAgICB0cnkge1xuICAgICAgLy8gQXN5bmNocm9ub3VzIGNhbGxzIGFyZSBub3Qgc3VwcG9ydGVkIGluIG9uRXhpdCBoYW5kbGVyXG4gICAgICBmcy5yaW1yYWZTeW5jKGFwcFBhdGgpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGxvZ2dlci53YXJuKGUubWVzc2FnZSk7XG4gICAgfVxuICB9XG59KTtcblxuXG5hc3luYyBmdW5jdGlvbiByZXRyaWV2ZUhlYWRlcnMgKGxpbmspIHtcbiAgdHJ5IHtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGFzeW5jUmVxdWVzdCh7XG4gICAgICB1cmw6IGxpbmssXG4gICAgICBtZXRob2Q6ICdIRUFEJyxcbiAgICAgIHJlc29sdmVXaXRoRnVsbFJlc3BvbnNlOiB0cnVlLFxuICAgICAgdGltZW91dDogNTAwMCxcbiAgICB9KTtcbiAgICByZXR1cm4gcmVzcG9uc2UuaGVhZGVycztcbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZ2dlci5kZWJ1ZyhgQ2Fubm90IHNlbmQgSEVBRCByZXF1ZXN0IHRvICcke2xpbmt9Jy4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICB9XG4gIHJldHVybiB7fTtcbn1cblxuZnVuY3Rpb24gZ2V0Q2FjaGVkQXBwbGljYXRpb25QYXRoIChsaW5rLCBjdXJyZW50TW9kaWZpZWQpIHtcbiAgaWYgKCFBUFBMSUNBVElPTlNfQ0FDSEUuaGFzKGxpbmspIHx8ICFjdXJyZW50TW9kaWZpZWQpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGNvbnN0IHtsYXN0TW9kaWZpZWQsIGZ1bGxQYXRofSA9IEFQUExJQ0FUSU9OU19DQUNIRS5nZXQobGluayk7XG4gIGlmIChsYXN0TW9kaWZpZWQgJiYgY3VycmVudE1vZGlmaWVkLmdldFRpbWUoKSA8PSBsYXN0TW9kaWZpZWQuZ2V0VGltZSgpKSB7XG4gICAgcmV0dXJuIGZ1bGxQYXRoO1xuICB9XG4gIGxvZ2dlci5kZWJ1ZyhgJ0xhc3QtTW9kaWZpZWQnIHRpbWVzdGFtcCBvZiAnJHtsaW5rfScgaGFzIGJlZW4gdXBkYXRlZC4gYCArXG4gICAgYEEgZnJlc2ggY29weSBvZiB0aGUgYXBwbGljYXRpb24gaXMgZ29pbmcgdG8gYmUgZG93bmxvYWRlZC5gKTtcbiAgcmV0dXJuIG51bGw7XG59XG5cbmZ1bmN0aW9uIHZlcmlmeUFwcEV4dGVuc2lvbiAoYXBwLCBzdXBwb3J0ZWRBcHBFeHRlbnNpb25zKSB7XG4gIGlmIChzdXBwb3J0ZWRBcHBFeHRlbnNpb25zLmluY2x1ZGVzKHBhdGguZXh0bmFtZShhcHApKSkge1xuICAgIHJldHVybiBhcHA7XG4gIH1cbiAgdGhyb3cgbmV3IEVycm9yKGBOZXcgYXBwIHBhdGggJyR7YXBwfScgZGlkIG5vdCBoYXZlIGV4dGVuc2lvbihzKSAnJHtzdXBwb3J0ZWRBcHBFeHRlbnNpb25zfSdgKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY29uZmlndXJlQXBwIChhcHAsIHN1cHBvcnRlZEFwcEV4dGVuc2lvbnMpIHtcbiAgaWYgKCFfLmlzU3RyaW5nKGFwcCkpIHtcbiAgICAvLyBpbW1lZGlhdGVseSBzaG9ydGNpcmN1aXQgaWYgbm90IGdpdmVuIGFuIGFwcFxuICAgIHJldHVybjtcbiAgfVxuICBpZiAoIV8uaXNBcnJheShzdXBwb3J0ZWRBcHBFeHRlbnNpb25zKSkge1xuICAgIHN1cHBvcnRlZEFwcEV4dGVuc2lvbnMgPSBbc3VwcG9ydGVkQXBwRXh0ZW5zaW9uc107XG4gIH1cblxuICBsZXQgbmV3QXBwID0gYXBwO1xuICBsZXQgc2hvdWxkVW56aXBBcHAgPSBmYWxzZTtcbiAgbGV0IGFyY2hpdmVIYXNoID0gbnVsbDtcbiAgbGV0IGN1cnJlbnRNb2RpZmllZCA9IG51bGw7XG4gIGNvbnN0IHtwcm90b2NvbCwgcGF0aG5hbWV9ID0gdXJsLnBhcnNlKG5ld0FwcCk7XG4gIGNvbnN0IGlzVXJsID0gWydodHRwOicsICdodHRwczonXS5pbmNsdWRlcyhwcm90b2NvbCk7XG5cbiAgcmV0dXJuIGF3YWl0IEFQUExJQ0FUSU9OU19DQUNIRV9HVUFSRC5hY3F1aXJlKGFwcCwgYXN5bmMgKCkgPT4ge1xuICAgIGlmIChpc1VybCkge1xuICAgICAgLy8gVXNlIHRoZSBhcHAgZnJvbSByZW1vdGUgVVJMXG4gICAgICBsb2dnZXIuaW5mbyhgVXNpbmcgZG93bmxvYWRhYmxlIGFwcCAnJHtuZXdBcHB9J2ApO1xuICAgICAgY29uc3QgaGVhZGVycyA9IGF3YWl0IHJldHJpZXZlSGVhZGVycyhuZXdBcHApO1xuICAgICAgaWYgKGhlYWRlcnNbJ2xhc3QtbW9kaWZpZWQnXSkge1xuICAgICAgICBsb2dnZXIuZGVidWcoYEFwcCBMYXN0LU1vZGlmaWVkOiAke2hlYWRlcnNbJ2xhc3QtbW9kaWZpZWQnXX1gKTtcbiAgICAgICAgY3VycmVudE1vZGlmaWVkID0gbmV3IERhdGUoaGVhZGVyc1snbGFzdC1tb2RpZmllZCddKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGNhY2hlZFBhdGggPSBnZXRDYWNoZWRBcHBsaWNhdGlvblBhdGgoYXBwLCBjdXJyZW50TW9kaWZpZWQpO1xuICAgICAgaWYgKGNhY2hlZFBhdGgpIHtcbiAgICAgICAgaWYgKGF3YWl0IGZzLmV4aXN0cyhjYWNoZWRQYXRoKSkge1xuICAgICAgICAgIGxvZ2dlci5pbmZvKGBSZXVzaW5nIHByZXZpb3VzbHkgZG93bmxvYWRlZCBhcHBsaWNhdGlvbiBhdCAnJHtjYWNoZWRQYXRofSdgKTtcbiAgICAgICAgICByZXR1cm4gdmVyaWZ5QXBwRXh0ZW5zaW9uKGNhY2hlZFBhdGgsIHN1cHBvcnRlZEFwcEV4dGVuc2lvbnMpO1xuICAgICAgICB9XG4gICAgICAgIGxvZ2dlci5pbmZvKGBUaGUgYXBwbGljYXRpb24gYXQgJyR7Y2FjaGVkUGF0aH0nIGRvZXMgbm90IGV4aXN0IGFueW1vcmUuIERlbGV0aW5nIGl0IGZyb20gdGhlIGNhY2hlYCk7XG4gICAgICAgIEFQUExJQ0FUSU9OU19DQUNIRS5kZWwoYXBwKTtcbiAgICAgIH1cblxuICAgICAgbGV0IGZpbGVOYW1lID0gbnVsbDtcbiAgICAgIGNvbnN0IGJhc2VuYW1lID0gc2FuaXRpemUocGF0aC5iYXNlbmFtZShkZWNvZGVVUklDb21wb25lbnQocGF0aG5hbWUpKSwge1xuICAgICAgICByZXBsYWNlbWVudDogU0FOSVRJWkVfUkVQTEFDRU1FTlRcbiAgICAgIH0pO1xuICAgICAgY29uc3QgZXh0bmFtZSA9IHBhdGguZXh0bmFtZShiYXNlbmFtZSk7XG4gICAgICAvLyB0byBkZXRlcm1pbmUgaWYgd2UgbmVlZCB0byB1bnppcCB0aGUgYXBwLCB3ZSBoYXZlIGEgbnVtYmVyIG9mIHBsYWNlc1xuICAgICAgLy8gdG8gbG9vazogY29udGVudCB0eXBlLCBjb250ZW50IGRpc3Bvc2l0aW9uLCBvciB0aGUgZmlsZSBleHRlbnNpb25cbiAgICAgIGlmIChaSVBfRVhUUy5pbmNsdWRlcyhleHRuYW1lKSkge1xuICAgICAgICBmaWxlTmFtZSA9IGJhc2VuYW1lO1xuICAgICAgICBzaG91bGRVbnppcEFwcCA9IHRydWU7XG4gICAgICB9XG4gICAgICBpZiAoaGVhZGVyc1snY29udGVudC10eXBlJ10pIHtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKGBDb250ZW50LVR5cGU6ICR7aGVhZGVyc1snY29udGVudC10eXBlJ119YCk7XG4gICAgICAgIC8vIHRoZSBmaWxldHlwZSBtYXkgbm90IGJlIG9idmlvdXMgZm9yIGNlcnRhaW4gdXJscywgc28gY2hlY2sgdGhlIG1pbWUgdHlwZSB0b29cbiAgICAgICAgaWYgKFpJUF9NSU1FX1RZUEVTLnNvbWUobWltZVR5cGUgPT4gbmV3IFJlZ0V4cChgXFxcXGIke18uZXNjYXBlUmVnRXhwKG1pbWVUeXBlKX1cXFxcYmApLnRlc3QoaGVhZGVyc1snY29udGVudC10eXBlJ10pKSkge1xuICAgICAgICAgIGlmICghZmlsZU5hbWUpIHtcbiAgICAgICAgICAgIGZpbGVOYW1lID0gYCR7REVGQVVMVF9CQVNFTkFNRX0uemlwYDtcbiAgICAgICAgICB9XG4gICAgICAgICAgc2hvdWxkVW56aXBBcHAgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAoaGVhZGVyc1snY29udGVudC1kaXNwb3NpdGlvbiddICYmIC9eYXR0YWNobWVudC9pLnRlc3QoaGVhZGVyc1snY29udGVudC1kaXNwb3NpdGlvbiddKSkge1xuICAgICAgICBsb2dnZXIuZGVidWcoYENvbnRlbnQtRGlzcG9zaXRpb246ICR7aGVhZGVyc1snY29udGVudC1kaXNwb3NpdGlvbiddfWApO1xuICAgICAgICBjb25zdCBtYXRjaCA9IC9maWxlbmFtZT1cIihbXlwiXSspL2kuZXhlYyhoZWFkZXJzWydjb250ZW50LWRpc3Bvc2l0aW9uJ10pO1xuICAgICAgICBpZiAobWF0Y2gpIHtcbiAgICAgICAgICBmaWxlTmFtZSA9IHNhbml0aXplKG1hdGNoWzFdLCB7XG4gICAgICAgICAgICByZXBsYWNlbWVudDogU0FOSVRJWkVfUkVQTEFDRU1FTlRcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBzaG91bGRVbnppcEFwcCA9IHNob3VsZFVuemlwQXBwIHx8IFpJUF9FWFRTLmluY2x1ZGVzKHBhdGguZXh0bmFtZShmaWxlTmFtZSkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAoIWZpbGVOYW1lKSB7XG4gICAgICAgIC8vIGFzc2lnbiB0aGUgZGVmYXVsdCBmaWxlIG5hbWUgYW5kIHRoZSBleHRlbnNpb24gaWYgbm9uZSBoYXMgYmVlbiBkZXRlY3RlZFxuICAgICAgICBjb25zdCByZXN1bHRpbmdOYW1lID0gYmFzZW5hbWVcbiAgICAgICAgICA/IGJhc2VuYW1lLnN1YnN0cmluZygwLCBiYXNlbmFtZS5sZW5ndGggLSBleHRuYW1lLmxlbmd0aClcbiAgICAgICAgICA6IERFRkFVTFRfQkFTRU5BTUU7XG4gICAgICAgIGxldCByZXN1bHRpbmdFeHQgPSBleHRuYW1lO1xuICAgICAgICBpZiAoIXN1cHBvcnRlZEFwcEV4dGVuc2lvbnMuaW5jbHVkZXMocmVzdWx0aW5nRXh0KSkge1xuICAgICAgICAgIGxvZ2dlci5pbmZvKGBUaGUgY3VycmVudCBmaWxlIGV4dGVuc2lvbiAnJHtyZXN1bHRpbmdFeHR9JyBpcyBub3Qgc3VwcG9ydGVkLiBgICtcbiAgICAgICAgICAgIGBEZWZhdWx0aW5nIHRvICcke18uZmlyc3Qoc3VwcG9ydGVkQXBwRXh0ZW5zaW9ucyl9J2ApO1xuICAgICAgICAgIHJlc3VsdGluZ0V4dCA9IF8uZmlyc3Qoc3VwcG9ydGVkQXBwRXh0ZW5zaW9ucyk7XG4gICAgICAgIH1cbiAgICAgICAgZmlsZU5hbWUgPSBgJHtyZXN1bHRpbmdOYW1lfSR7cmVzdWx0aW5nRXh0fWA7XG4gICAgICB9XG4gICAgICBjb25zdCB0YXJnZXRQYXRoID0gYXdhaXQgdGVtcERpci5wYXRoKHtcbiAgICAgICAgcHJlZml4OiBmaWxlTmFtZSxcbiAgICAgICAgc3VmZml4OiAnJyxcbiAgICAgIH0pO1xuICAgICAgbmV3QXBwID0gYXdhaXQgZG93bmxvYWRBcHAobmV3QXBwLCB0YXJnZXRQYXRoKTtcbiAgICB9IGVsc2UgaWYgKGF3YWl0IGZzLmV4aXN0cyhuZXdBcHApKSB7XG4gICAgICAvLyBVc2UgdGhlIGxvY2FsIGFwcFxuICAgICAgbG9nZ2VyLmluZm8oYFVzaW5nIGxvY2FsIGFwcCAnJHtuZXdBcHB9J2ApO1xuICAgICAgc2hvdWxkVW56aXBBcHAgPSBaSVBfRVhUUy5pbmNsdWRlcyhwYXRoLmV4dG5hbWUobmV3QXBwKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBlcnJvck1lc3NhZ2UgPSBgVGhlIGFwcGxpY2F0aW9uIGF0ICcke25ld0FwcH0nIGRvZXMgbm90IGV4aXN0IG9yIGlzIG5vdCBhY2Nlc3NpYmxlYDtcbiAgICAgIC8vIHByb3RvY29sIHZhbHVlIGZvciAnQzpcXFxcdGVtcCcgaXMgJ2M6Jywgc28gd2UgY2hlY2sgdGhlIGxlbmd0aCBhcyB3ZWxsXG4gICAgICBpZiAoXy5pc1N0cmluZyhwcm90b2NvbCkgJiYgcHJvdG9jb2wubGVuZ3RoID4gMikge1xuICAgICAgICBlcnJvck1lc3NhZ2UgPSBgVGhlIHByb3RvY29sICcke3Byb3RvY29sfScgdXNlZCBpbiAnJHtuZXdBcHB9JyBpcyBub3Qgc3VwcG9ydGVkLiBgICtcbiAgICAgICAgICBgT25seSBodHRwOiBhbmQgaHR0cHM6IHByb3RvY29scyBhcmUgc3VwcG9ydGVkYDtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvck1lc3NhZ2UpO1xuICAgIH1cblxuICAgIGlmIChzaG91bGRVbnppcEFwcCkge1xuICAgICAgY29uc3QgYXJjaGl2ZVBhdGggPSBuZXdBcHA7XG4gICAgICBhcmNoaXZlSGFzaCA9IGF3YWl0IGZzLmhhc2goYXJjaGl2ZVBhdGgpO1xuICAgICAgaWYgKEFQUExJQ0FUSU9OU19DQUNIRS5oYXMoYXBwKSAmJiBhcmNoaXZlSGFzaCA9PT0gQVBQTElDQVRJT05TX0NBQ0hFLmdldChhcHApLmhhc2gpIHtcbiAgICAgICAgY29uc3Qge2Z1bGxQYXRofSA9IEFQUExJQ0FUSU9OU19DQUNIRS5nZXQoYXBwKTtcbiAgICAgICAgaWYgKGF3YWl0IGZzLmV4aXN0cyhmdWxsUGF0aCkpIHtcbiAgICAgICAgICBpZiAoYXJjaGl2ZVBhdGggIT09IGFwcCkge1xuICAgICAgICAgICAgYXdhaXQgZnMucmltcmFmKGFyY2hpdmVQYXRoKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgbG9nZ2VyLmluZm8oYFdpbGwgcmV1c2UgcHJldmlvdXNseSBjYWNoZWQgYXBwbGljYXRpb24gYXQgJyR7ZnVsbFBhdGh9J2ApO1xuICAgICAgICAgIHJldHVybiB2ZXJpZnlBcHBFeHRlbnNpb24oZnVsbFBhdGgsIHN1cHBvcnRlZEFwcEV4dGVuc2lvbnMpO1xuICAgICAgICB9XG4gICAgICAgIGxvZ2dlci5pbmZvKGBUaGUgYXBwbGljYXRpb24gYXQgJyR7ZnVsbFBhdGh9JyBkb2VzIG5vdCBleGlzdCBhbnltb3JlLiBEZWxldGluZyBpdCBmcm9tIHRoZSBjYWNoZWApO1xuICAgICAgICBBUFBMSUNBVElPTlNfQ0FDSEUuZGVsKGFwcCk7XG4gICAgICB9XG4gICAgICBjb25zdCB0bXBSb290ID0gYXdhaXQgdGVtcERpci5vcGVuRGlyKCk7XG4gICAgICB0cnkge1xuICAgICAgICBuZXdBcHAgPSBhd2FpdCB1bnppcEFwcChhcmNoaXZlUGF0aCwgdG1wUm9vdCwgc3VwcG9ydGVkQXBwRXh0ZW5zaW9ucyk7XG4gICAgICB9IGZpbmFsbHkge1xuICAgICAgICBpZiAobmV3QXBwICE9PSBhcmNoaXZlUGF0aCAmJiBhcmNoaXZlUGF0aCAhPT0gYXBwKSB7XG4gICAgICAgICAgYXdhaXQgZnMucmltcmFmKGFyY2hpdmVQYXRoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgbG9nZ2VyLmluZm8oYFVuemlwcGVkIGxvY2FsIGFwcCB0byAnJHtuZXdBcHB9J2ApO1xuICAgIH0gZWxzZSBpZiAoIXBhdGguaXNBYnNvbHV0ZShuZXdBcHApKSB7XG4gICAgICBuZXdBcHAgPSBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgbmV3QXBwKTtcbiAgICAgIGxvZ2dlci53YXJuKGBUaGUgY3VycmVudCBhcHBsaWNhdGlvbiBwYXRoICcke2FwcH0nIGlzIG5vdCBhYnNvbHV0ZSBgICtcbiAgICAgICAgYGFuZCBoYXMgYmVlbiByZXdyaXR0ZW4gdG8gJyR7bmV3QXBwfScuIENvbnNpZGVyIHVzaW5nIGFic29sdXRlIHBhdGhzIHJhdGhlciB0aGFuIHJlbGF0aXZlYCk7XG4gICAgICBhcHAgPSBuZXdBcHA7XG4gICAgfVxuXG4gICAgdmVyaWZ5QXBwRXh0ZW5zaW9uKG5ld0FwcCwgc3VwcG9ydGVkQXBwRXh0ZW5zaW9ucyk7XG5cbiAgICBpZiAoYXBwICE9PSBuZXdBcHAgJiYgKGFyY2hpdmVIYXNoIHx8IGN1cnJlbnRNb2RpZmllZCkpIHtcbiAgICAgIGlmIChBUFBMSUNBVElPTlNfQ0FDSEUuaGFzKGFwcCkpIHtcbiAgICAgICAgY29uc3Qge2Z1bGxQYXRofSA9IEFQUExJQ0FUSU9OU19DQUNIRS5nZXQoYXBwKTtcbiAgICAgICAgLy8gQ2xlYW4gdXAgdGhlIG9ic29sZXRlIGVudHJ5IGZpcnN0IGlmIG5lZWRlZFxuICAgICAgICBpZiAoZnVsbFBhdGggIT09IG5ld0FwcCAmJiBhd2FpdCBmcy5leGlzdHMoZnVsbFBhdGgpKSB7XG4gICAgICAgICAgYXdhaXQgZnMucmltcmFmKGZ1bGxQYXRoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgQVBQTElDQVRJT05TX0NBQ0hFLnNldChhcHAsIHtcbiAgICAgICAgaGFzaDogYXJjaGl2ZUhhc2gsXG4gICAgICAgIGxhc3RNb2RpZmllZDogY3VycmVudE1vZGlmaWVkLFxuICAgICAgICBmdWxsUGF0aDogbmV3QXBwLFxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBuZXdBcHA7XG4gIH0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBkb3dubG9hZEFwcCAoYXBwLCB0YXJnZXRQYXRoKSB7XG4gIGNvbnN0IHtocmVmfSA9IHVybC5wYXJzZShhcHApO1xuICBjb25zdCB0aW1lciA9IG5ldyB0aW1pbmcuVGltZXIoKS5zdGFydCgpO1xuICB0cnkge1xuICAgIC8vIGRvbid0IHVzZSByZXF1ZXN0LXByb21pc2UgaGVyZSwgd2UgbmVlZCBzdHJlYW1zXG4gICAgYXdhaXQgbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgcmVxdWVzdChocmVmKVxuICAgICAgICAub24oJ2Vycm9yJywgcmVqZWN0KSAvLyBoYW5kbGUgcmVhbCBlcnJvcnMsIGxpa2UgY29ubmVjdGlvbiBlcnJvcnNcbiAgICAgICAgLm9uKCdyZXNwb25zZScsIChyZXMpID0+IHtcbiAgICAgICAgICAvLyBoYW5kbGUgcmVzcG9uc2VzIHRoYXQgZmFpbCwgbGlrZSA0MDRzXG4gICAgICAgICAgaWYgKHJlcy5zdGF0dXNDb2RlID49IDQwMCkge1xuICAgICAgICAgICAgcmV0dXJuIHJlamVjdChuZXcgRXJyb3IoYCR7cmVzLnN0YXR1c0NvZGV9IC0gJHtyZXMuc3RhdHVzTWVzc2FnZX1gKSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgICAucGlwZShfZnMuY3JlYXRlV3JpdGVTdHJlYW0odGFyZ2V0UGF0aCkpXG4gICAgICAgIC5vbignY2xvc2UnLCByZXNvbHZlKTtcbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBQcm9ibGVtIGRvd25sb2FkaW5nIGFwcCBmcm9tIHVybCAke2hyZWZ9OiAke2Vyci5tZXNzYWdlfWApO1xuICB9XG4gIGNvbnN0IHNlY29uZHNFbGFwc2VkID0gdGltZXIuZ2V0RHVyYXRpb24oKS5hc1NlY29uZHM7XG4gIGNvbnN0IHtzaXplfSA9IGF3YWl0IGZzLnN0YXQodGFyZ2V0UGF0aCk7XG4gIGxvZ2dlci5kZWJ1ZyhgJyR7aHJlZn0nICgke3V0aWwudG9SZWFkYWJsZVNpemVTdHJpbmcoc2l6ZSl9KSBgICtcbiAgICBgaGFzIGJlZW4gZG93bmxvYWRlZCB0byAnJHt0YXJnZXRQYXRofScgaW4gJHtzZWNvbmRzRWxhcHNlZC50b0ZpeGVkKDMpfXNgKTtcbiAgaWYgKHNlY29uZHNFbGFwc2VkID49IDIpIHtcbiAgICBjb25zdCBieXRlc1BlclNlYyA9IE1hdGguZmxvb3Ioc2l6ZSAvIHNlY29uZHNFbGFwc2VkKTtcbiAgICBsb2dnZXIuZGVidWcoYEFwcHJveGltYXRlIGRvd25sb2FkIHNwZWVkOiAke3V0aWwudG9SZWFkYWJsZVNpemVTdHJpbmcoYnl0ZXNQZXJTZWMpfS9zYCk7XG4gIH1cbiAgcmV0dXJuIHRhcmdldFBhdGg7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVuemlwQXBwICh6aXBQYXRoLCBkc3RSb290LCBzdXBwb3J0ZWRBcHBFeHRlbnNpb25zKSB7XG4gIGF3YWl0IHppcC5hc3NlcnRWYWxpZFppcCh6aXBQYXRoKTtcblxuICBpZiAoIV8uaXNBcnJheShzdXBwb3J0ZWRBcHBFeHRlbnNpb25zKSkge1xuICAgIHN1cHBvcnRlZEFwcEV4dGVuc2lvbnMgPSBbc3VwcG9ydGVkQXBwRXh0ZW5zaW9uc107XG4gIH1cblxuICBjb25zdCB0bXBSb290ID0gYXdhaXQgdGVtcERpci5vcGVuRGlyKCk7XG4gIHRyeSB7XG4gICAgbG9nZ2VyLmRlYnVnKGBVbnppcHBpbmcgJyR7emlwUGF0aH0nYCk7XG4gICAgYXdhaXQgemlwLmV4dHJhY3RBbGxUbyh6aXBQYXRoLCB0bXBSb290KTtcbiAgICBjb25zdCBhbGxFeHRyYWN0ZWRJdGVtcyA9IFtdO1xuICAgIGF3YWl0IGZzLndhbGtEaXIodG1wUm9vdCwgdHJ1ZSwgKGl0ZW1QYXRoKSA9PiB2b2lkIGFsbEV4dHJhY3RlZEl0ZW1zLnB1c2goaXRlbVBhdGgpKTtcbiAgICBsb2dnZXIuZGVidWcoYEV4dHJhY3RlZCAke2FsbEV4dHJhY3RlZEl0ZW1zLmxlbmd0aH0gaXRlbShzKSBmcm9tICcke3ppcFBhdGh9J2ApO1xuICAgIGNvbnN0IGlzU3VwcG9ydGVkQXBwSXRlbSA9IChyZWxhdGl2ZVBhdGgpID0+IHN1cHBvcnRlZEFwcEV4dGVuc2lvbnMuaW5jbHVkZXMocGF0aC5leHRuYW1lKHJlbGF0aXZlUGF0aCkpXG4gICAgICB8fCBfLnNvbWUoc3VwcG9ydGVkQXBwRXh0ZW5zaW9ucywgKHgpID0+IHJlbGF0aXZlUGF0aC5pbmNsdWRlcyhgJHt4fSR7cGF0aC5zZXB9YCkpO1xuICAgIGNvbnN0IGl0ZW1zVG9LZWVwID0gYWxsRXh0cmFjdGVkSXRlbXNcbiAgICAgIC5tYXAoKGl0ZW1QYXRoKSA9PiBwYXRoLnJlbGF0aXZlKHRtcFJvb3QsIGl0ZW1QYXRoKSlcbiAgICAgIC5maWx0ZXIoKHJlbGF0aXZlUGF0aCkgPT4gaXNTdXBwb3J0ZWRBcHBJdGVtKHJlbGF0aXZlUGF0aCkpXG4gICAgICAubWFwKChyZWxhdGl2ZVBhdGgpID0+IHBhdGgucmVzb2x2ZSh0bXBSb290LCByZWxhdGl2ZVBhdGgpKTtcbiAgICBjb25zdCBpdGVtc1RvUmVtb3ZlID0gXy5kaWZmZXJlbmNlKGFsbEV4dHJhY3RlZEl0ZW1zLCBpdGVtc1RvS2VlcClcbiAgICAgIC8vIEF2b2lkIHBhcmVudCBmb2xkZXJzIHRvIGJlIHJlY3Vyc2l2ZWx5IHJlbW92ZWRcbiAgICAgIC5maWx0ZXIoKGl0ZW1Ub1JlbW92ZVBhdGgpID0+ICFfLnNvbWUoaXRlbXNUb0tlZXAsIChpdGVtVG9LZWVwUGF0aCkgPT4gaXRlbVRvS2VlcFBhdGguc3RhcnRzV2l0aChpdGVtVG9SZW1vdmVQYXRoKSkpO1xuICAgIGF3YWl0IEIuYWxsKGl0ZW1zVG9SZW1vdmUsIGFzeW5jIChpdGVtUGF0aCkgPT4ge1xuICAgICAgaWYgKGF3YWl0IGZzLmV4aXN0cyhpdGVtUGF0aCkpIHtcbiAgICAgICAgYXdhaXQgZnMucmltcmFmKGl0ZW1QYXRoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBsZXQgYWxsQnVuZGxlSXRlbXMgPSBbXTtcbiAgICBhd2FpdCBmcy53YWxrRGlyKHRtcFJvb3QsIHRydWUsIChpdGVtUGF0aCkgPT4gdm9pZCBhbGxCdW5kbGVJdGVtcy5wdXNoKGl0ZW1QYXRoKSk7XG4gICAgYWxsQnVuZGxlSXRlbXMgPSBhbGxCdW5kbGVJdGVtc1xuICAgICAgLm1hcCgoaXRlbVBhdGgpID0+IHBhdGgucmVsYXRpdmUodG1wUm9vdCwgaXRlbVBhdGgpKVxuICAgICAgLmZpbHRlcigocmVsYXRpdmVQYXRoKSA9PiBpc1N1cHBvcnRlZEFwcEl0ZW0ocmVsYXRpdmVQYXRoKSlcbiAgICAgIC8vIEdldCB0aGUgdG9wIGxldmVsIG1hdGNoXG4gICAgICAuc29ydCgoYSwgYikgPT4gYS5zcGxpdChwYXRoLnNlcCkubGVuZ3RoIC0gYi5zcGxpdChwYXRoLnNlcCkubGVuZ3RoKTtcbiAgICBpZiAoXy5pc0VtcHR5KGFsbEJ1bmRsZUl0ZW1zKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBBcHAgemlwIHVuemlwcGVkIE9LLCBidXQgd2UgY291bGQgbm90IGZpbmQgJHtzdXBwb3J0ZWRBcHBFeHRlbnNpb25zfSBidW5kbGUocykgYCArXG4gICAgICAgIGBpbiBpdC4gTWFrZSBzdXJlIHlvdXIgYXJjaGl2ZSBjb250YWlucyAke3N1cHBvcnRlZEFwcEV4dGVuc2lvbnN9IHBhY2thZ2UocykgYCArXG4gICAgICAgIGBhbmQgbm90aGluZyBlbHNlYCk7XG4gICAgfVxuICAgIGNvbnN0IG1hdGNoZWRCdW5kbGUgPSBfLmZpcnN0KGFsbEJ1bmRsZUl0ZW1zKTtcbiAgICBsb2dnZXIuZGVidWcoYE1hdGNoZWQgJHthbGxCdW5kbGVJdGVtcy5sZW5ndGh9IGl0ZW0ocykgaW4gdGhlIGV4dHJhY3RlZCBhcmNoaXZlLiBgICtcbiAgICAgIGBBc3N1bWluZyAnJHttYXRjaGVkQnVuZGxlfScgaXMgdGhlIGNvcnJlY3QgYnVuZGxlYCk7XG4gICAgYXdhaXQgZnMubXYocGF0aC5yZXNvbHZlKHRtcFJvb3QsIG1hdGNoZWRCdW5kbGUpLCBwYXRoLnJlc29sdmUoZHN0Um9vdCwgbWF0Y2hlZEJ1bmRsZSksIHtcbiAgICAgIG1rZGlycDogdHJ1ZVxuICAgIH0pO1xuICAgIHJldHVybiBwYXRoLnJlc29sdmUoZHN0Um9vdCwgbWF0Y2hlZEJ1bmRsZSk7XG4gIH0gZmluYWxseSB7XG4gICAgYXdhaXQgZnMucmltcmFmKHRtcFJvb3QpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGlzUGFja2FnZU9yQnVuZGxlIChhcHApIHtcbiAgcmV0dXJuICgvXihbYS16QS1aMC05XFwtX10rXFwuW2EtekEtWjAtOVxcLV9dKykrJC8pLnRlc3QoYXBwKTtcbn1cblxuZnVuY3Rpb24gZ2V0Q29vcmREZWZhdWx0ICh2YWwpIHtcbiAgLy8gZ29pbmcgdGhlIGxvbmcgd2F5IGFuZCBjaGVja2luZyBmb3IgdW5kZWZpbmVkIGFuZCBudWxsIHNpbmNlXG4gIC8vIHdlIGNhbid0IGJlIGFzc3VyZWQgYGVsSWRgIGlzIGEgc3RyaW5nIGFuZCBub3QgYW4gaW50LiBTYW1lXG4gIC8vIHRoaW5nIHdpdGggZGVzdEVsZW1lbnQgYmVsb3cuXG4gIHJldHVybiB1dGlsLmhhc1ZhbHVlKHZhbCkgPyB2YWwgOiAwLjU7XG59XG5cbmZ1bmN0aW9uIGdldFN3aXBlVG91Y2hEdXJhdGlvbiAod2FpdEdlc3R1cmUpIHtcbiAgLy8gdGhlIHRvdWNoIGFjdGlvbiBhcGkgdXNlcyBtcywgd2Ugd2FudCBzZWNvbmRzXG4gIC8vIDAuOCBpcyB0aGUgZGVmYXVsdCB0aW1lIGZvciB0aGUgb3BlcmF0aW9uXG4gIGxldCBkdXJhdGlvbiA9IDAuODtcbiAgaWYgKHR5cGVvZiB3YWl0R2VzdHVyZS5vcHRpb25zLm1zICE9PSAndW5kZWZpbmVkJyAmJiB3YWl0R2VzdHVyZS5vcHRpb25zLm1zKSB7XG4gICAgZHVyYXRpb24gPSB3YWl0R2VzdHVyZS5vcHRpb25zLm1zIC8gMTAwMDtcbiAgICBpZiAoZHVyYXRpb24gPT09IDApIHtcbiAgICAgIC8vIHNldCB0byBhIHZlcnkgbG93IG51bWJlciwgc2luY2UgdGhleSB3YW50ZWQgaXQgZmFzdFxuICAgICAgLy8gYnV0IGJlbG93IDAuMSBiZWNvbWVzIDAgc3RlcHMsIHdoaWNoIGNhdXNlcyBlcnJvcnNcbiAgICAgIGR1cmF0aW9uID0gMC4xO1xuICAgIH1cbiAgfVxuICByZXR1cm4gZHVyYXRpb247XG59XG5cbi8qKlxuICogRmluZHMgYWxsIGluc3RhbmNlcyAnZmlyc3RLZXknIGFuZCBjcmVhdGUgYSBkdXBsaWNhdGUgd2l0aCB0aGUga2V5ICdzZWNvbmRLZXknLFxuICogRG8gdGhlIHNhbWUgdGhpbmcgaW4gcmV2ZXJzZS4gSWYgd2UgZmluZCAnc2Vjb25kS2V5JywgY3JlYXRlIGEgZHVwbGljYXRlIHdpdGggdGhlIGtleSAnZmlyc3RLZXknLlxuICpcbiAqIFRoaXMgd2lsbCBjYXVzZSBrZXlzIHRvIGJlIG92ZXJ3cml0dGVuIGlmIHRoZSBvYmplY3QgY29udGFpbnMgJ2ZpcnN0S2V5JyBhbmQgJ3NlY29uZEtleScuXG5cbiAqIEBwYXJhbSB7Kn0gaW5wdXQgQW55IHR5cGUgb2YgaW5wdXRcbiAqIEBwYXJhbSB7U3RyaW5nfSBmaXJzdEtleSBUaGUgZmlyc3Qga2V5IHRvIGR1cGxpY2F0ZVxuICogQHBhcmFtIHtTdHJpbmd9IHNlY29uZEtleSBUaGUgc2Vjb25kIGtleSB0byBkdXBsaWNhdGVcbiAqL1xuZnVuY3Rpb24gZHVwbGljYXRlS2V5cyAoaW5wdXQsIGZpcnN0S2V5LCBzZWNvbmRLZXkpIHtcbiAgLy8gSWYgYXJyYXkgcHJvdmlkZWQsIHJlY3Vyc2l2ZWx5IGNhbGwgb24gYWxsIGVsZW1lbnRzXG4gIGlmIChfLmlzQXJyYXkoaW5wdXQpKSB7XG4gICAgcmV0dXJuIGlucHV0Lm1hcCgoaXRlbSkgPT4gZHVwbGljYXRlS2V5cyhpdGVtLCBmaXJzdEtleSwgc2Vjb25kS2V5KSk7XG4gIH1cblxuICAvLyBJZiBvYmplY3QsIGNyZWF0ZSBkdXBsaWNhdGVzIGZvciBrZXlzIGFuZCB0aGVuIHJlY3Vyc2l2ZWx5IGNhbGwgb24gdmFsdWVzXG4gIGlmIChfLmlzUGxhaW5PYmplY3QoaW5wdXQpKSB7XG4gICAgY29uc3QgcmVzdWx0T2JqID0ge307XG4gICAgZm9yIChsZXQgW2tleSwgdmFsdWVdIG9mIF8udG9QYWlycyhpbnB1dCkpIHtcbiAgICAgIGNvbnN0IHJlY3Vyc2l2ZWx5Q2FsbGVkVmFsdWUgPSBkdXBsaWNhdGVLZXlzKHZhbHVlLCBmaXJzdEtleSwgc2Vjb25kS2V5KTtcbiAgICAgIGlmIChrZXkgPT09IGZpcnN0S2V5KSB7XG4gICAgICAgIHJlc3VsdE9ialtzZWNvbmRLZXldID0gcmVjdXJzaXZlbHlDYWxsZWRWYWx1ZTtcbiAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSBzZWNvbmRLZXkpIHtcbiAgICAgICAgcmVzdWx0T2JqW2ZpcnN0S2V5XSA9IHJlY3Vyc2l2ZWx5Q2FsbGVkVmFsdWU7XG4gICAgICB9XG4gICAgICByZXN1bHRPYmpba2V5XSA9IHJlY3Vyc2l2ZWx5Q2FsbGVkVmFsdWU7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHRPYmo7XG4gIH1cblxuICAvLyBCYXNlIGNhc2UuIFJldHVybiBwcmltaXRpdmVzIHdpdGhvdXQgZG9pbmcgYW55dGhpbmcuXG4gIHJldHVybiBpbnB1dDtcbn1cblxuLyoqXG4gKiBUYWtlcyBhIGRlc2lyZWQgY2FwYWJpbGl0eSBhbmQgdHJpZXMgdG8gSlNPTi5wYXJzZSBpdCBhcyBhbiBhcnJheSxcbiAqIGFuZCBlaXRoZXIgcmV0dXJucyB0aGUgcGFyc2VkIGFycmF5IG9yIGEgc2luZ2xldG9uIGFycmF5LlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfEFycmF5PFN0cmluZz59IGNhcCBBIGRlc2lyZWQgY2FwYWJpbGl0eVxuICovXG5mdW5jdGlvbiBwYXJzZUNhcHNBcnJheSAoY2FwKSB7XG4gIGlmIChfLmlzQXJyYXkoY2FwKSkge1xuICAgIHJldHVybiBjYXA7XG4gIH1cblxuICBsZXQgcGFyc2VkQ2FwcztcbiAgdHJ5IHtcbiAgICBwYXJzZWRDYXBzID0gSlNPTi5wYXJzZShjYXApO1xuICAgIGlmIChfLmlzQXJyYXkocGFyc2VkQ2FwcykpIHtcbiAgICAgIHJldHVybiBwYXJzZWRDYXBzO1xuICAgIH1cbiAgfSBjYXRjaCAoaWduKSB7XG4gICAgbG9nZ2VyLndhcm4oYEZhaWxlZCB0byBwYXJzZSBjYXBhYmlsaXR5IGFzIEpTT04gYXJyYXlgKTtcbiAgfVxuICBpZiAoXy5pc1N0cmluZyhjYXApKSB7XG4gICAgcmV0dXJuIFtjYXBdO1xuICB9XG4gIHRocm93IG5ldyBFcnJvcihgbXVzdCBwcm92aWRlIGEgc3RyaW5nIG9yIEpTT04gQXJyYXk7IHJlY2VpdmVkICR7Y2FwfWApO1xufVxuXG5leHBvcnQge1xuICBjb25maWd1cmVBcHAsIGlzUGFja2FnZU9yQnVuZGxlLCBnZXRDb29yZERlZmF1bHQsIGdldFN3aXBlVG91Y2hEdXJhdGlvbiwgZHVwbGljYXRlS2V5cywgcGFyc2VDYXBzQXJyYXlcbn07XG4iXSwiZmlsZSI6ImxpYi9iYXNlZHJpdmVyL2hlbHBlcnMuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
