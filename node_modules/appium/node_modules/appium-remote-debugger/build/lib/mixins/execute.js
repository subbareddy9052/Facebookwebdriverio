"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger"));

var _appiumBaseDriver = require("appium-base-driver");

var _utils = require("../utils");

var _atoms = require("../atoms");

var _appiumSupport = require("appium-support");

var _asyncbox = require("asyncbox");

var _lodash = _interopRequireDefault(require("lodash"));

const RPC_RESPONSE_TIMEOUT_MS = 5000;

async function executeAtom(atom, args, frames) {
  if (!this.rpcClient.isConnected) {
    throw new Error('Remote debugger is not connected');
  }

  _logger.default.debug(`Executing atom '${atom}'`);

  const script = await (0, _atoms.getScriptForAtom)(atom, args, frames);
  const value = await this.execute(script, true);

  _logger.default.debug(`Received result for atom '${atom}' execution: ${_lodash.default.truncate((0, _utils.simpleStringify)(value), {
    length: _utils.RESPONSE_LOG_LENGTH
  })}`);

  return value;
}

async function executeAtomAsync(atom, args, frames) {
  const evaluate = async (method, opts) => await this.rpcClient.send(method, Object.assign({
    appIdKey: this.appIdKey,
    pageIdKey: this.pageIdKey,
    returnByValue: false
  }, opts));

  const promiseName = `appiumAsyncExecutePromise${_appiumSupport.util.uuidV4().replace(/-/g, '')}`;
  const script = `var res, rej;
    window.${promiseName} = new Promise(function (resolve, reject) {
      res = resolve;
      rej = reject;
    });
    window.${promiseName}.resolve = res;
    window.${promiseName}.reject = rej;
    window.${promiseName};`;
  const obj = await evaluate('Runtime.evaluate', {
    command: script
  });
  const promiseObjectId = obj.result.objectId;
  const asyncCallBack = `function (res) {
      window.${promiseName}.resolve(res);
      window.${promiseName}Value = res;
    }`;
  await this.execute((await (0, _atoms.getScriptForAtom)(atom, args, frames, asyncCallBack)));
  let res;
  const subcommandTimeout = 1000;

  try {
    res = await evaluate('Runtime.awaitPromise', {
      promiseObjectId
    });
  } catch (err) {
    if (!err.message.includes(`'Runtime.awaitPromise' was not found`)) {
      throw err;
    }

    const retryWait = 100;
    const timeout = args.length >= 3 ? args[2] : RPC_RESPONSE_TIMEOUT_MS;
    const retries = parseInt(timeout / retryWait, 10) || 1;
    const timer = new _appiumSupport.timing.Timer().start();

    _logger.default.debug(`Waiting up to ${timeout}ms for async execute to finish`);

    res = await (0, _asyncbox.retryInterval)(retries, retryWait, async () => {
      const hasValue = await evaluate('Runtime.evaluate', {
        command: `window.hasOwnProperty('${promiseName}Value');`
      });

      if (hasValue) {
        return await evaluate('Runtime.evaluate', {
          command: `window.${promiseName}Value;`
        });
      }

      throw new _appiumBaseDriver.errors.TimeoutError(`Timed out waiting for asynchronous script ` + `result after ${timer.getDuration().asMilliSeconds.toFixed(0)}ms'));`);
    });
  } finally {
    try {
      await this.executeAtom('execute_script', [`delete window.${promiseName};`, [null, null], subcommandTimeout], frames);
    } catch (ign) {}
  }

  return (0, _utils.convertResult)(res);
}

async function execute(command, override) {
  if (this.pageLoading && !override) {
    _logger.default.debug('Trying to execute but page is not loaded.');

    await this.waitForDom();
  }

  (0, _utils.checkParams)({
    appIdKey: this.appIdKey,
    pageIdKey: this.pageIdKey
  });

  if (this.garbageCollectOnExecute) {
    await this.garbageCollect();
  }

  _logger.default.debug(`Sending javascript command: '${_lodash.default.truncate(command, {
    length: 50
  })}'`);

  const res = await this.rpcClient.send('Runtime.evaluate', {
    command,
    appIdKey: this.appIdKey,
    pageIdKey: this.pageIdKey
  });
  return (0, _utils.convertResult)(res);
}

async function callFunction(objId, fn, args) {
  (0, _utils.checkParams)({
    appIdKey: this.appIdKey,
    pageIdKey: this.pageIdKey
  });

  if (this.garbageCollectOnExecute) {
    await this.garbageCollect();
  }

  _logger.default.debug('Calling javascript function');

  const res = await this.rpcClient.send('Runtime.callFunctionOn', {
    objId,
    fn,
    args,
    appIdKey: this.appIdKey,
    pageIdKey: this.pageIdKey
  });
  return (0, _utils.convertResult)(res);
}

var _default = {
  executeAtom,
  executeAtomAsync,
  execute,
  callFunction
};
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9taXhpbnMvZXhlY3V0ZS5qcyJdLCJuYW1lcyI6WyJSUENfUkVTUE9OU0VfVElNRU9VVF9NUyIsImV4ZWN1dGVBdG9tIiwiYXRvbSIsImFyZ3MiLCJmcmFtZXMiLCJycGNDbGllbnQiLCJpc0Nvbm5lY3RlZCIsIkVycm9yIiwibG9nIiwiZGVidWciLCJzY3JpcHQiLCJ2YWx1ZSIsImV4ZWN1dGUiLCJfIiwidHJ1bmNhdGUiLCJsZW5ndGgiLCJSRVNQT05TRV9MT0dfTEVOR1RIIiwiZXhlY3V0ZUF0b21Bc3luYyIsImV2YWx1YXRlIiwibWV0aG9kIiwib3B0cyIsInNlbmQiLCJPYmplY3QiLCJhc3NpZ24iLCJhcHBJZEtleSIsInBhZ2VJZEtleSIsInJldHVybkJ5VmFsdWUiLCJwcm9taXNlTmFtZSIsInV0aWwiLCJ1dWlkVjQiLCJyZXBsYWNlIiwib2JqIiwiY29tbWFuZCIsInByb21pc2VPYmplY3RJZCIsInJlc3VsdCIsIm9iamVjdElkIiwiYXN5bmNDYWxsQmFjayIsInJlcyIsInN1YmNvbW1hbmRUaW1lb3V0IiwiZXJyIiwibWVzc2FnZSIsImluY2x1ZGVzIiwicmV0cnlXYWl0IiwidGltZW91dCIsInJldHJpZXMiLCJwYXJzZUludCIsInRpbWVyIiwidGltaW5nIiwiVGltZXIiLCJzdGFydCIsImhhc1ZhbHVlIiwiZXJyb3JzIiwiVGltZW91dEVycm9yIiwiZ2V0RHVyYXRpb24iLCJhc01pbGxpU2Vjb25kcyIsInRvRml4ZWQiLCJpZ24iLCJvdmVycmlkZSIsInBhZ2VMb2FkaW5nIiwid2FpdEZvckRvbSIsImdhcmJhZ2VDb2xsZWN0T25FeGVjdXRlIiwiZ2FyYmFnZUNvbGxlY3QiLCJjYWxsRnVuY3Rpb24iLCJvYmpJZCIsImZuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUlBLE1BQU1BLHVCQUF1QixHQUFHLElBQWhDOztBQUVBLGVBQWVDLFdBQWYsQ0FBNEJD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QUEsZ0JBQWY7QUFBaUNMLEVBQUFBLE9BQWpDO0FBQTBDa0QsRUFBQUE7QUFBMUMsQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyBjaGVja1BhcmFtcywgc2ltcGxlU3RyaW5naWZ5LCBjb252ZXJ0UmVzdWx0LCBSRVNQT05TRV9MT0dfTEVOR1RIIH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IHsgZ2V0U2NyaXB0Rm9yQXRvbSB9IGZyb20gJy4uL2F0b21zJztcbmltcG9ydCB7IHV0aWwsIHRpbWluZyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IHJldHJ5SW50ZXJ2YWwgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuXG5cbi8qIEhvdyBtYW55IG1pbGxpc2Vjb25kcyB0byB3YWl0IGZvciB3ZWJraXQgdG8gcmV0dXJuIGEgcmVzcG9uc2UgYmVmb3JlIHRpbWluZyBvdXQgKi9cbmNvbnN0IFJQQ19SRVNQT05TRV9USU1FT1VUX01TID0gNTAwMDtcblxuYXN5bmMgZnVuY3Rpb24gZXhlY3V0ZUF0b20gKGF0b20sIGFyZ3MsIGZyYW1lcykge1xuICBpZiAoIXRoaXMucnBjQ2xpZW50LmlzQ29ubmVjdGVkKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdSZW1vdGUgZGVidWdnZXIgaXMgbm90IGNvbm5lY3RlZCcpO1xuICB9XG5cbiAgbG9nLmRlYnVnKGBFeGVjdXRpbmcgYXRvbSAnJHthdG9tfSdgKTtcbiAgY29uc3Qgc2NyaXB0ID0gYXdhaXQgZ2V0U2NyaXB0Rm9yQXRvbShhdG9tLCBhcmdzLCBmcmFtZXMpO1xuICBjb25zdCB2YWx1ZSA9IGF3YWl0IHRoaXMuZXhlY3V0ZShzY3JpcHQsIHRydWUpO1xuICBsb2cuZGVidWcoYFJlY2VpdmVkIHJlc3VsdCBmb3IgYXRvbSAnJHthdG9tfScgZXhlY3V0aW9uOiAke18udHJ1bmNhdGUoc2ltcGxlU3RyaW5naWZ5KHZhbHVlKSwge2xlbmd0aDogUkVTUE9OU0VfTE9HX0xFTkdUSH0pfWApO1xuICByZXR1cm4gdmFsdWU7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGV4ZWN1dGVBdG9tQXN5bmMgKGF0b20sIGFyZ3MsIGZyYW1lcykge1xuICAvLyBoZWxwZXIgdG8gc2VuZCBkaXJlY3RseSB0byB0aGUgd2ViIGluc3BlY3RvclxuICBjb25zdCBldmFsdWF0ZSA9IGFzeW5jIChtZXRob2QsIG9wdHMpID0+IGF3YWl0IHRoaXMucnBjQ2xpZW50LnNlbmQobWV0aG9kLCBPYmplY3QuYXNzaWduKHtcbiAgICBhcHBJZEtleTogdGhpcy5hcHBJZEtleSxcbiAgICBwYWdlSWRLZXk6IHRoaXMucGFnZUlkS2V5LFxuICAgIHJldHVybkJ5VmFsdWU6IGZhbHNlLFxuICB9LCBvcHRzKSk7XG5cbiAgLy8gZmlyc3QgY3JlYXRlIGEgUHJvbWlzZSBvbiB0aGUgcGFnZSwgc2F2aW5nIHRoZSByZXNvbHZlL3JlamVjdCBmdW5jdGlvbnNcbiAgLy8gYXMgcHJvcGVydGllc1xuICBjb25zdCBwcm9taXNlTmFtZSA9IGBhcHBpdW1Bc3luY0V4ZWN1dGVQcm9taXNlJHt1dGlsLnV1aWRWNCgpLnJlcGxhY2UoLy0vZywgJycpfWA7XG4gIGNvbnN0IHNjcmlwdCA9XG4gICAgYHZhciByZXMsIHJlajtcbiAgICB3aW5kb3cuJHtwcm9taXNlTmFtZX0gPSBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICByZXMgPSByZXNvbHZlO1xuICAgICAgcmVqID0gcmVqZWN0O1xuICAgIH0pO1xuICAgIHdpbmRvdy4ke3Byb21pc2VOYW1lfS5yZXNvbHZlID0gcmVzO1xuICAgIHdpbmRvdy4ke3Byb21pc2VOYW1lfS5yZWplY3QgPSByZWo7XG4gICAgd2luZG93LiR7cHJvbWlzZU5hbWV9O2A7XG4gIGNvbnN0IG9iaiA9IGF3YWl0IGV2YWx1YXRlKCdSdW50aW1lLmV2YWx1YXRlJywge2NvbW1hbmQ6IHNjcmlwdH0pO1xuICBjb25zdCBwcm9taXNlT2JqZWN0SWQgPSBvYmoucmVzdWx0Lm9iamVjdElkO1xuXG4gIC8vIGV4ZWN1dGUgdGhlIGF0b20sIGNhbGxpbmcgYmFjayB0byB0aGUgcmVzb2x2ZSBmdW5jdGlvblxuICBjb25zdCBhc3luY0NhbGxCYWNrID1cbiAgICBgZnVuY3Rpb24gKHJlcykge1xuICAgICAgd2luZG93LiR7cHJvbWlzZU5hbWV9LnJlc29sdmUocmVzKTtcbiAgICAgIHdpbmRvdy4ke3Byb21pc2VOYW1lfVZhbHVlID0gcmVzO1xuICAgIH1gO1xuICBhd2FpdCB0aGlzLmV4ZWN1dGUoYXdhaXQgZ2V0U2NyaXB0Rm9yQXRvbShhdG9tLCBhcmdzLCBmcmFtZXMsIGFzeW5jQ2FsbEJhY2spKTtcblxuICAvLyB3YWl0IGZvciB0aGUgcHJvbWlzZSB0byBiZSByZXNvbHZlZFxuICBsZXQgcmVzO1xuICBjb25zdCBzdWJjb21tYW5kVGltZW91dCA9IDEwMDA7IC8vIHRpbWVvdXQgb24gaW5kaXZpZHVhbCBjb21tYW5kc1xuICB0cnkge1xuICAgIHJlcyA9IGF3YWl0IGV2YWx1YXRlKCdSdW50aW1lLmF3YWl0UHJvbWlzZScsIHtwcm9taXNlT2JqZWN0SWR9KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKCFlcnIubWVzc2FnZS5pbmNsdWRlcyhgJ1J1bnRpbWUuYXdhaXRQcm9taXNlJyB3YXMgbm90IGZvdW5kYCkpIHtcbiAgICAgIHRocm93IGVycjtcbiAgICB9XG4gICAgLy8gYXdhaXRQcm9taXNlIGlzIG5vdCBhbHdheXMgYXZhaWxhYmxlLCBzbyBzaW11bGF0ZSBpdCB3aXRoIHBvbGxcbiAgICBjb25zdCByZXRyeVdhaXQgPSAxMDA7XG4gICAgY29uc3QgdGltZW91dCA9IChhcmdzLmxlbmd0aCA+PSAzKSA/IGFyZ3NbMl0gOiBSUENfUkVTUE9OU0VfVElNRU9VVF9NUztcbiAgICAvLyBpZiB0aGUgdGltZW91dCBtYXRoIHR1cm5zIHVwIDAgcmV0cmllcywgbWFrZSBzdXJlIGl0IGhhcHBlbnMgb25jZVxuICAgIGNvbnN0IHJldHJpZXMgPSBwYXJzZUludCh0aW1lb3V0IC8gcmV0cnlXYWl0LCAxMCkgfHwgMTtcbiAgICBjb25zdCB0aW1lciA9IG5ldyB0aW1pbmcuVGltZXIoKS5zdGFydCgpO1xuICAgIGxvZy5kZWJ1ZyhgV2FpdGluZyB1cCB0byAke3RpbWVvdXR9bXMgZm9yIGFzeW5jIGV4ZWN1dGUgdG8gZmluaXNoYCk7XG4gICAgcmVzID0gYXdhaXQgcmV0cnlJbnRlcnZhbChyZXRyaWVzLCByZXRyeVdhaXQsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIHRoZSBhdG9tIF93aWxsXyByZXR1cm4sIGVpdGhlciBiZWNhdXNlIGl0IGZpbmlzaGVkIG9yIGFuIGVycm9yXG4gICAgICAvLyBpbmNsdWRpbmcgYSB0aW1lb3V0IGVycm9yXG4gICAgICBjb25zdCBoYXNWYWx1ZSA9IGF3YWl0IGV2YWx1YXRlKCdSdW50aW1lLmV2YWx1YXRlJywge1xuICAgICAgICBjb21tYW5kOiBgd2luZG93Lmhhc093blByb3BlcnR5KCcke3Byb21pc2VOYW1lfVZhbHVlJyk7YCxcbiAgICAgIH0pO1xuICAgICAgaWYgKGhhc1ZhbHVlKSB7XG4gICAgICAgIC8vIHdlIG9ubHkgcHV0IHRoZSBwcm9wZXJ0eSBvbiBgd2luZG93YCB3aGVuIHRoZSBjYWxsYmFjayBpcyBjYWxsZWQsXG4gICAgICAgIC8vIHNvIGlmIGl0IGlzIHRoZXJlLCBldmVyeXRoaW5nIGlzIGRvbmVcbiAgICAgICAgcmV0dXJuIGF3YWl0IGV2YWx1YXRlKCdSdW50aW1lLmV2YWx1YXRlJywge1xuICAgICAgICAgIGNvbW1hbmQ6IGB3aW5kb3cuJHtwcm9taXNlTmFtZX1WYWx1ZTtgLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIC8vIHRocm93IGEgVGltZW91dEVycm9yLCBvciBlbHNlIGl0IG5lZWRzIHRvIGJlIGNhdWdodCBhbmQgcmUtdGhyb3duXG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLlRpbWVvdXRFcnJvcihgVGltZWQgb3V0IHdhaXRpbmcgZm9yIGFzeW5jaHJvbm91cyBzY3JpcHQgYCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgcmVzdWx0IGFmdGVyICR7dGltZXIuZ2V0RHVyYXRpb24oKS5hc01pbGxpU2Vjb25kcy50b0ZpeGVkKDApfW1zJykpO2ApO1xuICAgIH0pO1xuICB9IGZpbmFsbHkge1xuICAgIHRyeSB7XG4gICAgICAvLyB0cnkgdG8gZ2V0IHJpZCBvZiB0aGUgcHJvbWlzZVxuICAgICAgYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZXhlY3V0ZV9zY3JpcHQnLCBbYGRlbGV0ZSB3aW5kb3cuJHtwcm9taXNlTmFtZX07YCwgW251bGwsIG51bGxdLCBzdWJjb21tYW5kVGltZW91dF0sIGZyYW1lcyk7XG4gICAgfSBjYXRjaCAoaWduKSB7fVxuICB9XG4gIHJldHVybiBjb252ZXJ0UmVzdWx0KHJlcyk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGV4ZWN1dGUgKGNvbW1hbmQsIG92ZXJyaWRlKSB7XG4gIC8vIGlmIHRoZSBwYWdlIGlzIG5vdCBsb2FkZWQgeWV0LCB3YWl0IGZvciBpdFxuICBpZiAodGhpcy5wYWdlTG9hZGluZyAmJiAhb3ZlcnJpZGUpIHtcbiAgICBsb2cuZGVidWcoJ1RyeWluZyB0byBleGVjdXRlIGJ1dCBwYWdlIGlzIG5vdCBsb2FkZWQuJyk7XG4gICAgYXdhaXQgdGhpcy53YWl0Rm9yRG9tKCk7XG4gIH1cblxuICBjaGVja1BhcmFtcyh7YXBwSWRLZXk6IHRoaXMuYXBwSWRLZXksIHBhZ2VJZEtleTogdGhpcy5wYWdlSWRLZXl9KTtcblxuICBpZiAodGhpcy5nYXJiYWdlQ29sbGVjdE9uRXhlY3V0ZSkge1xuICAgIGF3YWl0IHRoaXMuZ2FyYmFnZUNvbGxlY3QoKTtcbiAgfVxuXG4gIGxvZy5kZWJ1ZyhgU2VuZGluZyBqYXZhc2NyaXB0IGNvbW1hbmQ6ICcke18udHJ1bmNhdGUoY29tbWFuZCwge2xlbmd0aDogNTB9KX0nYCk7XG4gIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMucnBjQ2xpZW50LnNlbmQoJ1J1bnRpbWUuZXZhbHVhdGUnLCB7XG4gICAgY29tbWFuZCxcbiAgICBhcHBJZEtleTogdGhpcy5hcHBJZEtleSxcbiAgICBwYWdlSWRLZXk6IHRoaXMucGFnZUlkS2V5LFxuICB9KTtcblxuICByZXR1cm4gY29udmVydFJlc3VsdChyZXMpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBjYWxsRnVuY3Rpb24gKG9iaklkLCBmbiwgYXJncykge1xuICBjaGVja1BhcmFtcyh7YXBwSWRLZXk6IHRoaXMuYXBwSWRLZXksIHBhZ2VJZEtleTogdGhpcy5wYWdlSWRLZXl9KTtcblxuICBpZiAodGhpcy5nYXJiYWdlQ29sbGVjdE9uRXhlY3V0ZSkge1xuICAgIGF3YWl0IHRoaXMuZ2FyYmFnZUNvbGxlY3QoKTtcbiAgfVxuXG4gIGxvZy5kZWJ1ZygnQ2FsbGluZyBqYXZhc2NyaXB0IGZ1bmN0aW9uJyk7XG4gIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMucnBjQ2xpZW50LnNlbmQoJ1J1bnRpbWUuY2FsbEZ1bmN0aW9uT24nLCB7XG4gICAgb2JqSWQsXG4gICAgZm4sXG4gICAgYXJncyxcbiAgICBhcHBJZEtleTogdGhpcy5hcHBJZEtleSxcbiAgICBwYWdlSWRLZXk6IHRoaXMucGFnZUlkS2V5LFxuICB9KTtcblxuICByZXR1cm4gY29udmVydFJlc3VsdChyZXMpO1xufVxuXG5cbmV4cG9ydCBkZWZhdWx0IHsgZXhlY3V0ZUF0b20sIGV4ZWN1dGVBdG9tQXN5bmMsIGV4ZWN1dGUsIGNhbGxGdW5jdGlvbiB9O1xuIl0sImZpbGUiOiJsaWIvbWl4aW5zL2V4ZWN1dGUuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
