"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger"));

var _utils = require("../utils");

var _events = _interopRequireDefault(require("./events"));

var _appiumSupport = require("appium-support");

var _asyncbox = require("asyncbox");

var _lodash = _interopRequireDefault(require("lodash"));

const APP_CONNECT_TIMEOUT_MS = 0;
const APP_CONNECT_INTERVAL_MS = 100;
const SELECT_APP_RETRIES = 20;
const SELECT_APP_RETRY_SLEEP_MS = 500;
const SAFARI_BUNDLE_ID = 'com.apple.mobilesafari';
const BLANK_PAGE_URL = 'about:blank';

async function setConnectionKey() {
  _logger.default.debug('Sending connection key request');

  await this.rpcClient.send('setConnectionKey', {}, false);
}

async function connect(timeout = APP_CONNECT_TIMEOUT_MS) {
  this.setup();
  this.initRpcClient();
  this.rpcClient.on('_rpc_reportSetup:', _lodash.default.noop);
  this.rpcClient.on('_rpc_forwardGetListing:', this.onPageChange.bind(this));
  this.rpcClient.on('_rpc_reportConnectedApplicationList:', this.onConnectedApplicationList.bind(this));
  this.rpcClient.on('_rpc_applicationConnected:', this.onAppConnect.bind(this));
  this.rpcClient.on('_rpc_applicationDisconnected:', this.onAppDisconnect.bind(this));
  this.rpcClient.on('_rpc_applicationUpdated:', this.onAppUpdate.bind(this));
  this.rpcClient.on('_rpc_reportConnectedDriverList:', this.onConnectedDriverList.bind(this));
  this.rpcClient.on('Page.frameDetached', this.frameDetached.bind(this));
  await this.rpcClient.connect();

  try {
    await this.setConnectionKey();

    if (timeout) {
      _logger.default.debug(`Waiting up to ${timeout}ms for applications to be reported`);

      try {
        await (0, _asyncbox.waitForCondition)(() => !_lodash.default.isEmpty(this.appDict), {
          waitMs: timeout,
          interval: APP_CONNECT_INTERVAL_MS
        });
      } catch (err) {
        _logger.default.debug(`Timed out waiting for applications to be reported`);
      }
    }

    return this.appDict || {};
  } catch (err) {
    _logger.default.error(`Error setting connection key: ${err.message}`);

    await this.disconnect();
    throw err;
  }
}

async function disconnect() {
  if (this.rpcClient) {
    await this.rpcClient.disconnect();
  }

  this.emit(_events.default.EVENT_DISCONNECT, true);
  this.teardown();
}

async function selectApp(currentUrl = null, maxTries = SELECT_APP_RETRIES, ignoreAboutBlankUrl = false) {
  const shouldCheckForTarget = this.rpcClient.shouldCheckForTarget;
  this.rpcClient.shouldCheckForTarget = false;

  try {
    const timer = new _appiumSupport.timing.Timer().start();

    _logger.default.debug('Selecting application');

    if (!this.appDict || _lodash.default.isEmpty(this.appDict)) {
      _logger.default.debug('No applications currently connected.');

      return [];
    }

    const {
      appIdKey,
      pageDict
    } = await this.searchForApp(currentUrl, maxTries, ignoreAboutBlankUrl);

    if (!appIdKey || !pageDict) {
      _logger.default.errorAndThrow(`Could not connect to a valid app after ${maxTries} tries.`);
    }

    if (this.appIdKey !== appIdKey) {
      _logger.default.debug(`Received altered app id, updating from '${this.appIdKey}' to '${appIdKey}'`);

      this.appIdKey = appIdKey;
    }

    logApplicationDictionary(this.appDict);
    const pageArray = _lodash.default.isEmpty(this.appDict[appIdKey].pageArray) ? (0, _utils.pageArrayFromDict)(pageDict) : this.appDict[appIdKey].pageArray;

    _logger.default.debug(`Finally selecting app ${this.appIdKey}: ${(0, _utils.simpleStringify)(pageArray)}`);

    let fullPageArray = [];

    for (const [app, info] of _lodash.default.toPairs(this.appDict)) {
      if (!_lodash.default.isArray(info.pageArray) || !info.isActive) {
        continue;
      }

      const id = app.replace('PID:', '');

      for (const page of info.pageArray) {
        if (!(ignoreAboutBlankUrl && page.url === BLANK_PAGE_URL)) {
          let pageDict = _lodash.default.clone(page);

          pageDict.id = `${id}.${pageDict.id}`;
          pageDict.bundleId = info.bundleId;
          fullPageArray.push(pageDict);
        }
      }
    }

    _logger.default.debug(`Selected app after ${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);

    return fullPageArray;
  } finally {
    this.rpcClient.shouldCheckForTarget = shouldCheckForTarget;
  }
}

async function searchForApp(currentUrl, maxTries, ignoreAboutBlankUrl) {
  const bundleIds = this.includeSafari && !this.isSafari ? [this.bundleId, ...this.additionalBundleIds, SAFARI_BUNDLE_ID] : [this.bundleId, ...this.additionalBundleIds];

  try {
    return await (0, _asyncbox.retryInterval)(maxTries, SELECT_APP_RETRY_SLEEP_MS, async retryCount => {
      logApplicationDictionary(this.appDict);
      const possibleAppIds = (0, _utils.getPossibleDebuggerAppKeys)(bundleIds, this.appDict);

      _logger.default.debug(`Trying out the possible app ids: ${possibleAppIds.join(', ')} (try #${retryCount + 1} of ${maxTries})`);

      for (const attemptedAppIdKey of possibleAppIds) {
        try {
          if (!this.appDict[attemptedAppIdKey].isActive) {
            _logger.default.debug(`Skipping app '${attemptedAppIdKey}' because it is not active`);

            continue;
          }

          _logger.default.debug(`Attempting app '${attemptedAppIdKey}'`);

          const [appIdKey, pageDict] = await this.rpcClient.selectApp(attemptedAppIdKey, this.onAppConnect.bind(this));

          if (_lodash.default.isEmpty(pageDict)) {
            _logger.default.debug('Empty page dictionary received. Trying again.');

            continue;
          }

          this.appDict[appIdKey].pageArray = (0, _utils.pageArrayFromDict)(pageDict);
          const result = this.searchForPage(this.appDict, currentUrl, ignoreAboutBlankUrl);

          if (result) {
            return result;
          }

          if (currentUrl) {
            _logger.default.debug(`Received app, but expected url ('${currentUrl}') was not found. Trying again.`);
          } else {
            _logger.default.debug('Received app, but no match was found. Trying again.');
          }
        } catch (err) {
          _logger.default.debug(`Error checking application: '${err.message}'. Retrying connection`);
        }
      }

      retryCount++;
      throw new Error('Failed to find an app to select');
    }, 0);
  } catch (ign) {
    _logger.default.errorAndThrow(`Could not connect to a valid app after ${maxTries} tries.`);
  }
}

function searchForPage(appsDict, currentUrl = null, ignoreAboutBlankUrl = false) {
  for (const appDict of _lodash.default.values(appsDict)) {
    if (!appDict || !appDict.isActive || !appDict.pageArray || appDict.pageArray.promise) {
      continue;
    }

    for (const dict of appDict.pageArray) {
      if ((!ignoreAboutBlankUrl || dict.url !== BLANK_PAGE_URL) && (!currentUrl || dict.url === currentUrl || dict.url === `${currentUrl}/`)) {
        return {
          appIdKey: appDict.id,
          pageDict: dict
        };
      }
    }
  }

  return null;
}

async function selectPage(appIdKey, pageIdKey, skipReadyCheck = false) {
  this.appIdKey = `PID:${appIdKey}`;
  this.pageIdKey = pageIdKey;

  _logger.default.debug(`Selecting page '${pageIdKey}' on app '${this.appIdKey}' and forwarding socket setup`);

  const timer = new _appiumSupport.timing.Timer().start();
  await this.rpcClient.selectPage(this.appIdKey, pageIdKey);

  if (!skipReadyCheck && !(await this.checkPageIsReady())) {
    await this.pageUnload();
  }

  _logger.default.debug(`Selected page after ${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);
}

function logApplicationDictionary(apps) {
  function getValueString(key, value) {
    if (_lodash.default.isFunction(value)) {
      return '[Function]';
    }

    if (key === 'pageArray' && !_lodash.default.isArray(value)) {
      return `"Waiting for data"`;
    }

    return JSON.stringify(value);
  }

  _logger.default.debug('Current applications available:');

  for (const [app, info] of _lodash.default.toPairs(apps)) {
    _logger.default.debug(`    Application: "${app}"`);

    for (const [key, value] of _lodash.default.toPairs(info)) {
      if (key === 'pageArray' && Array.isArray(value) && value.length) {
        _logger.default.debug(`        ${key}:`);

        for (const page of value) {
          let prefix = '- ';

          for (const [k, v] of _lodash.default.toPairs(page)) {
            _logger.default.debug(`          ${prefix}${k}: ${JSON.stringify(v)}`);

            prefix = '  ';
          }
        }
      } else {
        const valueString = getValueString(key, value);

        _logger.default.debug(`        ${key}: ${valueString}`);
      }
    }
  }
}

function updateAppsWithDict(dict) {
  this.appDict = this.appDict || {};
  let [id, entry] = (0, _utils.appInfoFromDict)(dict);

  if (this.appDict[id]) {
    entry.pageArray = this.appDict[id].pageArray;
  }

  this.appDict[id] = entry;

  if (_lodash.default.isUndefined(entry.pageArray)) {
    entry.pageArray = (0, _utils.deferredPromise)();
  }

  if (!this.appIdKey) {
    this.appIdKey = (0, _utils.getDebuggerAppKey)(this.bundleId, this.appDict);
  }
}

var _default = {
  setConnectionKey,
  connect,
  disconnect,
  selectApp,
  searchForApp,
  searchForPage,
  selectPage,
  updateAppsWithDict
};
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9taXhpbnMvY29ubmVjdC5qcyJdLCJuYW1lcyI6WyJBUFBfQ09OTkVDVF9USU1FT1VUX01TIiwiQVBQX0NPTk5FQ1RfSU5URVJWQUxfTVMiLCJTRUxFQ1RfQVBQX1JFVFJJRVMiLCJTRUxFQ1RfQVBQX1JFVFJZX1NMRUVQX01TIiwiU0FGQVJJX0JVTkRMRV9JRCIsIkJMQU5LX1BBR0VfVVJMIiwic2V0Q29ubmVjdGlvbktleSIsImxvZyIsImRlYnVnIiwicnBjQ2xpZW50Iiwic2VuZCIsImNvbm5lY3QiLCJ0aW1lb3V0Iiwic2V0dXAiLCJpbml0UnBjQ2xpZW50Iiwib24iLCJfIiwibm9vcCIsIm9uUGFnZUNoYW5nZSIsImJpbmQiLCJvbkNvbm5lY3RlZEFwcGxpY2F0aW9uTGlzdCIsIm9uQXBwQ29ubmVjdCIsIm9uQXBwRGlzY29ubmVjdCIsIm9uQXBwVXBkYXRlIiwib25Db25uZWN0ZWREcml2ZXJMaXN0IiwiZnJhbWVEZXRhY2hlZCIsImlzRW1wdHkiLCJhcHBEaWN0Iiwid2FpdE1zIiwiaW50ZXJ2YWwiLCJlcnIiLCJlcnJvciIsIm1lc3NhZ2UiLCJkaXNjb25uZWN0IiwiZW1pdCIsImV2ZW50cyIsIkVWRU5UX0RJU0NPTk5FQ1QiLCJ0ZWFyZG93biIsInNlbGVjdEFwcCIsImN1cnJlbnRVcmwiLCJtYXhUcmllcyIsImlnbm9yZUFib3V0QmxhbmtVcmwiLCJzaG91bGRDaGVja0ZvclRhcmdldCIsInRpbWVyIiwidGltaW5nIiwiVGltZXIiLCJzdGFydCIsImFwcElkS2V5IiwicGFnZURpY3QiLCJzZWFyY2hGb3JBcHAiLCJlcnJvckFuZFRocm93IiwibG9nQXBwbGljYXRpb25EaWN0aW9uYXJ5IiwicGFnZUFycmF5IiwiZnVsbFBhZ2VBcnJheSIsImFwcCIsImluZm8iLCJ0b1BhaXJzIiwiaXNBcnJheSIsImlzQWN0aXZlIiwiaWQiLCJyZXBsYWNlIiwicGFnZSIsInVybCIsImNsb25lIiwiYnVuZGxlSWQiLCJwdXNoIiwiZ2V0RHVyYXRpb24iLCJhc01pbGxpU2Vjb25kcyIsInRvRml4ZWQiLCJidW5kbGVJZHMiLCJpbmNsdWRlU2FmYXJpIiwiaXNTYWZhcmkiLCJhZGRpdGlvbmFsQnVuZGxlSWRzIiwicmV0cnlDb3VudCIsInBvc3NpYmxlQXBwSWRzIiwiam9pbiIsImF0dGVtcHRlZEFwcElkS2V5IiwicmVzdWx0Iiwic2VhcmNoRm9yUGFnZSIsIkVycm9yIiwiaWduIiwiYXBwc0RpY3QiLCJ2YWx1ZXMiLCJwcm9taXNlIiwiZGljdCIsInNlbGVjdFBhZ2UiLCJwYWdlSWRLZXkiLCJza2lwUmVhZHlDaGVjayIsImNoZWNrUGFnZUlzUmVhZHkiLCJwYWdlVW5sb2FkIiwiYXBwcyIsImdldFZhbHVlU3RyaW5nIiwia2V5IiwidmFsdWUiLCJpc0Z1bmN0aW9uIiwiSlNPTiIsInN0cmluZ2lmeSIsIkFycmF5IiwibGVuZ3RoIiwicHJlZml4IiwiayIsInYiLCJ2YWx1ZVN0cmluZyIsInVwZGF0ZUFwcHNXaXRoRGljdCIsImVudHJ5IiwiaXNVbmRlZmluZWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsc0JBQXNCLEdBQUcsQ0FBL0I7QUFDQSxNQUFNQyx1QkFBdUIsR0FBRyxHQUFoQztBQUNBLE1BQU1DLGtCQUFrQixHQUFHLEVBQTNCO0FBQ0EsTUFBTUMseUJBQXlCLEdBQUcsR0FBbEM7QUFDQSxNQUFNQyxnQkFBZ0IsR0FBRyx3QkFBekI7QUFDQSxNQUFNQyxjQUFjLEdBQUcsYUFBdkI7O0FBR0EsZUFBZUMsZ0JBQWYsR0FBbUM7QUFDakNDLGtCQUFJQyxLQUFKLENBQVUsZ0NBQVY7O0FBR0EsUUFBTSxLQUFLQyxTQUFMLENBQWVDLElBQWYsQ0FBb0Isa0JBQXBCLEVBQXdDLEVBQXhDLEVBQTRDLEtBQTVDLENBQU47QUFDRDs7QUFFRCxlQUFlQyxPQUFmLENBQXdCQyxPQUFPLEdBQUdaLHNCQUFsQyxFQUEwRDtBQUN4RCxPQUFLYSxLQUFMO0FBR0EsT0FBS0Ms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ZSxLQUFLQSxPQUFMLElBQWdCLEVBQS9CO0FBQ0EsTUFBSSxDQUFDZ0MsRUFBRCxFQUFLNkMsS0FBTCxJQUFjLDRCQUFnQnBCLElBQWhCLENBQWxCOztBQUNBLE1BQUksS0FBS3pELE9BQUwsQ0FBYWdDLEVBQWIsQ0FBSixFQUFzQjtBQUVwQjZDLElBQUFBLEtBQUssQ0FBQ3BELFNBQU4sR0FBa0IsS0FBS3pCLE9BQUwsQ0FBYWdDLEVBQWIsRUFBaUJQLFNBQW5DO0FBQ0Q7O0FBQ0QsT0FBS3pCLE9BQUwsQ0FBYWdDLEVBQWIsSUFBbUI2QyxLQUFuQjs7QUFHQSxNQUFJeEYsZ0JBQUV5RixXQUFGLENBQWNELEtBQUssQ0FBQ3BELFNBQXBCLENBQUosRUFBb0M7QUFDbENvRCxJQUFBQSxLQUFLLENBQUNwRCxTQUFOLEdBQWtCLDZCQUFsQjtBQUNEOztBQUdELE1BQUksQ0FBQyxLQUFLTCxRQUFWLEVBQW9CO0FBQ2xCLFNBQUtBLFFBQUwsR0FBZ0IsOEJBQWtCLEtBQUtpQixRQUF2QixFQUFpQyxLQUFLckMsT0FBdEMsQ0FBaEI7QUFDRDtBQUNGOztlQUVjO0FBQUVyQixFQUFBQSxnQkFBRjtBQUFvQkssRUFBQUEsT0FBcEI7QUFBNkJzQixFQUFBQSxVQUE3QjtBQUF5Q0ssRUFBQUEsU0FBekM7QUFBb0RXLEVBQUFBLFlBQXBEO0FBQWtFNkIsRUFBQUEsYUFBbEU7QUFBaUZPLEVBQUFBLFVBQWpGO0FBQTZGa0IsRUFBQUE7QUFBN0YsQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IGFwcEluZm9Gcm9tRGljdCwgcGFnZUFycmF5RnJvbURpY3QsIGdldERlYnVnZ2VyQXBwS2V5LFxuICAgICAgICAgZ2V0UG9zc2libGVEZWJ1Z2dlckFwcEtleXMsIHNpbXBsZVN0cmluZ2lmeSwgZGVmZXJyZWRQcm9taXNlIH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IGV2ZW50cyBmcm9tICcuL2V2ZW50cyc7XG5pbXBvcnQgeyB0aW1pbmcgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyByZXRyeUludGVydmFsLCB3YWl0Rm9yQ29uZGl0aW9uIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuXG5jb25zdCBBUFBfQ09OTkVDVF9USU1FT1VUX01TID0gMDtcbmNvbnN0IEFQUF9DT05ORUNUX0lOVEVSVkFMX01TID0gMTAwO1xuY29uc3QgU0VMRUNUX0FQUF9SRVRSSUVTID0gMjA7XG5jb25zdCBTRUxFQ1RfQVBQX1JFVFJZX1NMRUVQX01TID0gNTAwO1xuY29uc3QgU0FGQVJJX0JVTkRMRV9JRCA9ICdjb20uYXBwbGUubW9iaWxlc2FmYXJpJztcbmNvbnN0IEJMQU5LX1BBR0VfVVJMID0gJ2Fib3V0OmJsYW5rJztcblxuXG5hc3luYyBmdW5jdGlvbiBzZXRDb25uZWN0aW9uS2V5ICgpIHtcbiAgbG9nLmRlYnVnKCdTZW5kaW5nIGNvbm5lY3Rpb24ga2V5IHJlcXVlc3QnKTtcbiAgLy8gc2VuZCBidXQgb25seSB3YWl0IHRvIG1ha2Ugc3VyZSB0aGUgc29ja2V0IHdvcmtlZFxuICAvLyBhcyByZXNwb25zZSBmcm9tIFdlYiBJbnNwZWN0b3IgY2FuIHRha2UgYSBsb25nIHRpbWVcbiAgYXdhaXQgdGhpcy5ycGNDbGllbnQuc2VuZCgnc2V0Q29ubmVjdGlvbktleScsIHt9LCBmYWxzZSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNvbm5lY3QgKHRpbWVvdXQgPSBBUFBfQ09OTkVDVF9USU1FT1VUX01TKSB7XG4gIHRoaXMuc2V0dXAoKTtcblxuICAvLyBpbml0aWFsaXplIHRoZSBycGMgY2xpZW50XG4gIHRoaXMuaW5pdFJwY0NsaWVudCgpO1xuXG4gIC8vIGxpc3RlbiBmb3IgYmFzaWMgZGVidWdnZXItbGV2ZWwgZXZlbnRzXG4gIHRoaXMucnBjQ2xpZW50Lm9uKCdfcnBjX3JlcG9ydFNldHVwOicsIF8ubm9vcCk7XG4gIHRoaXMucnBjQ2xpZW50Lm9uKCdfcnBjX2ZvcndhcmRHZXRMaXN0aW5nOicsIHRoaXMub25QYWdlQ2hhbmdlLmJpbmQodGhpcykpO1xuICB0aGlzLnJwY0NsaWVudC5vbignX3JwY19yZXBvcnRDb25uZWN0ZWRBcHBsaWNhdGlvbkxpc3Q6JywgdGhpcy5vbkNvbm5lY3RlZEFwcGxpY2F0aW9uTGlzdC5iaW5kKHRoaXMpKTtcbiAgdGhpcy5ycGNDbGllbnQub24oJ19ycGNfYXBwbGljYXRpb25Db25uZWN0ZWQ6JywgdGhpcy5vbkFwcENvbm5lY3QuYmluZCh0aGlzKSk7XG4gIHRoaXMucnBjQ2xpZW50Lm9uKCdfcnBjX2FwcGxpY2F0aW9uRGlzY29ubmVjdGVkOicsIHRoaXMub25BcHBEaXNjb25uZWN0LmJpbmQodGhpcykpO1xuICB0aGlzLnJwY0NsaWVudC5vbignX3JwY19hcHBsaWNhdGlvblVwZGF0ZWQ6JywgdGhpcy5vbkFwcFVwZGF0ZS5iaW5kKHRoaXMpKTtcbiAgdGhpcy5ycGNDbGllbnQub24oJ19ycGNfcmVwb3J0Q29ubmVjdGVkRHJpdmVyTGlzdDonLCB0aGlzLm9uQ29ubmVjdGVkRHJpdmVyTGlzdC5iaW5kKHRoaXMpKTtcbiAgdGhpcy5ycGNDbGllbnQub24oJ1BhZ2UuZnJhbWVEZXRhY2hlZCcsIHRoaXMuZnJhbWVEZXRhY2hlZC5iaW5kKHRoaXMpKTtcblxuICBhd2FpdCB0aGlzLnJwY0NsaWVudC5jb25uZWN0KCk7XG5cbiAgLy8gZ2V0IHRoZSBjb25uZWN0aW9uIGluZm9ybWF0aW9uIGFib3V0IHRoZSBhcHBcbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLnNldENvbm5lY3Rpb25LZXkoKTtcbiAgICBpZiAodGltZW91dCkge1xuICAgICAgbG9nLmRlYnVnKGBXYWl0aW5nIHVwIHRvICR7dGltZW91dH1tcyBmb3IgYXBwbGljYXRpb25zIHRvIGJlIHJlcG9ydGVkYCk7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKCgpID0+ICFfLmlzRW1wdHkodGhpcy5hcHBEaWN0KSwge1xuICAgICAgICAgIHdhaXRNczogdGltZW91dCxcbiAgICAgICAgICBpbnRlcnZhbDogQVBQX0NPTk5FQ1RfSU5URVJWQUxfTVMsXG4gICAgICAgIH0pO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgVGltZWQgb3V0IHdhaXRpbmcgZm9yIGFwcGxpY2F0aW9ucyB0byBiZSByZXBvcnRlZGApO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdGhpcy5hcHBEaWN0IHx8IHt9O1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cuZXJyb3IoYEVycm9yIHNldHRpbmcgY29ubmVjdGlvbiBrZXk6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgYXdhaXQgdGhpcy5kaXNjb25uZWN0KCk7XG4gICAgdGhyb3cgZXJyO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRpc2Nvbm5lY3QgKCkge1xuICBpZiAodGhpcy5ycGNDbGllbnQpIHtcbiAgICBhd2FpdCB0aGlzLnJwY0NsaWVudC5kaXNjb25uZWN0KCk7XG4gIH1cbiAgdGhpcy5lbWl0KGV2ZW50cy5FVkVOVF9ESVNDT05ORUNULCB0cnVlKTtcbiAgdGhpcy50ZWFyZG93bigpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZWxlY3RBcHAgKGN1cnJlbnRVcmwgPSBudWxsLCBtYXhUcmllcyA9IFNFTEVDVF9BUFBfUkVUUklFUywgaWdub3JlQWJvdXRCbGFua1VybCA9IGZhbHNlKSB7XG4gIGNvbnN0IHNob3VsZENoZWNrRm9yVGFyZ2V0ID0gdGhpcy5ycGNDbGllbnQuc2hvdWxkQ2hlY2tGb3JUYXJnZXQ7XG4gIHRoaXMucnBjQ2xpZW50LnNob3VsZENoZWNrRm9yVGFyZ2V0ID0gZmFsc2U7XG4gIHRyeSB7XG4gICAgY29uc3QgdGltZXIgPSBuZXcgdGltaW5nLlRpbWVyKCkuc3RhcnQoKTtcbiAgICBsb2cuZGVidWcoJ1NlbGVjdGluZyBhcHBsaWNhdGlvbicpO1xuICAgIGlmICghdGhpcy5hcHBEaWN0IHx8IF8uaXNFbXB0eSh0aGlzLmFwcERpY3QpKSB7XG4gICAgICBsb2cuZGVidWcoJ05vIGFwcGxpY2F0aW9ucyBjdXJyZW50bHkgY29ubmVjdGVkLicpO1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIGNvbnN0IHthcHBJZEtleSwgcGFnZURpY3R9ID0gYXdhaXQgdGhpcy5zZWFyY2hGb3JBcHAoY3VycmVudFVybCwgbWF4VHJpZXMsIGlnbm9yZUFib3V0QmxhbmtVcmwpO1xuXG4gICAgLy8gaWYsIGFmdGVyIGFsbCB0aGlzLCB3ZSBoYXZlIG5vIGRpY3Rpb25hcnksIHdlIGhhdmUgZmFpbGVkXG4gICAgaWYgKCFhcHBJZEtleSB8fCAhcGFnZURpY3QpIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGBDb3VsZCBub3QgY29ubmVjdCB0byBhIHZhbGlkIGFwcCBhZnRlciAke21heFRyaWVzfSB0cmllcy5gKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5hcHBJZEtleSAhPT0gYXBwSWRLZXkpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgUmVjZWl2ZWQgYWx0ZXJlZCBhcHAgaWQsIHVwZGF0aW5nIGZyb20gJyR7dGhpcy5hcHBJZEtleX0nIHRvICcke2FwcElkS2V5fSdgKTtcbiAgICAgIHRoaXMuYXBwSWRLZXkgPSBhcHBJZEtleTtcbiAgICB9XG5cbiAgICBsb2dBcHBsaWNhdGlvbkRpY3Rpb25hcnkodGhpcy5hcHBEaWN0KTtcblxuICAgIC8vIHRyYW5zbGF0ZSB0aGUgZGljdGlvbmFyeSBpbnRvIGEgdXNlZnVsIGZvcm0sIGFuZCByZXR1cm4gdG8gc2VuZGVyXG4gICAgY29uc3QgcGFnZUFycmF5ID0gXy5pc0VtcHR5KHRoaXMuYXBwRGljdFthcHBJZEtleV0ucGFnZUFycmF5KVxuICAgICAgPyBwYWdlQXJyYXlGcm9tRGljdChwYWdlRGljdClcbiAgICAgIDogdGhpcy5hcHBEaWN0W2FwcElkS2V5XS5wYWdlQXJyYXk7XG4gICAgbG9nLmRlYnVnKGBGaW5hbGx5IHNlbGVjdGluZyBhcHAgJHt0aGlzLmFwcElkS2V5fTogJHtzaW1wbGVTdHJpbmdpZnkocGFnZUFycmF5KX1gKTtcblxuICAgIGxldCBmdWxsUGFnZUFycmF5ID0gW107XG4gICAgZm9yIChjb25zdCBbYXBwLCBpbmZvXSBvZiBfLnRvUGFpcnModGhpcy5hcHBEaWN0KSkge1xuICAgICAgaWYgKCFfLmlzQXJyYXkoaW5mby5wYWdlQXJyYXkpIHx8ICFpbmZvLmlzQWN0aXZlKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgY29uc3QgaWQgPSBhcHAucmVwbGFjZSgnUElEOicsICcnKTtcbiAgICAgIGZvciAoY29uc3QgcGFnZSBvZiBpbmZvLnBhZ2VBcnJheSkge1xuICAgICAgICBpZiAoIShpZ25vcmVBYm91dEJsYW5rVXJsICYmIHBhZ2UudXJsID09PSBCTEFOS19QQUdFX1VSTCkpIHtcbiAgICAgICAgICBsZXQgcGFnZURpY3QgPSBfLmNsb25lKHBhZ2UpO1xuICAgICAgICAgIHBhZ2VEaWN0LmlkID0gYCR7aWR9LiR7cGFnZURpY3QuaWR9YDtcbiAgICAgICAgICBwYWdlRGljdC5idW5kbGVJZCA9IGluZm8uYnVuZGxlSWQ7XG4gICAgICAgICAgZnVsbFBhZ2VBcnJheS5wdXNoKHBhZ2VEaWN0KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGxvZy5kZWJ1ZyhgU2VsZWN0ZWQgYXBwIGFmdGVyICR7dGltZXIuZ2V0RHVyYXRpb24oKS5hc01pbGxpU2Vjb25kcy50b0ZpeGVkKDApfW1zYCk7XG4gICAgcmV0dXJuIGZ1bGxQYWdlQXJyYXk7XG4gIH0gZmluYWxseSB7XG4gICAgdGhpcy5ycGNDbGllbnQuc2hvdWxkQ2hlY2tGb3JUYXJnZXQgPSBzaG91bGRDaGVja0ZvclRhcmdldDtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBzZWFyY2hGb3JBcHAgKGN1cnJlbnRVcmwsIG1heFRyaWVzLCBpZ25vcmVBYm91dEJsYW5rVXJsKSB7XG4gIGNvbnN0IGJ1bmRsZUlkcyA9IHRoaXMuaW5jbHVkZVNhZmFyaSAmJiAhdGhpcy5pc1NhZmFyaVxuICAgID8gW3RoaXMuYnVuZGxlSWQsIC4uLnRoaXMuYWRkaXRpb25hbEJ1bmRsZUlkcywgU0FGQVJJX0JVTkRMRV9JRF1cbiAgICA6IFt0aGlzLmJ1bmRsZUlkLCAuLi50aGlzLmFkZGl0aW9uYWxCdW5kbGVJZHNdO1xuICB0cnkge1xuICAgIHJldHVybiBhd2FpdCByZXRyeUludGVydmFsKG1heFRyaWVzLCBTRUxFQ1RfQVBQX1JFVFJZX1NMRUVQX01TLCBhc3luYyAocmV0cnlDb3VudCkgPT4ge1xuICAgICAgbG9nQXBwbGljYXRpb25EaWN0aW9uYXJ5KHRoaXMuYXBwRGljdCk7XG4gICAgICBjb25zdCBwb3NzaWJsZUFwcElkcyA9IGdldFBvc3NpYmxlRGVidWdnZXJBcHBLZXlzKGJ1bmRsZUlkcywgdGhpcy5hcHBEaWN0KTtcbiAgICAgIGxvZy5kZWJ1ZyhgVHJ5aW5nIG91dCB0aGUgcG9zc2libGUgYXBwIGlkczogJHtwb3NzaWJsZUFwcElkcy5qb2luKCcsICcpfSAodHJ5ICMke3JldHJ5Q291bnQgKyAxfSBvZiAke21heFRyaWVzfSlgKTtcbiAgICAgIGZvciAoY29uc3QgYXR0ZW1wdGVkQXBwSWRLZXkgb2YgcG9zc2libGVBcHBJZHMpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBpZiAoIXRoaXMuYXBwRGljdFthdHRlbXB0ZWRBcHBJZEtleV0uaXNBY3RpdmUpIHtcbiAgICAgICAgICAgIGxvZy5kZWJ1ZyhgU2tpcHBpbmcgYXBwICcke2F0dGVtcHRlZEFwcElkS2V5fScgYmVjYXVzZSBpdCBpcyBub3QgYWN0aXZlYCk7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgbG9nLmRlYnVnKGBBdHRlbXB0aW5nIGFwcCAnJHthdHRlbXB0ZWRBcHBJZEtleX0nYCk7XG4gICAgICAgICAgY29uc3QgW2FwcElkS2V5LCBwYWdlRGljdF0gPSBhd2FpdCB0aGlzLnJwY0NsaWVudC5zZWxlY3RBcHAoYXR0ZW1wdGVkQXBwSWRLZXksIHRoaXMub25BcHBDb25uZWN0LmJpbmQodGhpcykpO1xuICAgICAgICAgIC8vIGluIGlPUyA4LjIgdGhlIGNvbm5lY3QgbG9naWMgaGFwcGVucywgYnV0IHdpdGggYW4gZW1wdHkgZGljdGlvbmFyeVxuICAgICAgICAgIC8vIHdoaWNoIGxlYWRzIHRvIHRoZSByZW1vdGUgZGVidWdnZXIgZ2V0dGluZyBkaXNjb25uZWN0ZWQsIGFuZCBpbnRvIGEgbG9vcFxuICAgICAgICAgIGlmIChfLmlzRW1wdHkocGFnZURpY3QpKSB7XG4gICAgICAgICAgICBsb2cuZGVidWcoJ0VtcHR5IHBhZ2UgZGljdGlvbmFyeSByZWNlaXZlZC4gVHJ5aW5nIGFnYWluLicpO1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgLy8gc2F2ZSB0aGUgcGFnZSBhcnJheSBmb3IgdGhpcyBhcHBcbiAgICAgICAgICB0aGlzLmFwcERpY3RbYXBwSWRLZXldLnBhZ2VBcnJheSA9IHBhZ2VBcnJheUZyb21EaWN0KHBhZ2VEaWN0KTtcblxuICAgICAgICAgIC8vIGlmIHdlIGFyZSBsb29raW5nIGZvciBhIHBhcnRpY3VsYXIgdXJsLCBtYWtlIHN1cmUgd2VcbiAgICAgICAgICAvLyBoYXZlIHRoZSByaWdodCBwYWdlLiBJZ25vcmUgZW1wdHkgb3IgdW5kZWZpbmVkIHVybHMuXG4gICAgICAgICAgLy8gSWdub3JlIGFib3V0OmJsYW5rIGlmIHJlcXVlc3RlZC5cbiAgICAgICAgICBjb25zdCByZXN1bHQgPSB0aGlzLnNlYXJjaEZvclBhZ2UodGhpcy5hcHBEaWN0LCBjdXJyZW50VXJsLCBpZ25vcmVBYm91dEJsYW5rVXJsKTtcbiAgICAgICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmIChjdXJyZW50VXJsKSB7XG4gICAgICAgICAgICBsb2cuZGVidWcoYFJlY2VpdmVkIGFwcCwgYnV0IGV4cGVjdGVkIHVybCAoJyR7Y3VycmVudFVybH0nKSB3YXMgbm90IGZvdW5kLiBUcnlpbmcgYWdhaW4uYCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxvZy5kZWJ1ZygnUmVjZWl2ZWQgYXBwLCBidXQgbm8gbWF0Y2ggd2FzIGZvdW5kLiBUcnlpbmcgYWdhaW4uJyk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICBsb2cuZGVidWcoYEVycm9yIGNoZWNraW5nIGFwcGxpY2F0aW9uOiAnJHtlcnIubWVzc2FnZX0nLiBSZXRyeWluZyBjb25uZWN0aW9uYCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHJ5Q291bnQrKztcbiAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIGZpbmQgYW4gYXBwIHRvIHNlbGVjdCcpO1xuICAgIH0sIDApO1xuICB9IGNhdGNoIChpZ24pIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgQ291bGQgbm90IGNvbm5lY3QgdG8gYSB2YWxpZCBhcHAgYWZ0ZXIgJHttYXhUcmllc30gdHJpZXMuYCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gc2VhcmNoRm9yUGFnZSAoYXBwc0RpY3QsIGN1cnJlbnRVcmwgPSBudWxsLCBpZ25vcmVBYm91dEJsYW5rVXJsID0gZmFsc2UpIHtcbiAgZm9yIChjb25zdCBhcHBEaWN0IG9mIF8udmFsdWVzKGFwcHNEaWN0KSkge1xuICAgIGlmICghYXBwRGljdCB8fCAhYXBwRGljdC5pc0FjdGl2ZSB8fCAhYXBwRGljdC5wYWdlQXJyYXkgfHwgYXBwRGljdC5wYWdlQXJyYXkucHJvbWlzZSkge1xuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBkaWN0IG9mIGFwcERpY3QucGFnZUFycmF5KSB7XG4gICAgICBpZiAoKCFpZ25vcmVBYm91dEJsYW5rVXJsIHx8IGRpY3QudXJsICE9PSBCTEFOS19QQUdFX1VSTCkgJiZcbiAgICAgICAgICAoIWN1cnJlbnRVcmwgfHwgZGljdC51cmwgPT09IGN1cnJlbnRVcmwgfHwgZGljdC51cmwgPT09IGAke2N1cnJlbnRVcmx9L2ApKSB7XG4gICAgICAgIHJldHVybiB7IGFwcElkS2V5OiBhcHBEaWN0LmlkLCBwYWdlRGljdDogZGljdCB9O1xuICAgICAgfVxuICAgIH1cbiAgfVxuICByZXR1cm4gbnVsbDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2VsZWN0UGFnZSAoYXBwSWRLZXksIHBhZ2VJZEtleSwgc2tpcFJlYWR5Q2hlY2sgPSBmYWxzZSkge1xuICB0aGlzLmFwcElkS2V5ID0gYFBJRDoke2FwcElkS2V5fWA7XG4gIHRoaXMucGFnZUlkS2V5ID0gcGFnZUlkS2V5O1xuXG4gIGxvZy5kZWJ1ZyhgU2VsZWN0aW5nIHBhZ2UgJyR7cGFnZUlkS2V5fScgb24gYXBwICcke3RoaXMuYXBwSWRLZXl9JyBhbmQgZm9yd2FyZGluZyBzb2NrZXQgc2V0dXBgKTtcblxuICBjb25zdCB0aW1lciA9IG5ldyB0aW1pbmcuVGltZXIoKS5zdGFydCgpO1xuXG4gIGF3YWl0IHRoaXMucnBjQ2xpZW50LnNlbGVjdFBhZ2UodGhpcy5hcHBJZEtleSwgcGFnZUlkS2V5KTtcblxuICAvLyBtYWtlIHN1cmUgZXZlcnl0aGluZyBpcyByZWFkeSB0byBnb1xuICBpZiAoIXNraXBSZWFkeUNoZWNrICYmICFhd2FpdCB0aGlzLmNoZWNrUGFnZUlzUmVhZHkoKSkge1xuICAgIGF3YWl0IHRoaXMucGFnZVVubG9hZCgpO1xuICB9XG5cbiAgbG9nLmRlYnVnKGBTZWxlY3RlZCBwYWdlIGFmdGVyICR7dGltZXIuZ2V0RHVyYXRpb24oKS5hc01pbGxpU2Vjb25kcy50b0ZpeGVkKDApfW1zYCk7XG59XG5cbmZ1bmN0aW9uIGxvZ0FwcGxpY2F0aW9uRGljdGlvbmFyeSAoYXBwcykge1xuICBmdW5jdGlvbiBnZXRWYWx1ZVN0cmluZyAoa2V5LCB2YWx1ZSkge1xuICAgIGlmIChfLmlzRnVuY3Rpb24odmFsdWUpKSB7XG4gICAgICByZXR1cm4gJ1tGdW5jdGlvbl0nO1xuICAgIH1cbiAgICBpZiAoa2V5ID09PSAncGFnZUFycmF5JyAmJiAhXy5pc0FycmF5KHZhbHVlKSkge1xuICAgICAgcmV0dXJuIGBcIldhaXRpbmcgZm9yIGRhdGFcImA7XG4gICAgfVxuICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7XG4gIH1cbiAgbG9nLmRlYnVnKCdDdXJyZW50IGFwcGxpY2F0aW9ucyBhdmFpbGFibGU6Jyk7XG4gIGZvciAoY29uc3QgW2FwcCwgaW5mb10gb2YgXy50b1BhaXJzKGFwcHMpKSB7XG4gICAgbG9nLmRlYnVnKGAgICAgQXBwbGljYXRpb246IFwiJHthcHB9XCJgKTtcbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBfLnRvUGFpcnMoaW5mbykpIHtcbiAgICAgIGlmIChrZXkgPT09ICdwYWdlQXJyYXknICYmIEFycmF5LmlzQXJyYXkodmFsdWUpICYmIHZhbHVlLmxlbmd0aCkge1xuICAgICAgICBsb2cuZGVidWcoYCAgICAgICAgJHtrZXl9OmApO1xuICAgICAgICBmb3IgKGNvbnN0IHBhZ2Ugb2YgdmFsdWUpIHtcbiAgICAgICAgICBsZXQgcHJlZml4ID0gJy0gJztcbiAgICAgICAgICBmb3IgKGNvbnN0IFtrLCB2XSBvZiBfLnRvUGFpcnMocGFnZSkpIHtcbiAgICAgICAgICAgIGxvZy5kZWJ1ZyhgICAgICAgICAgICR7cHJlZml4fSR7a306ICR7SlNPTi5zdHJpbmdpZnkodil9YCk7XG4gICAgICAgICAgICBwcmVmaXggPSAnICAnO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgdmFsdWVTdHJpbmcgPSBnZXRWYWx1ZVN0cmluZyhrZXksIHZhbHVlKTtcbiAgICAgICAgbG9nLmRlYnVnKGAgICAgICAgICR7a2V5fTogJHt2YWx1ZVN0cmluZ31gKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gdXBkYXRlQXBwc1dpdGhEaWN0IChkaWN0KSB7XG4gIC8vIGdldCB0aGUgZGljdGlvbmFyeSBlbnRyeSBpbnRvIGEgbmljZSBmb3JtLCBhbmQgYWRkIGl0IHRvIHRoZVxuICAvLyBhcHBsaWNhdGlvbiBkaWN0aW9uYXJ5XG4gIHRoaXMuYXBwRGljdCA9IHRoaXMuYXBwRGljdCB8fCB7fTtcbiAgbGV0IFtpZCwgZW50cnldID0gYXBwSW5mb0Zyb21EaWN0KGRpY3QpO1xuICBpZiAodGhpcy5hcHBEaWN0W2lkXSkge1xuICAgIC8vIHByZXNlcnZlIHRoZSBwYWdlIGRpY3Rpb25hcnkgZm9yIHRoaXMgZW50cnlcbiAgICBlbnRyeS5wYWdlQXJyYXkgPSB0aGlzLmFwcERpY3RbaWRdLnBhZ2VBcnJheTtcbiAgfVxuICB0aGlzLmFwcERpY3RbaWRdID0gZW50cnk7XG5cbiAgLy8gYWRkIGEgcHJvbWlzZSB0byBnZXQgdGhlIHBhZ2UgZGljdGlvbmFyeVxuICBpZiAoXy5pc1VuZGVmaW5lZChlbnRyeS5wYWdlQXJyYXkpKSB7XG4gICAgZW50cnkucGFnZUFycmF5ID0gZGVmZXJyZWRQcm9taXNlKCk7XG4gIH1cblxuICAvLyB0cnkgdG8gZ2V0IHRoZSBhcHAgaWQgZnJvbSBvdXIgY29ubmVjdGVkIGFwcHNcbiAgaWYgKCF0aGlzLmFwcElkS2V5KSB7XG4gICAgdGhpcy5hcHBJZEtleSA9IGdldERlYnVnZ2VyQXBwS2V5KHRoaXMuYnVuZGxlSWQsIHRoaXMuYXBwRGljdCk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgeyBzZXRDb25uZWN0aW9uS2V5LCBjb25uZWN0LCBkaXNjb25uZWN0LCBzZWxlY3RBcHAsIHNlYXJjaEZvckFwcCwgc2VhcmNoRm9yUGFnZSwgc2VsZWN0UGFnZSwgdXBkYXRlQXBwc1dpdGhEaWN0IH07XG4iXSwiZmlsZSI6ImxpYi9taXhpbnMvY29ubmVjdC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
