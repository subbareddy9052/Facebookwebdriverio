"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _net = _interopRequireDefault(require("net"));

var _rpcClient = _interopRequireDefault(require("./rpc-client"));

var _appiumIosDevice = require("appium-ios-device");

class RpcClientSimulator extends _rpcClient.default {
  constructor(opts = {}) {
    super(Object.assign({
      shouldCheckForTarget: false
    }, opts));
    const {
      socketPath,
      host = '::1',
      port,
      messageProxy
    } = opts;
    this.host = host;
    this.port = port;
    this.messageProxy = messageProxy;
    this.socket = null;
    this.socketPath = socketPath;
  }

  async connect() {
    if (this.socketPath) {
      if (this.messageProxy) {
        _logger.default.debug(`Connecting to remote debugger via proxy through unix domain socket: '${this.messageProxy}'`);

        this.socket = _net.default.connect(this.messageProxy);
        this.socket.once('connect', () => {
          _logger.default.debug(`Forwarding the actual web inspector socket to the proxy: '${this.socketPath}'`);

          this.socket.write(JSON.stringify({
            socketPath: this.socketPath
          }));
        });
      } else {
        _logger.default.debug(`Connecting to remote debugger through unix domain socket: '${this.socketPath}'`);

        this.socket = _net.default.connect(this.socketPath);
      }
    } else {
      if (this.messageProxy) {
        this.port = this.messageProxy;
      }

      _logger.default.debug(`Connecting to remote debugger ${this.messageProxy ? 'via proxy ' : ''}through TCP: ${this.host}:${this.port}`);

      this.socket = new _net.default.Socket({
        type: 'tcp6'
      });
      this.socket.connect(this.port, this.host);
    }

    this.socket.setNoDelay(true);
    this.socket.setKeepAlive(true);
    this.socket.on('close', () => {
      if (this.isConnected) {
        _logger.default.debug('Debugger socket disconnected');
      }

      this.isConnected = false;
      this.socket = null;
    });
    this.socket.on('end', () => {
      this.isConnected = false;
    });
    this.service = await _appiumIosDevice.services.startWebInspectorService(this.udid, {
      socket: this.socket,
      isSimulator: true,
      osVersion: this.platformVersion,
      verbose: this.logAllCommunication,
      verboseHexDump: this.logAllCommunicationHexDump
    });
    this.service.listenMessage(this.receive.bind(this));
    return await new _bluebird.default((resolve, reject) => {
      this.socket.on('connect', () => {
        _logger.default.debug(`Debugger socket connected`);

        this.isConnected = true;
        resolve();
      });
      this.socket.on('error', err => {
        if (this.isConnected) {
          _logger.default.error(`Socket error: ${err.message}`);

          this.isConnected = false;
        }

        reject(err);
      });
    });
  }

  async disconnect() {
    if (!this.isConnected) {
      return;
    }

    _logger.default.debug('Disconnecting from remote debugger');

    await super.disconnect();
    this.service.close();
    this.isConnected = false;
  }

  async sendMessage(cmd) {
    let onSocketError;
    return await new _bluebird.default((resolve, reject) => {
      onSocketError = err => {
        _logger.default.error(`Socket error: ${err.message}`);

        reject(err);
      };

      this.socket.on('error', onSocketError);
      this.service.sendMessage(cmd);
      resolve();
    }).finally(() => {
      try {
        this.socket.removeListener('error', onSocketError);
      } catch (ign) {}
    });
  }

  async receive(data) {
    if (!this.isConnected) {
      return;
    }

    if (!data) {
      return;
    }

    for (const key of ['WIRMessageDataKey', 'WIRDestinationKey', 'WIRSocketDataKey']) {
      if (!_lodash.default.isUndefined(data[key])) {
        data[key] = data[key].toString('utf8');
      }
    }

    await this.messageHandler.handleMessage(data);
  }

}

exports.default = RpcClientSimulator;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9ycGMvcnBjLWNsaWVudC1zaW11bGF0b3IuanMiXSwibmFtZXMiOlsiUnBjQ2xpZW50U2ltdWxhdG9yIiwiUnBjQ2xpZW50IiwiY29uc3RydWN0b3IiLCJvcHRzIiwiT2JqZWN0IiwiYXNzaWduIiwic2hvdWxkQ2hlY2tGb3JUYXJnZXQiLCJzb2NrZXRQYXRoIiwiaG9zdCIsInBvcnQiLCJtZXNzYWdlUHJveHkiLCJzb2NrZXQiLCJjb25uZWN0IiwibG9nIiwiZGVidWciLCJuZXQiLCJvbmNlIiwid3JpdGUiLCJKU09OIiwic3RyaW5naWZ5IiwiU29ja2V0IiwidHlwZSIsInNldE5vRGVsYXkiLCJzZXRLZWVwQWxpdmUiLCJvbiIsImlzQ29ubmVjdGVkIiwic2VydmljZSIsInNlcnZpY2VzIiwic3RhcnRXZWJJbnNwZWN0b3JTZXJ2aWNlIiwidWRpZCIsImlzU2ltdWxhdG9yIiwib3NWZXJzaW9uIiwicGxhdGZvcm1WZXJzaW9uIiwidmVyYm9zZSIsImxvZ0FsbENvbW11bmljYXRpb24iLCJ2ZXJib3NlSGV4RHVtcCIsImxvZ0FsbENvbW11bmljYXRpb25IZXhEdW1wIiwibGlzdGVuTWVzc2FnZSIsInJlY2VpdmUiLCJiaW5kIiwiQiIsInJlc29sdmUiLCJyZWplY3QiLCJlcnIiLCJlcnJvciIsIm1lc3NhZ2UiLCJkaXNjb25uZWN0IiwiY2xvc2UiLCJzZW5kTWVzc2FnZSIsImNtZCIsIm9uU29ja2V0RXJyb3IiLCJmaW5hbGx5IiwicmVtb3ZlTGlzdGVuZXIiLCJpZ24iLCJkYXRhIiwia2V5IiwiXyIsImlzVW5kZWZpbmVkIiwidG9TdHJpbmciLCJtZXNzYWdlSGFuZGxlciIsImhhbmRsZU1lc3NhZ2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR2UsTUFBTUEsa0JBQU4sU0FBaUNDLGtCQUFqQyxDQUEyQztBQUN4REMsRUFBQUEsV0FBVyxDQUFFQyxJQUFJLEdBQUcsRUFBVCxF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QUFELENBQU47QUFDRCxPQUxEOztBQU9BLFdBQUtoQyxNQUFMLENBQVlhLEVBQVosQ0FBZSxPQUFmLEVBQXdCMEIsYUFBeEI7QUFDQSxXQUFLeEIsT0FBTCxDQUFhc0IsV0FBYixDQUF5QkMsR0FBekI7QUFDQVIsTUFBQUEsT0FBTztBQUNSLEtBWlksRUFhWlUsT0FiWSxDQWFKLE1BQU07QUFFYixVQUFJO0FBQ0YsYUFBS3hDLE1BQUwsQ0FBWXlDLGNBQVosQ0FBMkIsT0FBM0IsRUFBb0NGLGFBQXBDO0FBQ0QsT0FGRCxDQUVFLE9BQU9HLEdBQVAsRUFBWSxDQUFFO0FBQ2pCLEtBbEJZLENBQWI7QUFtQkQ7O0FBRUQsUUFBTWYsT0FBTixDQUFlZ0IsSUFBZixFQUFxQjtBQUNuQixRQUFJLENBQUMsS0FBSzdCLFdBQVYsRUFBdUI7QUFDckI7QUFDRDs7QUFFRCxRQUFJLENBQUM2QixJQUFMLEVBQVc7QUFDVDtBQUNEOztBQUVELFNBQUssTUFBTUMsR0FBWCxJQUFrQixDQUFDLG1CQUFELEVBQXNCLG1CQUF0QixFQUEyQyxrQkFBM0MsQ0FBbEIsRUFBa0Y7QUFDaEYsVUFBSSxDQUFDQyxnQkFBRUMsV0FBRixDQUFjSCxJQUFJLENBQUNDLEdBQUQsQ0FBbEIsQ0FBTCxFQUErQjtBQUM3QkQsUUFBQUEsSUFBSSxDQUFDQyxHQUFELENBQUosR0FBWUQsSUFBSSxDQUFDQyxHQUFELENBQUosQ0FBVUcsUUFBVixDQUFtQixNQUFuQixDQUFaO0FBQ0Q7QUFDRjs7QUFDRCxVQUFNLEtBQUtDLGNBQUwsQ0FBb0JDLGFBQXBCLENBQWtDTixJQUFsQyxDQUFOO0FBQ0Q7O0FBbkp1RCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgbmV0IGZyb20gJ25ldCc7XG5pbXBvcnQgUnBjQ2xpZW50IGZyb20gJy4vcnBjLWNsaWVudCc7XG5pbXBvcnQgeyBzZXJ2aWNlcyB9IGZyb20gJ2FwcGl1bS1pb3MtZGV2aWNlJztcblxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBScGNDbGllbnRTaW11bGF0b3IgZXh0ZW5kcyBScGNDbGllbnQge1xuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7XG4gICAgc3VwZXIoT2JqZWN0LmFzc2lnbih7XG4gICAgICBzaG91bGRDaGVja0ZvclRhcmdldDogZmFsc2UsXG4gICAgfSwgb3B0cykpO1xuXG4gICAgY29uc3Qge1xuICAgICAgc29ja2V0UGF0aCxcbiAgICAgIGhvc3QgPSAnOjoxJyxcbiAgICAgIHBvcnQsXG4gICAgICBtZXNzYWdlUHJveHksXG4gICAgfSA9IG9wdHM7XG5cbiAgICAvLyBob3N0L3BvcnQgY29uZmlnIGZvciBUQ1AgY29tbXVuaWNhdGlvbiwgc29ja2V0UGF0aCBmb3IgdW5peCBkb21haW4gc29ja2V0c1xuICAgIHRoaXMuaG9zdCA9IGhvc3Q7XG4gICAgdGhpcy5wb3J0ID0gcG9ydDtcbiAgICB0aGlzLm1lc3NhZ2VQcm94eSA9IG1lc3NhZ2VQcm94eTtcblxuICAgIHRoaXMuc29ja2V0ID0gbnVsbDtcbiAgICB0aGlzLnNvY2tldFBhdGggPSBzb2NrZXRQYXRoO1xuICB9XG5cbiAgYXN5bmMgY29ubmVjdCAoKSB7XG4gICAgLy8gY3JlYXRlIHNvY2tldCBhbmQgaGFuZGxlIGl0cyBtZXNzYWdlc1xuICAgIGlmICh0aGlzLnNvY2tldFBhdGgpIHtcbiAgICAgIGlmICh0aGlzLm1lc3NhZ2VQcm94eSkge1xuICAgICAgICAvLyB1bml4IGRvbWFpbiBzb2NrZXQgdmlhIHByb3h5XG4gICAgICAgIGxvZy5kZWJ1ZyhgQ29ubmVjdGluZyB0byByZW1vdGUgZGVidWdnZXIgdmlhIHByb3h5IHRocm91Z2ggdW5peCBkb21haW4gc29ja2V0OiAnJHt0aGlzLm1lc3NhZ2VQcm94eX0nYCk7XG4gICAgICAgIHRoaXMuc29ja2V0ID0gbmV0LmNvbm5lY3QodGhpcy5tZXNzYWdlUHJveHkpO1xuXG4gICAgICAgIC8vIEZvcndhcmQgdGhlIGFjdHVhbCBzb2NrZXRQYXRoIHRvIHRoZSBwcm94eVxuICAgICAgICB0aGlzLnNvY2tldC5vbmNlKCdjb25uZWN0JywgKCkgPT4ge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgRm9yd2FyZGluZyB0aGUgYWN0dWFsIHdlYiBpbnNwZWN0b3Igc29ja2V0IHRvIHRoZSBwcm94eTogJyR7dGhpcy5zb2NrZXRQYXRofSdgKTtcbiAgICAgICAgICB0aGlzLnNvY2tldC53cml0ZShKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICBzb2NrZXRQYXRoOiB0aGlzLnNvY2tldFBhdGhcbiAgICAgICAgICB9KSk7XG4gICAgICAgIH0pO1xuXG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyB1bml4IGRvbWFpbiBzb2NrZXRcbiAgICAgICAgbG9nLmRlYnVnKGBDb25uZWN0aW5nIHRvIHJlbW90ZSBkZWJ1Z2dlciB0aHJvdWdoIHVuaXggZG9tYWluIHNvY2tldDogJyR7dGhpcy5zb2NrZXRQYXRofSdgKTtcbiAgICAgICAgdGhpcy5zb2NrZXQgPSBuZXQuY29ubmVjdCh0aGlzLnNvY2tldFBhdGgpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodGhpcy5tZXNzYWdlUHJveHkpIHtcbiAgICAgICAgLy8gY29ubmVjdCB0byB0aGUgcHJveHkgaW5zdGVhZCBvZiB0aGUgcmVtb3RlIGRlYnVnZ2VyIGRpcmVjdGx5XG4gICAgICAgIHRoaXMucG9ydCA9IHRoaXMubWVzc2FnZVByb3h5O1xuICAgICAgfVxuXG4gICAgICAvLyB0Y3Agc29ja2V0XG4gICAgICBsb2cuZGVidWcoYENvbm5lY3RpbmcgdG8gcmVtb3RlIGRlYnVnZ2VyICR7dGhpcy5tZXNzYWdlUHJveHkgPyAndmlhIHByb3h5ICcgOiAnJ310aHJvdWdoIFRDUDogJHt0aGlzLmhvc3R9OiR7dGhpcy5wb3J0fWApO1xuICAgICAgdGhpcy5zb2NrZXQgPSBuZXcgbmV0LlNvY2tldCh7dHlwZTogJ3RjcDYnfSk7XG4gICAgICB0aGlzLnNvY2tldC5jb25uZWN0KHRoaXMucG9ydCwgdGhpcy5ob3N0KTtcbiAgICB9XG5cbiAgICB0aGlzLnNvY2tldC5zZXROb0RlbGF5KHRydWUpO1xuICAgIHRoaXMuc29ja2V0LnNldEtlZXBBbGl2ZSh0cnVlKTtcbiAgICB0aGlzLnNvY2tldC5vbignY2xvc2UnLCAoKSA9PiB7XG4gICAgICBpZiAodGhpcy5pc0Nvbm5lY3RlZCkge1xuICAgICAgICBsb2cuZGVidWcoJ0RlYnVnZ2VyIHNvY2tldCBkaXNjb25uZWN0ZWQnKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuaXNDb25uZWN0ZWQgPSBmYWxzZTtcbiAgICAgIHRoaXMuc29ja2V0ID0gbnVsbDtcbiAgICB9KTtcbiAgICB0aGlzLnNvY2tldC5vbignZW5kJywgKCkgPT4ge1xuICAgICAgdGhpcy5pc0Nvbm5lY3RlZCA9IGZhbHNlO1xuICAgIH0pO1xuICAgIHRoaXMuc2VydmljZSA9IGF3YWl0IHNlcnZpY2VzLnN0YXJ0V2ViSW5zcGVjdG9yU2VydmljZSh0aGlzLnVkaWQsIHtcbiAgICAgIHNvY2tldDogdGhpcy5zb2NrZXQsXG4gICAgICBpc1NpbXVsYXRvcjogdHJ1ZSxcbiAgICAgIG9zVmVyc2lvbjogdGhpcy5wbGF0Zm9ybVZlcnNpb24sXG4gICAgICB2ZXJib3NlOiB0aGlzLmxvZ0FsbENvbW11bmljYXRpb24sXG4gICAgICB2ZXJib3NlSGV4RHVtcDogdGhpcy5sb2dBbGxDb21tdW5pY2F0aW9uSGV4RHVtcCxcbiAgICB9KTtcbiAgICB0aGlzLnNlcnZpY2UubGlzdGVuTWVzc2FnZSh0aGlzLnJlY2VpdmUuYmluZCh0aGlzKSk7XG5cbiAgICAvLyBjb25uZWN0IHRoZSBzb2NrZXRcbiAgICByZXR1cm4gYXdhaXQgbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgLy8gb25seSByZXNvbHZlIHRoaXMgZnVuY3Rpb24gd2hlbiB3ZSBhcmUgYWN0dWFsbHkgY29ubmVjdGVkXG4gICAgICB0aGlzLnNvY2tldC5vbignY29ubmVjdCcsICgpID0+IHtcbiAgICAgICAgbG9nLmRlYnVnKGBEZWJ1Z2dlciBzb2NrZXQgY29ubmVjdGVkYCk7XG4gICAgICAgIHRoaXMuaXNDb25uZWN0ZWQgPSB0cnVlO1xuXG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5zb2NrZXQub24oJ2Vycm9yJywgKGVycikgPT4ge1xuICAgICAgICBpZiAodGhpcy5pc0Nvbm5lY3RlZCkge1xuICAgICAgICAgIGxvZy5lcnJvcihgU29ja2V0IGVycm9yOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgICAgIHRoaXMuaXNDb25uZWN0ZWQgPSBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIHRoZSBjb25uZWN0aW9uIHdhcyByZWZ1c2VkLCBzbyByZWplY3QgdGhlIGNvbm5lY3QgcHJvbWlzZVxuICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgZGlzY29ubmVjdCAoKSB7XG4gICAgaWYgKCF0aGlzLmlzQ29ubmVjdGVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgbG9nLmRlYnVnKCdEaXNjb25uZWN0aW5nIGZyb20gcmVtb3RlIGRlYnVnZ2VyJyk7XG4gICAgYXdhaXQgc3VwZXIuZGlzY29ubmVjdCgpO1xuICAgIHRoaXMuc2VydmljZS5jbG9zZSgpO1xuICAgIHRoaXMuaXNDb25uZWN0ZWQgPSBmYWxzZTtcbiAgfVxuXG4gIGFzeW5jIHNlbmRNZXNzYWdlIChjbWQpIHtcbiAgICBsZXQgb25Tb2NrZXRFcnJvcjtcblxuICAgIHJldHVybiBhd2FpdCBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAvLyBoYW5kbGUgc29ja2V0IHByb2JsZW1zXG4gICAgICBvblNvY2tldEVycm9yID0gKGVycikgPT4ge1xuICAgICAgICBsb2cuZXJyb3IoYFNvY2tldCBlcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcblxuICAgICAgICAvLyB0aGUgY29ubmVjdGlvbiB3YXMgcmVmdXNlZCwgc28gcmVqZWN0IHRoZSBjb25uZWN0IHByb21pc2VcbiAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICB9O1xuXG4gICAgICB0aGlzLnNvY2tldC5vbignZXJyb3InLCBvblNvY2tldEVycm9yKTtcbiAgICAgIHRoaXMuc2VydmljZS5zZW5kTWVzc2FnZShjbWQpO1xuICAgICAgcmVzb2x2ZSgpO1xuICAgIH0pXG4gICAgLmZpbmFsbHkoKCkgPT4ge1xuICAgICAgLy8gcmVtb3ZlIHRoaXMgbGlzdGVuZXIsIHNvIHdlIGRvbid0IGV4aGF1c3QgdGhlIHN5c3RlbVxuICAgICAgdHJ5IHtcbiAgICAgICAgdGhpcy5zb2NrZXQucmVtb3ZlTGlzdGVuZXIoJ2Vycm9yJywgb25Tb2NrZXRFcnJvcik7XG4gICAgICB9IGNhdGNoIChpZ24pIHt9XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyByZWNlaXZlIChkYXRhKSB7XG4gICAgaWYgKCF0aGlzLmlzQ29ubmVjdGVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKCFkYXRhKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBrZXkgb2YgWydXSVJNZXNzYWdlRGF0YUtleScsICdXSVJEZXN0aW5hdGlvbktleScsICdXSVJTb2NrZXREYXRhS2V5J10pIHtcbiAgICAgIGlmICghXy5pc1VuZGVmaW5lZChkYXRhW2tleV0pKSB7XG4gICAgICAgIGRhdGFba2V5XSA9IGRhdGFba2V5XS50b1N0cmluZygndXRmOCcpO1xuICAgICAgfVxuICAgIH1cbiAgICBhd2FpdCB0aGlzLm1lc3NhZ2VIYW5kbGVyLmhhbmRsZU1lc3NhZ2UoZGF0YSk7XG4gIH1cbn1cbiJdLCJmaWxlIjoibGliL3JwYy9ycGMtY2xpZW50LXNpbXVsYXRvci5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
