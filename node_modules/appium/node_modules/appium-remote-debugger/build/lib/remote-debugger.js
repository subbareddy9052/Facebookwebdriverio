"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.RPC_RESPONSE_TIMEOUT_MS = exports.REMOTE_DEBUGGER_PORT = exports.RemoteDebugger = exports.default = void 0;

require("source-map-support/register");

var _events = require("events");

var _logger = _interopRequireDefault(require("./logger"));

var _rpc = require("./rpc");

var _utils = require("./utils");

var _mixins = require("./mixins");

var _lodash = _interopRequireDefault(require("lodash"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _path = _interopRequireDefault(require("path"));

var _asyncLock = _interopRequireDefault(require("async-lock"));

let VERSION;

try {
  VERSION = require(_path.default.resolve(__dirname, '..', '..', 'package.json')).version;
} catch (ign) {}

const REMOTE_DEBUGGER_PORT = 27753;
exports.REMOTE_DEBUGGER_PORT = REMOTE_DEBUGGER_PORT;
const SAFARI_BUNDLE_ID = 'com.apple.mobilesafari';
const RPC_RESPONSE_TIMEOUT_MS = 5000;
exports.RPC_RESPONSE_TIMEOUT_MS = RPC_RESPONSE_TIMEOUT_MS;
const PAGE_READY_TIMEOUT = 5000;
const GARBAGE_COLLECT_TIMEOUT = 5000;

class RemoteDebugger extends _events.EventEmitter {
  constructor(opts = {}) {
    super();

    if (VERSION) {
      _logger.default.info(`Remote Debugger version ${VERSION}`);
    }

    const {
      bundleId,
      additionalBundleIds = [],
      platformVersion,
      isSafari = true,
      includeSafari = false,
      useNewSafari = false,
      pageLoadMs,
      host,
      port = REMOTE_DEBUGGER_PORT,
      socketPath,
      pageReadyTimeout = PAGE_READY_TIMEOUT,
      remoteDebugProxy,
      garbageCollectOnExecute = false,
      logFullResponse = false,
      logAllCommunication = false,
      logAllCommunicationHexDump = false,
      socketChunkSize,
      fullPageInitialization
    } = opts;
    this.bundleId = bundleId;
    this.additionalBundleIds = additionalBundleIds;
    this.platformVersion = platformVersion;
    this.isSafari = isSafari;
    this.includeSafari = includeSafari;
    this.useNewSafari = useNewSafari;
    this.pageLoadMs = pageLoadMs;

    _logger.default.debug(`useNewSafari --> ${this.useNewSafari}`);

    this.garbageCollectOnExecute = garbageCollectOnExecute;
    this.host = host;
    this.port = port;
    this.socketPath = socketPath;
    this.remoteDebugProxy = remoteDebugProxy;
    this.pageReadyTimeout = pageReadyTimeout;
    this.logAllCommunication = _lodash.default.isNil(logAllCommunication) ? !!logFullResponse : !!logAllCommunication;
    this.logAllCommunicationHexDump = logAllCommunicationHexDump;
    this.socketChunkSize = socketChunkSize;
    this.fullPageInitialization = fullPageInitialization;
    this._lock = new _asyncLock.default();
  }

  setup() {
    this.appDict = {};
    this.appIdKey = null;
    this.pageIdKey = null;
    this.pageLoading = false;
    this._navigatingToPage = false;
    this.allowNavigationWithoutReload = false;
    this.rpcClient = null;
    this._clientEventListeners = {};
  }

  teardown() {
    _logger.default.debug('Cleaning up listeners');

    this.appDict = {};
    this.appIdKey = null;
    this.pageIdKey = null;
    this.pageLoading = false;
    this.rpcClient = null;
    this.removeAllListeners(RemoteDebugger.EVENT_PAGE_CHANGE);
    this.removeAllListeners(RemoteDebugger.EVENT_DISCONNECT);
  }

  initRpcClient() {
    this.rpcClient = new _rpc.RpcClientSimulator({
      bundleId: this.bundleId,
      platformVersion: this.platformVersion,
      isSafari: this.isSafari,
      host: this.host,
      port: this.port,
      socketPath: this.socketPath,
      messageProxy: this.remoteDebugProxy,
      logAllCommunication: this.logAllCommunication,
      logAllCommunicationHexDump: this.logAllCommunicationHexDump,
      fullPageInitialization: this.fullPageInitialization
    });
  }

  get isConnected() {
    var _this$rpcClient;

    return !!((_this$rpcClient = this.rpcClient) === null || _this$rpcClient === void 0 ? void 0 : _this$rpcClient.isConnected);
  }

  async launchSafari() {
    await this.rpcClient.send('launchApplication', {
      bundleId: SAFARI_BUNDLE_ID
    });
  }

  async startTimeline(fn) {
    _logger.default.debug('Starting to record the timeline');

    this.rpcClient.on('Timeline.eventRecorded', fn);
    return await this.rpcClient.send('startTimeline', {
      appIdKey: this.appIdKey,
      pageIdKey: this.pageIdKey
    });
  }

  async stopTimeline() {
    _logger.default.debug('Stopping to record the timeline');

    await this.rpcClient.send('Timeline.stop', {
      appIdKey: this.appIdKey,
      pageIdKey: this.pageIdKey
    });
  }

  addClientEventListener(eventName, listener) {
    this._clientEventListeners[eventName] = this._clientEventListeners[eventName] || [];

    this._clientEventListeners[eventName].push(listener);

    this.rpcClient.on(eventName, listener);
  }

  removeClientEventListener(eventName) {
    for (const listener of this._clientEventListeners[eventName] || []) {
      this.rpcClient.off(eventName, listener);
    }
  }

  startConsole(listener) {
    _logger.default.debug('Starting to listen for JavaScript console');

    this.addClientEventListener('Console.messageAdded', listener);
    this.addClientEventListener('Console.messageRepeatCountUpdated', listener);
  }

  stopConsole() {
    _logger.default.debug('Stopping to listen for JavaScript console');

    this.removeClientEventListener('Console.messageAdded');
    this.removeClientEventListener('Console.messageRepeatCountUpdated');
  }

  startNetwork(listener) {
    _logger.default.debug('Starting to listen for network events');

    this.addClientEventListener('NetworkEvent', listener);
  }

  stopNetwork() {
    _logger.default.debug('Stopping to listen for network events');

    this.removeClientEventListener('NetworkEvent');
  }

  set allowNavigationWithoutReload(allow) {
    this._allowNavigationWithoutReload = allow;
  }

  get allowNavigationWithoutReload() {
    return this._allowNavigationWithoutReload;
  }

  async getCookies(urls) {
    _logger.default.debug('Getting network cookies');

    return await this.rpcClient.send('Page.getCookies', {
      appIdKey: this.appIdKey,
      pageIdKey: this.pageIdKey,
      urls
    });
  }

  async deleteCookie(cookieName, url) {
    _logger.default.debug(`Deleting cookie '${cookieName}' on '${url}'`);

    return await this.rpcClient.send('Page.deleteCookie', {
      appIdKey: this.appIdKey,
      pageIdKey: this.pageIdKey,
      cookieName,
      url
    });
  }

  async garbageCollect(timeoutMs = GARBAGE_COLLECT_TIMEOUT) {
    _logger.default.debug(`Garbage collecting with ${timeoutMs}ms timeout`);

    try {
      (0, _utils.checkParams)({
        appIdKey: this.appIdKey,
        pageIdKey: this.pageIdKey
      });
    } catch (err) {
      _logger.default.debug(`Unable to collect garbage at this time`);

      return;
    }

    await _bluebird.default.resolve(this.rpcClient.send('Heap.gc', {
      appIdKey: this.appIdKey,
      pageIdKey: this.pageIdKey
    })).timeout(timeoutMs).then(function gcSuccess() {
      _logger.default.debug(`Garbage collection successful`);
    }).catch(function gcError(err) {
      if (err instanceof _bluebird.default.TimeoutError) {
        _logger.default.debug(`Garbage collection timed out after ${timeoutMs}ms`);
      } else {
        _logger.default.debug(`Unable to collect garbage: ${err.message}`);
      }
    });
  }

  async useAppDictLock(fn) {
    return await this._lock.acquire('appDict', fn);
  }

  get skippedApps() {
    return this._skippedApps || [];
  }

}

exports.RemoteDebugger = RemoteDebugger;

for (const [name, fn] of _lodash.default.toPairs(_mixins.mixins)) {
  RemoteDebugger.prototype[name] = fn;
}

for (const [name, event] of _lodash.default.toPairs(_mixins.events)) {
  RemoteDebugger[name] = event;
}

var _default = RemoteDebugger;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9yZW1vdGUtZGVidWdnZXIuanMiXSwibmFtZXMiOlsiVkVSU0lPTiIsInJlcXVpcmUiLCJwYXRoIiwicmVzb2x2ZSIsIl9fZGlybmFtZSIsInZlcnNpb24iLCJpZ24iLCJSRU1PVEVfREVCVUdHRVJfUE9SVCIsIlNBRkFSSV9CVU5ETEVfSUQiLCJSUENfUkVTUE9OU0VfVElNRU9VVF9NUyIsIlBBR0VfUkVBRFlfVElNRU9VVCIsIkdBUkJBR0VfQ09MTEVDVF9USU1FT1VUIiwiUmVtb3RlRGVidWdnZXIiLCJFdmVudEVtaXR0ZXIiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJsb2ciLCJpbmZvIiwiYnVuZGxlSWQiLCJhZGRpdGlvbmFsQnVuZGxlSWRzIiwicGxhdGZvcm1WZXJzaW9uIiwiaXNTYWZhcmkiLCJpbmNsdWRlU2FmYXJpIiwidXNlTmV3U2FmYXJpIiwicGFnZUxvYWRNcyIsImhvc3QiLCJwb3J0Iiwic29ja2V0UGF0aCIsInBhZ2VSZWFkeVRpbWVvdXQiLCJyZW1vdGVEZWJ1Z1Byb3h5IiwiZ2FyYmFnZUNvbGxlY3RPbkV4ZWN1dGUiLCJsb2dGdWxsUmVzcG9uc2UiLCJsb2dBbGxDb21tdW5pY2F0aW9uIiwibG9nQWxsQ29tbXVuaWNhdGlvbkhleER1bXAiLCJzb2NrZXRDaHVua1NpemUiLCJmdWxsUGFnZUluaXRpYWxpemF0aW9uIiwiZGVidWciLCJfIiwiaXNOaWwiLCJfbG9jayIsIkFzeW5jTG9jayIsInNldHVwIiwiYXBwRGljdCIsImFwcElkS2V5IiwicGFnZUlkS2V5IiwicGFnZUxvYWRpbmciLCJfbmF2aWdhdGluZ1RvUGFnZSIsImFsbG93TmF2aWdhdGlvbldpdGhvdXRSZWxvYWQiLCJycGNDbGllbnQiLCJfY2xpZW50RXZlbnRMaXN0ZW5lcnMiLCJ0ZWFyZG93biIsInJlbW92ZUFsbExpc3RlbmVycyIsIkVWRU5UX1BBR0VfQ0hBTkdFIiwiRVZFTlRfRElTQ09OTkVDVCIsImluaXRScGNDbGllbnQiLCJScGNDbGllbnRTaW11bGF0b3IiLCJtZXNzYWdlUHJveHkiLCJpc0Nvbm5lY3RlZCIsImxhdW5jaFNhZmFyaSIsInNlbmQiLCJzdGFydFRpbWVsaW5lIiwiZm4iLCJvbiIsInN0b3BUaW1lbGluZSIsImFkZENsaWVudEV2ZW50TGlzdGVuZXIiLCJldmVudE5hbWUiLCJsaXN0ZW5lciIsInB1c2giLCJyZW1vdmVDbGllbnRFdmVudExpc3RlbmVyIiwib2ZmIiwic3RhcnRDb25zb2xlIiwic3RvcENvbnNvbGUiLCJzdGFydE5ldHdvcmsiLCJzdG9wTmV0d29yayIsImFsbG93IiwiX2FsbG93TmF2aWdhdGlvbldpdGhvdXRSZWxvYWQiLCJnZXRDb29raWVzIiwidXJscyIsImRlbGV0ZUNvb2tpZSIsImNvb2tpZU5hbWUiLCJ1cmwiLCJnYXJiYWdlQ29sbGVjdCIsInRpbWVvdXRNcyIsImVyciIsIkIiLCJ0aW1lb3V0IiwidGhlbiIsImdjU3VjY2VzcyIsImNhdGNoIiwiZ2NFcnJvciIsIlRpbWVvdXRFcnJvciIsIm1lc3NhZ2UiLCJ1c2VBcHBEaWN0TG9jayIsImFjcXVpcmUiLCJza2lwcGVkQXBwcyIsIl9za2lwcGVkQXBwcyIsIm5hbWUiLCJ0b1BhaXJzIiwibWl4aW5zIiwicHJvdG90eXBlIiwiZXZlbnQiLCJldmVudHMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsSUFBSUEsT0FBSjs7QUFDQSxJQUFJO0FBQ0ZBLEVBQUFBLE9BQU8sR0FBR0MsT0FBTyxDQUFDQyxjQUFLQyxPQUFMLENBQWFDLFNBQWIsRUFBd0IsSUFBeEIsRUFBOEIsSUFBOUIsRUFBb0MsY0FBcEMsQ0FBRCxDQUFQLENBQTZEQyxPQUF2RTtBQUNELENBRkQsQ0FFRSxPQUFPQyxHQUFQLEVBQVksQ0FBRTs7QUFFaEIsTUFBTUMsb0JBQW9CLEdBQUcsS0FBN0I7O0FBQ0EsTUFBTUMsZ0JBQWdCLEdBQUcsd0JBQXpCO0FBR0EsTUFBTUMsdUJBQXVCLEdBQUcs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QUE5QixDQUFiO0FBQ0Q7O0FBRUQsTUFBSWlDLFdBQUosR0FBbUI7QUFDakIsV0FBTyxLQUFLQyxZQUFMLElBQXFCLEVBQTVCO0FBQ0Q7O0FBeE91Qzs7OztBQTJPMUMsS0FBSyxNQUFNLENBQUNDLElBQUQsRUFBT25DLEVBQVAsQ0FBWCxJQUF5QnhCLGdCQUFFNEQsT0FBRixDQUFVQyxjQUFWLENBQXpCLEVBQTRDO0FBQzFDdEYsRUFBQUEsY0FBYyxDQUFDdUYsU0FBZixDQUF5QkgsSUFBekIsSUFBaUNuQyxFQUFqQztBQUNEOztBQUVELEtBQUssTUFBTSxDQUFDbUMsSUFBRCxFQUFPSSxLQUFQLENBQVgsSUFBNEIvRCxnQkFBRTRELE9BQUYsQ0FBVUksY0FBVixDQUE1QixFQUErQztBQUM3Q3pGLEVBQUFBLGNBQWMsQ0FBQ29GLElBQUQsQ0FBZCxHQUF1QkksS0FBdkI7QUFDRDs7ZUFFY3hGLGMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICdldmVudHMnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBScGNDbGllbnRTaW11bGF0b3IgfSBmcm9tICcuL3JwYyc7XG5pbXBvcnQgeyBjaGVja1BhcmFtcyB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IHsgbWl4aW5zLCBldmVudHMgfSBmcm9tICcuL21peGlucyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgQXN5bmNMb2NrIGZyb20gJ2FzeW5jLWxvY2snO1xuXG5cbmxldCBWRVJTSU9OO1xudHJ5IHtcbiAgVkVSU0lPTiA9IHJlcXVpcmUocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ3BhY2thZ2UuanNvbicpKS52ZXJzaW9uO1xufSBjYXRjaCAoaWduKSB7fVxuXG5jb25zdCBSRU1PVEVfREVCVUdHRVJfUE9SVCA9IDI3NzUzO1xuY29uc3QgU0FGQVJJX0JVTkRMRV9JRCA9ICdjb20uYXBwbGUubW9iaWxlc2FmYXJpJztcblxuLyogSG93IG1hbnkgbWlsbGlzZWNvbmRzIHRvIHdhaXQgZm9yIHdlYmtpdCB0byByZXR1cm4gYSByZXNwb25zZSBiZWZvcmUgdGltaW5nIG91dCAqL1xuY29uc3QgUlBDX1JFU1BPTlNFX1RJTUVPVVRfTVMgPSA1MDAwO1xuXG5jb25zdCBQQUdFX1JFQURZX1RJTUVPVVQgPSA1MDAwO1xuXG5jb25zdCBHQVJCQUdFX0NPTExFQ1RfVElNRU9VVCA9IDUwMDA7XG5cblxuY2xhc3MgUmVtb3RlRGVidWdnZXIgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICAvKlxuICAgKiBUaGUgY29uc3RydWN0b3IgdGFrZXMgYW4gb3B0cyBoYXNoIHdpdGggdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOlxuICAgKiAgIC0gYnVuZGxlSWQgLSBpZCBvZiB0aGUgYXBwIGJlaW5nIGNvbm5lY3RlZCB0b1xuICAgKiAgIC0gYWRkaXRpb25hbEJ1bmRsZUlkcyAtIGFycmF5IG9mIHBvc3NpYmxlIGJ1bmRsZSBpZHMgdGhhdCB0aGUgaW5zcGVjdG9yXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgY291bGQgcmV0dXJuXG4gICAqICAgLSBwbGF0Zm9ybVZlcnNpb24gLSB2ZXJzaW9uIG9mIGlPU1xuICAgKiAgIC0gdXNlTmV3U2FmYXJpIC0gZm9yIHdlYiBpbnNwZWN0b3IsIHdoZXRoZXIgdGhpcyBpcyBhIG5ldyBTYWZhcmkgaW5zdGFuY2VcbiAgICogICAtIHBhZ2VMb2FkTXMgLSB0aGUgdGltZSwgaW4gbXMsIHRoYXQgc2hvdWxkIGJlIHdhaXRlZCBmb3IgcGFnZSBsb2FkaW5nXG4gICAqICAgLSBob3N0IC0gdGhlIHJlbW90ZSBkZWJ1Z2dlcidzIGhvc3QgYWRkcmVzc1xuICAgKiAgIC0gcG9ydCAtIHRoZSByZW1vdGUgZGVidWdnZXIgcG9ydCB0aHJvdWdoIHdoaWNoIHRvIGNvbW11bmljYXRlXG4gICAqICAgLSBsb2dBbGxDb21tdW5pY2F0aW9uIC0gbG9nIHBsaXN0cyBzZW50IGFuZCByZWNlaXZlZCBmcm9tIFdlYiBJbnNwZWN0b3JcbiAgICogICAtIGxvZ0FsbENvbW11bmljYXRpb25IZXhEdW1wIC0gbG9nIGNvbW11bmljYXRpb24gZnJvbSBXZWIgSW5zcGVjdG9yIGFzIGhleCBkdW1wXG4gICAqICAgLSBzb2NrZXRDaHVua1NpemUgLSBzaXplLCBpbiBieXRlcywgb2YgY2h1bmtzIG9mIGRhdGEgc2VudCB0byBXZWIgSW5zcGVjdG9yIChyZWFsIGRldmljZSBvbmx5KVxuICAgKi9cbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIHN1cGVyKCk7XG5cbiAgICBpZiAoVkVSU0lPTikge1xuICAgICAgbG9nLmluZm8oYFJlbW90ZSBEZWJ1Z2dlciB2ZXJzaW9uICR7VkVSU0lPTn1gKTtcbiAgICB9XG5cbiAgICBjb25zdCB7XG4gICAgICBidW5kbGVJZCxcbiAgICAgIGFkZGl0aW9uYWxCdW5kbGVJZHMgPSBbXSxcbiAgICAgIHBsYXRmb3JtVmVyc2lvbixcbiAgICAgIGlzU2FmYXJpID0gdHJ1ZSxcbiAgICAgIGluY2x1ZGVTYWZhcmkgPSBmYWxzZSxcbiAgICAgIHVzZU5ld1NhZmFyaSA9IGZhbHNlLFxuICAgICAgcGFnZUxvYWRNcyxcbiAgICAgIGhvc3QsXG4gICAgICBwb3J0ID0gUkVNT1RFX0RFQlVHR0VSX1BPUlQsXG4gICAgICBzb2NrZXRQYXRoLFxuICAgICAgcGFnZVJlYWR5VGltZW91dCA9IFBBR0VfUkVBRFlfVElNRU9VVCxcbiAgICAgIHJlbW90ZURlYnVnUHJveHksXG4gICAgICBnYXJiYWdlQ29sbGVjdE9uRXhlY3V0ZSA9IGZhbHNlLFxuICAgICAgbG9nRnVsbFJlc3BvbnNlID0gZmFsc2UsXG4gICAgICBsb2dBbGxDb21tdW5pY2F0aW9uID0gZmFsc2UsXG4gICAgICBsb2dBbGxDb21tdW5pY2F0aW9uSGV4RHVtcCA9IGZhbHNlLFxuICAgICAgc29ja2V0Q2h1bmtTaXplLFxuICAgICAgZnVsbFBhZ2VJbml0aWFsaXphdGlvbixcbiAgICB9ID0gb3B0cztcblxuICAgIHRoaXMuYnVuZGxlSWQgPSBidW5kbGVJZDtcbiAgICB0aGlzLmFkZGl0aW9uYWxCdW5kbGVJZHMgPSBhZGRpdGlvbmFsQnVuZGxlSWRzO1xuICAgIHRoaXMucGxhdGZvcm1WZXJzaW9uID0gcGxhdGZvcm1WZXJzaW9uO1xuICAgIHRoaXMuaXNTYWZhcmkgPSBpc1NhZmFyaTtcbiAgICB0aGlzLmluY2x1ZGVTYWZhcmkgPSBpbmNsdWRlU2FmYXJpO1xuICAgIHRoaXMudXNlTmV3U2FmYXJpID0gdXNlTmV3U2FmYXJpO1xuICAgIHRoaXMucGFnZUxvYWRNcyA9IHBhZ2VMb2FkTXM7XG4gICAgbG9nLmRlYnVnKGB1c2VOZXdTYWZhcmkgLS0+ICR7dGhpcy51c2VOZXdTYWZhcml9YCk7XG5cbiAgICB0aGlzLmdhcmJhZ2VDb2xsZWN0T25FeGVjdXRlID0gZ2FyYmFnZUNvbGxlY3RPbkV4ZWN1dGU7XG5cbiAgICB0aGlzLmhvc3QgPSBob3N0O1xuICAgIHRoaXMucG9ydCA9IHBvcnQ7XG4gICAgdGhpcy5zb2NrZXRQYXRoID0gc29ja2V0UGF0aDtcbiAgICB0aGlzLnJlbW90ZURlYnVnUHJveHkgPSByZW1vdGVEZWJ1Z1Byb3h5O1xuICAgIHRoaXMucGFnZVJlYWR5VGltZW91dCA9IHBhZ2VSZWFkeVRpbWVvdXQ7XG5cbiAgICB0aGlzLmxvZ0FsbENvbW11bmljYXRpb24gPSBfLmlzTmlsKGxvZ0FsbENvbW11bmljYXRpb24pID8gISFsb2dGdWxsUmVzcG9uc2UgOiAhIWxvZ0FsbENvbW11bmljYXRpb247XG4gICAgdGhpcy5sb2dBbGxDb21tdW5pY2F0aW9uSGV4RHVtcCA9IGxvZ0FsbENvbW11bmljYXRpb25IZXhEdW1wO1xuICAgIHRoaXMuc29ja2V0Q2h1bmtTaXplID0gc29ja2V0Q2h1bmtTaXplO1xuXG4gICAgdGhpcy5mdWxsUGFnZUluaXRpYWxpemF0aW9uID0gZnVsbFBhZ2VJbml0aWFsaXphdGlvbjtcblxuICAgIHRoaXMuX2xvY2sgPSBuZXcgQXN5bmNMb2NrKCk7XG4gIH1cblxuICBzZXR1cCAoKSB7XG4gICAgLy8gYXBwIGhhbmRsaW5nIGNvbmZpZ3VyYXRpb25cbiAgICB0aGlzLmFwcERpY3QgPSB7fTtcbiAgICB0aGlzLmFwcElkS2V5ID0gbnVsbDtcbiAgICB0aGlzLnBhZ2VJZEtleSA9IG51bGw7XG4gICAgdGhpcy5wYWdlTG9hZGluZyA9IGZhbHNlO1xuICAgIHRoaXMuX25hdmlnYXRpbmdUb1BhZ2UgPSBmYWxzZTtcbiAgICB0aGlzLmFsbG93TmF2aWdhdGlvbldpdGhvdXRSZWxvYWQgPSBmYWxzZTtcblxuICAgIHRoaXMucnBjQ2xpZW50ID0gbnVsbDtcbiAgICB0aGlzLl9jbGllbnRFdmVudExpc3RlbmVycyA9IHt9O1xuICB9XG5cbiAgdGVhcmRvd24gKCkge1xuICAgIGxvZy5kZWJ1ZygnQ2xlYW5pbmcgdXAgbGlzdGVuZXJzJyk7XG5cbiAgICB0aGlzLmFwcERpY3QgPSB7fTtcbiAgICB0aGlzLmFwcElkS2V5ID0gbnVsbDtcbiAgICB0aGlzLnBhZ2VJZEtleSA9IG51bGw7XG4gICAgdGhpcy5wYWdlTG9hZGluZyA9IGZhbHNlO1xuXG4gICAgdGhpcy5ycGNDbGllbnQgPSBudWxsO1xuXG4gICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoUmVtb3RlRGVidWdnZXIuRVZFTlRfUEFHRV9DSEFOR0UpO1xuICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKFJlbW90ZURlYnVnZ2VyLkVWRU5UX0RJU0NPTk5FQ1QpO1xuICB9XG5cbiAgaW5pdFJwY0NsaWVudCAoKSB7XG4gICAgdGhpcy5ycGNDbGllbnQgPSBuZXcgUnBjQ2xpZW50U2ltdWxhdG9yKHtcbiAgICAgIGJ1bmRsZUlkOiB0aGlzLmJ1bmRsZUlkLFxuICAgICAgcGxhdGZvcm1WZXJzaW9uOiB0aGlzLnBsYXRmb3JtVmVyc2lvbixcbiAgICAgIGlzU2FmYXJpOiB0aGlzLmlzU2FmYXJpLFxuICAgICAgaG9zdDogdGhpcy5ob3N0LFxuICAgICAgcG9ydDogdGhpcy5wb3J0LFxuICAgICAgc29ja2V0UGF0aDogdGhpcy5zb2NrZXRQYXRoLFxuICAgICAgbWVzc2FnZVByb3h5OiB0aGlzLnJlbW90ZURlYnVnUHJveHksXG4gICAgICBsb2dBbGxDb21tdW5pY2F0aW9uOiB0aGlzLmxvZ0FsbENvbW11bmljYXRpb24sXG4gICAgICBsb2dBbGxDb21tdW5pY2F0aW9uSGV4RHVtcDogdGhpcy5sb2dBbGxDb21tdW5pY2F0aW9uSGV4RHVtcCxcbiAgICAgIGZ1bGxQYWdlSW5pdGlhbGl6YXRpb246IHRoaXMuZnVsbFBhZ2VJbml0aWFsaXphdGlvbixcbiAgICB9KTtcbiAgfVxuXG4gIGdldCBpc0Nvbm5lY3RlZCAoKSB7XG4gICAgcmV0dXJuICEhdGhpcy5ycGNDbGllbnQ/LmlzQ29ubmVjdGVkO1xuICB9XG5cbiAgYXN5bmMgbGF1bmNoU2FmYXJpICgpIHtcbiAgICBhd2FpdCB0aGlzLnJwY0NsaWVudC5zZW5kKCdsYXVuY2hBcHBsaWNhdGlvbicsIHtcbiAgICAgIGJ1bmRsZUlkOiBTQUZBUklfQlVORExFX0lEXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBzdGFydFRpbWVsaW5lIChmbikge1xuICAgIGxvZy5kZWJ1ZygnU3RhcnRpbmcgdG8gcmVjb3JkIHRoZSB0aW1lbGluZScpO1xuICAgIHRoaXMucnBjQ2xpZW50Lm9uKCdUaW1lbGluZS5ldmVudFJlY29yZGVkJywgZm4pO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnJwY0NsaWVudC5zZW5kKCdzdGFydFRpbWVsaW5lJywge1xuICAgICAgYXBwSWRLZXk6IHRoaXMuYXBwSWRLZXksXG4gICAgICBwYWdlSWRLZXk6IHRoaXMucGFnZUlkS2V5LFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgc3RvcFRpbWVsaW5lICgpIHtcbiAgICBsb2cuZGVidWcoJ1N0b3BwaW5nIHRvIHJlY29yZCB0aGUgdGltZWxpbmUnKTtcbiAgICBhd2FpdCB0aGlzLnJwY0NsaWVudC5zZW5kKCdUaW1lbGluZS5zdG9wJywge1xuICAgICAgYXBwSWRLZXk6IHRoaXMuYXBwSWRLZXksXG4gICAgICBwYWdlSWRLZXk6IHRoaXMucGFnZUlkS2V5LFxuICAgIH0pO1xuICB9XG5cbiAgLypcbiAgICogS2VlcCB0cmFjayBvZiB0aGUgY2xpZW50IGV2ZW50IGxpc3RlbmVycyBzbyB0aGV5IGNhbiBiZSByZW1vdmVkXG4gICAqL1xuICBhZGRDbGllbnRFdmVudExpc3RlbmVyIChldmVudE5hbWUsIGxpc3RlbmVyKSB7XG4gICAgdGhpcy5fY2xpZW50RXZlbnRMaXN0ZW5lcnNbZXZlbnROYW1lXSA9IHRoaXMuX2NsaWVudEV2ZW50TGlzdGVuZXJzW2V2ZW50TmFtZV0gfHwgW107XG4gICAgdGhpcy5fY2xpZW50RXZlbnRMaXN0ZW5lcnNbZXZlbnROYW1lXS5wdXNoKGxpc3RlbmVyKTtcbiAgICB0aGlzLnJwY0NsaWVudC5vbihldmVudE5hbWUsIGxpc3RlbmVyKTtcbiAgfVxuXG4gIHJlbW92ZUNsaWVudEV2ZW50TGlzdGVuZXIgKGV2ZW50TmFtZSkge1xuICAgIGZvciAoY29uc3QgbGlzdGVuZXIgb2YgKHRoaXMuX2NsaWVudEV2ZW50TGlzdGVuZXJzW2V2ZW50TmFtZV0gfHwgW10pKSB7XG4gICAgICB0aGlzLnJwY0NsaWVudC5vZmYoZXZlbnROYW1lLCBsaXN0ZW5lcik7XG4gICAgfVxuICB9XG5cbiAgc3RhcnRDb25zb2xlIChsaXN0ZW5lcikge1xuICAgIGxvZy5kZWJ1ZygnU3RhcnRpbmcgdG8gbGlzdGVuIGZvciBKYXZhU2NyaXB0IGNvbnNvbGUnKTtcbiAgICB0aGlzLmFkZENsaWVudEV2ZW50TGlzdGVuZXIoJ0NvbnNvbGUubWVzc2FnZUFkZGVkJywgbGlzdGVuZXIpO1xuICAgIHRoaXMuYWRkQ2xpZW50RXZlbnRMaXN0ZW5lcignQ29uc29sZS5tZXNzYWdlUmVwZWF0Q291bnRVcGRhdGVkJywgbGlzdGVuZXIpO1xuICB9XG5cbiAgc3RvcENvbnNvbGUgKCkge1xuICAgIGxvZy5kZWJ1ZygnU3RvcHBpbmcgdG8gbGlzdGVuIGZvciBKYXZhU2NyaXB0IGNvbnNvbGUnKTtcbiAgICB0aGlzLnJlbW92ZUNsaWVudEV2ZW50TGlzdGVuZXIoJ0NvbnNvbGUubWVzc2FnZUFkZGVkJyk7XG4gICAgdGhpcy5yZW1vdmVDbGllbnRFdmVudExpc3RlbmVyKCdDb25zb2xlLm1lc3NhZ2VSZXBlYXRDb3VudFVwZGF0ZWQnKTtcbiAgfVxuXG4gIHN0YXJ0TmV0d29yayAobGlzdGVuZXIpIHtcbiAgICBsb2cuZGVidWcoJ1N0YXJ0aW5nIHRvIGxpc3RlbiBmb3IgbmV0d29yayBldmVudHMnKTtcbiAgICB0aGlzLmFkZENsaWVudEV2ZW50TGlzdGVuZXIoJ05ldHdvcmtFdmVudCcsIGxpc3RlbmVyKTtcbiAgfVxuXG4gIHN0b3BOZXR3b3JrICgpIHtcbiAgICBsb2cuZGVidWcoJ1N0b3BwaW5nIHRvIGxpc3RlbiBmb3IgbmV0d29yayBldmVudHMnKTtcbiAgICB0aGlzLnJlbW92ZUNsaWVudEV2ZW50TGlzdGVuZXIoJ05ldHdvcmtFdmVudCcpO1xuICB9XG5cbiAgc2V0IGFsbG93TmF2aWdhdGlvbldpdGhvdXRSZWxvYWQgKGFsbG93KSB7XG4gICAgdGhpcy5fYWxsb3dOYXZpZ2F0aW9uV2l0aG91dFJlbG9hZCA9IGFsbG93O1xuICB9XG5cbiAgZ2V0IGFsbG93TmF2aWdhdGlvbldpdGhvdXRSZWxvYWQgKCkge1xuICAgIHJldHVybiB0aGlzLl9hbGxvd05hdmlnYXRpb25XaXRob3V0UmVsb2FkO1xuICB9XG5cbiAgYXN5bmMgZ2V0Q29va2llcyAodXJscykge1xuICAgIGxvZy5kZWJ1ZygnR2V0dGluZyBuZXR3b3JrIGNvb2tpZXMnKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5ycGNDbGllbnQuc2VuZCgnUGFnZS5nZXRDb29raWVzJywge1xuICAgICAgYXBwSWRLZXk6IHRoaXMuYXBwSWRLZXksXG4gICAgICBwYWdlSWRLZXk6IHRoaXMucGFnZUlkS2V5LFxuICAgICAgdXJscyxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZUNvb2tpZSAoY29va2llTmFtZSwgdXJsKSB7XG4gICAgbG9nLmRlYnVnKGBEZWxldGluZyBjb29raWUgJyR7Y29va2llTmFtZX0nIG9uICcke3VybH0nYCk7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucnBjQ2xpZW50LnNlbmQoJ1BhZ2UuZGVsZXRlQ29va2llJywge1xuICAgICAgYXBwSWRLZXk6IHRoaXMuYXBwSWRLZXksXG4gICAgICBwYWdlSWRLZXk6IHRoaXMucGFnZUlkS2V5LFxuICAgICAgY29va2llTmFtZSxcbiAgICAgIHVybCxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGdhcmJhZ2VDb2xsZWN0ICh0aW1lb3V0TXMgPSBHQVJCQUdFX0NPTExFQ1RfVElNRU9VVCkge1xuICAgIGxvZy5kZWJ1ZyhgR2FyYmFnZSBjb2xsZWN0aW5nIHdpdGggJHt0aW1lb3V0TXN9bXMgdGltZW91dGApO1xuICAgIHRyeSB7XG4gICAgICBjaGVja1BhcmFtcyh7YXBwSWRLZXk6IHRoaXMuYXBwSWRLZXksIHBhZ2VJZEtleTogdGhpcy5wYWdlSWRLZXl9KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgVW5hYmxlIHRvIGNvbGxlY3QgZ2FyYmFnZSBhdCB0aGlzIHRpbWVgKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBhd2FpdCBCLnJlc29sdmUodGhpcy5ycGNDbGllbnQuc2VuZCgnSGVhcC5nYycsIHtcbiAgICAgIGFwcElkS2V5OiB0aGlzLmFwcElkS2V5LFxuICAgICAgcGFnZUlkS2V5OiB0aGlzLnBhZ2VJZEtleSxcbiAgICB9KSkudGltZW91dCh0aW1lb3V0TXMpXG4gICAgLnRoZW4oZnVuY3Rpb24gZ2NTdWNjZXNzICgpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBwcm9taXNlL3ByZWZlci1hd2FpdC10by10aGVuXG4gICAgICBsb2cuZGVidWcoYEdhcmJhZ2UgY29sbGVjdGlvbiBzdWNjZXNzZnVsYCk7XG4gICAgfSkuY2F0Y2goZnVuY3Rpb24gZ2NFcnJvciAoZXJyKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcHJvbWlzZS9wcmVmZXItYXdhaXQtdG8tY2FsbGJhY2tzXG4gICAgICBpZiAoZXJyIGluc3RhbmNlb2YgQi5UaW1lb3V0RXJyb3IpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBHYXJiYWdlIGNvbGxlY3Rpb24gdGltZWQgb3V0IGFmdGVyICR7dGltZW91dE1zfW1zYCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2cuZGVidWcoYFVuYWJsZSB0byBjb2xsZWN0IGdhcmJhZ2U6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyB1c2VBcHBEaWN0TG9jayAoZm4pIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5fbG9jay5hY3F1aXJlKCdhcHBEaWN0JywgZm4pO1xuICB9XG5cbiAgZ2V0IHNraXBwZWRBcHBzICgpIHtcbiAgICByZXR1cm4gdGhpcy5fc2tpcHBlZEFwcHMgfHwgW107XG4gIH1cbn1cblxuZm9yIChjb25zdCBbbmFtZSwgZm5dIG9mIF8udG9QYWlycyhtaXhpbnMpKSB7XG4gIFJlbW90ZURlYnVnZ2VyLnByb3RvdHlwZVtuYW1lXSA9IGZuO1xufVxuXG5mb3IgKGNvbnN0IFtuYW1lLCBldmVudF0gb2YgXy50b1BhaXJzKGV2ZW50cykpIHtcbiAgUmVtb3RlRGVidWdnZXJbbmFtZV0gPSBldmVudDtcbn1cblxuZXhwb3J0IGRlZmF1bHQgUmVtb3RlRGVidWdnZXI7XG5leHBvcnQge1xuICBSZW1vdGVEZWJ1Z2dlciwgUkVNT1RFX0RFQlVHR0VSX1BPUlQsIFJQQ19SRVNQT05TRV9USU1FT1VUX01TLFxufTtcbiJdLCJmaWxlIjoibGliL3JlbW90ZS1kZWJ1Z2dlci5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
