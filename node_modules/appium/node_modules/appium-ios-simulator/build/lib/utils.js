"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.killAllSimulators = killAllSimulators;
exports.endAllSimulatorDaemons = endAllSimulatorDaemons;
exports.safeRimRaf = safeRimRaf;
exports.simExists = simExists;
exports.getSimulatorInfo = getSimulatorInfo;
exports.installSSLCert = installSSLCert;
exports.uninstallSSLCert = uninstallSSLCert;
exports.hasSSLCert = hasSSLCert;
exports.execSQLiteQuery = execSQLiteQuery;
exports.toBiometricDomainComponent = toBiometricDomainComponent;
exports.getDeveloperRoot = getDeveloperRoot;
exports.MOBILE_SAFARI_BUNDLE_ID = exports.SAFARI_STARTUP_TIMEOUT = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _teen_process = require("teen_process");

var _asyncbox = require("asyncbox");

var _appiumXcode = require("appium-xcode");

var _nodeSimctl = _interopRequireDefault(require("node-simctl"));

var _appiumSupport = require("appium-support");

var _certificate = require("./certificate");

var _path = _interopRequireDefault(require("path"));

var _simulatorXcode = _interopRequireDefault(require("./simulator-xcode-6"));

var _fkill = _interopRequireDefault(require("fkill"));

const DEFAULT_SIM_SHUTDOWN_TIMEOUT = 30000;
const SAFARI_STARTUP_TIMEOUT = 25 * 1000;
exports.SAFARI_STARTUP_TIMEOUT = SAFARI_STARTUP_TIMEOUT;
const MOBILE_SAFARI_BUNDLE_ID = 'com.apple.mobilesafari';
exports.MOBILE_SAFARI_BUNDLE_ID = MOBILE_SAFARI_BUNDLE_ID;
const BIOMETRICS = {
  touchId: 'fingerTouch',
  faceId: 'pearl'
};

function toBiometricDomainComponent(name) {
  if (!BIOMETRICS[name]) {
    throw new Error(`'${name}' is not a valid biometric. Use one of: ${JSON.stringify(_lodash.default.keys(BIOMETRICS))}`);
  }

  return BIOMETRICS[name];
}

async function pkill(appName, forceKill = false) {
  let args = forceKill ? ['-9'] : [];
  args.push('-x', appName);

  try {
    await (0, _teen_process.exec)('pkill', args);
    return 0;
  } catch (err) {
    if (!_lodash.default.isUndefined(err.code)) {
      throw new Error(`Cannot forcefully terminate ${appName}. pkill error code: ${err.code}`);
    }

    _logger.default.error(`Received unexpected error while trying to kill ${appName}: ${err.message}`);

    throw err;
  }
}

async function killAllSimulators(timeout = DEFAULT_SIM_SHUTDOWN_TIMEOUT) {
  _logger.default.debug('Killing all iOS Simulators');

  const xcodeVersion = await (0, _appiumXcode.getVersion)(true);
  const appName = xcodeVersion.major >= 7 ? 'Simulator' : 'iOS Simulator';
  timeout = timeout * (xcodeVersion.major >= 8 ? 2 : 1);

  try {
    await (0, _teen_process.exec)('xcrun', ['simctl', 'shutdown', xcodeVersion.major > 8 ? 'all' : 'booted'], {
      timeout
    });
  } catch (ign) {}

  const pids = [];

  try {
    const {
      stdout
    } = await (0, _teen_process.exec)('pgrep', ['-f', `${appName}.app/Contents/MacOS/`]);

    if (stdout.trim()) {
      pids.push(...stdout.trim().split(/\s+/));
    }
  } catch (e) {
    if (e.code === 1) {
      _logger.default.debug(`${appName} is not running. Continuing...`);

      return;
    }

    if (_lodash.default.isEmpty(pids)) {
      _logger.default.warn(`pgrep error ${e.code} while detecting whether ${appName} is running. Trying to kill anyway.`);
    }
  }

  if (!_lodash.default.isEmpty(pids)) {
    _logger.default.debug(`Using fkill to kill processes: ${pids.join(', ')}`);

    try {
      await (0, _fkill.default)(pids, {
        force: true
      });
    } catch (ign) {}
  }

  _logger.default.debug(`Using pkill to kill application: ${appName}`);

  try {
    await pkill(appName, true);
  } catch (ign) {}

  let remainingDevices = [];

  async function allSimsAreDown() {
    remainingDevices = [];
    let devices = await new _nodeSimctl.default().getDevices();
    devices = _lodash.default.flatten(_lodash.default.values(devices));
    return _lodash.default.every(devices, sim => {
      let state = sim.state.toLowerCase();
      let done = state === 'shutdown' || state === 'unavailable' || state === 'disconnected';

      if (!done) {
        remainingDevices.push(`${sim.name} (${sim.sdk}, udid: ${sim.udid}) is still in state '${state}'`);
      }

      return done;
    });
  }

  try {
    await (0, _asyncbox.waitForCondition)(allSimsAreDown, {
      waitMs: timeout,
      intervalMs: 200
    });
  } catch (err) {
    if (remainingDevices.length > 0) {
      _logger.default.warn(`The following devices are still not in the correct state after ${timeout} ms:`);

      for (let device of remainingDevices) {
        _logger.default.warn(`    ${device}`);
      }
    }

    throw err;
  }
}

async function endAllSimulatorDaemons() {
  _logger.default.debug('Ending all simulator daemons');

  for (let servicePattern of ['com.apple.iphonesimulator', 'com.apple.CoreSimulator']) {
    _logger.default.debug(`Killing any other ${servicePattern} daemons`);

    let launchCtlCommand = `launchctl list | grep ${servicePattern} | cut -f 3 | xargs -n 1 launchctl`;

    try {
      let stopCmd = `${launchCtlCommand} stop`;
      await (0, _teen_process.exec)('bash', ['-c', stopCmd]);
    } catch (err) {
      _logger.default.warn(`Could not stop ${servicePattern} daemons, carrying on anyway!`);
    }

    try {
      let removeCmd = `${launchCtlCommand} remove`;
      await (0, _teen_process.exec)('bash', ['-c', removeCmd]);
    } catch (err) {
      _logger.default.warn(`Could not remove ${servicePattern} daemons, carrying on anyway!`);
    }
  }

  try {
    await (0, _asyncbox.waitForCondition)(async () => {
      let {
        stdout
      } = await (0, _teen_process.exec)('bash', ['-c', `ps -e  | grep launchd_sim | grep -v bash | grep -v grep | awk {'print$1'}`]);
      return stdout.trim().length === 0;
    }, {
      waitMs: 5000,
      intervalMs: 500
    });
  } catch (err) {
    _logger.default.warn(`Could not end all simulator daemons, carrying on!`);
  }

  _logger.default.debug('Finishing ending all simulator daemons');
}

async function getSimulatorInfo(udid) {
  let devices = await new _nodeSimctl.default().getDevices();
  devices = _lodash.default.toPairs(devices).map(pair => pair[1]).reduce((a, b) => a.concat(b), []);
  return _lodash.default.find(devices, sim => sim.udid === udid);
}

async function simExists(udid) {
  return !!(await getSimulatorInfo(udid));
}

async function safeRimRaf(delPath, tryNum = 0) {
  try {
    await _appiumSupport.fs.rimraf(delPath);
  } catch (err) {
    if (tryNum < 20) {
      if (err.message.indexOf('ENOTEMPTY') !== -1) {
        _logger.default.debug(`Path '${delPath}' was not empty during delete; retrying`);

        return await safeRimRaf(delPath, tryNum + 1);
      } else if (err.message.indexOf('ENOENT') !== -1) {
        _logger.default.debug(`Path '${delPath}' did not exist when we tried to delete, ignoring`);

        return await safeRimRaf(delPath, tryNum + 1);
      }
    }
  }
}

async function installSSLCert(pemText, udid) {
  try {
    await _appiumSupport.fs.which('openssl');
  } catch (e) {
    _logger.default.debug(`customSSLCert requires openssl to be available on path`);

    _logger.default.errorAndThrow(`Command 'openssl' not found`);
  }

  try {
    await _appiumSupport.fs.which('sqlite3');
  } catch (e) {
    _logger.default.debug(`customSSLCert requires sqlite3 to be available on path`);

    _logger.default.errorAndThrow(`Command 'sqlite3' not found`);
  }

  let tempFileName = _path.default.resolve((await _appiumSupport.tempDir.openDir()), 'temp-ssl-cert.pem');

  let pathToKeychain = new _simulatorXcode.default(udid).getDir();
  await _appiumSupport.fs.writeFile(tempFileName, pemText);

  try {
    await _appiumSupport.fs.stat(pathToKeychain);
  } catch (e) {
    _logger.default.debug(`Could not install SSL certificate. No simulator with udid '${udid}'`);

    _logger.default.errorAndThrow(e);
  }

  let certificate = new _certificate.Certificate(tempFileName);

  _logger.default.debug(`Installing certificate to ${pathToKeychain}`);

  await certificate.add(pathToKeychain);
  await _appiumSupport.fs.unlink(tempFileName);
  return certificate;
}

async function uninstallSSLCert(pemText, udid) {
  try {
    let tempFileName = _path.default.resolve(__dirname, 'temp-ssl-cert.pem');

    let pathToKeychain = _path.default.resolve(new _simulatorXcode.default(udid).getDir());

    await _appiumSupport.fs.writeFile(tempFileName, pemText);
    let certificate = new _certificate.Certificate(tempFileName);
    await certificate.remove(pathToKeychain);
    await _appiumSupport.fs.unlink(tempFileName);
    return certificate;
  } catch (e) {
    _logger.default.debug(`Could not uninstall SSL certificate. No simulator with udid '${udid}'`);

    _logger.default.errorAndThrow(e);
  }
}

async function hasSSLCert(pemText, udid) {
  const tempFileName = _path.default.resolve((await _appiumSupport.tempDir.openDir()), 'temp-ssl-cert.pem');

  const pathToKeychain = new _simulatorXcode.default(udid).getDir();
  await _appiumSupport.fs.writeFile(tempFileName, pemText);
  const certificate = new _certificate.Certificate(tempFileName);
  return certificate.has(pathToKeychain);
}

async function execSQLiteQuery(db, query, ...queryParams) {
  query = query.replace(/\n+/g, ' ');
  let queryTokens = query.split('?');
  let formattedQuery = [];
  queryParams.map(param => `${param}`).forEach((param, i) => {
    formattedQuery.push(queryTokens[i]);
    formattedQuery.push(param.replace(/'/g, "''"));
  });
  formattedQuery.push(queryTokens[queryTokens.length - 1]);

  _logger.default.debug(`Executing SQL query "${formattedQuery.join('')}" on '${db}'`);

  try {
    return (await (0, _teen_process.exec)('sqlite3', ['-line', db, formattedQuery.join('')])).stdout;
  } catch (err) {
    throw new Error(`Cannot execute SQLite query "${formattedQuery.join('')}" to '${db}'. ` + `Original error: ${err.stderr}`);
  }
}

async function getDeveloperRoot() {
  const {
    stdout
  } = await (0, _teen_process.exec)('xcode-select', ['-p']);
  return stdout.trim();
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91dGlscy5qcyJdLCJuYW1lcyI6WyJERUZBVUxUX1NJTV9TSFVURE9XTl9USU1FT1VUIiwiU0FGQVJJX1NUQVJUVVBfVElNRU9VVCIsIk1PQklMRV9TQUZBUklfQlVORExFX0lEIiwiQklPTUVUUklDUyIsInRvdWNoSWQiLCJmYWNlSWQiLCJ0b0Jpb21ldHJpY0RvbWFpbkNvbXBvbmVudCIsIm5hbWUiLCJFcnJvciIsIkpTT04iLCJzdHJpbmdpZnkiLCJfIiwia2V5cyIsInBraWxsIiwiYXBwTmFtZSIsImZvcmNlS2lsbCIsImFyZ3MiLCJwdXNoIiwiZXJyIiwiaXNVbmRlZmluZWQiLCJjb2RlIiwibG9nIiwiZXJyb3IiLCJtZXNzYWdlIiwia2lsbEFsbFNpbXVsYXRvcnMiLCJ0aW1lb3V0IiwiZGVidWciLCJ4Y29kZVZlcnNpb24iLCJtYWpvciIsImlnbiIsInBpZHMiLCJzdGRvdXQiLCJ0cmltIiwic3BsaXQiLCJlIiwiaXNFbXB0eSIsIndhcm4iLCJqb2luIiwiZm9yY2UiLCJyZW1haW5pbmdEZXZpY2VzIiwiYWxsU2ltc0FyZURvd24iLCJkZXZpY2VzIiwiU2ltY3RsIiwiZ2V0RGV2aWNlcyIsImZsYXR0ZW4iLCJ2YWx1ZXMiLCJldmVyeSIsInNpbSIsInN0YXRlIiwidG9Mb3dlckNhc2UiLCJkb25lIiwic2RrIiwidWRpZCIsIndhaXRNcyIsImludGVydmFsTXMiLCJsZW5ndGgiLCJkZXZpY2UiLCJlbmRBbGxTaW11bGF0b3JEYWVtb25zIiwic2VydmljZVBhdHRlcm4iLCJsYXVuY2hDdGxDb21tYW5kIiwic3RvcENtZCIsInJlbW92ZUNtZCIsImdldFNpbXVsYXRvckluZm8iLCJ0b1BhaXJzIiwibWFwIiwicGFpciIsInJlZHVjZSIsImEiLCJiIiwiY29uY2F0IiwiZmluZCIsInNpbUV4aXN0cyIsInNhZmVSaW1SYWYiLCJkZWxQYXRoIiwidHJ5TnVtIiwiZnMiLCJyaW1yYWYiLCJpbmRleE9mIiwiaW5zdGFsbFNTTENlcnQiLCJwZW1UZXh0Iiwid2hpY2giLCJlcnJvckFuZFRocm93IiwidGVtcEZpbGVOYW1lIiwicGF0aCIsInJlc29sdmUiLCJ0ZW1wRGlyIiwib3BlbkRpciIsInBhdGhUb0tleWNoYWluIiwiU2ltdWxhdG9yIiwiZ2V0RGlyIiwid3JpdGVGaWxlIiwic3RhdCIsImNlcnRpZmljYXRlIiwiQ2VydGlmaWNhdGUiLCJhZGQiLCJ1bmxpbmsiLCJ1bmluc3RhbGxTU0xDZXJ0IiwiX19kaXJuYW1lIiwicmVtb3ZlIiwiaGFzU1NMQ2VydCIsImhhcyIsImV4ZWNTUUxpdGVRdWVyeSIsImRiIiwicXVlcnkiLCJxdWVyeVBhcmFtcyIsInJlcGxhY2UiLCJxdWVyeVRva2VucyIsImZvcm1hdHRlZFF1ZXJ5IiwicGFyYW0iLCJmb3JFYWNoIiwiaSIsInN0ZGVyciIsImdldERldmVsb3BlclJvb3QiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSw0QkFBNEIsR0FBRyxLQUFyQztBQUNBLE1BQU1DLHNCQUFzQixHQUFHLEtBQUssSUFBcEM7O0FBQ0EsTUFBTUMsdUJBQXVCLEdBQUcsd0JBQWhDOztBQUVBLE1BQU1DLFVBQVUsR0FBRztBQUNqQkMsRUFBQUEsT0FBTyxFQUFFLGFBRFE7QUFFakJDLEVBQUFBLE1BQU0sRUFBRTtBQUZTLENBQW5COztBQUtBLFNBQVNDLDBCQUFULENBQXFDQyxJQUFyQyxFQUEyQztBQUN6QyxNQUFJLENBQUNKLFVBQVUsQ0FBQ0ksSUFBRCxDQUFmLEVBQXVCO0FBQ3JCLFVBQU0sSUFBSUMsS0FBSixDQUFXLElBQUdELElBQUssMkNBQTBDRSxJQUFJLENBQUNDLFNBQUwsQ0FBZUMsZ0JBQUVDLElBQUYsQ0FBT1QsVUFBUCxDQUFmLENBQW1DLEVBQWhHLENBQU47QUFDRDs7QUFDRCxTQUFPQSxVQUFVLENBQUNJLElBQUQsQ0FBakI7QUFDRDs7QUFRRCxlQUFl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QUosQ0FBVyx3QkFBdUJpRixjQUFjLENBQUN0RSxJQUFmLENBQW9CLEVBQXBCLENBQXdCLFNBQVFpRSxFQUFHLEdBQXJFOztBQUNBLE1BQUk7QUFDRixXQUFPLENBQUMsTUFBTSx3QkFBSyxTQUFMLEVBQWdCLENBQUMsT0FBRCxFQUFVQSxFQUFWLEVBQWNLLGNBQWMsQ0FBQ3RFLElBQWYsQ0FBb0IsRUFBcEIsQ0FBZCxDQUFoQixDQUFQLEVBQWdFTixNQUF2RTtBQUNELEdBRkQsQ0FFRSxPQUFPYixHQUFQLEVBQVk7QUFDWixVQUFNLElBQUlWLEtBQUosQ0FBVyxnQ0FBK0JtRyxjQUFjLENBQUN0RSxJQUFmLENBQW9CLEVBQXBCLENBQXdCLFNBQVFpRSxFQUFHLEtBQW5FLEdBQ2IsbUJBQWtCcEYsR0FBRyxDQUFDNkYsTUFBTyxFQUQxQixDQUFOO0FBRUQ7QUFDRjs7QUFFRCxlQUFlQyxnQkFBZixHQUFtQztBQUNqQyxRQUFNO0FBQUNqRixJQUFBQTtBQUFELE1BQVcsTUFBTSx3QkFBSyxjQUFMLEVBQXFCLENBQUMsSUFBRCxDQUFyQixDQUF2QjtBQUNBLFNBQU9BLE1BQU0sQ0FBQ0MsSUFBUCxFQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCB7IHdhaXRGb3JDb25kaXRpb24gfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgeyBnZXRWZXJzaW9uIH0gZnJvbSAnYXBwaXVtLXhjb2RlJztcbmltcG9ydCBTaW1jdGwgZnJvbSAnbm9kZS1zaW1jdGwnO1xuaW1wb3J0IHsgZnMsIHRlbXBEaXIgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBDZXJ0aWZpY2F0ZSB9IGZyb20gJy4vY2VydGlmaWNhdGUnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgU2ltdWxhdG9yIGZyb20gJy4vc2ltdWxhdG9yLXhjb2RlLTYnO1xuaW1wb3J0IGZraWxsIGZyb20gJ2ZraWxsJztcblxuXG5jb25zdCBERUZBVUxUX1NJTV9TSFVURE9XTl9USU1FT1VUID0gMzAwMDA7XG5jb25zdCBTQUZBUklfU1RBUlRVUF9USU1FT1VUID0gMjUgKiAxMDAwO1xuY29uc3QgTU9CSUxFX1NBRkFSSV9CVU5ETEVfSUQgPSAnY29tLmFwcGxlLm1vYmlsZXNhZmFyaSc7XG5cbmNvbnN0IEJJT01FVFJJQ1MgPSB7XG4gIHRvdWNoSWQ6ICdmaW5nZXJUb3VjaCcsXG4gIGZhY2VJZDogJ3BlYXJsJyxcbn07XG5cbmZ1bmN0aW9uIHRvQmlvbWV0cmljRG9tYWluQ29tcG9uZW50IChuYW1lKSB7XG4gIGlmICghQklPTUVUUklDU1tuYW1lXSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgJyR7bmFtZX0nIGlzIG5vdCBhIHZhbGlkIGJpb21ldHJpYy4gVXNlIG9uZSBvZjogJHtKU09OLnN0cmluZ2lmeShfLmtleXMoQklPTUVUUklDUykpfWApO1xuICB9XG4gIHJldHVybiBCSU9NRVRSSUNTW25hbWVdO1xufVxuXG4vLyBwZ3JlcC9wa2lsbCBleGl0IGNvZGVzOlxuLy8gMCAgICAgICBPbmUgb3IgbW9yZSBwcm9jZXNzZXMgd2VyZSBtYXRjaGVkLlxuLy8gMSAgICAgICBObyBwcm9jZXNzZXMgd2VyZSBtYXRjaGVkLlxuLy8gMiAgICAgICBJbnZhbGlkIG9wdGlvbnMgd2VyZSBzcGVjaWZpZWQgb24gdGhlIGNvbW1hbmQgbGluZS5cbi8vIDMgICAgICAgQW4gaW50ZXJuYWwgZXJyb3Igb2NjdXJyZWQuXG5cbmFzeW5jIGZ1bmN0aW9uIHBraWxsIChhcHBOYW1lLCBmb3JjZUtpbGwgPSBmYWxzZSkge1xuICBsZXQgYXJncyA9IGZvcmNlS2lsbCA/IFsnLTknXSA6IFtdO1xuICBhcmdzLnB1c2goJy14JywgYXBwTmFtZSk7XG4gIHRyeSB7XG4gICAgYXdhaXQgZXhlYygncGtpbGwnLCBhcmdzKTtcbiAgICByZXR1cm4gMDtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKCFfLmlzVW5kZWZpbmVkKGVyci5jb2RlKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgZm9yY2VmdWxseSB0ZXJtaW5hdGUgJHthcHBOYW1lfS4gcGtpbGwgZXJyb3IgY29kZTogJHtlcnIuY29kZX1gKTtcbiAgICB9XG4gICAgbG9nLmVycm9yKGBSZWNlaXZlZCB1bmV4cGVjdGVkIGVycm9yIHdoaWxlIHRyeWluZyB0byBraWxsICR7YXBwTmFtZX06ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgdGhyb3cgZXJyO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGtpbGxBbGxTaW11bGF0b3JzICh0aW1lb3V0ID0gREVGQVVMVF9TSU1fU0hVVERPV05fVElNRU9VVCkge1xuICBsb2cuZGVidWcoJ0tpbGxpbmcgYWxsIGlPUyBTaW11bGF0b3JzJyk7XG4gIGNvbnN0IHhjb2RlVmVyc2lvbiA9IGF3YWl0IGdldFZlcnNpb24odHJ1ZSk7XG4gIGNvbnN0IGFwcE5hbWUgPSB4Y29kZVZlcnNpb24ubWFqb3IgPj0gNyA/ICdTaW11bGF0b3InIDogJ2lPUyBTaW11bGF0b3InO1xuXG4gIC8vIGxhdGVyIHZlcnNpb25zIGFyZSBzbG93ZXIgdG8gY2xvc2VcbiAgdGltZW91dCA9IHRpbWVvdXQgKiAoeGNvZGVWZXJzaW9uLm1ham9yID49IDggPyAyIDogMSk7XG5cbiAgdHJ5IHtcbiAgICBhd2FpdCBleGVjKCd4Y3J1bicsIFsnc2ltY3RsJywgJ3NodXRkb3duJywgeGNvZGVWZXJzaW9uLm1ham9yID4gOCA/ICdhbGwnIDogJ2Jvb3RlZCddLCB7dGltZW91dH0pO1xuICB9IGNhdGNoIChpZ24pIHt9XG5cbiAgY29uc3QgcGlkcyA9IFtdO1xuICB0cnkge1xuICAgIGNvbnN0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYygncGdyZXAnLCBbJy1mJywgYCR7YXBwTmFtZX0uYXBwL0NvbnRlbnRzL01hY09TL2BdKTtcbiAgICBpZiAoc3Rkb3V0LnRyaW0oKSkge1xuICAgICAgcGlkcy5wdXNoKC4uLihzdGRvdXQudHJpbSgpLnNwbGl0KC9cXHMrLykpKTtcbiAgICB9XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBpZiAoZS5jb2RlID09PSAxKSB7XG4gICAgICBsb2cuZGVidWcoYCR7YXBwTmFtZX0gaXMgbm90IHJ1bm5pbmcuIENvbnRpbnVpbmcuLi5gKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKF8uaXNFbXB0eShwaWRzKSkge1xuICAgICAgbG9nLndhcm4oYHBncmVwIGVycm9yICR7ZS5jb2RlfSB3aGlsZSBkZXRlY3Rpbmcgd2hldGhlciAke2FwcE5hbWV9IGlzIHJ1bm5pbmcuIFRyeWluZyB0byBraWxsIGFueXdheS5gKTtcbiAgICB9XG4gIH1cbiAgaWYgKCFfLmlzRW1wdHkocGlkcykpIHtcbiAgICBsb2cuZGVidWcoYFVzaW5nIGZraWxsIHRvIGtpbGwgcHJvY2Vzc2VzOiAke3BpZHMuam9pbignLCAnKX1gKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgZmtpbGwocGlkcywge2ZvcmNlOiB0cnVlfSk7XG4gICAgfSBjYXRjaCAoaWduKSB7fVxuICB9XG5cbiAgbG9nLmRlYnVnKGBVc2luZyBwa2lsbCB0byBraWxsIGFwcGxpY2F0aW9uOiAke2FwcE5hbWV9YCk7XG4gIHRyeSB7XG4gICAgYXdhaXQgcGtpbGwoYXBwTmFtZSwgdHJ1ZSk7XG4gIH0gY2F0Y2ggKGlnbikge31cblxuICAvLyB3YWl0IGZvciBhbGwgdGhlIGRldmljZXMgdG8gYmUgc2h1dGRvd24gYmVmb3JlIENvbnRpbnVpbmdcbiAgLy8gYnV0IG9ubHkgcHJpbnQgb3V0IHRoZSBmYWlsZWQgb25lcyB3aGVuIHRoZXkgYXJlIGFjdHVhbGx5IGZ1bGx5IGZhaWxlZFxuICBsZXQgcmVtYWluaW5nRGV2aWNlcyA9IFtdO1xuICBhc3luYyBmdW5jdGlvbiBhbGxTaW1zQXJlRG93biAoKSB7XG4gICAgcmVtYWluaW5nRGV2aWNlcyA9IFtdO1xuICAgIGxldCBkZXZpY2VzID0gYXdhaXQgbmV3IFNpbWN0bCgpLmdldERldmljZXMoKTtcbiAgICBkZXZpY2VzID0gXy5mbGF0dGVuKF8udmFsdWVzKGRldmljZXMpKTtcbiAgICByZXR1cm4gXy5ldmVyeShkZXZpY2VzLCAoc2ltKSA9PiB7XG4gICAgICBsZXQgc3RhdGUgPSBzaW0uc3RhdGUudG9Mb3dlckNhc2UoKTtcbiAgICAgIGxldCBkb25lID0gc3RhdGUgPT09ICdzaHV0ZG93bicgfHxcbiAgICAgICAgICAgICAgICAgc3RhdGUgPT09ICd1bmF2YWlsYWJsZScgfHxcbiAgICAgICAgICAgICAgICAgc3RhdGUgPT09ICdkaXNjb25uZWN0ZWQnO1xuICAgICAgaWYgKCFkb25lKSB7XG4gICAgICAgIHJlbWFpbmluZ0RldmljZXMucHVzaChgJHtzaW0ubmFtZX0gKCR7c2ltLnNka30sIHVkaWQ6ICR7c2ltLnVkaWR9KSBpcyBzdGlsbCBpbiBzdGF0ZSAnJHtzdGF0ZX0nYCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gZG9uZTtcbiAgICB9KTtcbiAgfVxuICB0cnkge1xuICAgIGF3YWl0IHdhaXRGb3JDb25kaXRpb24oYWxsU2ltc0FyZURvd24sIHtcbiAgICAgIHdhaXRNczogdGltZW91dCxcbiAgICAgIGludGVydmFsTXM6IDIwMFxuICAgIH0pO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAocmVtYWluaW5nRGV2aWNlcy5sZW5ndGggPiAwKSB7XG4gICAgICBsb2cud2FybihgVGhlIGZvbGxvd2luZyBkZXZpY2VzIGFyZSBzdGlsbCBub3QgaW4gdGhlIGNvcnJlY3Qgc3RhdGUgYWZ0ZXIgJHt0aW1lb3V0fSBtczpgKTtcbiAgICAgIGZvciAobGV0IGRldmljZSBvZiByZW1haW5pbmdEZXZpY2VzKSB7XG4gICAgICAgIGxvZy53YXJuKGAgICAgJHtkZXZpY2V9YCk7XG4gICAgICB9XG4gICAgfVxuICAgIHRocm93IGVycjtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBlbmRBbGxTaW11bGF0b3JEYWVtb25zICgpIHtcbiAgbG9nLmRlYnVnKCdFbmRpbmcgYWxsIHNpbXVsYXRvciBkYWVtb25zJyk7XG4gIGZvciAobGV0IHNlcnZpY2VQYXR0ZXJuIG9mIFsnY29tLmFwcGxlLmlwaG9uZXNpbXVsYXRvcicsICdjb20uYXBwbGUuQ29yZVNpbXVsYXRvciddKSB7XG4gICAgbG9nLmRlYnVnKGBLaWxsaW5nIGFueSBvdGhlciAke3NlcnZpY2VQYXR0ZXJufSBkYWVtb25zYCk7XG4gICAgbGV0IGxhdW5jaEN0bENvbW1hbmQgPSBgbGF1bmNoY3RsIGxpc3QgfCBncmVwICR7c2VydmljZVBhdHRlcm59IHwgY3V0IC1mIDMgfCB4YXJncyAtbiAxIGxhdW5jaGN0bGA7XG4gICAgdHJ5IHtcbiAgICAgIGxldCBzdG9wQ21kID0gYCR7bGF1bmNoQ3RsQ29tbWFuZH0gc3RvcGA7XG4gICAgICBhd2FpdCBleGVjKCdiYXNoJywgWyctYycsIHN0b3BDbWRdKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy53YXJuKGBDb3VsZCBub3Qgc3RvcCAke3NlcnZpY2VQYXR0ZXJufSBkYWVtb25zLCBjYXJyeWluZyBvbiBhbnl3YXkhYCk7XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICBsZXQgcmVtb3ZlQ21kID0gYCR7bGF1bmNoQ3RsQ29tbWFuZH0gcmVtb3ZlYDtcbiAgICAgIGF3YWl0IGV4ZWMoJ2Jhc2gnLCBbJy1jJywgcmVtb3ZlQ21kXSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cud2FybihgQ291bGQgbm90IHJlbW92ZSAke3NlcnZpY2VQYXR0ZXJufSBkYWVtb25zLCBjYXJyeWluZyBvbiBhbnl3YXkhYCk7XG4gICAgfVxuICB9XG4gIC8vIHdhaXRpbmcgdW50aWwgdGhlIHNpbXVsYXRvciBzZXJ2aWNlIGhhcyBkaWVkLlxuICB0cnkge1xuICAgIGF3YWl0IHdhaXRGb3JDb25kaXRpb24oYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYygnYmFzaCcsIFsnLWMnLFxuICAgICAgICBgcHMgLWUgIHwgZ3JlcCBsYXVuY2hkX3NpbSB8IGdyZXAgLXYgYmFzaCB8IGdyZXAgLXYgZ3JlcCB8IGF3ayB7J3ByaW50JDEnfWBdKTtcbiAgICAgIHJldHVybiBzdGRvdXQudHJpbSgpLmxlbmd0aCA9PT0gMDtcbiAgICB9LCB7d2FpdE1zOiA1MDAwLCBpbnRlcnZhbE1zOiA1MDB9KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oYENvdWxkIG5vdCBlbmQgYWxsIHNpbXVsYXRvciBkYWVtb25zLCBjYXJyeWluZyBvbiFgKTtcbiAgfVxuICBsb2cuZGVidWcoJ0ZpbmlzaGluZyBlbmRpbmcgYWxsIHNpbXVsYXRvciBkYWVtb25zJyk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFNpbXVsYXRvckluZm8gKHVkaWQpIHtcbiAgLy8gc2VlIHRoZSBSRUFETUUgZm9yIGdpdGh1Yi5jb20vYXBwaXVtL25vZGUtc2ltY3RsIGZvciBleGFtcGxlIG91dHB1dCBvZiBnZXREZXZpY2VzKClcbiAgbGV0IGRldmljZXMgPSBhd2FpdCBuZXcgU2ltY3RsKCkuZ2V0RGV2aWNlcygpO1xuXG4gIGRldmljZXMgPSBfLnRvUGFpcnMoZGV2aWNlcylcbiAgICAubWFwKChwYWlyKSA9PiBwYWlyWzFdKVxuICAgIC5yZWR1Y2UoKGEsIGIpID0+IGEuY29uY2F0KGIpLCBbXSk7XG4gIHJldHVybiBfLmZpbmQoZGV2aWNlcywgKHNpbSkgPT4gc2ltLnVkaWQgPT09IHVkaWQpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzaW1FeGlzdHMgKHVkaWQpIHtcbiAgcmV0dXJuICEhKGF3YWl0IGdldFNpbXVsYXRvckluZm8odWRpZCkpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzYWZlUmltUmFmIChkZWxQYXRoLCB0cnlOdW0gPSAwKSB7XG4gIHRyeSB7XG4gICAgYXdhaXQgZnMucmltcmFmKGRlbFBhdGgpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAodHJ5TnVtIDwgMjApIHtcbiAgICAgIGlmIChlcnIubWVzc2FnZS5pbmRleE9mKCdFTk9URU1QVFknKSAhPT0gLTEpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBQYXRoICcke2RlbFBhdGh9JyB3YXMgbm90IGVtcHR5IGR1cmluZyBkZWxldGU7IHJldHJ5aW5nYCk7XG4gICAgICAgIHJldHVybiBhd2FpdCBzYWZlUmltUmFmKGRlbFBhdGgsIHRyeU51bSArIDEpO1xuICAgICAgfSBlbHNlIGlmIChlcnIubWVzc2FnZS5pbmRleE9mKCdFTk9FTlQnKSAhPT0gLTEpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBQYXRoICcke2RlbFBhdGh9JyBkaWQgbm90IGV4aXN0IHdoZW4gd2UgdHJpZWQgdG8gZGVsZXRlLCBpZ25vcmluZ2ApO1xuICAgICAgICByZXR1cm4gYXdhaXQgc2FmZVJpbVJhZihkZWxQYXRoLCB0cnlOdW0gKyAxKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBJbnN0YWxsIGFuIFNTTCBjZXJ0aWZpY2F0ZSB0byBhIGRldmljZSB3aXRoIGdpdmVuIHVkaWRcbiAqIEBwYXJhbSB7c3RyaW5nfSBwZW1UZXh0IFNTTCBwZW0gdGV4dFxuICogQHBhcmFtIHtzdHJpbmd9IHVkaWQgSWRlbnRpZmllciBvZiB0aGUgU2ltdWxhdG9yXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGluc3RhbGxTU0xDZXJ0IChwZW1UZXh0LCB1ZGlkKSB7XG4gIC8vIENoZWNrIHRoYXQgb3BlbnNzbCBpcyBpbnN0YWxsZWQgb24gdGhlIHBhdGhcbiAgdHJ5IHtcbiAgICBhd2FpdCBmcy53aGljaCgnb3BlbnNzbCcpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmRlYnVnKGBjdXN0b21TU0xDZXJ0IHJlcXVpcmVzIG9wZW5zc2wgdG8gYmUgYXZhaWxhYmxlIG9uIHBhdGhgKTtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgQ29tbWFuZCAnb3BlbnNzbCcgbm90IGZvdW5kYCk7XG4gIH1cblxuICAvLyBDaGVjayB0aGF0IHNxbGl0ZTMgaXMgaW5zdGFsbGVkIG9uIHRoZSBwYXRoXG4gIHRyeSB7XG4gICAgYXdhaXQgZnMud2hpY2goJ3NxbGl0ZTMnKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZy5kZWJ1ZyhgY3VzdG9tU1NMQ2VydCByZXF1aXJlcyBzcWxpdGUzIHRvIGJlIGF2YWlsYWJsZSBvbiBwYXRoYCk7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYENvbW1hbmQgJ3NxbGl0ZTMnIG5vdCBmb3VuZGApO1xuICB9XG5cbiAgLy8gQ3JlYXRlIGEgdGVtcG9yYXJ5IGZpbGUgdG8gc3RvcmUgUEVNIHRleHRcbiAgLy8gKGEgdGVtcCBmaWxlIGlzIG5lY2Vzc2FyeSB0byBydW4gYG9wZW5zc2xgIHNoZWxsIGNvbW1hbmRzLCBjYW4ndCBiZSBkb25lIGluIG1lbW9yeSlcbiAgbGV0IHRlbXBGaWxlTmFtZSA9IHBhdGgucmVzb2x2ZShhd2FpdCB0ZW1wRGlyLm9wZW5EaXIoKSwgJ3RlbXAtc3NsLWNlcnQucGVtJyk7XG4gIGxldCBwYXRoVG9LZXljaGFpbiA9IG5ldyBTaW11bGF0b3IodWRpZCkuZ2V0RGlyKCk7XG4gIGF3YWl0IGZzLndyaXRlRmlsZSh0ZW1wRmlsZU5hbWUsIHBlbVRleHQpO1xuICB0cnkge1xuICAgIGF3YWl0IGZzLnN0YXQocGF0aFRvS2V5Y2hhaW4pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmRlYnVnKGBDb3VsZCBub3QgaW5zdGFsbCBTU0wgY2VydGlmaWNhdGUuIE5vIHNpbXVsYXRvciB3aXRoIHVkaWQgJyR7dWRpZH0nYCk7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coZSk7XG4gIH1cblxuICAvLyBEbyB0aGUgY2VydGlmaWNhdGUgaW5zdGFsbGF0aW9uXG4gIGxldCBjZXJ0aWZpY2F0ZSA9IG5ldyBDZXJ0aWZpY2F0ZSh0ZW1wRmlsZU5hbWUpO1xuICBsb2cuZGVidWcoYEluc3RhbGxpbmcgY2VydGlmaWNhdGUgdG8gJHtwYXRoVG9LZXljaGFpbn1gKTtcbiAgYXdhaXQgY2VydGlmaWNhdGUuYWRkKHBhdGhUb0tleWNoYWluKTtcblxuICAvLyBSZW1vdmUgdGhlIHRlbXBvcmFyeSBmaWxlXG4gIGF3YWl0IGZzLnVubGluayh0ZW1wRmlsZU5hbWUpO1xuXG4gIHJldHVybiBjZXJ0aWZpY2F0ZTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gdW5pbnN0YWxsU1NMQ2VydCAocGVtVGV4dCwgdWRpZCkge1xuICB0cnkge1xuICAgIGxldCB0ZW1wRmlsZU5hbWUgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAndGVtcC1zc2wtY2VydC5wZW0nKTtcbiAgICBsZXQgcGF0aFRvS2V5Y2hhaW4gPSBwYXRoLnJlc29sdmUobmV3IFNpbXVsYXRvcih1ZGlkKS5nZXREaXIoKSk7XG4gICAgYXdhaXQgZnMud3JpdGVGaWxlKHRlbXBGaWxlTmFtZSwgcGVtVGV4dCk7XG4gICAgbGV0IGNlcnRpZmljYXRlID0gbmV3IENlcnRpZmljYXRlKHRlbXBGaWxlTmFtZSk7XG4gICAgYXdhaXQgY2VydGlmaWNhdGUucmVtb3ZlKHBhdGhUb0tleWNoYWluKTtcbiAgICBhd2FpdCBmcy51bmxpbmsodGVtcEZpbGVOYW1lKTtcbiAgICByZXR1cm4gY2VydGlmaWNhdGU7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2cuZGVidWcoYENvdWxkIG5vdCB1bmluc3RhbGwgU1NMIGNlcnRpZmljYXRlLiBObyBzaW11bGF0b3Igd2l0aCB1ZGlkICcke3VkaWR9J2ApO1xuICAgIGxvZy5lcnJvckFuZFRocm93KGUpO1xuICB9XG59XG5cbi8qKlxuICogQ2hlY2sgaWYgdGhlIFNpbXVsYXRvciBhbHJlYWR5IGhhcyB0aGlzIFNTTCBjZXJ0aWZpY2F0ZVxuICogQHBhcmFtIHtzdHJpbmd9IHBlbVRleHQgUEVNIHRleHQgb2YgU1NMIGNlcnRcbiAqIEBwYXJhbSB7c3RyaW5nfSB1ZGlkIElkZW50aWZpZXIgb2YgdGhlIFNpbXVsYXRvclxuICovXG5hc3luYyBmdW5jdGlvbiBoYXNTU0xDZXJ0IChwZW1UZXh0LCB1ZGlkKSB7XG4gIGNvbnN0IHRlbXBGaWxlTmFtZSA9IHBhdGgucmVzb2x2ZShhd2FpdCB0ZW1wRGlyLm9wZW5EaXIoKSwgJ3RlbXAtc3NsLWNlcnQucGVtJyk7XG4gIGNvbnN0IHBhdGhUb0tleWNoYWluID0gbmV3IFNpbXVsYXRvcih1ZGlkKS5nZXREaXIoKTtcbiAgYXdhaXQgZnMud3JpdGVGaWxlKHRlbXBGaWxlTmFtZSwgcGVtVGV4dCk7XG4gIGNvbnN0IGNlcnRpZmljYXRlID0gbmV3IENlcnRpZmljYXRlKHRlbXBGaWxlTmFtZSk7XG4gIHJldHVybiBjZXJ0aWZpY2F0ZS5oYXMocGF0aFRvS2V5Y2hhaW4pO1xufVxuXG4vKipcbiAqIFJ1bnMgYSBjb21tYW5kIGxpbmUgc3FsaXRlMyBxdWVyeVxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBkYiAtIEZ1bGwgcGF0aCB0byBzcWxpdGUgZGF0YWJhc2VcbiAqIEBwYXJhbSB7c3RyaW5nfSBxdWVyeSAtIFRoZSBhY3R1YWwgcXVlcnkgc3RyaW5nXG4gKiBAcGFyYW0gey4uLnN0cmluZ30gcXVlcnlQYXJhbXMgLSBUaGUgbGlzdCBvZiBxdWVyeSBwYXJhbWV0ZXJzXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBzcWxpdGUgY29tbWFuZCBzdGRvdXRcbiAqL1xuYXN5bmMgZnVuY3Rpb24gZXhlY1NRTGl0ZVF1ZXJ5IChkYiwgcXVlcnksIC4uLnF1ZXJ5UGFyYW1zKSB7XG4gIHF1ZXJ5ID0gcXVlcnkucmVwbGFjZSgvXFxuKy9nLCAnICcpO1xuICBsZXQgcXVlcnlUb2tlbnMgPSBxdWVyeS5zcGxpdCgnPycpO1xuICBsZXQgZm9ybWF0dGVkUXVlcnkgPSBbXTtcbiAgcXVlcnlQYXJhbXNcbiAgICAubWFwKChwYXJhbSkgPT4gYCR7cGFyYW19YClcbiAgICAuZm9yRWFjaCgocGFyYW0sIGkpID0+IHtcbiAgICAgIGZvcm1hdHRlZFF1ZXJ5LnB1c2gocXVlcnlUb2tlbnNbaV0pO1xuICAgICAgZm9ybWF0dGVkUXVlcnkucHVzaChwYXJhbS5yZXBsYWNlKC8nL2csIFwiJydcIikpO1xuICAgIH0pO1xuICBmb3JtYXR0ZWRRdWVyeS5wdXNoKHF1ZXJ5VG9rZW5zW3F1ZXJ5VG9rZW5zLmxlbmd0aCAtIDFdKTtcblxuICBsb2cuZGVidWcoYEV4ZWN1dGluZyBTUUwgcXVlcnkgXCIke2Zvcm1hdHRlZFF1ZXJ5LmpvaW4oJycpfVwiIG9uICcke2RifSdgKTtcbiAgdHJ5IHtcbiAgICByZXR1cm4gKGF3YWl0IGV4ZWMoJ3NxbGl0ZTMnLCBbJy1saW5lJywgZGIsIGZvcm1hdHRlZFF1ZXJ5LmpvaW4oJycpXSkpLnN0ZG91dDtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgZXhlY3V0ZSBTUUxpdGUgcXVlcnkgXCIke2Zvcm1hdHRlZFF1ZXJ5LmpvaW4oJycpfVwiIHRvICcke2RifScuIGAgK1xuICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2Vyci5zdGRlcnJ9YCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0RGV2ZWxvcGVyUm9vdCAoKSB7XG4gIGNvbnN0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYygneGNvZGUtc2VsZWN0JywgWyctcCddKTtcbiAgcmV0dXJuIHN0ZG91dC50cmltKCk7XG59XG5cbmV4cG9ydCB7XG4gIGtpbGxBbGxTaW11bGF0b3JzLFxuICBlbmRBbGxTaW11bGF0b3JEYWVtb25zLFxuICBzYWZlUmltUmFmLFxuICBzaW1FeGlzdHMsXG4gIGdldFNpbXVsYXRvckluZm8sXG4gIGluc3RhbGxTU0xDZXJ0LFxuICB1bmluc3RhbGxTU0xDZXJ0LFxuICBoYXNTU0xDZXJ0LFxuICBleGVjU1FMaXRlUXVlcnksXG4gIHRvQmlvbWV0cmljRG9tYWluQ29tcG9uZW50LFxuICBnZXREZXZlbG9wZXJSb290LFxuICBTQUZBUklfU1RBUlRVUF9USU1FT1VULFxuICBNT0JJTEVfU0FGQVJJX0JVTkRMRV9JRCxcbn07XG4iXSwiZmlsZSI6ImxpYi91dGlscy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
