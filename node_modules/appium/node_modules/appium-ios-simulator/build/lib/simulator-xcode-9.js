"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _simulatorXcode = _interopRequireDefault(require("./simulator-xcode-8"));

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _appiumSupport = require("appium-support");

var _asyncLock = _interopRequireDefault(require("async-lock"));

var _logger = _interopRequireDefault(require("./logger"));

var _asyncbox = require("asyncbox");

var _utils = require("./utils.js");

const SIMULATOR_SHUTDOWN_TIMEOUT = 15 * 1000;
const startupLock = new _asyncLock.default();
const preferencesPlistGuard = new _asyncLock.default();
const ENROLLMENT_NOTIFICATION_RECEIVER = 'com.apple.BiometricKit.enrollmentChanged';

class SimulatorXcode9 extends _simulatorXcode.default {
  constructor(udid, xcodeVersion) {
    super(udid, xcodeVersion);
  }

  async run(opts = {}) {
    opts = _lodash.default.cloneDeep(opts);

    _lodash.default.defaultsDeep(opts, {
      devicePreferences: {},
      isHeadless: false,
      startupTimeout: this.startupTimeout
    });

    if (opts.scaleFactor) {
      opts.devicePreferences.SimulatorWindowLastScale = parseFloat(opts.scaleFactor);
    }

    const commonPreferences = {
      RotateWindowWhenSignaledByGuest: true
    };

    if (_lodash.default.isBoolean(opts.connectHardwareKeyboard)) {
      opts.devicePreferences.ConnectHardwareKeyboard = opts.connectHardwareKeyboard;
      commonPreferences.ConnectHardwareKeyboard = opts.connectHardwareKeyboard;
    }

    if (!_lodash.default.isEmpty(opts.devicePreferences) || !_lodash.default.isEmpty(commonPreferences)) {
      await this.updatePreferences(opts.devicePreferences, commonPreferences);
    }

    const bootSimulator = async () => {
      try {
        await (0, _asyncbox.retryInterval)(3, 2000, async () => await this.simctl.bootDevice());
      } catch (err) {
        _logger.default.warn(`'xcrun simctl boot ${this.udid}' command has returned non-zero exit code`);
      }
    };

    const waitForShutdown = async (waitMs = SIMULATOR_SHUTDOWN_TIMEOUT) => {
      try {
        await (0, _asyncbox.waitForCondition)(async () => {
          const {
            state
          } = await this.stat();
          return state === 'Shutdown';
        }, {
          waitMs,
          intervalMs: 500
        });
      } catch (err) {
        throw new Error(`Simulator is not in 'Shutdown' state after ${waitMs}ms`);
      }
    };

    const timer = new _appiumSupport.timing.Timer().start();
    const shouldWaitForBoot = await startupLock.acquire(this.uiClientBundleId, async () => {
      const {
        state: serverState
      } = await this.stat();
      const isServerRunning = serverState === 'Booted';
      const uiClientPid = await this.getUIClientPid();

      if (opts.isHeadless) {
        if (isServerRunning && !uiClientPid) {
          _logger.default.info(`Simulator with UDID '${this.udid}' is already booted in headless mode.`);

          return false;
        }

        if (await this.killUIClient({
          pid: uiClientPid
        })) {
          _logger.default.info(`Detected the Simulator UI client was running and killed it. Verifying the current Simulator state...`);
        }

        try {
          await waitForShutdown(3000);
        } catch (e) {
          const {
            state
          } = await this.stat();

          if (state !== 'Booted') {
            throw new Error(`Simulator with UDID '${this.udid}' cannot be transitioned to headless mode. ` + `The recent state is '${state}'`);
          }

          return false;
        }

        _logger.default.info(`Booting Simulator with UDID '${this.udid}' in headless mode. All UI-related capabilities are going to be ignored`);

        await bootSimulator();
      } else {
        if (isServerRunning && uiClientPid) {
          _logger.default.info(`Both Simulator with UDID '${this.udid}' and the UI client are currently running`);

          return false;
        }

        if (!['Shutdown', 'Booted'].includes(serverState)) {
          if (serverState !== 'Shutting Down') {
            _logger.default.info(`Simulator '${this.udid}' is in '${serverState}' state. Trying to shutdown...`);

            try {
              await this.shutdown();
            } catch (err) {
              _logger.default.warn(`Error on Simulator shutdown: ${err.message}`);
            }
          }

          await waitForShutdown();
        }

        _logger.default.info(`Booting Simulator with UDID '${this.udid}'...`);

        await bootSimulator();

        if (!uiClientPid) {
          await this.startUIClient(opts);
        }
      }

      return true;
    });

    if (shouldWaitForBoot) {
      await this.waitForBoot(opts.startupTimeout);

      _logger.default.info(`Simulator with UDID ${this.udid} booted in ${timer.getDuration().asSeconds.toFixed(3)}s`);
    }
  }

  verifyDevicePreferences(prefs = {}) {
    if (_lodash.default.isEmpty(prefs)) {
      return;
    }

    if (!_lodash.default.isUndefined(prefs.SimulatorWindowLastScale)) {
      if (!_lodash.default.isNumber(prefs.SimulatorWindowLastScale) || prefs.SimulatorWindowLastScale <= 0) {
        _logger.default.errorAndThrow(`SimulatorWindowLastScale is expected to be a positive float value. ` + `'${prefs.SimulatorWindowLastScale}' is assigned instead.`);
      }
    }

    if (!_lodash.default.isUndefined(prefs.SimulatorWindowCenter)) {
      const verificationPattern = /{-?\d+(\.\d+)?,-?\d+(\.\d+)?}/;

      if (!_lodash.default.isString(prefs.SimulatorWindowCenter) || !verificationPattern.test(prefs.SimulatorWindowCenter)) {
        _logger.default.errorAndThrow(`SimulatorWindowCenter is expected to match "{floatXPosition,floatYPosition}" format (without spaces). ` + `'${prefs.SimulatorWindowCenter}' is assigned instead.`);
      }
    }

    if (!_lodash.default.isUndefined(prefs.SimulatorWindowOrientation)) {
      const acceptableValues = ['Portrait', 'LandscapeLeft', 'PortraitUpsideDown', 'LandscapeRight'];

      if (acceptableValues.indexOf(prefs.SimulatorWindowOrientation) === -1) {
        _logger.default.errorAndThrow(`SimulatorWindowOrientation is expected to be one of ${acceptableValues}. ` + `'${prefs.SimulatorWindowOrientation}' is assigned instead.`);
      }
    }

    if (!_lodash.default.isUndefined(prefs.SimulatorWindowRotationAngle)) {
      if (!_lodash.default.isNumber(prefs.SimulatorWindowRotationAngle)) {
        _logger.default.errorAndThrow(`SimulatorWindowRotationAngle is expected to be a valid number. ` + `'${prefs.SimulatorWindowRotationAngle}' is assigned instead.`);
      }
    }
  }

  async updatePreferences(devicePrefs = {}, commonPrefs = {}) {
    if (!_lodash.default.isEmpty(devicePrefs)) {
      _logger.default.debug(`Setting preferences of ${this.udid} Simulator to ${JSON.stringify(devicePrefs)}`);
    }

    if (!_lodash.default.isEmpty(commonPrefs)) {
      _logger.default.debug(`Setting common Simulator preferences to ${JSON.stringify(commonPrefs)}`);
    }

    const homeFolderPath = process.env.HOME;

    if (!homeFolderPath) {
      _logger.default.warn(`Cannot get the path to HOME folder from the process environment. ` + `Ignoring Simulator preferences update.`);

      return false;
    }

    this.verifyDevicePreferences(devicePrefs);

    const plistPath = _path.default.resolve(homeFolderPath, 'Library', 'Preferences', 'com.apple.iphonesimulator.plist');

    if (!(await _appiumSupport.fs.hasAccess(plistPath))) {
      _logger.default.warn(`Simulator preferences file '${plistPath}' is not accessible. ` + `Ignoring Simulator preferences update.`);

      return false;
    }

    let newPrefs = {};

    if (!_lodash.default.isEmpty(devicePrefs)) {
      newPrefs.DevicePreferences = {
        [this.udid.toUpperCase()]: devicePrefs
      };
    }

    newPrefs = _lodash.default.merge(newPrefs, commonPrefs);
    return await preferencesPlistGuard.acquire(SimulatorXcode9.name, async () => {
      try {
        const currentPlistContent = await _appiumSupport.plist.parsePlistFile(plistPath);
        await _appiumSupport.plist.updatePlistFile(plistPath, _lodash.default.merge(currentPlistContent, newPrefs), true);

        _logger.default.debug(`Updated ${this.udid} Simulator preferences at '${plistPath}' with ${JSON.stringify(newPrefs)}`);

        return true;
      } catch (e) {
        _logger.default.warn(`Cannot update ${this.udid} Simulator preferences at '${plistPath}'. ` + `Try to delete the file manually in order to reset it. Original error: ${e.message}`);

        return false;
      }
    });
  }

  async shutdown() {
    const {
      state
    } = await this.stat();

    if (state === 'Shutdown') {
      return;
    }

    await (0, _asyncbox.retryInterval)(5, 500, this.simctl.shutdownDevice.bind(this.simctl));
  }

  async clean() {
    _logger.default.info(`Cleaning simulator ${this.udid}`);

    await this.simctl.eraseDevice(10000);
  }

  async _activateWindow() {
    if (this.idb) {
      return await this.idb.focusSimulator();
    }

    _logger.default.warn(`Cannot focus Simulator window with idb. Defaulting to AppleScript`);

    const {
      name,
      sdk
    } = await this.stat();
    return `
      tell application "System Events"
        tell process "Simulator"
          set frontmost to false
          set frontmost to true
          click (menu item 1 where (its name contains "${name} " and its name contains "${sdk}")) of menu 1 of menu bar item "Window" of menu bar 1
        end tell
      end tell
    `;
  }

  async isBiometricEnrolled() {
    const {
      stdout
    } = await this.simctl.spawnProcess(['notifyutil', '-g', ENROLLMENT_NOTIFICATION_RECEIVER]);
    const match = new RegExp(`${_lodash.default.escapeRegExp(ENROLLMENT_NOTIFICATION_RECEIVER)}\\s+([01])`).exec(stdout);

    if (!match) {
      throw new Error(`Cannot parse biometric enrollment state from '${stdout}'`);
    }

    _logger.default.info(`Current biometric enrolled state for ${this.udid} Simulator: ${match[1]}`);

    return match[1] === '1';
  }

  async enrollBiometric(isEnabled = true) {
    _logger.default.debug(`Setting biometric enrolled state for ${this.udid} Simulator to '${isEnabled ? 'enabled' : 'disabled'}'`);

    await this.simctl.spawnProcess(['notifyutil', '-s', ENROLLMENT_NOTIFICATION_RECEIVER, isEnabled ? '1' : '0']);
    await this.simctl.spawnProcess(['notifyutil', '-p', ENROLLMENT_NOTIFICATION_RECEIVER]);

    if ((await this.isBiometricEnrolled()) !== isEnabled) {
      throw new Error(`Cannot set biometric enrolled state for ${this.udid} Simulator to '${isEnabled ? 'enabled' : 'disabled'}'`);
    }
  }

  async sendBiometricMatch(shouldMatch = true, biometricName = 'touchId') {
    const domainComponent = (0, _utils.toBiometricDomainComponent)(biometricName);
    const domain = `com.apple.BiometricKit_Sim.${domainComponent}.${shouldMatch ? '' : 'no'}match`;
    await this.simctl.spawnProcess(['notifyutil', '-p', domain]);

    _logger.default.info(`Sent notification ${domain} to ${shouldMatch ? 'match' : 'not match'} ${biometricName} biometric ` + `for ${this.udid} Simulator`);
  }

  async getLaunchDaemonsRoot() {
    const devRoot = await (0, _utils.getDeveloperRoot)();
    return _path.default.resolve(devRoot, 'Platforms/iPhoneOS.platform/Developer/Library/CoreSimulator/Profiles/Runtimes/iOS.simruntime/Contents/Resources/RuntimeRoot/System/Library/LaunchDaemons');
  }

}

var _default = SimulatorXcode9;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zaW11bGF0b3IteGNvZGUtOS5qcyJdLCJuYW1lcyI6WyJTSU1VTEFUT1JfU0hVVERPV05fVElNRU9VVCIsInN0YXJ0dXBMb2NrIiwiQXN5bmNMb2NrIiwicHJlZmVyZW5jZXNQbGlzdEd1YXJkIiwiRU5ST0xMTUVOVF9OT1RJRklDQVRJT05fUkVDRUlWRVIiLCJTaW11bGF0b3JYY29kZTkiLCJTaW11bGF0b3JYY29kZTgiLCJjb25zdHJ1Y3RvciIsInVkaWQiLCJ4Y29kZVZlcnNpb24iLCJydW4iLCJvcHRzIiwiXyIsImNsb25lRGVlcCIsImRlZmF1bHRzRGVlcCIsImRldmljZVByZWZlcmVuY2VzIiwiaXNIZWFkbGVzcyIsInN0YXJ0dXBUaW1lb3V0Iiwic2NhbGVGYWN0b3IiLCJTaW11bGF0b3JXaW5kb3dMYXN0U2NhbGUiLCJwYXJzZUZsb2F0IiwiY29tbW9uUHJlZmVyZW5jZXMiLCJSb3RhdGVXaW5kb3dXaGVuU2lnbmFsZWRCeUd1ZXN0IiwiaXNCb29sZWFuIiwiY29ubmVjdEhhcmR3YXJlS2V5Ym9hcmQiLCJDb25uZWN0SGFyZHdhcmVLZXlib2FyZCIsImlzRW1wdHkiLCJ1cGRhdGVQcmVmZXJlbmNlcyIsImJvb3RTaW11bGF0b3IiLCJzaW1jdGwiLCJib290RGV2aWNlIiwiZXJyIiwibG9nIiwid2FybiIsIndhaXRGb3JTaHV0ZG93biIsIndhaXRNcyIsInN0YXRlIiwic3RhdCIsImludGVydmFsTXMiLCJFcnJvciIsInRpbWVyIiwidGltaW5nIiwiVGltZXIiLCJzdGFydCIsInNob3VsZFdhaXRGb3JCb290IiwiYWNxdWlyZSIsInVpQ2xpZW50QnVuZGxlSWQiLCJzZXJ2ZXJTdGF0ZSIsImlzU2VydmVyUnVubmluZyIsInVpQ2xpZW50UGlkIiwiZ2V0VUlDbGllbnRQaWQiLCJpbmZvIiwia2lsbFVJQ2xpZW50IiwicGlkIiwiZSIsImluY2x1ZGVzIiwic2h1dGRvd24iLCJtZXNzYWdlIiwic3RhcnRVSUNsaWVudCIsIndhaXRGb3JCb290IiwiZ2V0RHVyYXRpb24iLCJhc1NlY29uZHMiLCJ0b0ZpeGVkIiwidmVyaWZ5RGV2aWNlUHJlZmVyZW5jZXMiLCJwcmVmcyIsImlzVW5kZWZpbmVkIiwiaXNOdW1iZXIiLCJlcnJvckFuZFRocm93IiwiU2ltdWxhdG9yV2luZG93Q2VudGVyIiwidmVyaWZpY2F0aW9uUGF0dGVybiIsImlzU3RyaW5nIiwidGVzdCIsIlNpbXVsYXRvcldpbmRvd09yaWVudGF0aW9uIiwiYWNjZXB0YWJsZVZhbHVlcyIsImluZGV4T2YiLCJTaW11bGF0b3JXaW5kb3dSb3RhdGlvbkFuZ2xlIiwiZGV2aWNlUHJlZnMiLCJjb21tb25QcmVmcyIsImRlYnVnIiwiSlNPTiIsInN0cmluZ2lmeSIsImhvbWVGb2xkZXJQYXRoIiwicHJvY2VzcyIsImVudiIsIkhPTUUiLCJwbGlzdFBhdGgiLCJwYXRoIiwicmVzb2x2ZSIsImZzIiwiaGFzQWNjZXNzIiwibmV3UHJlZnMiLCJEZXZpY2VQcmVmZXJlbmNlcyIsInRvVXBwZXJDYXNlIiwibWVyZ2UiLCJuYW1lIiwiY3VycmVudFBsaXN0Q29udGVudCIsInBsaXN0IiwicGFyc2VQbGlzdEZpbGUiLCJ1cGRhdGVQbGlzdEZpbGUiLCJzaHV0ZG93bkRldmljZSIsImJpbmQiLCJjbGVhbiIsImVyYXNlRGV2aWNlIiwiX2FjdGl2YXRlV2luZG93IiwiaWRiIiwiZm9jdXNTaW11bGF0b3IiLCJzZGsiLCJpc0Jpb21ldHJpY0Vucm9sbGVkIiwic3Rkb3V0Iiwic3Bhd25Qcm9jZXNzIiwibWF0Y2giLCJSZWdFeHAiLCJlc2NhcGVSZWdFeHAiLCJleGVjIiwiZW5yb2xsQmlvbWV0cmljIiwiaXNFbmFibGVkIiwic2VuZEJpb21ldHJpY01hdGNoIiwic2hvdWxkTWF0Y2giLCJiaW9tZXRyaWNOYW1lIiwiZG9tYWluQ29tcG9uZW50IiwiZG9tYWluIiwiZ2V0TGF1bmNoRGFlbW9uc1Jvb3QiLCJkZXZSb290Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztB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LG9CQUFOLEdBQThCO0FBQzVCLFVBQU1DLE9BQU8sR0FBRyxNQUFNLDhCQUF0QjtBQUNBLFdBQU9wQyxjQUFLQyxPQUFMLENBQWFtQyxPQUFiLEVBQ0wsMEpBREssQ0FBUDtBQUVEOztBQTVWMkM7O2VBZ1cvQnJILGUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgU2ltdWxhdG9yWGNvZGU4IGZyb20gJy4vc2ltdWxhdG9yLXhjb2RlLTgnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZnMsIHBsaXN0LCB0aW1pbmcgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgQXN5bmNMb2NrIGZyb20gJ2FzeW5jLWxvY2snO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyB3YWl0Rm9yQ29uZGl0aW9uLCByZXRyeUludGVydmFsIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IHsgdG9CaW9tZXRyaWNEb21haW5Db21wb25lbnQsIGdldERldmVsb3BlclJvb3QgfSBmcm9tICcuL3V0aWxzLmpzJztcblxuY29uc3QgU0lNVUxBVE9SX1NIVVRET1dOX1RJTUVPVVQgPSAxNSAqIDEwMDA7XG5jb25zdCBzdGFydHVwTG9jayA9IG5ldyBBc3luY0xvY2soKTtcbmNvbnN0IHByZWZlcmVuY2VzUGxpc3RHdWFyZCA9IG5ldyBBc3luY0xvY2soKTtcbmNvbnN0IEVOUk9MTE1FTlRfTk9USUZJQ0FUSU9OX1JFQ0VJVkVSID0gJ2NvbS5hcHBsZS5CaW9tZXRyaWNLaXQuZW5yb2xsbWVudENoYW5nZWQnO1xuXG5jbGFzcyBTaW11bGF0b3JYY29kZTkgZXh0ZW5kcyBTaW11bGF0b3JYY29kZTgge1xuICBjb25zdHJ1Y3RvciAodWRpZCwgeGNvZGVWZXJzaW9uKSB7XG4gICAgc3VwZXIodWRpZCwgeGNvZGVWZXJzaW9uKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAdHlwZWRlZiB7T2JqZWN0fSBEZXZpY2VQcmVmZXJlbmNlc1xuICAgKiBAcHJvcGVydHkgez9udW1iZXJ9IFNpbXVsYXRvckV4dGVybmFsRGlzcGxheSAtIFRCRC4gRXhhbXBsZSB2YWx1ZTogMi4xMTRcbiAgICogQHByb3BlcnR5IHs/c3RyaW5nfSBDaHJvbWVUaW50IC0gVEJELiBFeGFtcGxlIHZhbHVlOiAnJ1xuICAgKiBAcHJvcGVydHkgez9udW1iZXJ9IFNpbXVsYXRvcldpbmRvd0xhc3RTY2FsZSAtIFNjYWxlIHZhbHVlIGZvciB0aGUgcGFydGljdWxhciBTaW11bGF0b3Igd2luZG93LlxuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDEuMCBtZWFucyAxMDAlIHNjYWxlLlxuICAgKiBAcHJvcGVydHkgez9zdHJpbmd9IFNpbXVsYXRvcldpbmRvd09yaWVudGF0aW9uIC0gU2ltdWxhdG9yIHdpbmRvdyBvcmllbnRhdGlvbi4gUG9zc2libGUgdmFsdWVzIGFyZTpcbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdQb3J0cmFpdCcsICdMYW5kc2NhcGVMZWZ0JywgJ1BvcnRyYWl0VXBzaWRlRG93bicgYW5kICdMYW5kc2NhcGVSaWdodCcuXG4gICAqIEBwcm9wZXJ0eSB7P251bWJlcn0gU2ltdWxhdG9yV2luZG93Um90YXRpb25BbmdsZSAtIFdpbmRvdyByb3RhdGlvbiBhbmdsZS4gVGhpcyB2YWx1ZSBpcyBleHBlY3RlZCB0byBiZSBpbiBzeW5jXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpdGggX1NpbXVsYXRvcldpbmRvd09yaWVudGF0aW9uXy4gVGhlIGNvcnJlc3BvbmRpbmcgdmFsdWVzIGFyZTpcbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMCwgOTAsIDE4MCBhbmQgMjcwLlxuICAgKiBAcHJvcGVydHkgez9zdHJpbmd9IFNpbXVsYXRvcldpbmRvd0NlbnRlciAtIFRoZSBjb29yZGluYXRlcyBvZiBTaW11bGF0b3IncyB3aW5kb3cgY2VudGVyIGluIHBpeGVscyxcbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgZXhhbXBsZSAney0xMjk0LjUsIDc3NS41fScuXG4gICAqIEBwcm9wZXJ0eSB7P2Jvb2xlYW59IENvbm5lY3RIYXJkd2FyZUtleWJvYXJkIC0gRXF1YWxzIHRvIDEgaWYgaGFyZHdhcmUga2V5Ym9hcmQgc2hvdWxkIGJlIGNvbm5lY3RlZC5cbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBPdGhlcndpc2UgMC5cbiAgICovXG5cbiAgLyoqXG4gICAqIEB0eXBlZGVmIHtPYmplY3R9IENvbW1vblByZWZlcmVuY2VzXG4gICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gQ29ubmVjdEhhcmR3YXJlS2V5Ym9hcmQgLSBXaGV0aGVyIHRvIGNvbm5lY3QgaGFyZHdhcmUga2V5Ym9hcmRcbiAgICovXG5cbiAgLyoqXG4gICAqIEB0eXBlZGVmIHtPYmplY3R9IFJ1bk9wdGlvbnNcbiAgICogQHByb3BlcnR5IHtzdHJpbmd9IHNjYWxlRmFjdG9yOiBBbnkgcG9zaXRpdmUgZmxvYXQgdmFsdWUuIDEuMCBtZWFucyAxOjEgc2NhbGUuXG4gICAqIERlZmluZXMgdGhlIHdpbmRvdyBzY2FsZSB2YWx1ZSBmb3IgdGhlIFVJIGNsaWVudCB3aW5kb3cgZm9yIHRoZSBjdXJyZW50IFNpbXVsYXRvci5cbiAgICogRXF1YWxzIHRvIGBudWxsYCBieSBkZWZhdWx0LCB3aGljaCBrZWVwcyB0aGUgY3VycmVudCBzY2FsZSB1bmNoYW5nZWQuXG4gICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY29ubmVjdEhhcmR3YXJlS2V5Ym9hcmQ6IHdoZXRoZXIgdG8gY29ubmVjdCB0aGUgaGFyZHdhcmUga2V5Ym9hcmQgdG8gdGhlXG4gICAqIFNpbXVsYXRvciBVSSBjbGllbnQuIEVxdWFscyB0byBgZmFsc2VgIGJ5IGRlZmF1bHQuXG4gICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzdGFydHVwVGltZW91dDogbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byB3YWl0IHVudGlsIFNpbXVsYXRvciBib290aW5nXG4gICAqIHByb2Nlc3MgaXMgY29tcGxldGVkLiBUaGUgZGVmYXVsdCB0aW1lb3V0IHdpbGwgYmUgdXNlZCBpZiBub3Qgc2V0IGV4cGxpY2l0bHkuXG4gICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNIZWFkbGVzczogd2hldGhlciB0byBzdGFydCB0aGUgU2ltdWxhdG9yIGluIGhlYWRsZXNzIG1vZGUgKHdpdGggVUlcbiAgICogY2xpZW50IGludmlzaWJsZSkuIGBmYWxzZWAgYnkgZGVmYXVsdC5cbiAgICogQHByb3BlcnR5IHs/Ym9vbGVhbn0gdHJhY2VQb2ludGVyIFtmYWxzZV0gLSBXaGV0aGVyIHRvIGhpZ2hsaWdodCB0b3VjaGVzIG9uIFNpbXVsYXRvclxuICAgKiBzY3JlZW4uIFRoaXMgaXMgaGVscGZ1bCB3aGlsZSBkZWJ1Z2dpbmcgYXV0b21hdGVkIHRlc3RzIG9yIHdoaWxlIG9ic2VydmluZyB0aGUgYXV0b21hdGlvblxuICAgKiByZWNvcmRpbmdzLlxuICAgKiBAcHJvcGVydHkge0RldmljZVByZWZlcmVuY2VzfSBkZXZpY2VQcmVmZXJlbmNlczogcHJlZmVyZW5jZXMgb2YgdGhlIG5ld2x5IGNyZWF0ZWQgU2ltdWxhdG9yXG4gICAqIGRldmljZVxuICAgKi9cblxuICAvKipcbiAgICogRXhlY3V0ZXMgZ2l2ZW4gU2ltdWxhdG9yIHdpdGggb3B0aW9ucy4gVGhlIFNpbXVsYXRvciB3aWxsIG5vdCBiZSByZXN0YXJ0ZWQgaWZcbiAgICogaXQgaXMgYWxyZWFkeSBydW5uaW5nIGFuZCB0aGUgY3VycmVudCBVSSBzdGF0ZSBtYXRjaGVzIHRvIGBpc0hlYWRsZXNzYCBvcHRpb24uXG4gICAqIEBvdmVycmlkZVxuICAgKlxuICAgKiBAcGFyYW0ge1J1bk9wdGlvbnN9IG9wdHMgLSBPbmUgb3IgbW9yZSBvZiBhdmFpbGFibGUgU2ltdWxhdG9yIG9wdGlvbnNcbiAgICovXG4gIGFzeW5jIHJ1biAob3B0cyA9IHt9KSB7XG4gICAgb3B0cyA9IF8uY2xvbmVEZWVwKG9wdHMpO1xuICAgIF8uZGVmYXVsdHNEZWVwKG9wdHMsIHtcbiAgICAgIGRldmljZVByZWZlcmVuY2VzOiB7fSxcbiAgICAgIGlzSGVhZGxlc3M6IGZhbHNlLFxuICAgICAgc3RhcnR1cFRpbWVvdXQ6IHRoaXMuc3RhcnR1cFRpbWVvdXQsXG4gICAgfSk7XG4gICAgaWYgKG9wdHMuc2NhbGVGYWN0b3IpIHtcbiAgICAgIG9wdHMuZGV2aWNlUHJlZmVyZW5jZXMuU2ltdWxhdG9yV2luZG93TGFzdFNjYWxlID0gcGFyc2VGbG9hdChvcHRzLnNjYWxlRmFjdG9yKTtcbiAgICB9XG4gICAgLy8gVGhpcyBvcHRpb24gaXMgbmVjZXNzYXJ5IHRvIG1ha2UgdGhlIFNpbXVsYXRvciB3aW5kb3cgZm9sbG93XG4gICAgLy8gdGhlIGFjdHVhbCBYQ1VJRGV2aWNlIG9yaWVudGF0aW9uXG4gICAgY29uc3QgY29tbW9uUHJlZmVyZW5jZXMgPSB7XG4gICAgICBSb3RhdGVXaW5kb3dXaGVuU2lnbmFsZWRCeUd1ZXN0OiB0cnVlXG4gICAgfTtcbiAgICBpZiAoXy5pc0Jvb2xlYW4ob3B0cy5jb25uZWN0SGFyZHdhcmVLZXlib2FyZCkpIHtcbiAgICAgIG9wdHMuZGV2aWNlUHJlZmVyZW5jZXMuQ29ubmVjdEhhcmR3YXJlS2V5Ym9hcmQgPSBvcHRzLmNvbm5lY3RIYXJkd2FyZUtleWJvYXJkO1xuICAgICAgY29tbW9uUHJlZmVyZW5jZXMuQ29ubmVjdEhhcmR3YXJlS2V5Ym9hcmQgPSBvcHRzLmNvbm5lY3RIYXJkd2FyZUtleWJvYXJkO1xuICAgIH1cbiAgICBpZiAoIV8uaXNFbXB0eShvcHRzLmRldmljZVByZWZlcmVuY2VzKSB8fCAhXy5pc0VtcHR5KGNvbW1vblByZWZlcmVuY2VzKSkge1xuICAgICAgYXdhaXQgdGhpcy51cGRhdGVQcmVmZXJlbmNlcyhvcHRzLmRldmljZVByZWZlcmVuY2VzLCBjb21tb25QcmVmZXJlbmNlcyk7XG4gICAgfVxuICAgIGNvbnN0IGJvb3RTaW11bGF0b3IgPSBhc3luYyAoKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCByZXRyeUludGVydmFsKDMsIDIwMDAsIGFzeW5jICgpID0+IGF3YWl0IHRoaXMuc2ltY3RsLmJvb3REZXZpY2UoKSk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgbG9nLndhcm4oYCd4Y3J1biBzaW1jdGwgYm9vdCAke3RoaXMudWRpZH0nIGNvbW1hbmQgaGFzIHJldHVybmVkIG5vbi16ZXJvIGV4aXQgY29kZWApO1xuICAgICAgfVxuICAgIH07XG4gICAgY29uc3Qgd2FpdEZvclNodXRkb3duID0gYXN5bmMgKHdhaXRNcyA9IFNJTVVMQVRPUl9TSFVURE9XTl9USU1FT1VUKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKGFzeW5jICgpID0+IHtcbiAgICAgICAgICBjb25zdCB7c3RhdGV9ID0gYXdhaXQgdGhpcy5zdGF0KCk7XG4gICAgICAgICAgcmV0dXJuIHN0YXRlID09PSAnU2h1dGRvd24nO1xuICAgICAgICB9LCB7d2FpdE1zLCBpbnRlcnZhbE1zOiA1MDB9KTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFNpbXVsYXRvciBpcyBub3QgaW4gJ1NodXRkb3duJyBzdGF0ZSBhZnRlciAke3dhaXRNc31tc2ApO1xuICAgICAgfVxuICAgIH07XG4gICAgY29uc3QgdGltZXIgPSBuZXcgdGltaW5nLlRpbWVyKCkuc3RhcnQoKTtcbiAgICBjb25zdCBzaG91bGRXYWl0Rm9yQm9vdCA9IGF3YWl0IHN0YXJ0dXBMb2NrLmFjcXVpcmUodGhpcy51aUNsaWVudEJ1bmRsZUlkLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB7c3RhdGU6IHNlcnZlclN0YXRlfSA9IGF3YWl0IHRoaXMuc3RhdCgpO1xuICAgICAgY29uc3QgaXNTZXJ2ZXJSdW5uaW5nID0gc2VydmVyU3RhdGUgPT09ICdCb290ZWQnO1xuICAgICAgY29uc3QgdWlDbGllbnRQaWQgPSBhd2FpdCB0aGlzLmdldFVJQ2xpZW50UGlkKCk7XG4gICAgICBpZiAob3B0cy5pc0hlYWRsZXNzKSB7XG4gICAgICAgIGlmIChpc1NlcnZlclJ1bm5pbmcgJiYgIXVpQ2xpZW50UGlkKSB7XG4gICAgICAgICAgbG9nLmluZm8oYFNpbXVsYXRvciB3aXRoIFVESUQgJyR7dGhpcy51ZGlkfScgaXMgYWxyZWFkeSBib290ZWQgaW4gaGVhZGxlc3MgbW9kZS5gKTtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGF3YWl0IHRoaXMua2lsbFVJQ2xpZW50KHtwaWQ6IHVpQ2xpZW50UGlkfSkpIHtcbiAgICAgICAgICBsb2cuaW5mbyhgRGV0ZWN0ZWQgdGhlIFNpbXVsYXRvciBVSSBjbGllbnQgd2FzIHJ1bm5pbmcgYW5kIGtpbGxlZCBpdC4gVmVyaWZ5aW5nIHRoZSBjdXJyZW50IFNpbXVsYXRvciBzdGF0ZS4uLmApO1xuICAgICAgICB9XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgLy8gU3RvcHBpbmcgdGhlIFVJIGNsaWVudCBraWxscyBhbGwgcnVubmluZyBzZXJ2ZXJzIGZvciBzb21lIGVhcmx5IFhDb2RlIHZlcnNpb25zLiBUaGlzIGlzIGEga25vd24gYnVnXG4gICAgICAgICAgYXdhaXQgd2FpdEZvclNodXRkb3duKDMwMDApO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgY29uc3Qge3N0YXRlfSA9IGF3YWl0IHRoaXMuc3RhdCgpO1xuICAgICAgICAgIGlmIChzdGF0ZSAhPT0gJ0Jvb3RlZCcpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgU2ltdWxhdG9yIHdpdGggVURJRCAnJHt0aGlzLnVkaWR9JyBjYW5ub3QgYmUgdHJhbnNpdGlvbmVkIHRvIGhlYWRsZXNzIG1vZGUuIGAgK1xuICAgICAgICAgICAgICBgVGhlIHJlY2VudCBzdGF0ZSBpcyAnJHtzdGF0ZX0nYCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBsb2cuaW5mbyhgQm9vdGluZyBTaW11bGF0b3Igd2l0aCBVRElEICcke3RoaXMudWRpZH0nIGluIGhlYWRsZXNzIG1vZGUuIEFsbCBVSS1yZWxhdGVkIGNhcGFiaWxpdGllcyBhcmUgZ29pbmcgdG8gYmUgaWdub3JlZGApO1xuICAgICAgICBhd2FpdCBib290U2ltdWxhdG9yKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoaXNTZXJ2ZXJSdW5uaW5nICYmIHVpQ2xpZW50UGlkKSB7XG4gICAgICAgICAgbG9nLmluZm8oYEJvdGggU2ltdWxhdG9yIHdpdGggVURJRCAnJHt0aGlzLnVkaWR9JyBhbmQgdGhlIFVJIGNsaWVudCBhcmUgY3VycmVudGx5IHJ1bm5pbmdgKTtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFbJ1NodXRkb3duJywgJ0Jvb3RlZCddLmluY2x1ZGVzKHNlcnZlclN0YXRlKSkge1xuICAgICAgICAgIGlmIChzZXJ2ZXJTdGF0ZSAhPT0gJ1NodXR0aW5nIERvd24nKSB7XG4gICAgICAgICAgICBsb2cuaW5mbyhgU2ltdWxhdG9yICcke3RoaXMudWRpZH0nIGlzIGluICcke3NlcnZlclN0YXRlfScgc3RhdGUuIFRyeWluZyB0byBzaHV0ZG93bi4uLmApO1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgYXdhaXQgdGhpcy5zaHV0ZG93bigpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAgIGxvZy53YXJuKGBFcnJvciBvbiBTaW11bGF0b3Igc2h1dGRvd246ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGF3YWl0IHdhaXRGb3JTaHV0ZG93bigpO1xuICAgICAgICB9XG4gICAgICAgIGxvZy5pbmZvKGBCb290aW5nIFNpbXVsYXRvciB3aXRoIFVESUQgJyR7dGhpcy51ZGlkfScuLi5gKTtcbiAgICAgICAgYXdhaXQgYm9vdFNpbXVsYXRvcigpO1xuICAgICAgICBpZiAoIXVpQ2xpZW50UGlkKSB7XG4gICAgICAgICAgYXdhaXQgdGhpcy5zdGFydFVJQ2xpZW50KG9wdHMpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9KTtcblxuICAgIGlmIChzaG91bGRXYWl0Rm9yQm9vdCkge1xuICAgICAgYXdhaXQgdGhpcy53YWl0Rm9yQm9vdChvcHRzLnN0YXJ0dXBUaW1lb3V0KTtcbiAgICAgIGxvZy5pbmZvKGBTaW11bGF0b3Igd2l0aCBVRElEICR7dGhpcy51ZGlkfSBib290ZWQgaW4gJHt0aW1lci5nZXREdXJhdGlvbigpLmFzU2Vjb25kcy50b0ZpeGVkKDMpfXNgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUGVyZm9ybSB2ZXJpZmljYXRpb24gb2YgZGV2aWNlIHByZWZlcmVuY2VzIGNvcnJlY3RuZXNzLlxuICAgKlxuICAgKiBAcGFyYW0ge0RldmljZVByZWZlcmVuY2VzfSBwcmVmcyBbe31dIC0gVGhlIHByZWZlcmVuY2VzIHRvIGJlIHZlcmlmaWVkXG4gICAqIEB0aHJvd3Mge0Vycm9yfSBJZiBhbnkgb2YgdGhlIGdpdmVuIHByZWZlcmVuY2UgdmFsdWVzIGRvZXMgbm90IG1hdGNoIHRoZSBleHBlY3RlZFxuICAgKiBmb3JtYXQuXG4gICAqL1xuICB2ZXJpZnlEZXZpY2VQcmVmZXJlbmNlcyAocHJlZnMgPSB7fSkge1xuICAgIGlmIChfLmlzRW1wdHkocHJlZnMpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKCFfLmlzVW5kZWZpbmVkKHByZWZzLlNpbXVsYXRvcldpbmRvd0xhc3RTY2FsZSkpIHtcbiAgICAgIGlmICghXy5pc051bWJlcihwcmVmcy5TaW11bGF0b3JXaW5kb3dMYXN0U2NhbGUpIHx8IHByZWZzLlNpbXVsYXRvcldpbmRvd0xhc3RTY2FsZSA8PSAwKSB7XG4gICAgICAgIGxvZy5lcnJvckFuZFRocm93KGBTaW11bGF0b3JXaW5kb3dMYXN0U2NhbGUgaXMgZXhwZWN0ZWQgdG8gYmUgYSBwb3NpdGl2ZSBmbG9hdCB2YWx1ZS4gYCArXG4gICAgICAgICAgYCcke3ByZWZzLlNpbXVsYXRvcldpbmRvd0xhc3RTY2FsZX0nIGlzIGFzc2lnbmVkIGluc3RlYWQuYCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKCFfLmlzVW5kZWZpbmVkKHByZWZzLlNpbXVsYXRvcldpbmRvd0NlbnRlcikpIHtcbiAgICAgIC8vIGh0dHBzOi8vcmVnZXgxMDEuY29tL3IvMlpYT2lqLzJcbiAgICAgIGNvbnN0IHZlcmlmaWNhdGlvblBhdHRlcm4gPSAvey0/XFxkKyhcXC5cXGQrKT8sLT9cXGQrKFxcLlxcZCspP30vO1xuICAgICAgaWYgKCFfLmlzU3RyaW5nKHByZWZzLlNpbXVsYXRvcldpbmRvd0NlbnRlcikgfHwgIXZlcmlmaWNhdGlvblBhdHRlcm4udGVzdChwcmVmcy5TaW11bGF0b3JXaW5kb3dDZW50ZXIpKSB7XG4gICAgICAgIGxvZy5lcnJvckFuZFRocm93KGBTaW11bGF0b3JXaW5kb3dDZW50ZXIgaXMgZXhwZWN0ZWQgdG8gbWF0Y2ggXCJ7ZmxvYXRYUG9zaXRpb24sZmxvYXRZUG9zaXRpb259XCIgZm9ybWF0ICh3aXRob3V0IHNwYWNlcykuIGAgK1xuICAgICAgICAgIGAnJHtwcmVmcy5TaW11bGF0b3JXaW5kb3dDZW50ZXJ9JyBpcyBhc3NpZ25lZCBpbnN0ZWFkLmApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICghXy5pc1VuZGVmaW5lZChwcmVmcy5TaW11bGF0b3JXaW5kb3dPcmllbnRhdGlvbikpIHtcbiAgICAgIGNvbnN0IGFjY2VwdGFibGVWYWx1ZXMgPSBbJ1BvcnRyYWl0JywgJ0xhbmRzY2FwZUxlZnQnLCAnUG9ydHJhaXRVcHNpZGVEb3duJywgJ0xhbmRzY2FwZVJpZ2h0J107XG4gICAgICBpZiAoYWNjZXB0YWJsZVZhbHVlcy5pbmRleE9mKHByZWZzLlNpbXVsYXRvcldpbmRvd09yaWVudGF0aW9uKSA9PT0gLTEpIHtcbiAgICAgICAgbG9nLmVycm9yQW5kVGhyb3coYFNpbXVsYXRvcldpbmRvd09yaWVudGF0aW9uIGlzIGV4cGVjdGVkIHRvIGJlIG9uZSBvZiAke2FjY2VwdGFibGVWYWx1ZXN9LiBgICtcbiAgICAgICAgICBgJyR7cHJlZnMuU2ltdWxhdG9yV2luZG93T3JpZW50YXRpb259JyBpcyBhc3NpZ25lZCBpbnN0ZWFkLmApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICghXy5pc1VuZGVmaW5lZChwcmVmcy5TaW11bGF0b3JXaW5kb3dSb3RhdGlvbkFuZ2xlKSkge1xuICAgICAgaWYgKCFfLmlzTnVtYmVyKHByZWZzLlNpbXVsYXRvcldpbmRvd1JvdGF0aW9uQW5nbGUpKSB7XG4gICAgICAgIGxvZy5lcnJvckFuZFRocm93KGBTaW11bGF0b3JXaW5kb3dSb3RhdGlvbkFuZ2xlIGlzIGV4cGVjdGVkIHRvIGJlIGEgdmFsaWQgbnVtYmVyLiBgICtcbiAgICAgICAgICBgJyR7cHJlZnMuU2ltdWxhdG9yV2luZG93Um90YXRpb25BbmdsZX0nIGlzIGFzc2lnbmVkIGluc3RlYWQuYCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZSB0aGUgY29tbW9uIGlPUyBTaW11bGF0b3IgcHJlZmVyZW5jZXMgZmlsZSB3aXRoIG5ldyB2YWx1ZXMuXG4gICAqIEl0IGlzIG5lY2Vzc2FyeSB0byByZXN0YXJ0IHRoZSBjb3JyZXNwb25kaW5nIFNpbXVsYXRvciBiZWZvcmVcbiAgICogdGhlc2UgY2hhbmdlcyBhcmUgYXBwbGllZC5cbiAgICpcbiAgICogQHBhcmFtIHtEZXZpY2VQcmVmZXJlbmNlc30gZGV2aWNlUHJlZnMgW3t9XSAtIFRoZSBtYXBwaW5nLCB3aGljaCByZXByZXNlbnRzIG5ldyBkZXZpY2UgcHJlZmVyZW5jZSB2YWx1ZXNcbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciB0aGUgZ2l2ZW4gU2ltdWxhdG9yLlxuICAgKiBAcGFyYW0ge0NvbW1vblByZWZlcmVuY2VzfSBjb21tb25QcmVmcyBbe31dIC0gVGhlIG1hcHBpbmcsIHdoaWNoIHJlcHJlc2VudHMgbmV3IGNvbW1vbiBwcmVmZXJlbmNlIHZhbHVlc1xuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGFsbCBTaW11bGF0b3JzLlxuICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBwcmVmZXJlbmNlcyB3ZXJlIHN1Y2Nlc3NmdWxseSB1cGRhdGVkLlxuICAgKi9cbiAgYXN5bmMgdXBkYXRlUHJlZmVyZW5jZXMgKGRldmljZVByZWZzID0ge30sIGNvbW1vblByZWZzID0ge30pIHtcbiAgICBpZiAoIV8uaXNFbXB0eShkZXZpY2VQcmVmcykpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgU2V0dGluZyBwcmVmZXJlbmNlcyBvZiAke3RoaXMudWRpZH0gU2ltdWxhdG9yIHRvICR7SlNPTi5zdHJpbmdpZnkoZGV2aWNlUHJlZnMpfWApO1xuICAgIH1cbiAgICBpZiAoIV8uaXNFbXB0eShjb21tb25QcmVmcykpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgU2V0dGluZyBjb21tb24gU2ltdWxhdG9yIHByZWZlcmVuY2VzIHRvICR7SlNPTi5zdHJpbmdpZnkoY29tbW9uUHJlZnMpfWApO1xuICAgIH1cbiAgICBjb25zdCBob21lRm9sZGVyUGF0aCA9IHByb2Nlc3MuZW52LkhPTUU7XG4gICAgaWYgKCFob21lRm9sZGVyUGF0aCkge1xuICAgICAgbG9nLndhcm4oYENhbm5vdCBnZXQgdGhlIHBhdGggdG8gSE9NRSBmb2xkZXIgZnJvbSB0aGUgcHJvY2VzcyBlbnZpcm9ubWVudC4gYCArXG4gICAgICAgIGBJZ25vcmluZyBTaW11bGF0b3IgcHJlZmVyZW5jZXMgdXBkYXRlLmApO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICB0aGlzLnZlcmlmeURldmljZVByZWZlcmVuY2VzKGRldmljZVByZWZzKTtcbiAgICBjb25zdCBwbGlzdFBhdGggPSBwYXRoLnJlc29sdmUoaG9tZUZvbGRlclBhdGgsICdMaWJyYXJ5JywgJ1ByZWZlcmVuY2VzJywgJ2NvbS5hcHBsZS5pcGhvbmVzaW11bGF0b3IucGxpc3QnKTtcbiAgICBpZiAoIWF3YWl0IGZzLmhhc0FjY2VzcyhwbGlzdFBhdGgpKSB7XG4gICAgICBsb2cud2FybihgU2ltdWxhdG9yIHByZWZlcmVuY2VzIGZpbGUgJyR7cGxpc3RQYXRofScgaXMgbm90IGFjY2Vzc2libGUuIGAgK1xuICAgICAgICBgSWdub3JpbmcgU2ltdWxhdG9yIHByZWZlcmVuY2VzIHVwZGF0ZS5gKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgbGV0IG5ld1ByZWZzID0ge307XG4gICAgaWYgKCFfLmlzRW1wdHkoZGV2aWNlUHJlZnMpKSB7XG4gICAgICBuZXdQcmVmcy5EZXZpY2VQcmVmZXJlbmNlcyA9IHtbdGhpcy51ZGlkLnRvVXBwZXJDYXNlKCldOiBkZXZpY2VQcmVmc307XG4gICAgfVxuICAgIG5ld1ByZWZzID0gXy5tZXJnZShuZXdQcmVmcywgY29tbW9uUHJlZnMpO1xuICAgIHJldHVybiBhd2FpdCBwcmVmZXJlbmNlc1BsaXN0R3VhcmQuYWNxdWlyZShTaW11bGF0b3JYY29kZTkubmFtZSwgYXN5bmMgKCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgY3VycmVudFBsaXN0Q29udGVudCA9IGF3YWl0IHBsaXN0LnBhcnNlUGxpc3RGaWxlKHBsaXN0UGF0aCk7XG4gICAgICAgIGF3YWl0IHBsaXN0LnVwZGF0ZVBsaXN0RmlsZShwbGlzdFBhdGgsIF8ubWVyZ2UoY3VycmVudFBsaXN0Q29udGVudCwgbmV3UHJlZnMpLCB0cnVlKTtcbiAgICAgICAgbG9nLmRlYnVnKGBVcGRhdGVkICR7dGhpcy51ZGlkfSBTaW11bGF0b3IgcHJlZmVyZW5jZXMgYXQgJyR7cGxpc3RQYXRofScgd2l0aCAke0pTT04uc3RyaW5naWZ5KG5ld1ByZWZzKX1gKTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxvZy53YXJuKGBDYW5ub3QgdXBkYXRlICR7dGhpcy51ZGlkfSBTaW11bGF0b3IgcHJlZmVyZW5jZXMgYXQgJyR7cGxpc3RQYXRofScuIGAgK1xuICAgICAgICAgICAgICAgICBgVHJ5IHRvIGRlbGV0ZSB0aGUgZmlsZSBtYW51YWxseSBpbiBvcmRlciB0byByZXNldCBpdC4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogU2h1dCBkb3duIHRoZSBjdXJyZW50IFNpbXVsYXRvci5cbiAgICogQG92ZXJyaWRlXG4gICAqL1xuICBhc3luYyBzaHV0ZG93biAoKSB7XG4gICAgY29uc3Qge3N0YXRlfSA9IGF3YWl0IHRoaXMuc3RhdCgpO1xuICAgIGlmIChzdGF0ZSA9PT0gJ1NodXRkb3duJykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBhd2FpdCByZXRyeUludGVydmFsKDUsIDUwMCwgdGhpcy5zaW1jdGwuc2h1dGRvd25EZXZpY2UuYmluZCh0aGlzLnNpbWN0bCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlc2V0IHRoZSBjdXJyZW50IFNpbXVsYXRvciB0byB0aGUgY2xlYW4gc3RhdGUuXG4gICAqIEBvdmVycmlkZVxuICAgKi9cbiAgYXN5bmMgY2xlYW4gKCkge1xuICAgIGxvZy5pbmZvKGBDbGVhbmluZyBzaW11bGF0b3IgJHt0aGlzLnVkaWR9YCk7XG4gICAgYXdhaXQgdGhpcy5zaW1jdGwuZXJhc2VEZXZpY2UoMTAwMDApO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0ZG9jXG4gICAqIEBvdmVycmlkZVxuICAgKiBAcHJpdmF0ZVxuICAgKi9cbiAgYXN5bmMgX2FjdGl2YXRlV2luZG93ICgpIHtcbiAgICBpZiAodGhpcy5pZGIpIHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmlkYi5mb2N1c1NpbXVsYXRvcigpO1xuICAgIH1cbiAgICBsb2cud2FybihgQ2Fubm90IGZvY3VzIFNpbXVsYXRvciB3aW5kb3cgd2l0aCBpZGIuIERlZmF1bHRpbmcgdG8gQXBwbGVTY3JpcHRgKTtcbiAgICBjb25zdCB7bmFtZSwgc2RrfSA9IGF3YWl0IHRoaXMuc3RhdCgpO1xuICAgIHJldHVybiBgXG4gICAgICB0ZWxsIGFwcGxpY2F0aW9uIFwiU3lzdGVtIEV2ZW50c1wiXG4gICAgICAgIHRlbGwgcHJvY2VzcyBcIlNpbXVsYXRvclwiXG4gICAgICAgICAgc2V0IGZyb250bW9zdCB0byBmYWxzZVxuICAgICAgICAgIHNldCBmcm9udG1vc3QgdG8gdHJ1ZVxuICAgICAgICAgIGNsaWNrIChtZW51IGl0ZW0gMSB3aGVyZSAoaXRzIG5hbWUgY29udGFpbnMgXCIke25hbWV9IFwiIGFuZCBpdHMgbmFtZSBjb250YWlucyBcIiR7c2RrfVwiKSkgb2YgbWVudSAxIG9mIG1lbnUgYmFyIGl0ZW0gXCJXaW5kb3dcIiBvZiBtZW51IGJhciAxXG4gICAgICAgIGVuZCB0ZWxsXG4gICAgICBlbmQgdGVsbFxuICAgIGA7XG4gIH1cblxuICAvKipcbiAgICogQGluaGVyaXRkb2NcbiAgICogQG92ZXJyaWRlXG4gICAqL1xuICBhc3luYyBpc0Jpb21ldHJpY0Vucm9sbGVkICgpIHtcbiAgICBjb25zdCB7c3Rkb3V0fSA9IGF3YWl0IHRoaXMuc2ltY3RsLnNwYXduUHJvY2VzcyhbXG4gICAgICAnbm90aWZ5dXRpbCcsXG4gICAgICAnLWcnLCBFTlJPTExNRU5UX05PVElGSUNBVElPTl9SRUNFSVZFUlxuICAgIF0pO1xuICAgIGNvbnN0IG1hdGNoID0gKG5ldyBSZWdFeHAoYCR7Xy5lc2NhcGVSZWdFeHAoRU5ST0xMTUVOVF9OT1RJRklDQVRJT05fUkVDRUlWRVIpfVxcXFxzKyhbMDFdKWApKVxuICAgICAgLmV4ZWMoc3Rkb3V0KTtcbiAgICBpZiAoIW1hdGNoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBwYXJzZSBiaW9tZXRyaWMgZW5yb2xsbWVudCBzdGF0ZSBmcm9tICcke3N0ZG91dH0nYCk7XG4gICAgfVxuICAgIGxvZy5pbmZvKGBDdXJyZW50IGJpb21ldHJpYyBlbnJvbGxlZCBzdGF0ZSBmb3IgJHt0aGlzLnVkaWR9IFNpbXVsYXRvcjogJHttYXRjaFsxXX1gKTtcbiAgICByZXR1cm4gbWF0Y2hbMV0gPT09ICcxJztcbiAgfVxuXG4gIC8qKlxuICAgKiBAaW5oZXJpdGRvY1xuICAgKiBAb3ZlcnJpZGVcbiAgICovXG4gIGFzeW5jIGVucm9sbEJpb21ldHJpYyAoaXNFbmFibGVkID0gdHJ1ZSkge1xuICAgIGxvZy5kZWJ1ZyhgU2V0dGluZyBiaW9tZXRyaWMgZW5yb2xsZWQgc3RhdGUgZm9yICR7dGhpcy51ZGlkfSBTaW11bGF0b3IgdG8gJyR7aXNFbmFibGVkID8gJ2VuYWJsZWQnIDogJ2Rpc2FibGVkJ30nYCk7XG4gICAgYXdhaXQgdGhpcy5zaW1jdGwuc3Bhd25Qcm9jZXNzKFtcbiAgICAgICdub3RpZnl1dGlsJyxcbiAgICAgICctcycsIEVOUk9MTE1FTlRfTk9USUZJQ0FUSU9OX1JFQ0VJVkVSLCBpc0VuYWJsZWQgPyAnMScgOiAnMCdcbiAgICBdKTtcbiAgICBhd2FpdCB0aGlzLnNpbWN0bC5zcGF3blByb2Nlc3MoW1xuICAgICAgJ25vdGlmeXV0aWwnLFxuICAgICAgJy1wJywgRU5ST0xMTUVOVF9OT1RJRklDQVRJT05fUkVDRUlWRVJcbiAgICBdKTtcbiAgICBpZiAoYXdhaXQgdGhpcy5pc0Jpb21ldHJpY0Vucm9sbGVkKCkgIT09IGlzRW5hYmxlZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3Qgc2V0IGJpb21ldHJpYyBlbnJvbGxlZCBzdGF0ZSBmb3IgJHt0aGlzLnVkaWR9IFNpbXVsYXRvciB0byAnJHtpc0VuYWJsZWQgPyAnZW5hYmxlZCcgOiAnZGlzYWJsZWQnfSdgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2VuZHMgYSBub3RpZmljYXRpb24gdG8gbWF0Y2gvbm90IG1hdGNoIHRoZSBwYXJ0aWN1bGFyIGJpb21ldHJpYy5cbiAgICogQG92ZXJyaWRlXG4gICAqXG4gICAqIEBwYXJhbSB7P2Jvb2xlYW59IHNob3VsZE1hdGNoIFt0cnVlXSAtIFNldCBpdCB0byB0cnVlIG9yIGZhbHNlIGluIG9yZGVyIHRvIGVtdWxhdGVcbiAgICogbWF0Y2hpbmcvbm90IG1hdGNoaW5nIHRoZSBjb3JyZXNwb25kaW5nIGJpb21ldHJpY1xuICAgKiBAcGFyYW0gez9zdHJpbmd9IGJpb21ldHJpY05hbWUgW3RvdWNoSWRdIC0gRWl0aGVyIHRvdWNoSWQgb3IgZmFjZUlkIChmYWNlSWQgaXMgb25seSBhdmFpbGFibGUgc2luY2UgaU9TIDExKVxuICAgKi9cbiAgYXN5bmMgc2VuZEJpb21ldHJpY01hdGNoIChzaG91bGRNYXRjaCA9IHRydWUsIGJpb21ldHJpY05hbWUgPSAndG91Y2hJZCcpIHtcbiAgICBjb25zdCBkb21haW5Db21wb25lbnQgPSB0b0Jpb21ldHJpY0RvbWFpbkNvbXBvbmVudChiaW9tZXRyaWNOYW1lKTtcbiAgICBjb25zdCBkb21haW4gPSBgY29tLmFwcGxlLkJpb21ldHJpY0tpdF9TaW0uJHtkb21haW5Db21wb25lbnR9LiR7c2hvdWxkTWF0Y2ggPyAnJyA6ICdubyd9bWF0Y2hgO1xuICAgIGF3YWl0IHRoaXMuc2ltY3RsLnNwYXduUHJvY2VzcyhbXG4gICAgICAnbm90aWZ5dXRpbCcsXG4gICAgICAnLXAnLCBkb21haW5cbiAgICBdKTtcbiAgICBsb2cuaW5mbyhgU2VudCBub3RpZmljYXRpb24gJHtkb21haW59IHRvICR7c2hvdWxkTWF0Y2ggPyAnbWF0Y2gnIDogJ25vdCBtYXRjaCd9ICR7YmlvbWV0cmljTmFtZX0gYmlvbWV0cmljIGAgK1xuICAgICAgYGZvciAke3RoaXMudWRpZH0gU2ltdWxhdG9yYCk7XG4gIH1cblxuICAvKipcbiAgICogQG92ZXJyaWRlXG4gICAqL1xuICBhc3luYyBnZXRMYXVuY2hEYWVtb25zUm9vdCAoKSB7XG4gICAgY29uc3QgZGV2Um9vdCA9IGF3YWl0IGdldERldmVsb3BlclJvb3QoKTtcbiAgICByZXR1cm4gcGF0aC5yZXNvbHZlKGRldlJvb3QsXG4gICAgICAnUGxhdGZvcm1zL2lQaG9uZU9TLnBsYXRmb3JtL0RldmVsb3Blci9MaWJyYXJ5L0NvcmVTaW11bGF0b3IvUHJvZmlsZXMvUnVudGltZXMvaU9TLnNpbXJ1bnRpbWUvQ29udGVudHMvUmVzb3VyY2VzL1J1bnRpbWVSb290L1N5c3RlbS9MaWJyYXJ5L0xhdW5jaERhZW1vbnMnKTtcbiAgfVxuXG59XG5cbmV4cG9ydCBkZWZhdWx0IFNpbXVsYXRvclhjb2RlOTtcbiJdLCJmaWxlIjoibGliL3NpbXVsYXRvci14Y29kZS05LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
