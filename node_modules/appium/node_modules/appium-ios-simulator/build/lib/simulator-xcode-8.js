"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _simulatorXcode = require("./simulator-xcode-6");

var _simulatorXcode2 = _interopRequireDefault(require("./simulator-xcode-7"));

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _asyncbox = require("asyncbox");

var _teen_process = require("teen_process");

var _geolocation = require("./geolocation");

var _appiumSupport = require("appium-support");

var _utils = require("./utils");

const STARTUP_TIMEOUT = 120 * 1000;

const PROCESS_LAUNCH_OK_PATTERN = bundleId => new RegExp(`${bundleId.replace('.', '\\.')}:\\s+\\d+`);

class SimulatorXcode8 extends _simulatorXcode2.default {
  constructor(udid, xcodeVersion) {
    super(udid, xcodeVersion);
    this.isFreshFiles = ['Library/Cookies', 'Library/Preferences/.GlobalPreferences.plist', 'Library/Preferences/com.apple.springboard.plist', 'var/run/syslog.pid'];
    this._idb = null;
  }

  set idb(value) {
    this._idb = value;
  }

  get idb() {
    return this._idb;
  }

  async killUIClient(opts = {}) {
    let {
      pid,
      signal = 2
    } = opts;
    pid = pid || (await this.getUIClientPid());

    if (!pid) {
      return false;
    }

    _logger.default.debug(`Sending ${signal} kill signal to Simulator UI client with PID ${pid}`);

    try {
      await (0, _teen_process.exec)('kill', [`-${signal}`, pid]);
      return true;
    } catch (e) {
      if (e.code === 1) {
        return false;
      }

      throw new Error(`Cannot kill the Simulator UI client. Original error: ${e.message}`);
    }
  }

  async isAppInstalled(bundleId) {
    try {
      const appContainer = await this.simctl.getAppContainer(bundleId);
      return appContainer.endsWith('.app');
    } catch (err) {
      try {
        const info = await this.simctl.appInfo(bundleId);
        return info.includes('ApplicationType');
      } catch (e) {
        return false;
      }
    }
  }

  get startupTimeout() {
    return STARTUP_TIMEOUT;
  }

  async waitForBoot(startupTimeout) {
    await this.simctl.startBootMonitor({
      timeout: startupTimeout
    });
    this.emit(_simulatorXcode.BOOT_COMPLETED_EVENT);
  }

  async openUrl(url) {
    if (!(await this.isRunning())) {
      throw new Error(`Tried to open '${url}', but Simulator is not in Booted state`);
    }

    const timer = new _appiumSupport.timing.Timer().start();
    let lastError = null;

    try {
      await (0, _asyncbox.waitForCondition)(async () => {
        try {
          const stdout = await this.simctl.launchApp(_utils.MOBILE_SAFARI_BUNDLE_ID);

          if (PROCESS_LAUNCH_OK_PATTERN(_utils.MOBILE_SAFARI_BUNDLE_ID).test(stdout)) {
            await this.simctl.openUrl(url);
            return true;
          }
        } catch (err) {
          _logger.default.warn(`Failed to open '${url}' in Safari. Retrying...`);

          lastError = err.stderr || err.message;
        }

        return false;
      }, {
        waitMs: _utils.SAFARI_STARTUP_TIMEOUT,
        intervalMs: 500
      });
    } catch (err) {
      throw new Error(`Safari cannot open '${url}' after ${timer.getDuration().asSeconds.toFixed(3)}s ` + `because of: ${lastError || 'an unknown error'}`);
    }

    _logger.default.debug(`Safari successfully opened '${url}' in ${timer.getDuration().asSeconds.toFixed(3)}s`);
  }

  async cleanSafari(keepPrefs = true) {
    try {
      if (await this.isRunning()) {
        await this.simctl.terminateApp(_utils.MOBILE_SAFARI_BUNDLE_ID);
      }
    } catch (ign) {}

    await super.cleanSafari(keepPrefs);
  }

  async cleanCustomApp(appFile, appBundleId, scrub = false) {
    try {
      await this.simctl.terminateApp(appBundleId);
    } catch (ign) {}

    await super.cleanCustomApp(appFile, appBundleId, scrub);
  }

  async shake() {
    _logger.default.info(`Performing shake gesture on ${this.udid} Simulator`);

    await this.simctl.spawnProcess(['notifyutil', '-p', 'com.apple.UIKit.SimulatorShake']);
  }

  async _activateWindow() {
    if (this.idb) {
      return await this.idb.focusSimulator();
    }

    _logger.default.warn(`Cannot focus Simulator window with idb. Defaulting to AppleScript`);

    return await super._activateWindow();
  }

  async isBiometricEnrolled() {
    const output = await this.executeUIClientScript(`
      tell application "System Events"
        tell process "Simulator"
          set dstMenuItem to menu item "Toggle Enrolled State" of menu 1 of menu item "Touch ID" of menu 1 of menu bar item "Hardware" of menu bar 1
          set isChecked to (value of attribute "AXMenuItemMarkChar" of dstMenuItem) is "✓"
        end tell
      end tell
    `);

    _logger.default.debug(`Touch ID enrolled state: ${output}`);

    return _lodash.default.isString(output) && output.trim() === 'true';
  }

  async enrollBiometric(isEnabled = true) {
    await this.executeUIClientScript(`
      tell application "System Events"
        tell process "Simulator"
          set dstMenuItem to menu item "Toggle Enrolled State" of menu 1 of menu item "Touch ID" of menu 1 of menu bar item "Hardware" of menu bar 1
          set isChecked to (value of attribute "AXMenuItemMarkChar" of dstMenuItem) is "✓"
          if ${isEnabled ? 'not ' : ''}isChecked then
            click dstMenuItem
          end if
        end tell
      end tell
    `);
  }

  async sendBiometricMatch(shouldMatch = true) {
    await this.executeUIClientScript(`
      tell application "System Events"
        tell process "Simulator"
          set dstMenuItem to menu item "${shouldMatch ? 'Matching Touch' : 'Non-matching Touch'}" of menu 1 of menu item "Touch ID" of menu 1 of menu bar item "Hardware" of menu bar 1
          click dstMenuItem
        end tell
      end tell
    `);
  }

  async setGeolocation(latitude, longitude) {
    const locationSetters = [async () => await (0, _geolocation.setLocationWithLyft)(this.udid, latitude, longitude), async () => await (0, _geolocation.setLocationWithIdb)(this.idb, latitude, longitude), async () => await (0, _geolocation.setLocationWithAppleScript)(this, latitude, longitude)];
    let lastError;

    for (const setter of locationSetters) {
      try {
        await setter();
        return true;
      } catch (e) {
        _logger.default.info(e.message);

        lastError = e;
      }
    }

    throw lastError;
  }

}

var _default = SimulatorXcode8;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zaW11bGF0b3IteGNvZGUtOC5qcyJdLCJuYW1lcyI6WyJTVEFSVFVQX1RJTUVPVVQiLCJQUk9DRVNTX0xBVU5DSF9PS19QQVRURVJOIiwiYnVuZGxlSWQiLCJSZWdFeHAiLCJyZXBsYWNlIiwiU2ltdWxhdG9yWGNvZGU4IiwiU2ltdWxhdG9yWGNvZGU3IiwiY29uc3RydWN0b3IiLCJ1ZGlkIiwieGNvZGVWZXJzaW9uIiwiaXNGcmVzaEZpbGVzIiwiX2lkYiIsImlkYiIsInZhbHVlIiwia2lsbFVJQ2xpZW50Iiwib3B0cyIsInBpZCIsInNpZ25hbCIsImdldFVJQ2xpZW50UGlkIiwibG9nIiwiZGVidWciLCJlIiwiY29kZSIsIkVycm9yIiwibWVzc2FnZSIsImlzQXBwSW5zdGFsbGVkIiwiYXBwQ29udGFpbmVyIiwic2ltY3RsIiwiZ2V0QXBwQ29udGFpbmVyIiwiZW5kc1dpdGgiLCJlcnIiLCJpbmZvIiwiYXBwSW5mbyIsImluY2x1ZGVzIiwic3RhcnR1cFRpbWVvdXQiLCJ3YWl0Rm9yQm9vdCIsInN0YXJ0Qm9vdE1vbml0b3IiLCJ0aW1lb3V0IiwiZW1pdCIsIkJPT1RfQ09NUExFVEVEX0VWRU5UIiwib3BlblVybCIsInVybCIsImlzUnVubmluZyIsInRpbWVyIiwidGltaW5nIiwiVGltZXIiLCJzdGFydCIsImxhc3RFcnJvciIsInN0ZG91dCIsImxhdW5jaEFwcCIsIk1PQklMRV9TQUZBUklfQlVORExFX0lEIiwidGVzdCIsIndhcm4iLCJzdGRlcnIiLCJ3YWl0TXMiLCJTQUZBUklfU1RBUlRVUF9USU1FT1VUIiwiaW50ZXJ2YWxNcyIsImdldER1cmF0aW9uIiwiYXNTZWNvbmRzIiwidG9GaXhlZCIsImNsZWFuU2FmYXJpIiwia2VlcFByZWZzIiwidGVybWluYXRlQXBwIiwiaWduIiwiY2xlYW5DdXN0b21BcHAiLCJhcHBGaWxlIiwiYXBwQnVuZGxlSWQiLCJzY3J1YiIsInNoYWtlIiwic3Bhd25Qcm9jZXNzIiwiX2FjdGl2YXRlV2luZG93IiwiZm9jdXNTaW11bGF0b3IiLCJpc0Jpb21ldHJpY0Vucm9sbGVkIiwib3V0cHV0IiwiZXhlY3V0ZVVJQ2xpZW50U2NyaXB0IiwiXyIsImlzU3RyaW5nIiwidHJpbSIsImVucm9sbEJpb21ldHJpYyIsImlzRW5hYmxlZCIsInNlbmRCaW9tZXRyaWNNYXRjaCIsInNob3VsZE1hdGNoIiwic2V0R2VvbG9jYXRpb24iLCJsYXRpdHVkZSIsImxvbmdpdHVkZSIsImxvY2F0aW9uU2V0dGVycyIsInNldHRlciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFJQTs7QUFDQTs7QUFJQSxNQUFNQSxlQUFlLEdBQUcsTUFBTSxJQUE5Qjs7QUFDQSxNQUFNQyx5QkFBeUIsR0FBSUMsUUFBRCxJQUFjLElBQUlDLE1BQUosQ0FBWSxHQUFFRCxRQUFRLENBQUNFLE9BQVQsQ0FBaUIsR0FBakIsRUFBc0IsS0FBdEIsQ0FBNkIsV0FBM0MsQ0FBaEQ7O0FBRUEsTUFBTUMsZUFBTixTQUE4QkMsd0JBQTlCLENBQThDO0FBQzVDQyxFQUFBQSxXQUFXLENBQUVDLElBQUYsRUFBUUMsWUFBUixFQUFzQjtBQUMvQixVQUFNRCxJQUFOLEVBQVlDLFlBQVo7QUFLQSxTQUFLQyxZQUFMLEdBQW9CLENBQ2xCLGlCQURrQixFQUVsQiw4Q0FGa0IsRUFHbEIsaURBSGtCLEVBSWxCLG9CQUprQixDQUFwQjtBQU1BLFNBQUtDLElBQUwsR0FBWSxJQUFaO0FBQ0Q7O0FBT0QsTUFBSUMsR0FBSixDQUFTQyxLQUFULEVBQWdCO0FBQ2QsU0FBS0YsSUFBTCxHQUFZRSxLQUFaO0FBQ0Q7O0FBS0QsTUFBSUQsR0FBSixHQUFXO0FBQ1QsV0FBTyxLQUFLRCxJQUFaO0FBQ0Q7O0FBaUJELFFBQU1HLFlBQU4sQ0FBb0JDLElBQUksR0FBRyxFQUEzQixFQUErQjtBQUM3QixRQUFJO0FBQ0ZDLE1BQUFBLEdBREU7QUFFRkMsTUFBQUEsTUFBTSxHQUFHO0FBRlAsUUFHQUYsSUFISjtB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QUo7O0FBQ0EsU0FBSyxNQUFNdUMsTUFBWCxJQUFxQkQsZUFBckIsRUFBc0M7QUFDcEMsVUFBSTtBQUNGLGNBQU1DLE1BQU0sRUFBWjtBQUNBLGVBQU8sSUFBUDtBQUNELE9BSEQsQ0FHRSxPQUFPakUsQ0FBUCxFQUFVO0FBQ1ZGLHdCQUFJWSxJQUFKLENBQVNWLENBQUMsQ0FBQ0csT0FBWDs7QUFDQXVCLFFBQUFBLFNBQVMsR0FBRzFCLENBQVo7QUFDRDtBQUNGOztBQUNELFVBQU0wQixTQUFOO0FBQ0Q7O0FBOVIyQzs7ZUFpUy9CMUMsZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJPT1RfQ09NUExFVEVEX0VWRU5UIH0gZnJvbSAnLi9zaW11bGF0b3IteGNvZGUtNic7XG5pbXBvcnQgU2ltdWxhdG9yWGNvZGU3IGZyb20gJy4vc2ltdWxhdG9yLXhjb2RlLTcnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgd2FpdEZvckNvbmRpdGlvbiB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHtcbiAgc2V0TG9jYXRpb25XaXRoTHlmdCxcbiAgc2V0TG9jYXRpb25XaXRoSWRiLFxuICBzZXRMb2NhdGlvbldpdGhBcHBsZVNjcmlwdCB9IGZyb20gJy4vZ2VvbG9jYXRpb24nO1xuaW1wb3J0IHsgdGltaW5nIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgTU9CSUxFX1NBRkFSSV9CVU5ETEVfSUQsIFNBRkFSSV9TVEFSVFVQX1RJTUVPVVQgfSBmcm9tICcuL3V0aWxzJztcblxuXG4vLyB0aGVzZSBzaW1zIGFyZSBzbG9vb29vb29vd1xuY29uc3QgU1RBUlRVUF9USU1FT1VUID0gMTIwICogMTAwMDtcbmNvbnN0IFBST0NFU1NfTEFVTkNIX09LX1BBVFRFUk4gPSAoYnVuZGxlSWQpID0+IG5ldyBSZWdFeHAoYCR7YnVuZGxlSWQucmVwbGFjZSgnLicsICdcXFxcLicpfTpcXFxccytcXFxcZCtgKTtcblxuY2xhc3MgU2ltdWxhdG9yWGNvZGU4IGV4dGVuZHMgU2ltdWxhdG9yWGNvZGU3IHtcbiAgY29uc3RydWN0b3IgKHVkaWQsIHhjb2RlVmVyc2lvbikge1xuICAgIHN1cGVyKHVkaWQsIHhjb2RlVmVyc2lvbik7XG5cbiAgICAvLyBsaXN0IG9mIGZpbGVzIHRvIGNoZWNrIGZvciB3aGVuIHNlZWluZyBpZiBhIHNpbXVsYXRvciBpcyBcImZyZXNoXCJcbiAgICAvLyAobWVhbmluZyBpdCBoYXMgbmV2ZXIgYmVlbiBib290ZWQpLlxuICAgIC8vIElmIHRoZXNlIGZpbGVzIGFyZSBwcmVzZW50LCB3ZSBhc3N1bWUgaXQncyBiZWVuIHN1Y2Nlc3NmdWxseSBib290ZWRcbiAgICB0aGlzLmlzRnJlc2hGaWxlcyA9IFtcbiAgICAgICdMaWJyYXJ5L0Nvb2tpZXMnLFxuICAgICAgJ0xpYnJhcnkvUHJlZmVyZW5jZXMvLkdsb2JhbFByZWZlcmVuY2VzLnBsaXN0JyxcbiAgICAgICdMaWJyYXJ5L1ByZWZlcmVuY2VzL2NvbS5hcHBsZS5zcHJpbmdib2FyZC5wbGlzdCcsXG4gICAgICAndmFyL3J1bi9zeXNsb2cucGlkJ1xuICAgIF07XG4gICAgdGhpcy5faWRiID0gbnVsbDtcbiAgfVxuXG4gIC8qKlxuICAgKiBJREIgaW5zdGFuY2Ugc2V0dGVyXG4gICAqXG4gICAqIEBwYXJhbSB7SURCfSB2YWx1ZVxuICAgKi9cbiAgc2V0IGlkYiAodmFsdWUpIHtcbiAgICB0aGlzLl9pZGIgPSB2YWx1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcmV0dXJuIHtJREJ9IGlkYiBpbnN0YW5jZVxuICAgKi9cbiAgZ2V0IGlkYiAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2lkYjtcbiAgfVxuXG4gIC8qKlxuICAgKiBAdHlwZWRlZiB7T2JqZWN0fSBraWxsT3B0c1xuICAgKiBAcHJvcGVydHkgez9udW1iZXJ8c3RyaW5nfSBwaWQgLSBQcm9jZXNzIGlkIG9mIHRoZSBVSSBTaW11bGF0b3Igd2luZG93XG4gICAqIEBwcm9wZXJ0eSB7bnVtYmVyfHN0cmluZ30gc2lnbmFsIFsyXSAtIFRoZSBzaWduYWwgbnVtYmVyIHRvIHNlbmQgdG8gdGhlXG4gICAqIGBraWxsYCBjb21tYW5kXG4gICAqL1xuXG4gIC8qKlxuICAgKiBLaWxsIHRoZSBVSSBjbGllbnQgaWYgaXQgaXMgcnVubmluZy5cbiAgICpcbiAgICogQHBhcmFtIHs/a2lsbE9wdHN9IG9wdHNcbiAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgVUkgY2xpZW50IHdhcyBzdWNjZXNzZnVsbHkga2lsbGVkIG9yIGZhbHNlXG4gICAqICAgICAgICAgICAgICAgICAgIGlmIGl0IGlzIG5vdCBydW5uaW5nLlxuICAgKiBAdGhyb3dzIHtFcnJvcn0gSWYgc2VuZGluZyB0aGUgc2lnbmFsIHRvIHRoZSBjbGllbnQgcHJvY2VzcyBmYWlsc1xuICAgKi9cbiAgYXN5bmMga2lsbFVJQ2xpZW50IChvcHRzID0ge30pIHtcbiAgICBsZXQge1xuICAgICAgcGlkLFxuICAgICAgc2lnbmFsID0gMixcbiAgICB9ID0gb3B0cztcbiAgICBwaWQgPSBwaWQgfHwgYXdhaXQgdGhpcy5nZXRVSUNsaWVudFBpZCgpO1xuICAgIGlmICghcGlkKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgbG9nLmRlYnVnKGBTZW5kaW5nICR7c2lnbmFsfSBraWxsIHNpZ25hbCB0byBTaW11bGF0b3IgVUkgY2xpZW50IHdpdGggUElEICR7cGlkfWApO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBleGVjKCdraWxsJywgW2AtJHtzaWduYWx9YCwgcGlkXSk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBpZiAoZS5jb2RlID09PSAxKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGtpbGwgdGhlIFNpbXVsYXRvciBVSSBjbGllbnQuIE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVmVyaWZ5IHdoZXRoZXIgdGhlIHBhcnRpY3VsYXIgYXBwbGljYXRpb24gaXMgaW5zdGFsbGVkIG9uIFNpbXVsYXRvci5cbiAgICogQG92ZXJyaWRlXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBidW5kbGVJZCAtIFRoZSBidW5kbGUgaWQgb2YgdGhlIGFwcGxpY2F0aW9uIHRvIGJlIGNoZWNrZWQuXG4gICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGdpdmVuIGFwcGxpY2F0aW9uIGlzIGluc3RhbGxlZC5cbiAgICovXG4gIGFzeW5jIGlzQXBwSW5zdGFsbGVkIChidW5kbGVJZCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBhcHBDb250YWluZXIgPSBhd2FpdCB0aGlzLnNpbWN0bC5nZXRBcHBDb250YWluZXIoYnVuZGxlSWQpO1xuICAgICAgcmV0dXJuIGFwcENvbnRhaW5lci5lbmRzV2l0aCgnLmFwcCcpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgLy8gZ2V0X2FwcF9jb250YWluZXIgc3ViY29tbWFuZCBmYWlscyBmb3Igc3lzdGVtIGFwcGxpY2F0aW9ucyxcbiAgICAgIC8vIHNvIHdlIHRyeSB0aGUgaGlkZGVuIGFwcGluZm8gc3ViY29tbWFuZCwgd2hpY2ggcHJpbnRzIGNvcnJlY3QgaW5mbyBmb3JcbiAgICAgIC8vIHN5c3RlbS9oaWRkZW4gYXBwc1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgaW5mbyA9IGF3YWl0IHRoaXMuc2ltY3RsLmFwcEluZm8oYnVuZGxlSWQpO1xuICAgICAgICByZXR1cm4gaW5mby5pbmNsdWRlcygnQXBwbGljYXRpb25UeXBlJyk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgbWF4IG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gd2FpdCB1bnRpbCBTaW11bGF0b3IgYm9vdGluZyBpcyBjb21wbGV0ZWQuXG4gICAqL1xuICBnZXQgc3RhcnR1cFRpbWVvdXQgKCkge1xuICAgIHJldHVybiBTVEFSVFVQX1RJTUVPVVQ7XG4gIH1cblxuICAvKipcbiAgICogVmVyaWZ5IHdoZXRoZXIgdGhlIFNpbXVsYXRvciBib290aW5nIGlzIGNvbXBsZXRlZCBhbmQvb3Igd2FpdCBmb3IgaXRcbiAgICogdW50aWwgdGhlIHRpbWVvdXQgZXhwaXJlcy5cbiAgICogQG92ZXJyaWRlXG4gICAqXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBzdGFydHVwVGltZW91dCAtIHRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHdhaXQgdW50aWwgYm9vdGluZyBpcyBjb21wbGV0ZWQuXG4gICAqIEBlbWl0cyBCT09UX0NPTVBMRVRFRF9FVkVOVCBpZiB0aGUgY3VycmVudCBTaW11bGF0b3IgaXMgcmVhZHkgdG8gYWNjZXB0IHNpbWN0bCBjb21tYW5kcywgbGlrZSAnaW5zdGFsbCcuXG4gICAqL1xuICBhc3luYyB3YWl0Rm9yQm9vdCAoc3RhcnR1cFRpbWVvdXQpIHtcbiAgICBhd2FpdCB0aGlzLnNpbWN0bC5zdGFydEJvb3RNb25pdG9yKHt0aW1lb3V0OiBzdGFydHVwVGltZW91dH0pO1xuICAgIHRoaXMuZW1pdChCT09UX0NPTVBMRVRFRF9FVkVOVCk7XG4gIH1cblxuICAvKipcbiAgICogT3BlbiB0aGUgZ2l2ZW4gVVJMIGluIG1vYmlsZSBTYWZhcmkgYnJvd3Nlci5cbiAgICogVGhlIGJyb3dzZXIgd2lsbCBiZSBzdGFydGVkIGF1dG9tYXRpY2FsbHkgaWYgaXQgaXMgbm90IHJ1bm5pbmcuXG4gICAqIEBvdmVycmlkZVxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gVGhlIFVSTCB0byBiZSBvcGVuZWQuXG4gICAqL1xuICBhc3luYyBvcGVuVXJsICh1cmwpIHtcbiAgICBpZiAoIWF3YWl0IHRoaXMuaXNSdW5uaW5nKCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVHJpZWQgdG8gb3BlbiAnJHt1cmx9JywgYnV0IFNpbXVsYXRvciBpcyBub3QgaW4gQm9vdGVkIHN0YXRlYCk7XG4gICAgfVxuICAgIGNvbnN0IHRpbWVyID0gbmV3IHRpbWluZy5UaW1lcigpLnN0YXJ0KCk7XG4gICAgbGV0IGxhc3RFcnJvciA9IG51bGw7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHdhaXRGb3JDb25kaXRpb24oYXN5bmMgKCkgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIC8vIFRoaXMgaXMgdG8gbWFrZSBzdXJlIFNhZmFyaSBpcyBhbHJlYWR5IHJ1bm5pbmdcbiAgICAgICAgICBjb25zdCBzdGRvdXQgPSBhd2FpdCB0aGlzLnNpbWN0bC5sYXVuY2hBcHAoTU9CSUxFX1NBRkFSSV9CVU5ETEVfSUQpO1xuICAgICAgICAgIGlmIChQUk9DRVNTX0xBVU5DSF9PS19QQVRURVJOKE1PQklMRV9TQUZBUklfQlVORExFX0lEKS50ZXN0KHN0ZG91dCkpIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuc2ltY3RsLm9wZW5VcmwodXJsKTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgbG9nLndhcm4oYEZhaWxlZCB0byBvcGVuICcke3VybH0nIGluIFNhZmFyaS4gUmV0cnlpbmcuLi5gKTtcbiAgICAgICAgICBsYXN0RXJyb3IgPSBlcnIuc3RkZXJyIHx8IGVyci5tZXNzYWdlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH0sIHt3YWl0TXM6IFNBRkFSSV9TVEFSVFVQX1RJTUVPVVQsIGludGVydmFsTXM6IDUwMH0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBTYWZhcmkgY2Fubm90IG9wZW4gJyR7dXJsfScgYWZ0ZXIgJHt0aW1lci5nZXREdXJhdGlvbigpLmFzU2Vjb25kcy50b0ZpeGVkKDMpfXMgYCArXG4gICAgICAgIGBiZWNhdXNlIG9mOiAke2xhc3RFcnJvciB8fCAnYW4gdW5rbm93biBlcnJvcid9YCk7XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhgU2FmYXJpIHN1Y2Nlc3NmdWxseSBvcGVuZWQgJyR7dXJsfScgaW4gJHt0aW1lci5nZXREdXJhdGlvbigpLmFzU2Vjb25kcy50b0ZpeGVkKDMpfXNgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhbiB1cCB0aGUgZGlyZWN0b3JpZXMgZm9yIG1vYmlsZSBTYWZhcmkuXG4gICAqIEBvdmVycmlkZVxuICAgKlxuICAgKiBAcGFyYW0ge2Jvb2xlYW59IGtlZXBQcmVmcyAtIFdoZXRoZXIgdG8ga2VlcCBTYWZhcmkgcHJlZmVyZW5jZXMgZnJvbSBiZWluZyBkZWxldGVkLlxuICAgKi9cbiAgYXN5bmMgY2xlYW5TYWZhcmkgKGtlZXBQcmVmcyA9IHRydWUpIHtcbiAgICB0cnkge1xuICAgICAgaWYgKGF3YWl0IHRoaXMuaXNSdW5uaW5nKCkpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5zaW1jdGwudGVybWluYXRlQXBwKE1PQklMRV9TQUZBUklfQlVORExFX0lEKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChpZ24pIHtcbiAgICAgIC8vIGlnbm9yZSBlcnJvclxuICAgIH1cbiAgICBhd2FpdCBzdXBlci5jbGVhblNhZmFyaShrZWVwUHJlZnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIENsZWFuL3NjcnViIHRoZSBwYXJ0aWN1bGFyIGFwcGxpY2F0aW9uIG9uIFNpbXVsYXRvci5cbiAgICogQG92ZXJyaWRlXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBhcHBGaWxlIC0gQXBwbGljYXRpb24gbmFtZSBtaW51cyBcIi5hcHBcIi5cbiAgICogQHBhcmFtIHtzdHJpbmd9IGFwcEJ1bmRsZUlkIC0gQnVuZGxlIGlkZW50aWZpZXIgb2YgdGhlIGFwcGxpY2F0aW9uLlxuICAgKiBAcGFyYW0ge2Jvb2xlYW59IHNjcnViIC0gSWYgYHNjcnViYCBpcyBmYWxzZSwgd2Ugd2FudCB0byBjbGVhbiBieSBkZWxldGluZyB0aGUgYXBwIGFuZCBhbGxcbiAgICogICBmaWxlcyBhc3NvY2lhdGVkIHdpdGggaXQuIElmIGBzY3J1YmAgaXMgdHJ1ZSwgd2UganVzdCB3YW50IHRvIGRlbGV0ZSB0aGUgcHJlZmVyZW5jZXMgYW5kXG4gICAqICAgY2hhbmdlZCBmaWxlcy5cbiAgICovXG4gIGFzeW5jIGNsZWFuQ3VzdG9tQXBwIChhcHBGaWxlLCBhcHBCdW5kbGVJZCwgc2NydWIgPSBmYWxzZSkge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnNpbWN0bC50ZXJtaW5hdGVBcHAoYXBwQnVuZGxlSWQpO1xuICAgIH0gY2F0Y2ggKGlnbikge1xuICAgICAgLy8gaWdub3JlIGVycm9yXG4gICAgfVxuICAgIGF3YWl0IHN1cGVyLmNsZWFuQ3VzdG9tQXBwKGFwcEZpbGUsIGFwcEJ1bmRsZUlkLCBzY3J1Yik7XG4gIH1cblxuICAvKipcbiAgICogUGVyZm9ybSBTaGFrZSBnZXN0dXJlIG9uIFNpbXVsYXRvciB3aW5kb3cuXG4gICAqL1xuICBhc3luYyBzaGFrZSAoKSB7XG4gICAgbG9nLmluZm8oYFBlcmZvcm1pbmcgc2hha2UgZ2VzdHVyZSBvbiAke3RoaXMudWRpZH0gU2ltdWxhdG9yYCk7XG4gICAgYXdhaXQgdGhpcy5zaW1jdGwuc3Bhd25Qcm9jZXNzKFtcbiAgICAgICdub3RpZnl1dGlsJyxcbiAgICAgICctcCcsICdjb20uYXBwbGUuVUlLaXQuU2ltdWxhdG9yU2hha2UnXG4gICAgXSk7XG4gIH1cblxuICAvKipcbiAgICogQGluaGVyaXRkb2NcbiAgICogQG92ZXJyaWRlXG4gICAqIEBwcml2YXRlXG4gICAqL1xuICBhc3luYyBfYWN0aXZhdGVXaW5kb3cgKCkge1xuICAgIGlmICh0aGlzLmlkYikge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuaWRiLmZvY3VzU2ltdWxhdG9yKCk7XG4gICAgfVxuICAgIGxvZy53YXJuKGBDYW5ub3QgZm9jdXMgU2ltdWxhdG9yIHdpbmRvdyB3aXRoIGlkYi4gRGVmYXVsdGluZyB0byBBcHBsZVNjcmlwdGApO1xuICAgIHJldHVybiBhd2FpdCBzdXBlci5fYWN0aXZhdGVXaW5kb3coKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAaW5oZXJpdGRvY1xuICAgKiBAb3ZlcnJpZGVcbiAgICovXG4gIGFzeW5jIGlzQmlvbWV0cmljRW5yb2xsZWQgKCkge1xuICAgIGNvbnN0IG91dHB1dCA9IGF3YWl0IHRoaXMuZXhlY3V0ZVVJQ2xpZW50U2NyaXB0KGBcbiAgICAgIHRlbGwgYXBwbGljYXRpb24gXCJTeXN0ZW0gRXZlbnRzXCJcbiAgICAgICAgdGVsbCBwcm9jZXNzIFwiU2ltdWxhdG9yXCJcbiAgICAgICAgICBzZXQgZHN0TWVudUl0ZW0gdG8gbWVudSBpdGVtIFwiVG9nZ2xlIEVucm9sbGVkIFN0YXRlXCIgb2YgbWVudSAxIG9mIG1lbnUgaXRlbSBcIlRvdWNoIElEXCIgb2YgbWVudSAxIG9mIG1lbnUgYmFyIGl0ZW0gXCJIYXJkd2FyZVwiIG9mIG1lbnUgYmFyIDFcbiAgICAgICAgICBzZXQgaXNDaGVja2VkIHRvICh2YWx1ZSBvZiBhdHRyaWJ1dGUgXCJBWE1lbnVJdGVtTWFya0NoYXJcIiBvZiBkc3RNZW51SXRlbSkgaXMgXCLinJNcIlxuICAgICAgICBlbmQgdGVsbFxuICAgICAgZW5kIHRlbGxcbiAgICBgKTtcbiAgICBsb2cuZGVidWcoYFRvdWNoIElEIGVucm9sbGVkIHN0YXRlOiAke291dHB1dH1gKTtcbiAgICByZXR1cm4gXy5pc1N0cmluZyhvdXRwdXQpICYmIG91dHB1dC50cmltKCkgPT09ICd0cnVlJztcbiAgfVxuXG4gIC8qKlxuICAgKiBAaW5oZXJpdGRvY1xuICAgKiBAb3ZlcnJpZGVcbiAgICovXG4gIGFzeW5jIGVucm9sbEJpb21ldHJpYyAoaXNFbmFibGVkID0gdHJ1ZSkge1xuICAgIGF3YWl0IHRoaXMuZXhlY3V0ZVVJQ2xpZW50U2NyaXB0KGBcbiAgICAgIHRlbGwgYXBwbGljYXRpb24gXCJTeXN0ZW0gRXZlbnRzXCJcbiAgICAgICAgdGVsbCBwcm9jZXNzIFwiU2ltdWxhdG9yXCJcbiAgICAgICAgICBzZXQgZHN0TWVudUl0ZW0gdG8gbWVudSBpdGVtIFwiVG9nZ2xlIEVucm9sbGVkIFN0YXRlXCIgb2YgbWVudSAxIG9mIG1lbnUgaXRlbSBcIlRvdWNoIElEXCIgb2YgbWVudSAxIG9mIG1lbnUgYmFyIGl0ZW0gXCJIYXJkd2FyZVwiIG9mIG1lbnUgYmFyIDFcbiAgICAgICAgICBzZXQgaXNDaGVja2VkIHRvICh2YWx1ZSBvZiBhdHRyaWJ1dGUgXCJBWE1lbnVJdGVtTWFya0NoYXJcIiBvZiBkc3RNZW51SXRlbSkgaXMgXCLinJNcIlxuICAgICAgICAgIGlmICR7aXNFbmFibGVkID8gJ25vdCAnIDogJyd9aXNDaGVja2VkIHRoZW5cbiAgICAgICAgICAgIGNsaWNrIGRzdE1lbnVJdGVtXG4gICAgICAgICAgZW5kIGlmXG4gICAgICAgIGVuZCB0ZWxsXG4gICAgICBlbmQgdGVsbFxuICAgIGApO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0ZG9jXG4gICAqIEBvdmVycmlkZVxuICAgKi9cbiAgYXN5bmMgc2VuZEJpb21ldHJpY01hdGNoIChzaG91bGRNYXRjaCA9IHRydWUpIHtcbiAgICBhd2FpdCB0aGlzLmV4ZWN1dGVVSUNsaWVudFNjcmlwdChgXG4gICAgICB0ZWxsIGFwcGxpY2F0aW9uIFwiU3lzdGVtIEV2ZW50c1wiXG4gICAgICAgIHRlbGwgcHJvY2VzcyBcIlNpbXVsYXRvclwiXG4gICAgICAgICAgc2V0IGRzdE1lbnVJdGVtIHRvIG1lbnUgaXRlbSBcIiR7c2hvdWxkTWF0Y2ggPyAnTWF0Y2hpbmcgVG91Y2gnIDogJ05vbi1tYXRjaGluZyBUb3VjaCd9XCIgb2YgbWVudSAxIG9mIG1lbnUgaXRlbSBcIlRvdWNoIElEXCIgb2YgbWVudSAxIG9mIG1lbnUgYmFyIGl0ZW0gXCJIYXJkd2FyZVwiIG9mIG1lbnUgYmFyIDFcbiAgICAgICAgICBjbGljayBkc3RNZW51SXRlbVxuICAgICAgICBlbmQgdGVsbFxuICAgICAgZW5kIHRlbGxcbiAgICBgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgY3VzdG9tIGdlb2xvY2F0aW9uIHBhcmFtZXRlcnMgZm9yIHRoZSBnaXZlbiBTaW11bGF0b3IgdXNpbmcgQXBwbGVTY3JpcHQuXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gbGF0aXR1ZGUgLSBUaGUgbGF0aXR1ZGUgdmFsdWUsIHdoaWNoIGlzIGdvaW5nIHRvIGJlIGVudGVyZWRcbiAgICogICBpbnRvIHRoZSBjb3JyZXNwb25kaW5nIGVkaXQgZmllbGQsIGZvciBleGFtcGxlICczOSwwMDA2Jy5cbiAgICogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBsb25naXR1ZGUgLSBUaGUgbG9uZ2l0dWRlIHZhbHVlLCB3aGljaCBpcyBnb2luZyB0byBiZSBlbnRlcmVkXG4gICAqICAgaW50byB0aGUgY29ycmVzcG9uZGluZyBlZGl0IGZpZWxkLCBmb3IgZXhhbXBsZSAnMTksMDA2OCcuXG4gICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIHRoZSBnaXZlbiBwYXJhbWV0ZXJzIGhhdmUgY29ycmVjdCBmb3JtYXQgYW5kIHdlcmUgc3VjY2Vzc2Z1bGx5IGFjY2VwdGVkLlxuICAgKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIHNldHRpbmcgdGhlIGxvY2F0aW9uXG4gICAqL1xuICBhc3luYyBzZXRHZW9sb2NhdGlvbiAobGF0aXR1ZGUsIGxvbmdpdHVkZSkge1xuICAgIGNvbnN0IGxvY2F0aW9uU2V0dGVycyA9IFtcbiAgICAgIGFzeW5jICgpID0+IGF3YWl0IHNldExvY2F0aW9uV2l0aEx5ZnQodGhpcy51ZGlkLCBsYXRpdHVkZSwgbG9uZ2l0dWRlKSxcbiAgICAgIGFzeW5jICgpID0+IGF3YWl0IHNldExvY2F0aW9uV2l0aElkYih0aGlzLmlkYiwgbGF0aXR1ZGUsIGxvbmdpdHVkZSksXG4gICAgICBhc3luYyAoKSA9PiBhd2FpdCBzZXRMb2NhdGlvbldpdGhBcHBsZVNjcmlwdCh0aGlzLCBsYXRpdHVkZSwgbG9uZ2l0dWRlKVxuICAgIF07XG5cbiAgICBsZXQgbGFzdEVycm9yO1xuICAgIGZvciAoY29uc3Qgc2V0dGVyIG9mIGxvY2F0aW9uU2V0dGVycykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgc2V0dGVyKCk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2cuaW5mbyhlLm1lc3NhZ2UpO1xuICAgICAgICBsYXN0RXJyb3IgPSBlO1xuICAgICAgfVxuICAgIH1cbiAgICB0aHJvdyBsYXN0RXJyb3I7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgU2ltdWxhdG9yWGNvZGU4O1xuIl0sImZpbGUiOiJsaWIvc2ltdWxhdG9yLXhjb2RlLTguanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
