"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _appiumBaseDriver = require("appium-base-driver");

var _lodash = _interopRequireDefault(require("lodash"));

var _js2xmlparser = _interopRequireDefault(require("js2xmlparser2"));

var _logger = _interopRequireDefault(require("../logger"));

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var utils = _interopRequireWildcard(require("../utils"));

var _nodeSimctl = require("node-simctl");

var _moment = _interopRequireDefault(require("moment"));

let commands = {},
    helpers = {},
    extensions = {};
exports.helpers = helpers;
exports.commands = commands;
const MOMENT_FORMAT_ISO8601 = 'YYYY-MM-DDTHH:mm:ssZ';

commands.active = async function active() {
  if (this.isWebContext()) {
    return await this.executeAtom('active_element', []);
  } else {
    return await this.uiAutoClient.sendCommand('au.getActiveElement()');
  }
};

commands.getDeviceTime = async function getDeviceTime(format = MOMENT_FORMAT_ISO8601) {
  _logger.default.info('Attempting to capture iOS device date and time');

  let cmd;
  let args;
  let inputFormat;

  if (this.isRealDevice()) {
    try {
      cmd = await _appiumSupport.fs.which('idevicedate');
    } catch (err) {
      _logger.default.errorAndThrow('Could not capture device date and time using libimobiledevice idevicedate. ' + 'Libimobiledevice is probably not installed');
    }

    _logger.default.info(`Found idevicedate: '${cmd}'`);

    args = ['-u', this.opts.udid];
    inputFormat = 'ddd MMM DD HH:mm:ss z YYYY';
  } else {
    _logger.default.warn('On simulator. Assuming device time is the same as host time');

    cmd = 'date';
    args = ['+%Y-%m-%dT%H:%M:%S%z'];
    inputFormat = 'YYYY-MM-DDTHH:mm:ssZZ';
  }

  const stdout = (await (0, _teen_process.exec)(cmd, args)).stdout.trim();

  _logger.default.debug(`Got the following output out of '${cmd} ${args.join(' ')}': ${stdout}`);

  const parsedTimestamp = _moment.default.utc(stdout, inputFormat);

  if (!parsedTimestamp.isValid()) {
    _logger.default.warn(`Cannot parse the timestamp '${stdout}' returned by '${cmd}' command. Returning it as is`);

    return stdout;
  }

  return parsedTimestamp.utcOffset(parsedTimestamp._tzm || 0).format(format);
};

commands.hideKeyboard = async function hideKeyboard(strategy, ...possibleKeys) {
  possibleKeys.pop();
  let cmd;

  let key = _lodash.default.find(possibleKeys, k => {
    return k;
  });

  if (key) {
    strategy = strategy || 'pressKey';
    cmd = `au.hideKeyboard('${strategy}', '${key}')`;
  } else {
    strategy = strategy || 'default';
    cmd = `au.hideKeyboard('${strategy}')`;
  }

  await this.uiAutoClient.sendCommand(cmd);
};

commands.getPageSource = async function getPageSource() {
  if (this.isWebContext()) {
    const script = 'return document.documentElement.outerHTML';
    return await this.executeAtom('execute_script', [script, []]);
  } else {
    return await this.getNativePageSource();
  }
};

helpers.getNativePageSource = async function getNativePageSource() {
  let jsonSource = await this.getSourceForElementForXML();

  if (typeof jsonSource === 'string') {
    jsonSource = JSON.parse(jsonSource);
  }

  let xmlSource = (0, _js2xmlparser.default)('AppiumAUT', jsonSource, {
    wrapArray: {
      enabled: false,
      elementName: 'element'
    },
    declaration: {
      include: true
    },
    prettyPrinting: {
      indentString: '    '
    }
  });
  return xmlSource;
};

commands.background = async function background(secs) {
  await this.uiAutoClient.sendCommand(`au.background(${secs})`);
};

commands.lock = async function lock(secs) {
  if (!secs) {
    _logger.default.debug('No seconds parameter. Using 0 seconds');

    secs = 0;
  }

  await this.uiAutoClient.sendCommand(`au.lock(${secs})`);
};

commands.closeApp = async function closeApp() {
  let appName = this.opts.app || this.opts.bundleId;

  try {
    await this.stop();

    _logger.default.info(`Successfully closed the '${appName}' app.`);
  } catch (err) {
    _logger.default.warn(`Something went wrong while closing the '${appName}' app.`);

    throw err;
  }
};

commands.launchApp = async function launchApp() {
  let appName = this.opts.app || this.opts.bundleId;

  try {
    await this.start();

    _logger.default.info(`Successfully launched the '${appName}' app.`);
  } catch (err) {
    _logger.default.warn(`Something went wrong while launching the '${appName}' app.`);

    throw err;
  }
};

commands.removeApp = async function removeApp(bundleId) {
  if (this.isRealDevice()) {
    await this.realDevice.remove(bundleId);
  } else {
    await this.sim.removeApp(bundleId);
  }
};

commands.keys = async function keys(keys) {
  if (this.isWebContext()) {
    let el = await this.active();

    if (_lodash.default.isUndefined(el.ELEMENT)) {
      throw new _appiumBaseDriver.errors.NoSuchElementError();
    }

    await this.setValue(keys, el.ELEMENT);
  } else {
    if (_lodash.default.isArray(keys)) {
      keys = keys.join('');
    }

    if (!_lodash.default.isString(keys)) {
      keys = keys.toString();
    }

    keys = _appiumSupport.util.escapeSpecialChars(keys, "'");
    let command = `au.sendKeysToActiveElement('${keys}')`;
    await this.uiAutoClient.sendCommand(command);
  }
};

commands.setGeoLocation = async function setGeoLocation(location) {
  await this.uiAutoClient.sendCommand(`target.setLocation(${JSON.stringify(location)})`);
};

commands.getWindowSize = async function getWindowSize(windowHandle = 'current') {
  if (windowHandle !== 'current') {
    throw new _appiumBaseDriver.errors.NotYetImplementedError('Currently only getting current window size is supported.');
  }

  if (this.isWebContext()) {
    return await this.executeAtom('get_window_size', []);
  } else {
    return await this.uiAutoClient.sendCommand('au.getWindowSize()');
  }
};

commands.getWindowRect = async function getWindowRect() {
  const {
    width,
    height
  } = await this.getWindowSize();
  return {
    width,
    height,
    x: 0,
    y: 0
  };
};

commands.getStrings = async function getStrings(language, stringFile = null) {
  _logger.default.debug(`Gettings strings for language '${language}' and string file '${stringFile}'`);

  return await utils.parseLocalizableStrings(Object.assign({}, this.opts, {
    language,
    stringFile,
    strictMode: true
  }));
};

commands.setUrl = async function setUrl(url) {
  _logger.default.debug(`Attempting to set url '${url}'`);

  if (!this.isWebContext()) {
    await (0, _nodeSimctl.openUrl)(this.opts.udid || this.sim.udid, url);
    return;
  }

  this.setCurrentUrl(url);
  this.curWebFrames = [];
  await this.remote.navToUrl(url);
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9nZW5lcmFsLmpzIl0sIm5hbWVzIjpbImNvbW1hbmRzIiwiaGVscGVycyIsImV4dGVuc2lvbnMiLCJNT01FTlRfRk9STUFUX0lTTzg2MDEiLCJhY3RpdmUiLCJpc1dlYkNvbnRleHQiLCJleGVjdXRlQXRvbSIsInVpQXV0b0NsaWVudCIsInNlbmRDb21tYW5kIiwiZ2V0RGV2aWNlVGltZSIsImZvcm1hdCIsImxvZyIsImluZm8iLCJjbWQiLCJhcmdzIiwiaW5wdXRGb3JtYXQiLCJpc1JlYWxEZXZpY2UiLCJmcyIsIndoaWNoIiwiZXJyIiwiZXJyb3JBbmRUaHJvdyIsIm9wdHMiLCJ1ZGlkIiwid2FybiIsInN0ZG91dCIsInRyaW0iLCJkZWJ1ZyIsImpvaW4iLCJwYXJzZWRUaW1lc3RhbXAiLCJtb21lbnQiLCJ1dGMiLCJpc1ZhbGlkIiwidXRjT2Zmc2V0IiwiX3R6bSIsImhpZGVLZXlib2FyZCIsInN0cmF0ZWd5IiwicG9zc2libGVLZXlzIiwicG9wIiwia2V5IiwiXyIsImZpbmQiLCJrIiwiZ2V0UGFnZVNvdXJjZSIsInNjcmlwdCIsImdldE5hdGl2ZVBhZ2VTb3VyY2UiLCJqc29uU291cmNlIiwiZ2V0U291cmNlRm9yRWxlbWVudEZvclhNTCIsIkpTT04iLCJwYXJzZSIsInhtbFNvdXJjZSIsIndyYXBBcnJheSIsImVuYWJsZWQiLCJlbGVtZW50TmFtZSIsImRlY2xhcmF0aW9uIiwiaW5jbHVkZSIsInByZXR0eVByaW50aW5nIiwiaW5kZW50U3RyaW5nIiwiYmFja2dyb3VuZCIsInNlY3MiLCJsb2NrIiwiY2xvc2VBcHAiLCJhcHBOYW1lIiwiYXBwIiwiYnVuZGxlSWQiLCJzdG9wIiwibGF1bmNoQXBwIiwic3RhcnQiLCJyZW1vdmVBcHAiLCJyZWFsRGV2aWNlIiwicmVtb3ZlIiwic2ltIiwia2V5cyIsImVsIiwiaXNVbmRlZmluZWQiLCJFTEVNRU5UIiwiZXJyb3JzIiwiTm9TdWNoRWxlbWVudEVycm9yIiwic2V0VmFsdWUiLCJpc0FycmF5IiwiaXNTdHJpbmciLCJ0b1N0cmluZyIsInV0aWwiLCJlc2NhcGVTcGVjaWFsQ2hhcnMiLCJjb21tYW5kIiwic2V0R2VvTG9jYXRpb24iLCJsb2NhdGlvbiIsInN0cmluZ2lmeSIsImdldFdpbmRvd1NpemUiLCJ3aW5kb3dIYW5kbGUiLCJOb3RZZXRJbXBsZW1lbnRlZEVycm9yIiwiZ2V0V2luZG93UmVjdCIsIndpZHRoIiwiaGVpZ2h0IiwieCIsInkiLCJnZXRTdHJpbmdzIiwibGFuZ3VhZ2UiLCJzdHJpbmdGaWxlIiwidXRpbHMiLCJwYXJzZUxvY2FsaXphYmxlU3RyaW5ncyIsIk9iamVjdCIsImFzc2lnbiIsInN0cmljdE1vZGUiLCJzZXRVcmwiLCJ1cmwiLCJzZXRDdXJyZW50VXJsIiwiY3VyV2ViRnJhbWVzIiwicmVtb3RlIiwibmF2VG9VcmwiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxJQUFJQSxRQUFRLEdBQUcsRUFBZjtBQUFBLElBQW1CQyxPQUFPLEdBQUcsRUFBN0I7QUFBQSxJQUFpQ0MsVUFBVSxHQUFHLEVBQTlDOzs7QUFFQSxNQUFNQyxxQkFBcUIsR0FBRyxzQkFBOUI7O0FBRUFILFFBQVEsQ0FBQ0ksTUFBVCxHQUFrQixlQUFlQSxNQUFmLEdBQXlCO0FBQ3pDLE1BQUksS0FBS0MsWUFBTCxFQUFKLEVBQXlCO0FBQ3ZCLFdBQU8sTUFBTSxLQUFLQyxXQUFMLENBQWlCLGdCQUFqQixFQUFtQyxFQUFuQyxDQUFiO0FBQ0QsR0FGRCxNQUVPO0FBQ0wsV0FBTyxNQUFNLEtBQUtDLFlBQUwsQ0FBa0JDLFdBQWxCLENBQThCLHVCQUE5QixDQUFiO0FBQ0Q7QUFDRixDQU5EOztBQWlCQVIsUUFBUSxDQUFDUyxhQUFULEdBQXlCLGVBQWVBLGFBQWYsQ0FBOEJDLE1BQU0sR0FBR1AscUJBQXZDLEVBQThEO0FBQ3JGUSxrQkFBSUMsSUFBSixDQUFTLGdEQUFUOztBQUNBLE1B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S2dELEdBQUwsQ0FBU2hELElBQW5DLEVBQXlDa0YsR0FBekMsQ0FBTjtBQUNBO0FBQ0Q7O0FBQ0QsT0FBS0MsYUFBTCxDQUFtQkQsR0FBbkI7QUFFQSxPQUFLRSxZQUFMLEdBQW9CLEVBQXBCO0FBQ0EsUUFBTSxLQUFLQyxNQUFMLENBQVlDLFFBQVosQ0FBcUJKLEdBQXJCLENBQU47QUFDRCxDQVhEOztBQWNBSixNQUFNLENBQUNDLE1BQVAsQ0FBY25HLFVBQWQsRUFBMEJGLFFBQTFCLEVBQW9DQyxPQUFwQztlQUVlQyxVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZXJyb3JzIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQganMyeG1sIGZyb20gJ2pzMnhtbHBhcnNlcjInO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgZnMsIHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCAqIGFzIHV0aWxzIGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB7IG9wZW5VcmwgfSBmcm9tICdub2RlLXNpbWN0bCc7XG5pbXBvcnQgbW9tZW50IGZyb20gJ21vbWVudCc7XG5cbmxldCBjb21tYW5kcyA9IHt9LCBoZWxwZXJzID0ge30sIGV4dGVuc2lvbnMgPSB7fTtcblxuY29uc3QgTU9NRU5UX0ZPUk1BVF9JU084NjAxID0gJ1lZWVktTU0tRERUSEg6bW06c3NaJztcblxuY29tbWFuZHMuYWN0aXZlID0gYXN5bmMgZnVuY3Rpb24gYWN0aXZlICgpIHtcbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnYWN0aXZlX2VsZW1lbnQnLCBbXSk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKCdhdS5nZXRBY3RpdmVFbGVtZW50KCknKTtcbiAgfVxufTtcblxuLyoqXG4gKiBSZXRyaWV2ZXMgdGhlIGN1cnJlbnQgZGV2aWNlJ3MgdGltZXN0YW1wLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBmb3JtYXQgLSBUaGUgc2V0IG9mIGZvcm1hdCBzcGVjaWZpZXJzLiBSZWFkXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgaHR0cHM6Ly9tb21lbnRqcy5jb20vZG9jcy8gdG8gZ2V0IHRoZSBmdWxsIGxpc3Qgb2Ygc3VwcG9ydGVkXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0ZXRpbWUgZm9ybWF0IHNwZWNpZmllcnMuIFRoZSBkZWZhdWx0IGZvcm1hdCBpc1xuICogICAgICAgICAgICAgICAgICAgICAgICAgIGBZWVlZLU1NLUREVEhIOm1tOnNzWmAsIHdoaWNoIGNvbXBsaWVzIHRvIElTTy04NjAxXG4gKiBAcmV0dXJucyBGb3JtYXR0ZWQgZGF0ZXRpbWUgc3RyaW5nIG9yIHRoZSByYXcgY29tbWFuZCBvdXRwdXQgaWYgZm9ybWF0dGluZyBmYWlsc1xuICovXG5jb21tYW5kcy5nZXREZXZpY2VUaW1lID0gYXN5bmMgZnVuY3Rpb24gZ2V0RGV2aWNlVGltZSAoZm9ybWF0ID0gTU9NRU5UX0ZPUk1BVF9JU084NjAxKSB7XG4gIGxvZy5pbmZvKCdBdHRlbXB0aW5nIHRvIGNhcHR1cmUgaU9TIGRldmljZSBkYXRlIGFuZCB0aW1lJyk7XG4gIGxldCBjbWQ7XG4gIGxldCBhcmdzO1xuICBsZXQgaW5wdXRGb3JtYXQ7XG4gIGlmICh0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNtZCA9IGF3YWl0IGZzLndoaWNoKCdpZGV2aWNlZGF0ZScpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3coJ0NvdWxkIG5vdCBjYXB0dXJlIGRldmljZSBkYXRlIGFuZCB0aW1lIHVzaW5nIGxpYmltb2JpbGVkZXZpY2UgaWRldmljZWRhdGUuICcgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJ0xpYmltb2JpbGVkZXZpY2UgaXMgcHJvYmFibHkgbm90IGluc3RhbGxlZCcpO1xuICAgIH1cbiAgICBsb2cuaW5mbyhgRm91bmQgaWRldmljZWRhdGU6ICcke2NtZH0nYCk7XG4gICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2xpYmltb2JpbGVkZXZpY2UvbGliaW1vYmlsZWRldmljZS9ibG9iLzI2MzczYjMzNDg4OWY1YWUyZTI3MzdmZjQ0N2ViMjViMTcwMGZhMmYvdG9vbHMvaWRldmljZWRhdGUuYyNMMTI5XG4gICAgYXJncyA9IFsnLXUnLCB0aGlzLm9wdHMudWRpZF07XG4gICAgaW5wdXRGb3JtYXQgPSAnZGRkIE1NTSBERCBISDptbTpzcyB6IFlZWVknO1xuICB9IGVsc2Uge1xuICAgIGxvZy53YXJuKCdPbiBzaW11bGF0b3IuIEFzc3VtaW5nIGRldmljZSB0aW1lIGlzIHRoZSBzYW1lIGFzIGhvc3QgdGltZScpO1xuICAgIGNtZCA9ICdkYXRlJztcbiAgICBhcmdzID0gWycrJVktJW0tJWRUJUg6JU06JVMleiddO1xuICAgIGlucHV0Rm9ybWF0ID0gJ1lZWVktTU0tRERUSEg6bW06c3NaWic7XG4gIH1cbiAgY29uc3Qgc3Rkb3V0ID0gKGF3YWl0IGV4ZWMoY21kLCBhcmdzKSkuc3Rkb3V0LnRyaW0oKTtcbiAgbG9nLmRlYnVnKGBHb3QgdGhlIGZvbGxvd2luZyBvdXRwdXQgb3V0IG9mICcke2NtZH0gJHthcmdzLmpvaW4oJyAnKX0nOiAke3N0ZG91dH1gKTtcbiAgY29uc3QgcGFyc2VkVGltZXN0YW1wID0gbW9tZW50LnV0YyhzdGRvdXQsIGlucHV0Rm9ybWF0KTtcbiAgaWYgKCFwYXJzZWRUaW1lc3RhbXAuaXNWYWxpZCgpKSB7XG4gICAgbG9nLndhcm4oYENhbm5vdCBwYXJzZSB0aGUgdGltZXN0YW1wICcke3N0ZG91dH0nIHJldHVybmVkIGJ5ICcke2NtZH0nIGNvbW1hbmQuIFJldHVybmluZyBpdCBhcyBpc2ApO1xuICAgIHJldHVybiBzdGRvdXQ7XG4gIH1cbiAgcmV0dXJuIHBhcnNlZFRpbWVzdGFtcC51dGNPZmZzZXQocGFyc2VkVGltZXN0YW1wLl90em0gfHwgMCkuZm9ybWF0KGZvcm1hdCk7XG59O1xuXG5jb21tYW5kcy5oaWRlS2V5Ym9hcmQgPSBhc3luYyBmdW5jdGlvbiBoaWRlS2V5Ym9hcmQgKHN0cmF0ZWd5LCAuLi5wb3NzaWJsZUtleXMpIHtcbiAgcG9zc2libGVLZXlzLnBvcCgpOyAvLyBsYXN0IHBhcmFtZXRlciBpcyB0aGUgc2Vzc2lvbiBpZFxuICBsZXQgY21kO1xuICBsZXQga2V5ID0gXy5maW5kKHBvc3NpYmxlS2V5cywgKGspID0+IHtyZXR1cm4gazt9KTtcbiAgaWYgKGtleSkge1xuICAgIHN0cmF0ZWd5ID0gc3RyYXRlZ3kgfHwgJ3ByZXNzS2V5JztcbiAgICBjbWQgPSBgYXUuaGlkZUtleWJvYXJkKCcke3N0cmF0ZWd5fScsICcke2tleX0nKWA7XG4gIH0gZWxzZSB7XG4gICAgc3RyYXRlZ3kgPSBzdHJhdGVneSB8fCAnZGVmYXVsdCc7XG4gICAgY21kID0gYGF1LmhpZGVLZXlib2FyZCgnJHtzdHJhdGVneX0nKWA7XG4gIH1cbiAgYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoY21kKTtcbn07XG5cbmNvbW1hbmRzLmdldFBhZ2VTb3VyY2UgPSBhc3luYyBmdW5jdGlvbiBnZXRQYWdlU291cmNlICgpIHtcbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICBjb25zdCBzY3JpcHQgPSAncmV0dXJuIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5vdXRlckhUTUwnO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdleGVjdXRlX3NjcmlwdCcsIFtzY3JpcHQsIFtdXSk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0TmF0aXZlUGFnZVNvdXJjZSgpO1xuICB9XG59O1xuXG5oZWxwZXJzLmdldE5hdGl2ZVBhZ2VTb3VyY2UgPSBhc3luYyBmdW5jdGlvbiBnZXROYXRpdmVQYWdlU291cmNlICgpIHtcbiAgbGV0IGpzb25Tb3VyY2UgPSBhd2FpdCB0aGlzLmdldFNvdXJjZUZvckVsZW1lbnRGb3JYTUwoKTtcbiAgaWYgKHR5cGVvZiBqc29uU291cmNlID09PSAnc3RyaW5nJykge1xuICAgIGpzb25Tb3VyY2UgPSBKU09OLnBhcnNlKGpzb25Tb3VyY2UpO1xuICB9XG4gIGxldCB4bWxTb3VyY2UgPSBqczJ4bWwoJ0FwcGl1bUFVVCcsIGpzb25Tb3VyY2UsIHtcbiAgICB3cmFwQXJyYXk6IHtlbmFibGVkOiBmYWxzZSwgZWxlbWVudE5hbWU6ICdlbGVtZW50J30sXG4gICAgZGVjbGFyYXRpb246IHtpbmNsdWRlOiB0cnVlfSxcbiAgICBwcmV0dHlQcmludGluZzoge2luZGVudFN0cmluZzogJyAgICAnfVxuICB9KTtcbiAgcmV0dXJuIHhtbFNvdXJjZTtcbn07XG5cbmNvbW1hbmRzLmJhY2tncm91bmQgPSBhc3luYyBmdW5jdGlvbiBiYWNrZ3JvdW5kIChzZWNzKSB7XG4gIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGBhdS5iYWNrZ3JvdW5kKCR7c2Vjc30pYCk7XG59O1xuXG5jb21tYW5kcy5sb2NrID0gYXN5bmMgZnVuY3Rpb24gbG9jayAoc2Vjcykge1xuICBpZiAoIXNlY3MpIHtcbiAgICBsb2cuZGVidWcoJ05vIHNlY29uZHMgcGFyYW1ldGVyLiBVc2luZyAwIHNlY29uZHMnKTtcbiAgICBzZWNzID0gMDtcbiAgfVxuICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChgYXUubG9jaygke3NlY3N9KWApO1xufTtcblxuY29tbWFuZHMuY2xvc2VBcHAgPSBhc3luYyBmdW5jdGlvbiBjbG9zZUFwcCAoKSB7XG4gIGxldCBhcHBOYW1lID0gdGhpcy5vcHRzLmFwcCB8fCB0aGlzLm9wdHMuYnVuZGxlSWQ7XG4gIHRyeSB7XG4gICAgYXdhaXQgdGhpcy5zdG9wKCk7XG4gICAgbG9nLmluZm8oYFN1Y2Nlc3NmdWxseSBjbG9zZWQgdGhlICcke2FwcE5hbWV9JyBhcHAuYCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy53YXJuKGBTb21ldGhpbmcgd2VudCB3cm9uZyB3aGlsZSBjbG9zaW5nIHRoZSAnJHthcHBOYW1lfScgYXBwLmApO1xuICAgIHRocm93IGVycjtcbiAgfVxufTtcblxuY29tbWFuZHMubGF1bmNoQXBwID0gYXN5bmMgZnVuY3Rpb24gbGF1bmNoQXBwICgpIHtcbiAgbGV0IGFwcE5hbWUgPSB0aGlzLm9wdHMuYXBwIHx8IHRoaXMub3B0cy5idW5kbGVJZDtcbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLnN0YXJ0KCk7XG4gICAgbG9nLmluZm8oYFN1Y2Nlc3NmdWxseSBsYXVuY2hlZCB0aGUgJyR7YXBwTmFtZX0nIGFwcC5gKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oYFNvbWV0aGluZyB3ZW50IHdyb25nIHdoaWxlIGxhdW5jaGluZyB0aGUgJyR7YXBwTmFtZX0nIGFwcC5gKTtcbiAgICB0aHJvdyBlcnI7XG4gIH1cbn07XG5cbmNvbW1hbmRzLnJlbW92ZUFwcCA9IGFzeW5jIGZ1bmN0aW9uIHJlbW92ZUFwcCAoYnVuZGxlSWQpIHtcbiAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICBhd2FpdCB0aGlzLnJlYWxEZXZpY2UucmVtb3ZlKGJ1bmRsZUlkKTtcbiAgfSBlbHNlIHtcbiAgICBhd2FpdCB0aGlzLnNpbS5yZW1vdmVBcHAoYnVuZGxlSWQpO1xuICB9XG59O1xuXG5jb21tYW5kcy5rZXlzID0gYXN5bmMgZnVuY3Rpb24ga2V5cyAoa2V5cykge1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIGxldCBlbCA9IGF3YWl0IHRoaXMuYWN0aXZlKCk7XG4gICAgaWYgKF8uaXNVbmRlZmluZWQoZWwuRUxFTUVOVCkpIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoRWxlbWVudEVycm9yKCk7XG4gICAgfVxuICAgIGF3YWl0IHRoaXMuc2V0VmFsdWUoa2V5cywgZWwuRUxFTUVOVCk7XG4gIH0gZWxzZSB7XG4gICAgaWYgKF8uaXNBcnJheShrZXlzKSkge1xuICAgICAga2V5cyA9IGtleXMuam9pbignJyk7XG4gICAgfVxuICAgIGlmICghXy5pc1N0cmluZyhrZXlzKSkge1xuICAgICAga2V5cyA9IGtleXMudG9TdHJpbmcoKTtcbiAgICB9XG4gICAga2V5cyA9IHV0aWwuZXNjYXBlU3BlY2lhbENoYXJzKGtleXMsIFwiJ1wiKTtcbiAgICBsZXQgY29tbWFuZCA9IGBhdS5zZW5kS2V5c1RvQWN0aXZlRWxlbWVudCgnJHtrZXlzfScpYDtcbiAgICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChjb21tYW5kKTtcbiAgfVxufTtcblxuY29tbWFuZHMuc2V0R2VvTG9jYXRpb24gPSBhc3luYyBmdW5jdGlvbiBzZXRHZW9Mb2NhdGlvbiAobG9jYXRpb24pIHtcbiAgLy8gVE9ETzogY2hlY2sgdGhlIGhhc09wdGlvbnMgYml0LCB0aGUgbWV0aG9kIHNpZ25hdHVyZSBzaG91bGQgYmUgbG9jYXRpb24sIG9wdGlvblxuXG4gIC8vIGxldCBoYXNPcHRpb25zID0gYWx0aXR1ZGUgIT09IG51bGwgfHwgaG9yaXpvbnRhbEFjY3VyYWN5ICE9PSBudWxsIHx8IHZlcnRpY2FsQWNjdXJhY3kgIT09IG51bGwgfHwgY291cnNlICE9PSBudWxsIHx8IHNwZWVkICE9PSBudWxsO1xuICAvLyBpZiAoaGFzT3B0aW9ucykge1xuICAvLyAgIGxldCBvcHRpb25zID0ge307XG4gIC8vICAgaWYgKGFsdGl0dWRlICE9PSBudWxsKSB7XG4gIC8vICAgICBvcHRpb25zLmFsdGl0dWRlID0gYWx0aXR1ZGU7XG4gIC8vICAgfVxuICAvLyAgIGlmIChob3Jpem9udGFsQWNjdXJhY3kgIT09IG51bGwpIHtcbiAgLy8gICAgIG9wdGlvbnMuaG9yaXpvbnRhbEFjY3VyYWN5ID0gaG9yaXpvbnRhbEFjY3VyYWN5O1xuICAvLyAgIH1cbiAgLy8gICBpZiAodmVydGljYWxBY2N1cmFjeSAhPT0gbnVsbCkge1xuICAvLyAgICAgb3B0aW9ucy52ZXJ0aWNhbEFjY3VyYWN5ID0gdmVydGljYWxBY2N1cmFjeTtcbiAgLy8gICB9XG4gIC8vICAgaWYgKGNvdXJzZSAhPT0gbnVsbCkge1xuICAvLyAgICAgb3B0aW9ucy5jb3Vyc2UgPSBjb3Vyc2U7XG4gIC8vICAgfVxuICAvLyAgIGlmIChzcGVlZCAhPT0gbnVsbCkge1xuICAvLyAgICAgb3B0aW9ucy5zcGVlZCA9IHNwZWVkO1xuICAvLyAgIH1cbiAgLy8gICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChcbiAgLy8gICAgIGB0YXJnZXQuc2V0TG9jYXRpb25XaXRoT3B0aW9ucygke0pTT04uc3RyaW5naWZ5KGNvb3JkaW5hdGVzKX0sICR7SlNPTi5zdHJpbmdpZnkob3B0aW9ucyl9KWApO1xuICAvLyB9IGVsc2Uge1xuICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChgdGFyZ2V0LnNldExvY2F0aW9uKCR7SlNPTi5zdHJpbmdpZnkobG9jYXRpb24pfSlgKTtcbiAgLy8gfVxufTtcblxuY29tbWFuZHMuZ2V0V2luZG93U2l6ZSA9IGFzeW5jIGZ1bmN0aW9uIGdldFdpbmRvd1NpemUgKHdpbmRvd0hhbmRsZSA9ICdjdXJyZW50Jykge1xuICBpZiAod2luZG93SGFuZGxlICE9PSAnY3VycmVudCcpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdFlldEltcGxlbWVudGVkRXJyb3IoJ0N1cnJlbnRseSBvbmx5IGdldHRpbmcgY3VycmVudCB3aW5kb3cgc2l6ZSBpcyBzdXBwb3J0ZWQuJyk7XG4gIH1cblxuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdnZXRfd2luZG93X3NpemUnLCBbXSk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKCdhdS5nZXRXaW5kb3dTaXplKCknKTtcbiAgfVxufTtcblxuLy8gRm9yIFczQ1xuY29tbWFuZHMuZ2V0V2luZG93UmVjdCA9IGFzeW5jIGZ1bmN0aW9uIGdldFdpbmRvd1JlY3QgKCkge1xuICBjb25zdCB7d2lkdGgsIGhlaWdodH0gPSBhd2FpdCB0aGlzLmdldFdpbmRvd1NpemUoKTtcbiAgcmV0dXJuIHtcbiAgICB3aWR0aCxcbiAgICBoZWlnaHQsXG4gICAgeDogMCxcbiAgICB5OiAwXG4gIH07XG59O1xuXG5jb21tYW5kcy5nZXRTdHJpbmdzID0gYXN5bmMgZnVuY3Rpb24gZ2V0U3RyaW5ncyAobGFuZ3VhZ2UsIHN0cmluZ0ZpbGUgPSBudWxsKSB7XG4gIGxvZy5kZWJ1ZyhgR2V0dGluZ3Mgc3RyaW5ncyBmb3IgbGFuZ3VhZ2UgJyR7bGFuZ3VhZ2V9JyBhbmQgc3RyaW5nIGZpbGUgJyR7c3RyaW5nRmlsZX0nYCk7XG4gIHJldHVybiBhd2FpdCB1dGlscy5wYXJzZUxvY2FsaXphYmxlU3RyaW5ncyhPYmplY3QuYXNzaWduKHt9LCB0aGlzLm9wdHMsIHtcbiAgICBsYW5ndWFnZSxcbiAgICBzdHJpbmdGaWxlLFxuICAgIHN0cmljdE1vZGU6IHRydWUsXG4gIH0pKTtcbn07XG5cbmNvbW1hbmRzLnNldFVybCA9IGFzeW5jIGZ1bmN0aW9uIHNldFVybCAodXJsKSB7XG4gIGxvZy5kZWJ1ZyhgQXR0ZW1wdGluZyB0byBzZXQgdXJsICcke3VybH0nYCk7XG4gIGlmICghdGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIC8vIHVzZSB4Y3J1biB0byBvcGVuIGRlZXBsaW5rXG4gICAgYXdhaXQgb3BlblVybCh0aGlzLm9wdHMudWRpZCB8fCB0aGlzLnNpbS51ZGlkLCB1cmwpO1xuICAgIHJldHVybjtcbiAgfVxuICB0aGlzLnNldEN1cnJlbnRVcmwodXJsKTtcbiAgLy8gbWFrZSBzdXJlIHRvIGNsZWFyIG91dCBhbnkgbGVmdG92ZXIgd2ViIGZyYW1lc1xuICB0aGlzLmN1cldlYkZyYW1lcyA9IFtdO1xuICBhd2FpdCB0aGlzLnJlbW90ZS5uYXZUb1VybCh1cmwpO1xufTtcblxuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcbmV4cG9ydCB7IGNvbW1hbmRzLCBoZWxwZXJzIH07XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sImZpbGUiOiJsaWIvY29tbWFuZHMvZ2VuZXJhbC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
