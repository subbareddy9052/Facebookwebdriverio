"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.DEFAULT_WAD_PORT = exports.DEFAULT_WAD_HOST = exports.WinAppDriver = void 0;

require("source-map-support/register");

var _events = _interopRequireDefault(require("events"));

var _appiumBaseDriver = require("appium-base-driver");

var _logger = _interopRequireDefault(require("./logger"));

var _teen_process = require("teen_process");

var _installer = require("./installer");

var _asyncbox = require("asyncbox");

var _child_process = _interopRequireDefault(require("child_process"));

var _bluebird = _interopRequireDefault(require("bluebird"));

const REQUIRED_PARAMS = [];
const DEFAULT_WAD_HOST = '127.0.0.1';
exports.DEFAULT_WAD_HOST = DEFAULT_WAD_HOST;
const DEFAULT_WAD_PORT = 4724;
exports.DEFAULT_WAD_PORT = DEFAULT_WAD_PORT;
const DEFAULT_CREATE_SESSION_TIMEOUT_MS = 20000;

class WinAppDriver extends _events.default.EventEmitter {
  constructor(opts = {}) {
    const {
      host,
      port,
      createSessionTimeout
    } = opts;
    super();

    for (let req of REQUIRED_PARAMS) {
      if (!opts || !opts[req]) {
        throw new Error(`Option '${req}' is required!`);
      }

      this[req] = opts[req];
    }

    this.proxyHost = host || DEFAULT_WAD_HOST;
    this.proxyPort = port || DEFAULT_WAD_PORT;
    this.createSessionTimeout = createSessionTimeout || DEFAULT_CREATE_SESSION_TIMEOUT_MS;
    this.proc = null;
    this.state = WinAppDriver.STATE_STOPPED;
    this.jwproxy = new _appiumBaseDriver.JWProxy({
      server: this.proxyHost,
      port: this.proxyPort
    });
  }

  async start() {
    if (!(await (0, _installer.verifyWAD)())) {
      throw new Error('Could not verify WinAppDriver install; re-run install');
    }

    this.changeState(WinAppDriver.STATE_STARTING);
    let args = [this.proxyPort + '/wd/hub'];

    const startDetector = stdout => {
      return stdout.indexOf('listening for requests') !== -1;
    };

    let processIsAlive = false;

    try {
      await this.killAll();
      this.proc = new _teen_process.SubProcess(_installer.WAD_INSTALL_PATH, args, {
        encoding: 'ucs2'
      });
      processIsAlive = true;

      for (let stream of ['STDOUT', 'STDERR']) {
        this.proc.on(`lines-${stream.toLowerCase()}`, lines => {
          for (let l of lines) {
            _logger.default.info(`[${stream}] ${l.trim()}`);
          }
        });
      }

      this.proc.on('exit', (code, signal) => {
        processIsAlive = false;

        if (this.state !== WinAppDriver.STATE_STOPPED && this.state !== WinAppDriver.STATE_STOPPING) {
          let msg = `WinAppDriver exited unexpectedly with code ${code}, ` + `signal ${signal}`;

          _logger.default.error(msg);

          this.changeState(WinAppDriver.STATE_STOPPED);
        }
      });

      _logger.default.info(`Spawning WinAppDriver with: ${args.join(' ')}`);

      await this.proc.start(startDetector);
      await this.waitForOnline();
    } catch (e) {
      this.emit(WinAppDriver.EVENT_ERROR, e);

      if (processIsAlive) {
        await this.proc.stop();
      }

      _logger.default.errorAndThrow(e);
    }
  }

  sessionId() {
    if (this.state !== WinAppDriver.STATE_ONLINE) {
      return null;
    }

    return this.jwproxy.sessionId;
  }

  async waitForOnline() {
    let winappdriverStopped = false;
    await (0, _asyncbox.retryInterval)(20, 200, async () => {
      if ([WinAppDriver.STATE_STOPPED, WinAppDriver.STATE_ONLINE].indexOf(this.state) >= 0) {
        winappdriverStopped = this.state === WinAppDriver.STATE_STOPPED;
        return;
      }

      if (await this.getStatus()) {
        this.changeState(WinAppDriver.STATE_ONLINE);
      }
    });

    if (winappdriverStopped) {
      throw new Error('WinAppDriver crashed during startup.');
    }
  }

  async getStatus() {
    const resBlock = await this.jwproxy.proxy('/status', 'GET');

    if (resBlock[0].statusCode === 200) {
      _logger.default.info(`Status call returned 200. we're online and ready to run tests`);

      return true;
    }

    return false;
  }

  async startSession(caps) {
    const createSessionTimeout = caps.createSessionTimeout || this.createSessionTimeout;

    _logger.default.debug(`Starting WinAppDriver session. Will timeout in '${createSessionTimeout}' ms.`);

    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
    let retryIteration = 0;
    let lastError;

    const condFn = async () => {
      lastError = null;

      try {
        retryIteration++;
        await this.jwproxy.command('/session', 'POST', {
          desiredCapabilities: caps
        });
        return true;
      } catch (error) {
        lastError = error;

        _logger.default.warn(`Could not start WinAppDriver session error = '${error.message}', attempt = '${retryIteration}' from '${this.createSessionRetry}'`);

        return false;
      }
    };

    try {
      await (0, _asyncbox.waitForCondition)(condFn, {
        waitMs: createSessionTimeout,
        intervalMs: 500
      });
    } catch (timeoutError) {
      _logger.default.debug(`timeoutError was ${timeoutError.message}`);

      if (lastError) {
        throw lastError;
      }

      throw new Error(`Could not start WinAppDriver session within ${createSessionTimeout} ms.`);
    }
  }

  async stop(emitStates = true) {
    if (emitStates) {
      this.changeState(WinAppDriver.STATE_STOPPING);
    }

    try {
      if (this.proc) {
        await this.proc.stop();
      }

      if (emitStates) {
        this.changeState(WinAppDriver.STATE_STOPPED);
      }
    } catch (e) {
      _logger.default.error(e);
    }
  }

  changeState(state) {
    this.state = state;

    _logger.default.debug(`WinAppDriver changed state to '${state}'`);

    this.emit(WinAppDriver.EVENT_CHANGED, {
      state
    });
  }

  async sendCommand(url, method, body) {
    return await this.jwproxy.command(url, method, body);
  }

  async proxyReq(req, res) {
    return await this.jwproxy.proxyReqRes(req, res);
  }

  async killAll() {
    let cmd;
    cmd = 'FOR /F "usebackq tokens=5" %a in (`netstat -nao ^| ' + 'findstr /R /C:"' + this.proxyPort + ' "`) do (' + 'FOR /F "usebackq" %b in (`TASKLIST /FI "PID eq %a" ^| ' + 'findstr /I winappdriver.exe`) do (IF NOT %b=="" TASKKILL ' + '/F /PID %a))';

    _logger.default.info(`Killing any old WinAppDrivers on same port, running: ${cmd}`);

    try {
      await _bluebird.default.promisify(_child_process.default.exec)(cmd);

      _logger.default.info('Successfully cleaned up old WinAppDrivers');
    } catch (err) {
      _logger.default.info('No old WinAppDrivers seemed to exist');
    }
  }

  async deleteSession() {
    _logger.default.debug('Deleting WinAppDriver server session');

    try {
      await this.jwproxy.command('/', 'DELETE');
    } catch (err) {
      _logger.default.warn(`Did not get confirmation WinAppDriver deleteSession worked; ` + `Error was: ${err}`);
    }
  }

}

exports.WinAppDriver = WinAppDriver;
WinAppDriver.EVENT_ERROR = 'winappdriver_error';
WinAppDriver.EVENT_CHANGED = 'stateChanged';
WinAppDriver.STATE_STOPPED = 'stopped';
WinAppDriver.STATE_STARTING = 'starting';
WinAppDriver.STATE_ONLINE = 'online';
WinAppDriver.STATE_STOPPING = 'stopping';
var _default = WinAppDriver;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93aW5hcHBkcml2ZXIuanMiXSwibmFtZXMiOlsiUkVRVUlSRURfUEFSQU1TIiwiREVGQVVMVF9XQURfSE9TVCIsIkRFRkFVTFRfV0FEX1BPUlQiLCJERUZBVUxUX0NSRUFURV9TRVNTSU9OX1RJTUVPVVRfTVMiLCJXaW5BcHBEcml2ZXIiLCJldmVudHMiLCJFdmVudEVtaXR0ZXIiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJob3N0IiwicG9ydCIsImNyZWF0ZVNlc3Npb25UaW1lb3V0IiwicmVxIiwiRXJyb3IiLCJwcm94eUhvc3QiLCJwcm94eVBvcnQiLCJwcm9jIiwic3RhdGUiLCJTVEFURV9TVE9QUEVEIiwiandwcm94eSIsIkpXUHJveHkiLCJzZXJ2ZXIiLCJzdGFydCIsImNoYW5nZVN0YXRlIiwiU1RBVEVfU1RBUlRJTkciLCJhcmdzIiwic3RhcnREZXRlY3RvciIsInN0ZG91dCIsImluZGV4T2YiLCJwcm9jZXNzSXNBbGl2ZSIsImtpbGxBbGwiLCJTdWJQcm9jZXNzIiwiV0FEX0lOU1RBTExfUEFUSCIsImVuY29kaW5nIiwic3RyZWFtIiwib24iLCJ0b0xvd2VyQ2FzZSIsImxpbmVzIiwibCIsImxvZyIsImluZm8iLCJ0cmltIiwiY29kZSIsInNpZ25hbCIsIlNUQVRFX1NUT1BQSU5HIiwibXNnIiwiZXJyb3IiLCJqb2luIiwid2FpdEZvck9ubGluZSIsImUiLCJlbWl0IiwiRVZFTlRfRVJST1IiLCJzdG9wIiwiZXJyb3JBbmRUaHJvdyIsInNlc3Npb25JZCIsIlNUQVRFX09OTElORSIsIndpbmFwcGRyaXZlclN0b3BwZWQiLCJnZXRTdGF0dXMiLCJyZXNCbG9jayIsInByb3h5Iiwic3RhdHVzQ29kZSIsInN0YXJ0U2Vzc2lvbiIsImNhcHMiLCJkZWJ1ZyIsInByb3h5UmVxUmVzIiwiYmluZCIsInJldHJ5SXRlcmF0aW9uIiwibGFzdEVycm9yIiwiY29uZEZuIiwiY29tbWFuZCIsImRlc2lyZWRDYXBhYmlsaXRpZXMiLCJ3YXJuIiwibWVzc2FnZSIsImNyZWF0ZVNlc3Npb25SZXRyeSIsIndhaXRNcyIsImludGVydmFsTXMiLCJ0aW1lb3V0RXJyb3IiLCJlbWl0U3RhdGVzIiwiRVZFTlRfQ0hBTkdFRCIsInNlbmRDb21tYW5kIiwidXJsIiwibWV0aG9kIiwiYm9keSIsInByb3h5UmVxIiwicmVzIiwiY21kIiwiQiIsInByb21pc2lmeSIsImNwIiwiZXhlYyIsImVyciIsImRlbGV0ZVNlc3Npb24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsZUFBZSxHQUFHLEVBQXhCO0FBQ0EsTUFBTUMsZ0JBQWdCLEdBQUcsV0FBekI7O0FBQ0EsTUFBTUMsZ0JBQWdCLEdBQUcsSUFBekI7O0FBQ0EsTUFBTUMsaUNBQWlDLEdBQUcsS0FBMUM7O0FBRUEsTUFBTUMsWUFBTixTQUEyQkMsZ0JBQU9DLFlBQWxDLENBQStDO0FBQzdDQyxFQUFBQSxXQUFXLENBQUVDLElBQUksR0FBRyxFQUFULEVBQWE7QUFDdEIsVUFBTTtBQUFDQyxNQUFBQSxJQUFEO0FBQU9DLE1BQUFBLElBQVA7QUFBYUMsTUFBQUE7QUFBYixRQUFxQ0gsSUFBM0M7QUFDQTs7QUFFQSxTQUFLLElBQUlJLEdBQVQsSUFBZ0JaLGVBQWhCLEVBQWlDO0FBQy9CLFVBQUksQ0FBQ1EsSUFBRCxJQUFTLENBQUNBLElBQUksQ0FBQ0ksR0FBRCxDQUFsQixFQUF5QjtBQUN2QixjQUFNLElBQUlDLEtBQUosQ0FBVyxXQUFVRCxHQUFJLGdCQUF6QixDQUFOO0FBQ0Q7O0FBQ0QsV0FBS0EsR0FBTCxJQUFZSixJQUFJLENBQUNJLEdBQUQsQ0FBaEI7QUFDRDs7QUFFRCxTQUFLRSxTQUFMLEdBQWlCTCxJQUFJLElBQUlSLGdCQUF6QjtBQUNBLFNBQUtjLFNBQUwsR0FBaUJMLElBQUksSUFBSVIsZ0JBQXpCO0FBQ0EsU0FBS1Msb0JBQUwsR0FBNEJBLG9CQUFvQixJQUFJUixpQ0FBcEQ7QUFDQSxTQUFLYSxJ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QU47O0FBQ0E5QyxzQkFBSUMsSUFBSixDQUFTLDJDQUFUO0FBQ0QsS0FKRCxDQUlFLE9BQU9rRCxHQUFQLEVBQVk7QUFDWm5ELHNCQUFJQyxJQUFKLENBQVMsc0NBQVQ7QUFDRDtBQUNGOztBQUVELFFBQU1tRCxhQUFOLEdBQXVCO0FBQ3JCcEQsb0JBQUl3QixLQUFKLENBQVUsc0NBQVY7O0FBR0EsUUFBSTtBQUNGLFlBQU0sS0FBSzVDLE9BQUwsQ0FBYWtELE9BQWIsQ0FBcUIsR0FBckIsRUFBMEIsUUFBMUIsQ0FBTjtBQUNELEtBRkQsQ0FFRSxPQUFPcUIsR0FBUCxFQUFZO0FBQ1puRCxzQkFBSWdDLElBQUosQ0FBVSw4REFBRCxHQUNOLGNBQWFtQixHQUFJLEVBRHBCO0FBRUQ7QUFDRjs7QUFwTjRDOzs7QUF1Ti9DdEYsWUFBWSxDQUFDK0MsV0FBYixHQUEyQixvQkFBM0I7QUFDQS9DLFlBQVksQ0FBQzBFLGFBQWIsR0FBNkIsY0FBN0I7QUFDQTFFLFlBQVksQ0FBQ2MsYUFBYixHQUE2QixTQUE3QjtBQUNBZCxZQUFZLENBQUNvQixjQUFiLEdBQThCLFVBQTlCO0FBQ0FwQixZQUFZLENBQUNtRCxZQUFiLEdBQTRCLFFBQTVCO0FBQ0FuRCxZQUFZLENBQUN3QyxjQUFiLEdBQThCLFVBQTlCO2VBR2V4QyxZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGV2ZW50cyBmcm9tICdldmVudHMnO1xuaW1wb3J0IHsgSldQcm94eSB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IFN1YlByb2Nlc3MgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHsgV0FEX0lOU1RBTExfUEFUSCwgdmVyaWZ5V0FEIH0gZnJvbSAnLi9pbnN0YWxsZXInO1xuaW1wb3J0IHsgcmV0cnlJbnRlcnZhbCwgd2FpdEZvckNvbmRpdGlvbiB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCBjcCBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcblxuY29uc3QgUkVRVUlSRURfUEFSQU1TID0gW107IC8vIFhYWUQgMS01LTIwMTg6IHJlbW92ZWQgYXBwIGZyb20gcmVxdWlyZWQgcGFyYW1zIGJlY2F1c2UgeW91IGNhbiBhbHRlcm5hdGl2ZWx5IHVzZSBhcHBUb3BMZXZlbFdpbmRvd1xuY29uc3QgREVGQVVMVF9XQURfSE9TVCA9ICcxMjcuMC4wLjEnO1xuY29uc3QgREVGQVVMVF9XQURfUE9SVCA9IDQ3MjQ7IC8vIHNob3VsZCBiZSBub24tNDcyMyB0byBhdm9pZCBjb25mbGljdCBvbiB0aGUgc2FtZSBib3g7XG5jb25zdCBERUZBVUxUX0NSRUFURV9TRVNTSU9OX1RJTUVPVVRfTVMgPSAyMDAwMDsgLy8gcmV0cnkgc3RhcnQgc2Vzc2lvbiBjcmVhdGlvbiBkdXJpbmcgdGhlIHRpbWVvdXQgaW4gbWlsbGlzZWNvbmRzXG5cbmNsYXNzIFdpbkFwcERyaXZlciBleHRlbmRzIGV2ZW50cy5FdmVudEVtaXR0ZXIge1xuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7XG4gICAgY29uc3Qge2hvc3QsIHBvcnQsIGNyZWF0ZVNlc3Npb25UaW1lb3V0fSA9IG9wdHM7XG4gICAgc3VwZXIoKTtcblxuICAgIGZvciAobGV0IHJlcSBvZiBSRVFVSVJFRF9QQVJBTVMpIHtcbiAgICAgIGlmICghb3B0cyB8fCAhb3B0c1tyZXFdKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgT3B0aW9uICcke3JlcX0nIGlzIHJlcXVpcmVkIWApO1xuICAgICAgfVxuICAgICAgdGhpc1tyZXFdID0gb3B0c1tyZXFdO1xuICAgIH1cblxuICAgIHRoaXMucHJveHlIb3N0ID0gaG9zdCB8fCBERUZBVUxUX1dBRF9IT1NUO1xuICAgIHRoaXMucHJveHlQb3J0ID0gcG9ydCB8fCBERUZBVUxUX1dBRF9QT1JUO1xuICAgIHRoaXMuY3JlYXRlU2Vzc2lvblRpbWVvdXQgPSBjcmVhdGVTZXNzaW9uVGltZW91dCB8fCBERUZBVUxUX0NSRUFURV9TRVNTSU9OX1RJTUVPVVRfTVM7XG4gICAgdGhpcy5wcm9jID0gbnVsbDtcbiAgICB0aGlzLnN0YXRlID0gV2luQXBwRHJpdmVyLlNUQVRFX1NUT1BQRUQ7XG4gICAgdGhpcy5qd3Byb3h5ID0gbmV3IEpXUHJveHkoe3NlcnZlcjogdGhpcy5wcm94eUhvc3QsIHBvcnQ6IHRoaXMucHJveHlQb3J0fSk7XG4gIH1cblxuICBhc3luYyBzdGFydCAoKSB7XG4gICAgaWYgKCFhd2FpdCB2ZXJpZnlXQUQoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb3VsZCBub3QgdmVyaWZ5IFdpbkFwcERyaXZlciBpbnN0YWxsOyByZS1ydW4gaW5zdGFsbCcpO1xuICAgIH1cblxuICAgIHRoaXMuY2hhbmdlU3RhdGUoV2luQXBwRHJpdmVyLlNUQVRFX1NUQVJUSU5HKTtcblxuICAgIC8vIFhYWFlEIFRPRE86IHdvdWxkIGJlIGJldHRlciBpZiBXaW5BcHBEcml2ZXIgZGlkbid0IHJlcXVpcmUgcGFzc2luZyBpbiAvd2QvaHViIGFzIGEgcGFyYW1cbiAgICBsZXQgYXJncyA9IFt0aGlzLnByb3h5UG9ydCArICcvd2QvaHViJ107XG5cbiAgICBjb25zdCBzdGFydERldGVjdG9yID0gKHN0ZG91dCkgPT4ge1xuICAgICAgcmV0dXJuIHN0ZG91dC5pbmRleE9mKCdsaXN0ZW5pbmcgZm9yIHJlcXVlc3RzJykgIT09IC0xO1xuICAgIH07XG5cbiAgICBsZXQgcHJvY2Vzc0lzQWxpdmUgPSBmYWxzZTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5raWxsQWxsKCk7XG5cbiAgICAgIC8vIHNldCB1cCBvdXIgc3VicHJvY2VzcyBvYmplY3RcbiAgICAgIHRoaXMucHJvYyA9IG5ldyBTdWJQcm9jZXNzKFdBRF9JTlNUQUxMX1BBVEgsIGFyZ3MsIHtcbiAgICAgICAgZW5jb2Rpbmc6ICd1Y3MyJ1xuICAgICAgfSk7XG4gICAgICBwcm9jZXNzSXNBbGl2ZSA9IHRydWU7XG5cbiAgICAgIC8vIGhhbmRsZSBsb2cgb3V0cHV0XG4gICAgICBmb3IgKGxldCBzdHJlYW0gb2YgWydTVERPVVQnLCAnU1RERVJSJ10pIHtcbiAgICAgICAgdGhpcy5wcm9jLm9uKGBsaW5lcy0ke3N0cmVhbS50b0xvd2VyQ2FzZSgpfWAsIChsaW5lcykgPT4ge1xuICAgICAgICAgIGZvciAobGV0IGwgb2YgbGluZXMpIHtcbiAgICAgICAgICAgIGxvZy5pbmZvKGBbJHtzdHJlYW19XSAke2wudHJpbSgpfWApO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIGhhbmRsZSBvdXQtb2YtYm91bmQgZXhpdCBieSBzaW1wbHkgZW1pdHRpbmcgYSBzdG9wcGVkIHN0YXRlXG4gICAgICB0aGlzLnByb2Mub24oJ2V4aXQnLCAoY29kZSwgc2lnbmFsKSA9PiB7XG4gICAgICAgIHByb2Nlc3NJc0FsaXZlID0gZmFsc2U7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSBXaW5BcHBEcml2ZXIuU1RBVEVfU1RPUFBFRCAmJlxuICAgICAgICAgICAgdGhpcy5zdGF0ZSAhPT0gV2luQXBwRHJpdmVyLlNUQVRFX1NUT1BQSU5HKSB7XG4gICAgICAgICAgbGV0IG1zZyA9IGBXaW5BcHBEcml2ZXIgZXhpdGVkIHVuZXhwZWN0ZWRseSB3aXRoIGNvZGUgJHtjb2RlfSwgYCArXG4gICAgICAgICAgICAgICAgICAgIGBzaWduYWwgJHtzaWduYWx9YDtcbiAgICAgICAgICBsb2cuZXJyb3IobXNnKTtcbiAgICAgICAgICB0aGlzLmNoYW5nZVN0YXRlKFdpbkFwcERyaXZlci5TVEFURV9TVE9QUEVEKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICBsb2cuaW5mbyhgU3Bhd25pbmcgV2luQXBwRHJpdmVyIHdpdGg6ICR7YXJncy5qb2luKCcgJyl9YCk7XG5cbiAgICAgIC8vIHN0YXJ0IHN1YnByb2MgYW5kIHdhaXQgZm9yIHN0YXJ0RGV0ZWN0b3JcbiAgICAgIGF3YWl0IHRoaXMucHJvYy5zdGFydChzdGFydERldGVjdG9yKTtcbiAgICAgIGF3YWl0IHRoaXMud2FpdEZvck9ubGluZSgpO1xuXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhpcy5lbWl0KFdpbkFwcERyaXZlci5FVkVOVF9FUlJPUiwgZSk7XG4gICAgICAvLyBqdXN0IGJlY2F1c2Ugd2UgaGFkIGFuIGVycm9yIGRvZXNuJ3QgbWVhbiB0aGUgV2luQXBwRHJpdmVyIHByb2Nlc3NcbiAgICAgIC8vIGZpbmlzaGVkOyB3ZSBzaG91bGQgY2xlYW4gdXAgaWYgbmVjZXNzYXJ5XG4gICAgICBpZiAocHJvY2Vzc0lzQWxpdmUpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5wcm9jLnN0b3AoKTtcbiAgICAgIH1cbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGUpO1xuICAgIH1cbiAgfVxuXG4gIHNlc3Npb25JZCAoKSB7XG4gICAgaWYgKHRoaXMuc3RhdGUgIT09IFdpbkFwcERyaXZlci5TVEFURV9PTkxJTkUpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmp3cHJveHkuc2Vzc2lvbklkO1xuICB9XG5cbiAgYXN5bmMgd2FpdEZvck9ubGluZSAoKSB7XG5cbiAgICAvLyB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSBXQUQgaGFzbid0IGNyYXNoZWRcbiAgICBsZXQgd2luYXBwZHJpdmVyU3RvcHBlZCA9IGZhbHNlO1xuICAgIGF3YWl0IHJldHJ5SW50ZXJ2YWwoMjAsIDIwMCwgYXN5bmMgKCkgPT4ge1xuICAgICAgaWYgKFtXaW5BcHBEcml2ZXIuU1RBVEVfU1RPUFBFRCwgV2luQXBwRHJpdmVyLlNUQVRFX09OTElORV0uaW5kZXhPZih0aGlzLnN0YXRlKSA+PSAwKSB7XG4gICAgICAgIC8vIHdlIGFyZSBlaXRoZXIgc3RvcHBlZCwgc3RvcHBpbmcsIG9yIHdlJ3JlIG9ubGluZVxuICAgICAgICB3aW5hcHBkcml2ZXJTdG9wcGVkID0gdGhpcy5zdGF0ZSA9PT0gV2luQXBwRHJpdmVyLlNUQVRFX1NUT1BQRUQ7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgaWYgKGF3YWl0IHRoaXMuZ2V0U3RhdHVzKCkpIHtcbiAgICAgICAgdGhpcy5jaGFuZ2VTdGF0ZShXaW5BcHBEcml2ZXIuU1RBVEVfT05MSU5FKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGlmICh3aW5hcHBkcml2ZXJTdG9wcGVkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1dpbkFwcERyaXZlciBjcmFzaGVkIGR1cmluZyBzdGFydHVwLicpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldFN0YXR1cyAoKSB7XG4gICAgY29uc3QgcmVzQmxvY2sgPSBhd2FpdCB0aGlzLmp3cHJveHkucHJveHkoJy9zdGF0dXMnLCAnR0VUJyk7XG4gICAgaWYgKHJlc0Jsb2NrWzBdLnN0YXR1c0NvZGUgPT09IDIwMCkge1xuICAgICAgbG9nLmluZm8oYFN0YXR1cyBjYWxsIHJldHVybmVkIDIwMC4gd2UncmUgb25saW5lIGFuZCByZWFkeSB0byBydW4gdGVzdHNgKTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBhc3luYyBzdGFydFNlc3Npb24gKGNhcHMpIHtcblxuICAgIGNvbnN0IGNyZWF0ZVNlc3Npb25UaW1lb3V0ID0gY2Fwcy5jcmVhdGVTZXNzaW9uVGltZW91dCB8fCB0aGlzLmNyZWF0ZVNlc3Npb25UaW1lb3V0O1xuICAgIGxvZy5kZWJ1ZyhgU3RhcnRpbmcgV2luQXBwRHJpdmVyIHNlc3Npb24uIFdpbGwgdGltZW91dCBpbiAnJHtjcmVhdGVTZXNzaW9uVGltZW91dH0nIG1zLmApO1xuICAgIHRoaXMucHJveHlSZXFSZXMgPSB0aGlzLmp3cHJveHkucHJveHlSZXFSZXMuYmluZCh0aGlzLmp3cHJveHkpO1xuICAgIGxldCByZXRyeUl0ZXJhdGlvbiA9IDA7XG4gICAgbGV0IGxhc3RFcnJvcjtcblxuICAgIGNvbnN0IGNvbmRGbiA9IGFzeW5jICgpID0+IHtcbiAgICAgIGxhc3RFcnJvciA9IG51bGw7XG4gICAgICB0cnkge1xuICAgICAgICByZXRyeUl0ZXJhdGlvbisrO1xuICAgICAgICBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCgnL3Nlc3Npb24nLCAnUE9TVCcsIHtkZXNpcmVkQ2FwYWJpbGl0aWVzOiBjYXBzfSk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgbGFzdEVycm9yID0gZXJyb3I7XG4gICAgICAgIGxvZy53YXJuKGBDb3VsZCBub3Qgc3RhcnQgV2luQXBwRHJpdmVyIHNlc3Npb24gZXJyb3IgPSAnJHtlcnJvci5tZXNzYWdlfScsIGF0dGVtcHQgPSAnJHtyZXRyeUl0ZXJhdGlvbn0nIGZyb20gJyR7dGhpcy5jcmVhdGVTZXNzaW9uUmV0cnl9J2ApO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfTtcblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKGNvbmRGbiwge1xuICAgICAgICB3YWl0TXM6IGNyZWF0ZVNlc3Npb25UaW1lb3V0LFxuICAgICAgICBpbnRlcnZhbE1zOiA1MDBcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKHRpbWVvdXRFcnJvcikge1xuICAgICAgbG9nLmRlYnVnKGB0aW1lb3V0RXJyb3Igd2FzICR7dGltZW91dEVycm9yLm1lc3NhZ2V9YCk7XG4gICAgICBpZiAobGFzdEVycm9yKSB7XG4gICAgICAgIHRocm93IChsYXN0RXJyb3IpO1xuICAgICAgfVxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3Qgc3RhcnQgV2luQXBwRHJpdmVyIHNlc3Npb24gd2l0aGluICR7Y3JlYXRlU2Vzc2lvblRpbWVvdXR9IG1zLmApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHN0b3AgKGVtaXRTdGF0ZXMgPSB0cnVlKSB7XG4gICAgaWYgKGVtaXRTdGF0ZXMpIHtcbiAgICAgIHRoaXMuY2hhbmdlU3RhdGUoV2luQXBwRHJpdmVyLlNUQVRFX1NUT1BQSU5HKTtcbiAgICB9XG4gICAgdHJ5IHtcbiAgICAgIGlmICh0aGlzLnByb2MpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5wcm9jLnN0b3AoKTtcbiAgICAgIH1cbiAgICAgIGlmIChlbWl0U3RhdGVzKSB7XG4gICAgICAgIHRoaXMuY2hhbmdlU3RhdGUoV2luQXBwRHJpdmVyLlNUQVRFX1NUT1BQRUQpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGxvZy5lcnJvcihlKTtcbiAgICB9XG4gIH1cblxuICBjaGFuZ2VTdGF0ZSAoc3RhdGUpIHtcbiAgICB0aGlzLnN0YXRlID0gc3RhdGU7XG4gICAgbG9nLmRlYnVnKGBXaW5BcHBEcml2ZXIgY2hhbmdlZCBzdGF0ZSB0byAnJHtzdGF0ZX0nYCk7XG4gICAgdGhpcy5lbWl0KFdpbkFwcERyaXZlci5FVkVOVF9DSEFOR0VELCB7c3RhdGV9KTtcbiAgfVxuXG4gIGFzeW5jIHNlbmRDb21tYW5kICh1cmwsIG1ldGhvZCwgYm9keSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCh1cmwsIG1ldGhvZCwgYm9keSk7XG4gIH1cblxuICBhc3luYyBwcm94eVJlcSAocmVxLCByZXMpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5qd3Byb3h5LnByb3h5UmVxUmVzKHJlcSwgcmVzKTtcbiAgfVxuXG4gIGFzeW5jIGtpbGxBbGwgKCkge1xuICAgIGxldCBjbWQ7XG4gICAgLy8ganMgaGludCBjYW5ub3QgaGFuZGxlIGJhY2t0aWNrcywgZXZlbiBlc2NhcGVkLCB3aXRoaW4gdGVtcGxhdGUgbGl0ZXJhbHNcbiAgICBjbWQgPSAnRk9SIC9GIFwidXNlYmFja3EgdG9rZW5zPTVcIiAlYSBpbiAoYG5ldHN0YXQgLW5hbyBefCAnICtcbiAgICAgICAgICAnZmluZHN0ciAvUiAvQzpcIicgKyB0aGlzLnByb3h5UG9ydCArICcgXCJgKSBkbyAoJyArXG4gICAgICAgICAgJ0ZPUiAvRiBcInVzZWJhY2txXCIgJWIgaW4gKGBUQVNLTElTVCAvRkkgXCJQSUQgZXEgJWFcIiBefCAnICtcbiAgICAgICAgICAnZmluZHN0ciAvSSB3aW5hcHBkcml2ZXIuZXhlYCkgZG8gKElGIE5PVCAlYj09XCJcIiBUQVNLS0lMTCAnICtcbiAgICAgICAgICAnL0YgL1BJRCAlYSkpJztcbiAgICBsb2cuaW5mbyhgS2lsbGluZyBhbnkgb2xkIFdpbkFwcERyaXZlcnMgb24gc2FtZSBwb3J0LCBydW5uaW5nOiAke2NtZH1gKTtcbiAgICB0cnkge1xuICAgICAgLy8gdXNlIGNwLmV4ZWMgaW5zdGVhZCBvZiB0ZWVuIHByb2Nlc3MgYmVjYXVzZSBvZiBjcmF6eSB3aW5kb3dzIHF1b3RpbmdcbiAgICAgIGF3YWl0IChCLnByb21pc2lmeShjcC5leGVjKSkoY21kKTtcbiAgICAgIGxvZy5pbmZvKCdTdWNjZXNzZnVsbHkgY2xlYW5lZCB1cCBvbGQgV2luQXBwRHJpdmVycycpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmluZm8oJ05vIG9sZCBXaW5BcHBEcml2ZXJzIHNlZW1lZCB0byBleGlzdCcpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVNlc3Npb24gKCkge1xuICAgIGxvZy5kZWJ1ZygnRGVsZXRpbmcgV2luQXBwRHJpdmVyIHNlcnZlciBzZXNzaW9uJyk7XG4gICAgLy8gcmVseSBvbiBqd3Byb3h5J3MgaW50ZWxsaWdlbmNlIHRvIGtub3cgd2hhdCB3ZSdyZSB0YWxraW5nIGFib3V0IGFuZFxuICAgIC8vIGRlbGV0ZSB0aGUgY3VycmVudCBzZXNzaW9uXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvJywgJ0RFTEVURScpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLndhcm4oYERpZCBub3QgZ2V0IGNvbmZpcm1hdGlvbiBXaW5BcHBEcml2ZXIgZGVsZXRlU2Vzc2lvbiB3b3JrZWQ7IGAgK1xuICAgICAgICBgRXJyb3Igd2FzOiAke2Vycn1gKTtcbiAgICB9XG4gIH1cbn1cblxuV2luQXBwRHJpdmVyLkVWRU5UX0VSUk9SID0gJ3dpbmFwcGRyaXZlcl9lcnJvcic7XG5XaW5BcHBEcml2ZXIuRVZFTlRfQ0hBTkdFRCA9ICdzdGF0ZUNoYW5nZWQnO1xuV2luQXBwRHJpdmVyLlNUQVRFX1NUT1BQRUQgPSAnc3RvcHBlZCc7XG5XaW5BcHBEcml2ZXIuU1RBVEVfU1RBUlRJTkcgPSAnc3RhcnRpbmcnO1xuV2luQXBwRHJpdmVyLlNUQVRFX09OTElORSA9ICdvbmxpbmUnO1xuV2luQXBwRHJpdmVyLlNUQVRFX1NUT1BQSU5HID0gJ3N0b3BwaW5nJztcblxuZXhwb3J0IHsgV2luQXBwRHJpdmVyLCBERUZBVUxUX1dBRF9IT1NULCBERUZBVUxUX1dBRF9QT1JUIH07XG5leHBvcnQgZGVmYXVsdCBXaW5BcHBEcml2ZXI7XG4iXSwiZmlsZSI6ImxpYi93aW5hcHBkcml2ZXIuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
