"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.TEST_APK_PKG = exports.REQUIRED_PARAMS = exports.EspressoRunner = void 0;

require("source-map-support/register");

var _appiumBaseDriver = require("appium-base-driver");

var _asyncbox = require("asyncbox");

var _logger = _interopRequireDefault(require("./logger"));

var _serverBuilder = require("./server-builder");

var _path = _interopRequireDefault(require("path"));

var _appiumSupport = require("appium-support");

var _package = require("../../package.json");

var _requestPromise = _interopRequireDefault(require("request-promise"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _lodash = _interopRequireDefault(require("lodash"));

var _utils = require("./utils");

const TEST_SERVER_ROOT = _path.default.resolve(__dirname, '..', '..', 'espresso-server');

const TEST_APK_PKG = 'io.appium.espressoserver.test';
exports.TEST_APK_PKG = TEST_APK_PKG;
const REQUIRED_PARAMS = ['adb', 'tmpDir', 'host', 'systemPort', 'devicePort', 'appPackage', 'forceEspressoRebuild'];
exports.REQUIRED_PARAMS = REQUIRED_PARAMS;
const ESPRESSO_SERVER_LAUNCH_TIMEOUT = 30000;
const TARGET_PACKAGE_CONTAINER = '/data/local/tmp/espresso.apppackage';

class EspressoRunner {
  constructor(opts = {}) {
    for (let req of REQUIRED_PARAMS) {
      if (!opts || !_appiumSupport.util.hasValue(opts[req])) {
        throw new Error(`Option '${req}' is required!`);
      }

      this[req] = opts[req];
    }

    this.jwproxy = new _appiumBaseDriver.JWProxy({
      server: this.host,
      port: this.systemPort,
      base: '',
      keepAlive: true
    });
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
    this.modServerPath = _path.default.resolve(this.tmpDir, `${TEST_APK_PKG}_${_package.version}_${this.appPackage}_${this.adb.curDeviceId}.apk`);
    this.showGradleLog = opts.showGradleLog;
    this.espressoBuildConfig = opts.espressoBuildConfig;
    this.serverLaunchTimeout = opts.serverLaunchTimeout || ESPRESSO_SERVER_LAUNCH_TIMEOUT;
    this.androidInstallTimeout = opts.androidInstallTimeout;

    if (opts.useKeystore && opts.keystorePath && opts.keystorePassword && opts.keyAlias && opts.keyPassword) {
      this.signingConfig = (0, _serverBuilder.buildServerSigningConfig)({
        keystoreFile: opts.keystorePath,
        keystorePassword: opts.keystorePassword,
        keyAlias: opts.keyAlias,
        keyPassword: opts.keyPassword
      });
    } else {
      this.signingConfig = null;
    }
  }

  async isAppPackageChanged() {
    if (!(await this.adb.fileExists(TARGET_PACKAGE_CONTAINER))) {
      _logger.default.debug('The previous target application package is unknown');

      return true;
    }

    const previousAppPackage = (await this.adb.shell(['cat', TARGET_PACKAGE_CONTAINER])).trim();

    _logger.default.debug(`The previous target application package was '${previousAppPackage}'. ` + `The current package is '${this.appPackage}'`);

    return previousAppPackage !== this.appPackage;
  }

  async installServer() {
    const appState = await this.adb.getApplicationInstallState(this.modServerPath, TEST_APK_PKG);
    const shouldUninstallApp = [this.adb.APP_INSTALL_STATE.OLDER_VERSION_INSTALLED, this.adb.APP_INSTALL_STATE.NEWER_VERSION_INSTALLED].includes(appState);
    const shouldInstallApp = shouldUninstallApp || [this.adb.APP_INSTALL_STATE.NOT_INSTALLED].includes(appState);

    if (shouldUninstallApp) {
      _logger.default.info(`Uninstalling Espresso Test Server apk from the target device (pkg: '${TEST_APK_PKG}')`);

      try {
        await this.adb.uninstallApk(TEST_APK_PKG);
      } catch (err) {
        _logger.default.warn(`Error uninstalling '${TEST_APK_PKG}': ${err.message}`);
      }
    }

    if (shouldInstallApp) {
      _logger.default.info(`Installing Espresso Test Server apk from the target device (path: '${this.modServerPath}')`);

      try {
        await this.adb.install(this.modServerPath, {
          replace: false,
          timeout: this.androidInstallTimeout
        });

        _logger.default.info(`Installed Espresso Test Server apk '${this.modServerPath}' (pkg: '${TEST_APK_PKG}')`);
      } catch (err) {
        _logger.default.errorAndThrow(`Cannot install '${this.modServerPath}' because of '${err.message}'`);
      }
    }
  }

  async installTestApk() {
    let rebuild = this.forceEspressoRebuild;

    if (rebuild) {
      _logger.default.debug(`'forceEspressoRebuild' capability is enabled`);
    } else if (await this.isAppPackageChanged()) {
      _logger.default.info(`Forcing Espresso server rebuild because of changed application package`);

      rebuild = true;
    }

    if (rebuild && (await _appiumSupport.fs.exists(this.modServerPath))) {
      _logger.default.debug(`Deleting the obsolete Espresso server package '${this.modServerPath}'`);

      await _appiumSupport.fs.unlink(this.modServerPath);
    }

    if (!(await _appiumSupport.fs.exists(this.modServerPath))) {
      await this.buildNewModServer();
    }

    const isSigned = await this.adb.checkApkCert(this.modServerPath, TEST_APK_PKG);

    if (!isSigned) {
      await this.adb.sign(this.modServerPath);
    }

    if ((rebuild || !isSigned) && (await this.adb.uninstallApk(TEST_APK_PKG))) {
      _logger.default.info('Uninstalled the obsolete Espresso server package from the device under test');
    }

    await this.installServer();
  }

  async buildNewModServer() {
    let buildConfiguration = {};

    if (this.espressoBuildConfig) {
      _logger.default.info(`Using build configuration JSON from: '${this.espressoBuildConfig}'`);

      try {
        buildConfiguration = JSON.parse((await _appiumSupport.fs.readFile(this.espressoBuildConfig, 'utf8')));
      } catch (e) {
        _logger.default.error('Failed to parse build configuration JSON', e);

        throw e;
      }
    }

    const serverPath = _path.default.resolve(this.tmpDir, `espresso-server-${this.adb.curDeviceId}`);

    _logger.default.info(`Building espresso server in '${serverPath}'`);

    _logger.default.debug(`The build folder root could be customized by changing the 'tmpDir' capability`);

    await _appiumSupport.fs.rimraf(serverPath);
    await (0, _appiumSupport.mkdirp)(serverPath);

    _logger.default.debug(`Copying espresso server template from ('${TEST_SERVER_ROOT}' to '${serverPath}')`);

    await (0, _utils.copyGradleProjectRecursively)(TEST_SERVER_ROOT, serverPath);

    _logger.default.debug('Bulding espresso server');

    await new _serverBuilder.ServerBuilder({
      serverPath,
      buildConfiguration,
      showGradleLog: this.showGradleLog,
      testAppPackage: this.appPackage,
      signingConfig: this.signingConfig
    }).build();

    const apkPath = _path.default.resolve(serverPath, 'app', 'build', 'outputs', 'apk', 'androidTest', 'debug', 'app-debug-androidTest.apk');

    _logger.default.debug(`Copying built apk from '${apkPath}' to '${this.modServerPath}'`);

    await _appiumSupport.fs.copyFile(apkPath, this.modServerPath);
  }

  async cleanupSessionLeftovers() {
    _logger.default.debug('Performing cleanup of automation leftovers');

    try {
      const {
        value
      } = await _requestPromise.default.get({
        url: `http://${this.host}:${this.systemPort}/sessions`,
        timeout: 500,
        json: true
      });
      const activeSessionIds = value.map(sess => sess.id);

      if (activeSessionIds.length) {
        _logger.default.debug(`The following obsolete sessions are still running: ${JSON.stringify(activeSessionIds)}`);

        _logger.default.debug('Cleaning up the obsolete sessions');

        await _bluebird.default.all(activeSessionIds.map(id => _requestPromise.default.delete({
          url: `http://${this.host}:${this.systemPort}/session/${id}`
        })));
        await _bluebird.default.delay(1000);
      } else {
        _logger.default.debug('No obsolete sessions have been detected');
      }
    } catch (e) {
      _logger.default.debug(`No obsolete sessions have been detected (${e.message})`);
    }
  }

  async startSession(caps) {
    await this.cleanupSessionLeftovers();
    const cmd = ['shell', 'am', 'instrument', '-w', '-e', 'debug', process.env.ESPRESSO_JAVA_DEBUG === 'true' ? 'true' : 'false', `${TEST_APK_PKG}/androidx.test.runner.AndroidJUnitRunner`];

    _logger.default.info(`Starting Espresso Server v${_package.version} with cmd: adb ${cmd.join(' ')}`);

    let hasSocketError = false;
    this.instProcess = this.adb.createSubProcess(cmd);
    this.instProcess.on('exit', (code, signal) => {
      _logger.default.info(`Instrumentation process exited with code ${code} from signal ${signal}`);
    });
    this.instProcess.on('die', (code, signal) => {
      _logger.default.error(`Instrumentation process died with code ${code} and signal ${signal}`);
    });
    this.instProcess.on('stream-line', line => {
      if (_lodash.default.isEmpty(line.trim())) {
        return;
      }

      _logger.default.debug(`[Instrumentation] ${line.trim()}`);

      if (line.toLowerCase().includes('java.net.socketexception')) {
        hasSocketError = true;
      }
    });
    await this.instProcess.start((stdout, stderr) => {
      const out = stdout.trim() || stderr.trim();

      if (out.includes('io.appium.espressoserver.EspressoServerRunnerTest:')) {
        return true;
      }

      if (out.toLowerCase().includes('exception')) {
        throw new Error(out);
      }
    }, this.serverLaunchTimeout);

    _logger.default.info('Waiting for Espresso to be online...');

    try {
      await (0, _asyncbox.retryInterval)(20, 1000, async () => {
        await this.jwproxy.command('/status', 'GET');
      });
    } catch (e) {
      if (hasSocketError) {
        _logger.default.errorAndThrow(`Timed out waiting for Espresso Server to start due to Socket exception. Espresso Server requires the 'INTERNET' permission to be set in the Android manifest for the app-under-test (<uses-permission android:name="android.permission.INTERNET" />)`);
      } else {
        _logger.default.errorAndThrow(`Timed out waiting for Espresso Server to start. Original error: ${e.message}`);
      }
    }

    await this.jwproxy.command('/session', 'POST', {
      capabilities: {
        firstMatch: [caps],
        alwaysMatch: {}
      }
    });
    await this.recordTargetAppPackage();
  }

  async recordTargetAppPackage() {
    await this.adb.shell([`echo "${this.appPackage}" > "${TARGET_PACKAGE_CONTAINER}"`]);

    _logger.default.info(`Recorded the target application package '${this.appPackage}' to ${TARGET_PACKAGE_CONTAINER}`);
  }

  async deleteSession() {
    _logger.default.debug('Deleting Espresso server session');

    try {
      await this.jwproxy.command('/', 'DELETE');
    } catch (err) {
      _logger.default.warn(`Did not get confirmation Espresso deleteSession worked; ` + `Error was: ${err}`);
    }

    if (this.instProcess && this.instProcess.isRunning) {
      await this.instProcess.stop();
    }
  }

}

exports.EspressoRunner = EspressoRunner;
var _default = EspressoRunner;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9lc3ByZXNzby1ydW5uZXIuanMiXSwibmFtZXMiOlsiVEVTVF9TRVJWRVJfUk9PVCIsInBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwiVEVTVF9BUEtfUEtHIiwiUkVRVUlSRURfUEFSQU1TIiwiRVNQUkVTU09fU0VSVkVSX0xBVU5DSF9USU1FT1VUIiwiVEFSR0VUX1BBQ0tBR0VfQ09OVEFJTkVSIiwiRXNwcmVzc29SdW5uZXIiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJyZXEiLCJ1dGlsIiwiaGFzVmFsdWUiLCJFcnJvciIsImp3cHJveHkiLCJKV1Byb3h5Iiwic2VydmVyIiwiaG9zdCIsInBvcnQiLCJzeXN0ZW1Qb3J0IiwiYmFzZSIsImtlZXBBbGl2ZSIsInByb3h5UmVxUmVzIiwiYmluZCIsIm1vZFNlcnZlclBhdGgiLCJ0bXBEaXIiLCJ2ZXJzaW9uIiwiYXBwUGFja2FnZSIsImFkYiIsImN1ckRldmljZUlkIiwic2hvd0dyYWRsZUxvZyIsImVzcHJlc3NvQnVpbGRDb25maWciLCJzZXJ2ZXJMYXVuY2hUaW1lb3V0IiwiYW5kcm9pZEluc3RhbGxUaW1lb3V0IiwidXNlS2V5c3RvcmUiLCJrZXlzdG9yZVBhdGgiLCJrZXlzdG9yZVBhc3N3b3JkIiwia2V5QWxpYXMiLCJrZXlQYXNzd29yZCIsInNpZ25pbmdDb25maWciLCJrZXlzdG9yZUZpbGUiLCJpc0FwcFBhY2thZ2VDaGFuZ2VkIiwiZmlsZUV4aXN0cyIsImxvZ2dlciIsImRlYnVnIiwicHJldmlvdXNBcHBQYWNrYWdlIiwic2hlbGwiLCJ0cmltIiwiaW5zdGFsbFNlcnZlciIsImFwcFN0YXRlIiwiZ2V0QXBwbGljYXRpb25JbnN0YWxsU3RhdGUiLCJzaG91bGRVbmluc3RhbGxBcHAiLCJBUFBfSU5TVEFMTF9TVEFURSIsIk9MREVSX1ZFUlNJT05fSU5TVEFMTEVEIiwiTkVXRVJfVkVSU0lPTl9JTlNUQUxMRUQiLCJpbmNsdWRlcyIsInNob3VsZEluc3RhbGxBcHAiLCJOT1RfSU5TVEFMTEVEIiwiaW5mbyIsInVuaW5zdGFsbEFwayIsImVyciIsIndhcm4iLCJtZXNzYWdlIiwiaW5zdGFsbCIsInJlcGxhY2UiLCJ0aW1lb3V0IiwiZXJyb3JBbmRUaHJvdyIsImluc3RhbGxUZXN0QXBrIiwicmVidWlsZCIsImZvcmNlRXNwcmVzc29SZWJ1aWxkIiwiZnMiLCJleGlzdHMiLCJ1bmxpbmsiLCJidWlsZE5ld01vZFNlcnZlciIsImlzU2lnbmVkIiwiY2hlY2tBcGtDZXJ0Iiwic2lnbiIsImJ1aWxkQ29uZmlndXJhdGlvbiIsIkpTT04iLCJwYXJzZSIsInJlYWRGaWxlIiwiZSIsImVycm9yIiwic2VydmVyUGF0aCIsInJpbXJhZiIsIlNlcnZlckJ1aWxkZXIiLCJ0ZXN0QXBwUGFja2FnZSIsImJ1aWxkIiwiYXBrUGF0aCIsImNvcHlGaWxlIiwiY2xlYW51cFNlc3Npb25MZWZ0b3ZlcnMiLCJ2YWx1ZSIsInJlcXVlc3QiLCJnZXQiLCJ1cmwiLCJqc29uIiwiYWN0aXZlU2Vzc2lvbklkcyIsIm1hcCIsInNlc3MiLCJpZCIsImxlbmd0aCIsInN0cmluZ2lmeSIsIkIiLCJhbGwiLCJkZWxldGUiLCJkZWxheSIsInN0YXJ0U2Vzc2lvbiIsImNhcHMiLCJjbWQiLCJwcm9jZXNzIiwiZW52IiwiRVNQUkVTU09fSkFWQV9ERUJVRyIsImpvaW4iLCJoYXNTb2NrZXRFcnJvciIsImluc3RQcm9jZXNzIiwiY3JlYXRlU3ViUHJvY2VzcyIsIm9uIiwiY29kZSIsInNpZ25hbCIsImxpbmUiLCJfIiwiaXNFbXB0eSIsInRvTG93ZXJDYXNlIiwic3RhcnQiLCJzdGRvdXQiLCJzdGRlcnIiLCJvdXQiLCJjb21tYW5kIiwiY2FwYWJpbGl0aWVzIiwiZmlyc3RNYXRjaCIsImFsd2F5c01hdGNoIiwicmVjb3JkVGFyZ2V0QXBwUGFja2FnZSIsImRlbGV0ZVNlc3Npb24iLCJpc1J1bm5pbmciLCJzdG9wIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNB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cUIsR0FBckIsRUFBMEIsUUFBMUIsQ0FBTjtBQUNELEtBRkQsQ0FFRSxPQUFPbkUsR0FBUCxFQUFZO0FBQ1pqQixzQkFBT2tCLElBQVAsQ0FBYSwwREFBRCxHQUNQLGNBQWFELEdBQUksRUFEdEI7QUFFRDs7QUFFRCxRQUFJLEtBQUtzRCxXQUFMLElBQW9CLEtBQUtBLFdBQUwsQ0FBaUJtQixTQUF6QyxFQUFvRDtBQUNsRCxZQUFNLEtBQUtuQixXQUFMLENBQWlCb0IsSUFBakIsRUFBTjtBQUNEO0FBQ0Y7O0FBbFFrQjs7O2VBc1FOL0gsYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEpXUHJveHkgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgcmV0cnlJbnRlcnZhbCB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgU2VydmVyQnVpbGRlciwgYnVpbGRTZXJ2ZXJTaWduaW5nQ29uZmlnIH0gZnJvbSAnLi9zZXJ2ZXItYnVpbGRlcic7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGZzLCB1dGlsLCBta2RpcnAgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyB2ZXJzaW9uIH0gZnJvbSAnLi4vLi4vcGFja2FnZS5qc29uJzsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBpbXBvcnQvbm8tdW5yZXNvbHZlZFxuaW1wb3J0IHJlcXVlc3QgZnJvbSAncmVxdWVzdC1wcm9taXNlJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBjb3B5R3JhZGxlUHJvamVjdFJlY3Vyc2l2ZWx5IH0gZnJvbSAnLi91dGlscyc7XG5cblxuY29uc3QgVEVTVF9TRVJWRVJfUk9PVCA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICdlc3ByZXNzby1zZXJ2ZXInKTtcbmNvbnN0IFRFU1RfQVBLX1BLRyA9ICdpby5hcHBpdW0uZXNwcmVzc29zZXJ2ZXIudGVzdCc7XG5jb25zdCBSRVFVSVJFRF9QQVJBTVMgPSBbXG4gICdhZGInLFxuICAndG1wRGlyJyxcbiAgJ2hvc3QnLFxuICAnc3lzdGVtUG9ydCcsXG4gICdkZXZpY2VQb3J0JyxcbiAgJ2FwcFBhY2thZ2UnLFxuICAnZm9yY2VFc3ByZXNzb1JlYnVpbGQnLFxuXTtcbmNvbnN0IEVTUFJFU1NPX1NFUlZFUl9MQVVOQ0hfVElNRU9VVCA9IDMwMDAwO1xuY29uc3QgVEFSR0VUX1BBQ0tBR0VfQ09OVEFJTkVSID0gJy9kYXRhL2xvY2FsL3RtcC9lc3ByZXNzby5hcHBwYWNrYWdlJztcblxuY2xhc3MgRXNwcmVzc29SdW5uZXIge1xuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7XG4gICAgZm9yIChsZXQgcmVxIG9mIFJFUVVJUkVEX1BBUkFNUykge1xuICAgICAgaWYgKCFvcHRzIHx8ICF1dGlsLmhhc1ZhbHVlKG9wdHNbcmVxXSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBPcHRpb24gJyR7cmVxfScgaXMgcmVxdWlyZWQhYCk7XG4gICAgICB9XG4gICAgICB0aGlzW3JlcV0gPSBvcHRzW3JlcV07XG4gICAgfVxuICAgIHRoaXMuandwcm94eSA9IG5ldyBKV1Byb3h5KHtcbiAgICAgIHNlcnZlcjogdGhpcy5ob3N0LFxuICAgICAgcG9ydDogdGhpcy5zeXN0ZW1Qb3J0LFxuICAgICAgYmFzZTogJycsXG4gICAgICBrZWVwQWxpdmU6IHRydWUsXG4gICAgfSk7XG4gICAgdGhpcy5wcm94eVJlcVJlcyA9IHRoaXMuandwcm94eS5wcm94eVJlcVJlcy5iaW5kKHRoaXMuandwcm94eSk7XG5cbiAgICB0aGlzLm1vZFNlcnZlclBhdGggPSBwYXRoLnJlc29sdmUodGhpcy50bXBEaXIsIGAke1RFU1RfQVBLX1BLR31fJHt2ZXJzaW9ufV8ke3RoaXMuYXBwUGFja2FnZX1fJHt0aGlzLmFkYi5jdXJEZXZpY2VJZH0uYXBrYCk7XG4gICAgdGhpcy5zaG93R3JhZGxlTG9nID0gb3B0cy5zaG93R3JhZGxlTG9nO1xuICAgIHRoaXMuZXNwcmVzc29CdWlsZENvbmZpZyA9IG9wdHMuZXNwcmVzc29CdWlsZENvbmZpZztcblxuICAgIHRoaXMuc2VydmVyTGF1bmNoVGltZW91dCA9IG9wdHMuc2VydmVyTGF1bmNoVGltZW91dCB8fCBFU1BSRVNTT19TRVJWRVJfTEFVTkNIX1RJTUVPVVQ7XG4gICAgdGhpcy5hbmRyb2lkSW5zdGFsbFRpbWVvdXQgPSBvcHRzLmFuZHJvaWRJbnN0YWxsVGltZW91dDtcblxuICAgIC8vIEVzcHJlc3NvIFNlcnZlciBhcHAgbmVlZHMgdG8gYmUgc2lnbmVkIHdpdGggc2FtZSBrZXlTdG9yZSBhcyBhcHBQYWNrYWdlXG4gICAgaWYgKG9wdHMudXNlS2V5c3RvcmUgJiYgb3B0cy5rZXlzdG9yZVBhdGggJiYgb3B0cy5rZXlzdG9yZVBhc3N3b3JkICYmIG9wdHMua2V5QWxpYXMgJiYgb3B0cy5rZXlQYXNzd29yZCkge1xuICAgICAgdGhpcy5zaWduaW5nQ29uZmlnID0gYnVpbGRTZXJ2ZXJTaWduaW5nQ29uZmlnKHtcbiAgICAgICAga2V5c3RvcmVGaWxlOiBvcHRzLmtleXN0b3JlUGF0aCxcbiAgICAgICAga2V5c3RvcmVQYXNzd29yZDogb3B0cy5rZXlzdG9yZVBhc3N3b3JkLFxuICAgICAgICBrZXlBbGlhczogb3B0cy5rZXlBbGlhcyxcbiAgICAgICAga2V5UGFzc3dvcmQ6IG9wdHMua2V5UGFzc3dvcmRcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnNpZ25pbmdDb25maWcgPSBudWxsO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGlzQXBwUGFja2FnZUNoYW5nZWQgKCkge1xuICAgIGlmICghYXdhaXQgdGhpcy5hZGIuZmlsZUV4aXN0cyhUQVJHRVRfUEFDS0FHRV9DT05UQUlORVIpKSB7XG4gICAgICBsb2dnZXIuZGVidWcoJ1RoZSBwcmV2aW91cyB0YXJnZXQgYXBwbGljYXRpb24gcGFja2FnZSBpcyB1bmtub3duJyk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgY29uc3QgcHJldmlvdXNBcHBQYWNrYWdlID0gKGF3YWl0IHRoaXMuYWRiLnNoZWxsKFsnY2F0JywgVEFSR0VUX1BBQ0tBR0VfQ09OVEFJTkVSXSkpLnRyaW0oKTtcbiAgICBsb2dnZXIuZGVidWcoYFRoZSBwcmV2aW91cyB0YXJnZXQgYXBwbGljYXRpb24gcGFja2FnZSB3YXMgJyR7cHJldmlvdXNBcHBQYWNrYWdlfScuIGAgK1xuICAgICAgYFRoZSBjdXJyZW50IHBhY2thZ2UgaXMgJyR7dGhpcy5hcHBQYWNrYWdlfSdgKTtcbiAgICByZXR1cm4gcHJldmlvdXNBcHBQYWNrYWdlICE9PSB0aGlzLmFwcFBhY2thZ2U7XG4gIH1cblxuICAvKipcbiAgICogSW5zdGFsbHMgRXNwcmVzc28gc2VydmVyIGFwayBvbiB0byB0aGUgZGV2aWNlIG9yIGVtdWxhdG9yLlxuICAgKiBFYWNoIGFkYiBjb21tYW5kIHVzZXMgZGVmYXVsdCB0aW1lb3V0IGJ5IHRoZW0uXG4gICAqL1xuICBhc3luYyBpbnN0YWxsU2VydmVyICgpIHtcbiAgICBjb25zdCBhcHBTdGF0ZSA9IGF3YWl0IHRoaXMuYWRiLmdldEFwcGxpY2F0aW9uSW5zdGFsbFN0YXRlKHRoaXMubW9kU2VydmVyUGF0aCwgVEVTVF9BUEtfUEtHKTtcblxuICAgIGNvbnN0IHNob3VsZFVuaW5zdGFsbEFwcCA9IFtcbiAgICAgIHRoaXMuYWRiLkFQUF9JTlNUQUxMX1NUQVRFLk9MREVSX1ZFUlNJT05fSU5TVEFMTEVELFxuICAgICAgdGhpcy5hZGIuQVBQX0lOU1RBTExfU1RBVEUuTkVXRVJfVkVSU0lPTl9JTlNUQUxMRURcbiAgICBdLmluY2x1ZGVzKGFwcFN0YXRlKTtcbiAgICBjb25zdCBzaG91bGRJbnN0YWxsQXBwID0gc2hvdWxkVW5pbnN0YWxsQXBwIHx8IFtcbiAgICAgIHRoaXMuYWRiLkFQUF9JTlNUQUxMX1NUQVRFLk5PVF9JTlNUQUxMRURcbiAgICBdLmluY2x1ZGVzKGFwcFN0YXRlKTtcblxuICAgIGlmIChzaG91bGRVbmluc3RhbGxBcHApIHtcbiAgICAgIGxvZ2dlci5pbmZvKGBVbmluc3RhbGxpbmcgRXNwcmVzc28gVGVzdCBTZXJ2ZXIgYXBrIGZyb20gdGhlIHRhcmdldCBkZXZpY2UgKHBrZzogJyR7VEVTVF9BUEtfUEtHfScpYCk7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLmFkYi51bmluc3RhbGxBcGsoVEVTVF9BUEtfUEtHKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBsb2dnZXIud2FybihgRXJyb3IgdW5pbnN0YWxsaW5nICcke1RFU1RfQVBLX1BLR30nOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChzaG91bGRJbnN0YWxsQXBwKSB7XG4gICAgICBsb2dnZXIuaW5mbyhgSW5zdGFsbGluZyBFc3ByZXNzbyBUZXN0IFNlcnZlciBhcGsgZnJvbSB0aGUgdGFyZ2V0IGRldmljZSAocGF0aDogJyR7dGhpcy5tb2RTZXJ2ZXJQYXRofScpYCk7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLmFkYi5pbnN0YWxsKHRoaXMubW9kU2VydmVyUGF0aCwgeyByZXBsYWNlOiBmYWxzZSwgdGltZW91dDogdGhpcy5hbmRyb2lkSW5zdGFsbFRpbWVvdXQgfSk7XG4gICAgICAgIGxvZ2dlci5pbmZvKGBJbnN0YWxsZWQgRXNwcmVzc28gVGVzdCBTZXJ2ZXIgYXBrICcke3RoaXMubW9kU2VydmVyUGF0aH0nIChwa2c6ICcke1RFU1RfQVBLX1BLR30nKWApO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvckFuZFRocm93KGBDYW5ub3QgaW5zdGFsbCAnJHt0aGlzLm1vZFNlcnZlclBhdGh9JyBiZWNhdXNlIG9mICcke2Vyci5tZXNzYWdlfSdgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyBpbnN0YWxsVGVzdEFwayAoKSB7XG4gICAgbGV0IHJlYnVpbGQgPSB0aGlzLmZvcmNlRXNwcmVzc29SZWJ1aWxkO1xuICAgIGlmIChyZWJ1aWxkKSB7XG4gICAgICBsb2dnZXIuZGVidWcoYCdmb3JjZUVzcHJlc3NvUmVidWlsZCcgY2FwYWJpbGl0eSBpcyBlbmFibGVkYCk7XG4gICAgfSBlbHNlIGlmIChhd2FpdCB0aGlzLmlzQXBwUGFja2FnZUNoYW5nZWQoKSkge1xuICAgICAgbG9nZ2VyLmluZm8oYEZvcmNpbmcgRXNwcmVzc28gc2VydmVyIHJlYnVpbGQgYmVjYXVzZSBvZiBjaGFuZ2VkIGFwcGxpY2F0aW9uIHBhY2thZ2VgKTtcbiAgICAgIHJlYnVpbGQgPSB0cnVlO1xuICAgIH1cblxuICAgIGlmIChyZWJ1aWxkICYmIGF3YWl0IGZzLmV4aXN0cyh0aGlzLm1vZFNlcnZlclBhdGgpKSB7XG4gICAgICBsb2dnZXIuZGVidWcoYERlbGV0aW5nIHRoZSBvYnNvbGV0ZSBFc3ByZXNzbyBzZXJ2ZXIgcGFja2FnZSAnJHt0aGlzLm1vZFNlcnZlclBhdGh9J2ApO1xuICAgICAgYXdhaXQgZnMudW5saW5rKHRoaXMubW9kU2VydmVyUGF0aCk7XG4gICAgfVxuICAgIGlmICghKGF3YWl0IGZzLmV4aXN0cyh0aGlzLm1vZFNlcnZlclBhdGgpKSkge1xuICAgICAgYXdhaXQgdGhpcy5idWlsZE5ld01vZFNlcnZlcigpO1xuICAgIH1cbiAgICBjb25zdCBpc1NpZ25lZCA9IGF3YWl0IHRoaXMuYWRiLmNoZWNrQXBrQ2VydCh0aGlzLm1vZFNlcnZlclBhdGgsIFRFU1RfQVBLX1BLRyk7XG4gICAgaWYgKCFpc1NpZ25lZCkge1xuICAgICAgYXdhaXQgdGhpcy5hZGIuc2lnbih0aGlzLm1vZFNlcnZlclBhdGgpO1xuICAgIH1cbiAgICBpZiAoKHJlYnVpbGQgfHwgIWlzU2lnbmVkKSAmJiBhd2FpdCB0aGlzLmFkYi51bmluc3RhbGxBcGsoVEVTVF9BUEtfUEtHKSkge1xuICAgICAgbG9nZ2VyLmluZm8oJ1VuaW5zdGFsbGVkIHRoZSBvYnNvbGV0ZSBFc3ByZXNzbyBzZXJ2ZXIgcGFja2FnZSBmcm9tIHRoZSBkZXZpY2UgdW5kZXIgdGVzdCcpO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMuaW5zdGFsbFNlcnZlcigpO1xuICB9XG5cbiAgYXN5bmMgYnVpbGROZXdNb2RTZXJ2ZXIgKCkge1xuICAgIGxldCBidWlsZENvbmZpZ3VyYXRpb24gPSB7fTtcbiAgICBpZiAodGhpcy5lc3ByZXNzb0J1aWxkQ29uZmlnKSB7XG4gICAgICBsb2dnZXIuaW5mbyhgVXNpbmcgYnVpbGQgY29uZmlndXJhdGlvbiBKU09OIGZyb206ICcke3RoaXMuZXNwcmVzc29CdWlsZENvbmZpZ30nYCk7XG4gICAgICB0cnkge1xuICAgICAgICBidWlsZENvbmZpZ3VyYXRpb24gPSBKU09OLnBhcnNlKGF3YWl0IGZzLnJlYWRGaWxlKHRoaXMuZXNwcmVzc29CdWlsZENvbmZpZywgJ3V0ZjgnKSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvcignRmFpbGVkIHRvIHBhcnNlIGJ1aWxkIGNvbmZpZ3VyYXRpb24gSlNPTicsIGUpO1xuICAgICAgICB0aHJvdyBlO1xuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCBzZXJ2ZXJQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMudG1wRGlyLCBgZXNwcmVzc28tc2VydmVyLSR7dGhpcy5hZGIuY3VyRGV2aWNlSWR9YCk7XG4gICAgbG9nZ2VyLmluZm8oYEJ1aWxkaW5nIGVzcHJlc3NvIHNlcnZlciBpbiAnJHtzZXJ2ZXJQYXRofSdgKTtcbiAgICBsb2dnZXIuZGVidWcoYFRoZSBidWlsZCBmb2xkZXIgcm9vdCBjb3VsZCBiZSBjdXN0b21pemVkIGJ5IGNoYW5naW5nIHRoZSAndG1wRGlyJyBjYXBhYmlsaXR5YCk7XG4gICAgYXdhaXQgZnMucmltcmFmKHNlcnZlclBhdGgpO1xuICAgIGF3YWl0IG1rZGlycChzZXJ2ZXJQYXRoKTtcbiAgICBsb2dnZXIuZGVidWcoYENvcHlpbmcgZXNwcmVzc28gc2VydmVyIHRlbXBsYXRlIGZyb20gKCcke1RFU1RfU0VSVkVSX1JPT1R9JyB0byAnJHtzZXJ2ZXJQYXRofScpYCk7XG4gICAgYXdhaXQgY29weUdyYWRsZVByb2plY3RSZWN1cnNpdmVseShURVNUX1NFUlZFUl9ST09ULCBzZXJ2ZXJQYXRoKTtcbiAgICBsb2dnZXIuZGVidWcoJ0J1bGRpbmcgZXNwcmVzc28gc2VydmVyJyk7XG4gICAgYXdhaXQgbmV3IFNlcnZlckJ1aWxkZXIoe3NlcnZlclBhdGgsIGJ1aWxkQ29uZmlndXJhdGlvbiwgc2hvd0dyYWRsZUxvZzogdGhpcy5zaG93R3JhZGxlTG9nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXN0QXBwUGFja2FnZTogdGhpcy5hcHBQYWNrYWdlLCBzaWduaW5nQ29uZmlnOiB0aGlzLnNpZ25pbmdDb25maWd9KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuYnVpbGQoKTtcbiAgICBjb25zdCBhcGtQYXRoID0gcGF0aC5yZXNvbHZlKHNlcnZlclBhdGgsICdhcHAnLCAnYnVpbGQnLCAnb3V0cHV0cycsICdhcGsnLCAnYW5kcm9pZFRlc3QnLCAnZGVidWcnLCAnYXBwLWRlYnVnLWFuZHJvaWRUZXN0LmFwaycpO1xuICAgIGxvZ2dlci5kZWJ1ZyhgQ29weWluZyBidWlsdCBhcGsgZnJvbSAnJHthcGtQYXRofScgdG8gJyR7dGhpcy5tb2RTZXJ2ZXJQYXRofSdgKTtcbiAgICBhd2FpdCBmcy5jb3B5RmlsZShhcGtQYXRoLCB0aGlzLm1vZFNlcnZlclBhdGgpO1xuICB9XG5cbiAgYXN5bmMgY2xlYW51cFNlc3Npb25MZWZ0b3ZlcnMgKCkge1xuICAgIGxvZ2dlci5kZWJ1ZygnUGVyZm9ybWluZyBjbGVhbnVwIG9mIGF1dG9tYXRpb24gbGVmdG92ZXJzJyk7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3Qge3ZhbHVlfSA9IGF3YWl0IHJlcXVlc3QuZ2V0KHtcbiAgICAgICAgdXJsOiBgaHR0cDovLyR7dGhpcy5ob3N0fToke3RoaXMuc3lzdGVtUG9ydH0vc2Vzc2lvbnNgLFxuICAgICAgICB0aW1lb3V0OiA1MDAsXG4gICAgICAgIGpzb246IHRydWUsXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IGFjdGl2ZVNlc3Npb25JZHMgPSB2YWx1ZS5tYXAoKHNlc3MpID0+IHNlc3MuaWQpO1xuICAgICAgaWYgKGFjdGl2ZVNlc3Npb25JZHMubGVuZ3RoKSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhgVGhlIGZvbGxvd2luZyBvYnNvbGV0ZSBzZXNzaW9ucyBhcmUgc3RpbGwgcnVubmluZzogJHtKU09OLnN0cmluZ2lmeShhY3RpdmVTZXNzaW9uSWRzKX1gKTtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKCdDbGVhbmluZyB1cCB0aGUgb2Jzb2xldGUgc2Vzc2lvbnMnKTtcbiAgICAgICAgYXdhaXQgQi5hbGwoYWN0aXZlU2Vzc2lvbklkcy5tYXAoKGlkKSA9PlxuICAgICAgICAgIHJlcXVlc3QuZGVsZXRlKHtcbiAgICAgICAgICAgIHVybDogYGh0dHA6Ly8ke3RoaXMuaG9zdH06JHt0aGlzLnN5c3RlbVBvcnR9L3Nlc3Npb24vJHtpZH1gLFxuICAgICAgICAgIH0pXG4gICAgICAgICkpO1xuICAgICAgICAvLyBMZXQgYWxsIHNlc3Npb25zIHRvIGJlIHByb3Blcmx5IHRlcm1pbmF0ZWQgYmVmb3JlIGNvbnRpbnVpbmdcbiAgICAgICAgYXdhaXQgQi5kZWxheSgxMDAwKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZygnTm8gb2Jzb2xldGUgc2Vzc2lvbnMgaGF2ZSBiZWVuIGRldGVjdGVkJyk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbG9nZ2VyLmRlYnVnKGBObyBvYnNvbGV0ZSBzZXNzaW9ucyBoYXZlIGJlZW4gZGV0ZWN0ZWQgKCR7ZS5tZXNzYWdlfSlgKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzdGFydFNlc3Npb24gKGNhcHMpIHtcbiAgICBhd2FpdCB0aGlzLmNsZWFudXBTZXNzaW9uTGVmdG92ZXJzKCk7XG5cbiAgICBjb25zdCBjbWQgPSBbXG4gICAgICAnc2hlbGwnLFxuICAgICAgJ2FtJywgJ2luc3RydW1lbnQnLFxuICAgICAgJy13JyxcbiAgICAgICctZScsICdkZWJ1ZycsIHByb2Nlc3MuZW52LkVTUFJFU1NPX0pBVkFfREVCVUcgPT09ICd0cnVlJyA/ICd0cnVlJyA6ICdmYWxzZScsXG4gICAgICBgJHtURVNUX0FQS19QS0d9L2FuZHJvaWR4LnRlc3QucnVubmVyLkFuZHJvaWRKVW5pdFJ1bm5lcmAsXG4gICAgXTtcblxuICAgIGxvZ2dlci5pbmZvKGBTdGFydGluZyBFc3ByZXNzbyBTZXJ2ZXIgdiR7dmVyc2lvbn0gd2l0aCBjbWQ6IGFkYiAke2NtZC5qb2luKCcgJyl9YCk7XG5cbiAgICBsZXQgaGFzU29ja2V0RXJyb3IgPSBmYWxzZTtcblxuICAgIC8vIHN0YXJ0IHRoZSBpbnN0cnVtZW50YXRpb24gcHJvY2Vzc1xuICAgIHRoaXMuaW5zdFByb2Nlc3MgPSB0aGlzLmFkYi5jcmVhdGVTdWJQcm9jZXNzKGNtZCk7XG4gICAgdGhpcy5pbnN0UHJvY2Vzcy5vbignZXhpdCcsIChjb2RlLCBzaWduYWwpID0+IHtcbiAgICAgIGxvZ2dlci5pbmZvKGBJbnN0cnVtZW50YXRpb24gcHJvY2VzcyBleGl0ZWQgd2l0aCBjb2RlICR7Y29kZX0gZnJvbSBzaWduYWwgJHtzaWduYWx9YCk7XG4gICAgfSk7XG4gICAgdGhpcy5pbnN0UHJvY2Vzcy5vbignZGllJywgKGNvZGUsIHNpZ25hbCkgPT4ge1xuICAgICAgbG9nZ2VyLmVycm9yKGBJbnN0cnVtZW50YXRpb24gcHJvY2VzcyBkaWVkIHdpdGggY29kZSAke2NvZGV9IGFuZCBzaWduYWwgJHtzaWduYWx9YCk7XG4gICAgfSk7XG4gICAgdGhpcy5pbnN0UHJvY2Vzcy5vbignc3RyZWFtLWxpbmUnLCAobGluZSkgPT4ge1xuICAgICAgaWYgKF8uaXNFbXB0eShsaW5lLnRyaW0oKSkpIHtcbiAgICAgICAgLy8gRG8gbm90IHByaW50IGVtcHR5IGxpbmVzIGludG8gdGhlIHN5c3RlbSBsb2dcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBsb2dnZXIuZGVidWcoYFtJbnN0cnVtZW50YXRpb25dICR7bGluZS50cmltKCl9YCk7XG4gICAgICAvLyBBICdTb2NrZXRFeGNlcHRpb24nIGluZGljYXRlcyB0aGF0IHdlIGNvdWxkbid0IGNvbm5lY3QgdG8gdGhlIEVzcHJlc3NvIFNlcnZlciwgYmVjYXVzZSB0aGUgSU5URVJORVQgcGVybWlzc2lvbiBpcyBub3Qgc2V0XG4gICAgICBpZiAobGluZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCdqYXZhLm5ldC5zb2NrZXRleGNlcHRpb24nKSkge1xuICAgICAgICBoYXNTb2NrZXRFcnJvciA9IHRydWU7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBhd2FpdCB0aGlzLmluc3RQcm9jZXNzLnN0YXJ0KChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgLy8gZm9yIGFueSBjYWxsIHRvIHRoZSBzdGFydCBkZXRlY3Rvciwgb25lIG9mIHN0ZG91dCBvciBzdGRlcnIgd2lsbCBoYXZlXG4gICAgICAvLyBjb250ZW50LCBzbyBtZXJnZSBmb3IgY2hlY2tzIGhlcmVcbiAgICAgIGNvbnN0IG91dCA9IHN0ZG91dC50cmltKCkgfHwgc3RkZXJyLnRyaW0oKTtcblxuICAgICAgLy8gYWRiIGFsd2F5cyBwcmludHMgdGhpcyBvdXQgb24gc3VjY2Vzcy4gSWYgdGhpcyBpcyBmb3VuZCBub3QgdG8gYmUgdGhlXG4gICAgICAvLyBjYXNlLCBhZGQgb3RoZXIgY29uZGl0aW9uc1xuICAgICAgaWYgKG91dC5pbmNsdWRlcygnaW8uYXBwaXVtLmVzcHJlc3Nvc2VydmVyLkVzcHJlc3NvU2VydmVyUnVubmVyVGVzdDonKSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIGlmIChvdXQudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnZXhjZXB0aW9uJykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKG91dCk7XG4gICAgICB9XG4gICAgfSwgdGhpcy5zZXJ2ZXJMYXVuY2hUaW1lb3V0KTtcblxuICAgIGxvZ2dlci5pbmZvKCdXYWl0aW5nIGZvciBFc3ByZXNzbyB0byBiZSBvbmxpbmUuLi4nKTtcblxuICAgIC8vIHdhaXQgMjBzIGZvciBlc3ByZXNzbyB0byBiZSBvbmxpbmVcbiAgICB0cnkge1xuICAgICAgYXdhaXQgcmV0cnlJbnRlcnZhbCgyMCwgMTAwMCwgYXN5bmMgKCkgPT4ge1xuICAgICAgICBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCgnL3N0YXR1cycsICdHRVQnKTtcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChoYXNTb2NrZXRFcnJvcikge1xuICAgICAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhgVGltZWQgb3V0IHdhaXRpbmcgZm9yIEVzcHJlc3NvIFNlcnZlciB0byBzdGFydCBkdWUgdG8gU29ja2V0IGV4Y2VwdGlvbi4gRXNwcmVzc28gU2VydmVyIHJlcXVpcmVzIHRoZSAnSU5URVJORVQnIHBlcm1pc3Npb24gdG8gYmUgc2V0IGluIHRoZSBBbmRyb2lkIG1hbmlmZXN0IGZvciB0aGUgYXBwLXVuZGVyLXRlc3QgKDx1c2VzLXBlcm1pc3Npb24gYW5kcm9pZDpuYW1lPVwiYW5kcm9pZC5wZXJtaXNzaW9uLklOVEVSTkVUXCIgLz4pYCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhgVGltZWQgb3V0IHdhaXRpbmcgZm9yIEVzcHJlc3NvIFNlcnZlciB0byBzdGFydC4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvc2Vzc2lvbicsICdQT1NUJywge1xuICAgICAgY2FwYWJpbGl0aWVzOiB7XG4gICAgICAgIGZpcnN0TWF0Y2g6IFtjYXBzXSxcbiAgICAgICAgYWx3YXlzTWF0Y2g6IHt9XG4gICAgICB9XG4gICAgfSk7XG4gICAgYXdhaXQgdGhpcy5yZWNvcmRUYXJnZXRBcHBQYWNrYWdlKCk7XG4gIH1cblxuICBhc3luYyByZWNvcmRUYXJnZXRBcHBQYWNrYWdlICgpIHtcbiAgICBhd2FpdCB0aGlzLmFkYi5zaGVsbChbYGVjaG8gXCIke3RoaXMuYXBwUGFja2FnZX1cIiA+IFwiJHtUQVJHRVRfUEFDS0FHRV9DT05UQUlORVJ9XCJgXSk7XG4gICAgbG9nZ2VyLmluZm8oYFJlY29yZGVkIHRoZSB0YXJnZXQgYXBwbGljYXRpb24gcGFja2FnZSAnJHt0aGlzLmFwcFBhY2thZ2V9JyB0byAke1RBUkdFVF9QQUNLQUdFX0NPTlRBSU5FUn1gKTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVNlc3Npb24gKCkge1xuICAgIGxvZ2dlci5kZWJ1ZygnRGVsZXRpbmcgRXNwcmVzc28gc2VydmVyIHNlc3Npb24nKTtcbiAgICAvLyByZWx5IG9uIGp3cHJveHkncyBpbnRlbGxpZ2VuY2UgdG8ga25vdyB3aGF0IHdlJ3JlIHRhbGtpbmcgYWJvdXQgYW5kXG4gICAgLy8gZGVsZXRlIHRoZSBjdXJyZW50IHNlc3Npb25cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQoJy8nLCAnREVMRVRFJyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2dnZXIud2FybihgRGlkIG5vdCBnZXQgY29uZmlybWF0aW9uIEVzcHJlc3NvIGRlbGV0ZVNlc3Npb24gd29ya2VkOyBgICtcbiAgICAgICAgICBgRXJyb3Igd2FzOiAke2Vycn1gKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5pbnN0UHJvY2VzcyAmJiB0aGlzLmluc3RQcm9jZXNzLmlzUnVubmluZykge1xuICAgICAgYXdhaXQgdGhpcy5pbnN0UHJvY2Vzcy5zdG9wKCk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCB7IEVzcHJlc3NvUnVubmVyLCBSRVFVSVJFRF9QQVJBTVMsIFRFU1RfQVBLX1BLRyB9O1xuZXhwb3J0IGRlZmF1bHQgRXNwcmVzc29SdW5uZXI7XG4iXSwiZmlsZSI6ImxpYi9lc3ByZXNzby1ydW5uZXIuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
